{"meta":{"version":1,"warehouse":"4.0.2"},"models":{"Asset":[{"_id":"themes/archer/source/avatar/avatar.jpg","path":"avatar/avatar.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/css/dark.css","path":"css/dark.css","modified":1,"renderable":1},{"_id":"themes/archer/source/css/dark.css.map","path":"css/dark.css.map","modified":1,"renderable":1},{"_id":"themes/archer/source/css/mobile.css","path":"css/mobile.css","modified":1,"renderable":1},{"_id":"themes/archer/source/css/mobile.css.map","path":"css/mobile.css.map","modified":1,"renderable":1},{"_id":"themes/archer/source/css/style.css","path":"css/style.css","modified":1,"renderable":1},{"_id":"themes/archer/source/css/style.css.map","path":"css/style.css.map","modified":1,"renderable":1},{"_id":"themes/archer/source/font/Oswald-Regular.ttf","path":"font/Oswald-Regular.ttf","modified":1,"renderable":1},{"_id":"themes/archer/source/font/Source Sans Pro.woff","path":"font/Source Sans Pro.woff","modified":1,"renderable":1},{"_id":"themes/archer/source/font/Source Sans Pro.woff2","path":"font/Source Sans Pro.woff2","modified":1,"renderable":1},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff","path":"font/SourceCodePro-Regular.ttf.woff","modified":1,"renderable":1},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff2","path":"font/SourceCodePro-Regular.ttf.woff2","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/404-bg.jpg","path":"intro/404-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/about-bg.jpg","path":"intro/about-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/index-bg.jpg","path":"intro/index-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/post-bg.jpg","path":"intro/post-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/home-bg.jpg","path":"intro/home-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/lib/webfontloader.min.js","path":"lib/webfontloader.min.js","modified":1,"renderable":1},{"_id":"themes/archer/source/lib/jquery.min.js","path":"lib/jquery.min.js","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/customFontLoader.js.map","path":"scripts/customFontLoader.js.map","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/customFontLoader.js","path":"scripts/customFontLoader.js","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/dark.js","path":"scripts/dark.js","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/dark.js.map","path":"scripts/dark.js.map","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/main.js","path":"scripts/main.js","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/main.js.LICENSE.txt","path":"scripts/main.js.LICENSE.txt","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/search.js","path":"scripts/search.js","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/search.js.map","path":"scripts/search.js.map","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/search.js.LICENSE.txt","path":"scripts/search.js.LICENSE.txt","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/share.js","path":"scripts/share.js","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/share.js.map","path":"scripts/share.js.map","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/main.js.map","path":"scripts/main.js.map","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/algolia_logo.svg","path":"assets/algolia_logo.svg","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/beian.png","path":"assets/beian.png","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/wechat.jpg","path":"assets/wechat.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/loading.svg","path":"assets/loading.svg","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/favicon.ico","path":"assets/favicon.ico","modified":1,"renderable":1}],"Cache":[{"_id":"source/404.md","hash":"17657585e818d245e2000306cb66d0ce8dedb022","modified":1685264465705},{"_id":"source/_posts/JS如何实现图片压缩.md","hash":"19d0d84a871e1abe27b94281b8cd50e75579480d","modified":1685274582397},{"_id":"source/_posts/CommonJS模块化引入的实质与使用.md","hash":"682778eb57d85d01b80dae3d744f9bbfc8f3e2cf","modified":1685275074446},{"_id":"source/_posts/JavaScript在浏览器中的事件循环.md","hash":"50fa26c12bf955e7ed390b72eafd273c372f745f","modified":1685274005565},{"_id":"source/_posts/Concurrency-封装并发请求.md","hash":"c8cbe1b697d8383b3f455a91f3e57a17dec6ccba","modified":1685274536581},{"_id":"source/_posts/Node.JS中的事件循环 Event Loop.md","hash":"3fcc8d9dcce925c59b82ed170d54b3055c385356","modified":1685275036531},{"_id":"source/_posts/React Fiber架构.md","hash":"74b4a65fb31b354e3386d298ee718fb9a08a9583","modified":1685274758833},{"_id":"source/_posts/React Hooks-useState逻辑实现.md","hash":"5249abdcc43c4b4644a4676aa167130bd2db4a8c","modified":1685274415833},{"_id":"source/_posts/React15的三个Will生命周期为什么会在Fiber出现后被废弃.md","hash":"979a2e3edf65fd628de202d13e1144f10e55f30d","modified":1685274834852},{"_id":"source/_posts/React中使用Hooks的正确姿势.md","hash":"c2d363490c03c2eb9a3be0807fbaf0b455dc5a96","modified":1685274890817},{"_id":"source/_posts/useSwiper.md","hash":"01808438bf0e7427d85ffe47ae9654fbd1367053","modified":1685273944292},{"_id":"source/_posts/手写依赖收集（Proxy和Reflect）.md","hash":"3365b11ebcb89d045b5b37c0173429b4a2364c4b","modified":1685274766521},{"_id":"source/_posts/迭代器（iterator）、可迭代对象、生成器（generator）到底是什么.md","hash":"8b848ad0b3eb5815566885e8d4e4b57b8eb82be7","modified":1685274899522},{"_id":"source/about/index.md","hash":"2a72c225333e2ef6bc3a9e602ba83da4fd4ef25a","modified":1685264382221},{"_id":"source/_posts/Nest.js中如何使用HTTP五种数据传输方式.md","hash":"b50714164511d58304464ea18ecb27e2056c3bf6","modified":1685274774851},{"_id":"source/_posts/ES Modules的实现原理.md","hash":"70b9b6c239d979cce6d5fced1090f771e81f7128","modified":1685274258075},{"_id":"themes/archer/layout/_partial/comment/custom.ejs","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1685263902295},{"_id":"themes/archer/.babelrc","hash":"afa50eba6e461a2fffa7f7df19ffcc2ffe160c2e","modified":1685263902263},{"_id":"themes/archer/.editorconfig","hash":"5bccaaa5c39bfb2c7f8174853942bcf150023b41","modified":1685263902264},{"_id":"themes/archer/.eslintignore","hash":"40e63f21b940706c4a7437fb051c10debd89c628","modified":1685263902265},{"_id":"themes/archer/.gitattributes","hash":"82c1a621642d5b620275ae1ed59845c3f7015a64","modified":1685263902267},{"_id":"themes/archer/.eslintrc.json","hash":"3f53b2d1eb42d1d221b408159a6d65e34d2c115a","modified":1685263902266},{"_id":"themes/archer/.prettierignore","hash":"f1489a0426112ccd5a243b8ffb84ba8c9311d70f","modified":1685263902273},{"_id":"themes/archer/.gitignore","hash":"80337e5a48f9ecf0e5d5e13fb37f7b152ad89cb1","modified":1685278345455},{"_id":"themes/archer/.prettierrc.js","hash":"3a31e8e081b4e1bdd1174f70d89489114095a578","modified":1685263902273},{"_id":"themes/archer/LICENSE","hash":"35f4fb806270f8243459c870a2141e795dfab166","modified":1685263902275},{"_id":"themes/archer/CHANGELOG.md","hash":"152a607acacfc4893276d8e2f15379238fd0eb7d","modified":1685263902274},{"_id":"themes/archer/_config.yml","hash":"63195a6abd84ca7d9fe6b4022662a41a0b28430a","modified":1685263902277},{"_id":"themes/archer/README.md","hash":"2a3b7b756dd219b68b50560f63cc3864e6f6536e","modified":1685263902276},{"_id":"themes/archer/gulpfile.js","hash":"25b788354e20c9b99866dea35959006dcf837fe1","modified":1685263902284},{"_id":"themes/archer/package.json","hash":"aaf4f8bc6ade0f8e5d3a45358993950b4d53650b","modified":1685263902315},{"_id":"themes/archer/webpack.config.js","hash":"d8359ceb1df91202dee1600a00a0f4dd28fdc729","modified":1685263902414},{"_id":"themes/archer/webpack.dev.js","hash":"9508d5fef1acb87dcc71bf6a228f3f86eb9c6408","modified":1685263902415},{"_id":"themes/archer/webpack.prod.js","hash":"9b036689235595d86394e01bb9e93c77f9d35f36","modified":1685263902415},{"_id":"themes/archer/docs/develop-guide-en.md","hash":"c10293eb8ccad5d02412a1369ec1c7e77516b929","modified":1685263902280},{"_id":"themes/archer/docs/README-en.md","hash":"e4fff6fc13f3296c2b168ab220f847192bf1273b","modified":1685263902279},{"_id":"themes/archer/dev/archer.sh","hash":"9474c501c1c55f47f02cccdd9e2039498ebc5e43","modified":1685263902278},{"_id":"themes/archer/docs/develop-guide-zh.md","hash":"74a24a12219234175d118aaf75d6b6bd5a38b8d7","modified":1685263902280},{"_id":"themes/archer/languages/default.yml","hash":"77a3a6f64410611ac732d5a3f537d810fcaa60d9","modified":1685263902285},{"_id":"themes/archer/layout/404.ejs","hash":"a35e0e478ff84592c4a9d129fb24260e3ddc28ee","modified":1685263902287},{"_id":"themes/archer/layout/about.ejs","hash":"79eb9f77fcf72c07f8399bdf571e912c5588c647","modified":1685263902309},{"_id":"themes/archer/layout/layout.ejs","hash":"05285ac99ca71d3d5ad73cf927065182bb0bf005","modified":1685263902311},{"_id":"themes/archer/layout/index.ejs","hash":"ee164984b6a824c6b2caef224e169ef8a2827fa5","modified":1685263902310},{"_id":"themes/archer/languages/en.yml","hash":"5790207a1c8f4ed7763961af036e014ce8884901","modified":1685263902286},{"_id":"themes/archer/layout/post.ejs","hash":"c9007e2cffcfd32b4908403e02a4e822f67a641f","modified":1685263902311},{"_id":"themes/archer/layout/site-meta.ejs","hash":"7a5a65c84cb0573b510f87eff2b812ee05a17041","modified":1685263902312},{"_id":"themes/archer/.github/ISSUE_TEMPLATE/-----------bug--help-wanted-or-bug-report-.md","hash":"7d1c5dbbc89b03b9e764e71aedb3f9567bed49bf","modified":1685263902269},{"_id":"themes/archer/.github/ISSUE_TEMPLATE/-----other-issue-.md","hash":"1ee1770c446ffe4d489db8d216981f473da4addc","modified":1685263902271},{"_id":"themes/archer/layout/_partial/algolia.ejs","hash":"f119abb7e9f594a1516df45520bc45d0c620bdb6","modified":1685263902288},{"_id":"themes/archer/layout/_partial/base-background-image.ejs","hash":"a83db6fb5336af0353fadabb6712623f500dce42","modified":1685263902288},{"_id":"themes/archer/.github/ISSUE_TEMPLATE/-----feature-request-.md","hash":"ce7449948855556971a7353d4bfc7e8cd1b49634","modified":1685263902270},{"_id":"themes/archer/layout/_partial/base-footer.ejs","hash":"ea4c8bcc821640188f77e9ed88afd15f2add8486","modified":1685267789454},{"_id":"themes/archer/layout/_partial/base-footer-fixed.ejs","hash":"e4dbde6594c0c2d1c5de71ddf968be0879ceddb7","modified":1685263902289},{"_id":"themes/archer/layout/_partial/base-head.ejs","hash":"979c5353550ebf198af65ec2ab02eac8c25c3c22","modified":1685263902290},{"_id":"themes/archer/layout/_partial/base-profile.ejs","hash":"c3738524b663b0fcee9d3d64c62556daf1213168","modified":1685263902292},{"_id":"themes/archer/.github/workflows/deploy-demo-page.yml","hash":"d423d9fd3b0a35105b850505334cba89c2e42ef8","modified":1685263902272},{"_id":"themes/archer/layout/_partial/base-header.ejs","hash":"e4e13f1a416f0e41a8d3d8f8131e1e5e57ce737d","modified":1685263902291},{"_id":"themes/archer/layout/_partial/base-social.ejs","hash":"0cfba91d1a7273f349a5ca676a1fb8d23fb5e4e9","modified":1685263902293},{"_id":"themes/archer/layout/_partial/base-preload-polyfill.ejs","hash":"52445702f566f2d75407455fb4724e7469dc4b85","modified":1685263902291},{"_id":"themes/archer/layout/_partial/base-title-tags.ejs","hash":"fc4c44f8f21ed8a3ad011a86c956a750c5ff4db2","modified":1685263902293},{"_id":"themes/archer/layout/_partial/intro-height.ejs","hash":"03b295e12f90373042faf3ddc00baa7ea66f682e","modified":1685263902303},{"_id":"themes/archer/layout/_partial/custom-font.ejs","hash":"d75ca325a2253ae8ea498a6ca02bf7d556ec3066","modified":1685263902302},{"_id":"themes/archer/source/css/dark.css","hash":"f07379381480bf112f4634358bd9481077815960","modified":1685263902323},{"_id":"themes/archer/source/css/dark.css.map","hash":"f49556935deae49df3158c2eb2265464129ef978","modified":1685263902324},{"_id":"themes/archer/source/css/style.css","hash":"1c62cb298a11a15fd47a384b3890389d08871b40","modified":1685263902326},{"_id":"themes/archer/source/css/mobile.css","hash":"4fc84e2898489dcda23db447e196102ea990b424","modified":1685263902325},{"_id":"themes/archer/source/css/mobile.css.map","hash":"c9f9dade45b119ae2eb7a93be0160baef4d494f8","modified":1685263902325},{"_id":"themes/archer/source/font/Source Sans Pro.woff","hash":"a6722c9b6439b7a020a9be3d3178970757a9265c","modified":1685263902330},{"_id":"themes/archer/source/font/Source Sans Pro.woff2","hash":"da65f527a8da65d5eb6721626d28cfdb46ab104a","modified":1685263902330},{"_id":"themes/archer/source/lib/webfontloader.min.js","hash":"03f379e646bdedbbbcc53c634d7e0039519cb0ad","modified":1685263902342},{"_id":"themes/archer/source/scripts/customFontLoader.js","hash":"d42b6fb6cd91bf5b04786235d5ad0d439359d2fa","modified":1685263902344},{"_id":"themes/archer/source/scripts/customFontLoader.js.map","hash":"562be3e71da177c343b1b726925536dccc6a3c03","modified":1685263902344},{"_id":"themes/archer/source/scripts/dark.js","hash":"469ff6acbb00deb0d62ce765f06a2fc76dadbfc0","modified":1685263902345},{"_id":"themes/archer/source/scripts/dark.js.map","hash":"cd67c01806a5918af4c0b90e97a73915448d35ec","modified":1685263902346},{"_id":"themes/archer/source/scripts/main.js.LICENSE.txt","hash":"821bf670591761f55c867aa192e12a7d841dde18","modified":1685263902353},{"_id":"themes/archer/source/scripts/search.js.LICENSE.txt","hash":"0fdfc6844a6c5bbf2ecfb3fe038412afb398b9e6","modified":1685263902364},{"_id":"themes/archer/source/scripts/share.js","hash":"2ff4c7ed16fc3ceba2fe217c2f9287107370b585","modified":1685263902370},{"_id":"themes/archer/src/js/browser.js","hash":"1c2672917d07adc8e74c065264a520e081154191","modified":1685263902372},{"_id":"themes/archer/src/js/dark.js","hash":"7f03e978af9d59ff990a68dfa939a37cb6e87af1","modified":1685263902374},{"_id":"themes/archer/src/js/customFontLoader.js","hash":"7dbdaf6ab1d0553129f827768cab793360cf1d63","modified":1685263902373},{"_id":"themes/archer/src/js/fontawsome.js","hash":"5694c5c42a3990c034dcb2ed9baf73264805b039","modified":1685263902375},{"_id":"themes/archer/src/js/init.js","hash":"1eed1591f6387f847b9800a3f7ca87e16d0c325e","modified":1685263902376},{"_id":"themes/archer/src/js/initSidebar.js","hash":"ad88bef0bf1c71c6278072d203aaad8c84561fde","modified":1685263902376},{"_id":"themes/archer/src/js/fancybox.js","hash":"2907a27a3ba897cfc7c3ab3dd7bc6a3e8a7c504c","modified":1685263902374},{"_id":"themes/archer/src/js/scroll.js","hash":"2eb22a59c249d7cee541c77b8aa894999801c63e","modified":1685263902378},{"_id":"themes/archer/src/js/search.js","hash":"2751aee7fc0e494b0f5fb1273ef24317c40f819a","modified":1685263902379},{"_id":"themes/archer/src/js/main.js","hash":"8c5c513fb030c07b88d0f6120dba5f3b61d548ca","modified":1685267938238},{"_id":"themes/archer/src/js/share.js","hash":"eb8990823f7931b0f71478f6da665664c9e36e81","modified":1685263902380},{"_id":"themes/archer/src/js/mobile.js","hash":"5064036c3c8c77a44c62fadb4d3c34ad1943fd6e","modified":1685263902378},{"_id":"themes/archer/src/js/toc.js","hash":"070dc7760f80802afd71faf3b39772c392504eb2","modified":1685263902382},{"_id":"themes/archer/src/js/sidebar.js","hash":"fcd110c73662ee4cccd2b0873e095309a365d2ec","modified":1685263902380},{"_id":"themes/archer/src/js/util.js","hash":"5347de39208195bd5ba67479e3c00945b0f89d56","modified":1685263902382},{"_id":"themes/archer/src/scss/_common.scss","hash":"d5ac6df18ba0bed9fae2a7c0858c2dcc5f497904","modified":1685263902383},{"_id":"themes/archer/src/js/tag.js","hash":"ddf2723fe7cce2aae12ad0479287d5a3c53baa07","modified":1685263902381},{"_id":"themes/archer/src/scss/_normalize.scss","hash":"fb6a1349bab25b65cf89b47e136d958d10947533","modified":1685263902397},{"_id":"themes/archer/src/scss/_variables.scss","hash":"99915c1ae8562f475eddc55ec296d531262d82ff","modified":1685263902411},{"_id":"themes/archer/src/scss/_mixin.scss","hash":"ede5b572a3a29fd01902b1947057508441bc1a7e","modified":1685263902394},{"_id":"themes/archer/src/scss/dark.scss","hash":"f3a3dcd962a3ca60967757a174999d22f26884aa","modified":1685263902411},{"_id":"themes/archer/src/scss/style.scss","hash":"bcd8df4e180903820938324201ccc24a464c7cde","modified":1685263902412},{"_id":"themes/archer/src/scss/mobile.scss","hash":"735d7b52f512c329ffcf6b4c3cacae7f465fee41","modified":1685263902412},{"_id":"themes/archer/source/assets/beian.png","hash":"a99df13e8eb11db86edebf6e5ac246eb59f4b3c4","modified":1685263902318},{"_id":"themes/archer/source/assets/algolia_logo.svg","hash":"16505f61f19ba65f629dfd033f14ee9abcf18756","modified":1685263902317},{"_id":"themes/archer/layout/_partial/comment/changyan.ejs","hash":"f35a8bb655ba782676493c87d94f4021d1f8d4e7","modified":1685263902294},{"_id":"themes/archer/source/assets/loading.svg","hash":"85082b002bae1335114b71550350907884187e38","modified":1685263902320},{"_id":"themes/archer/layout/_partial/comment/disqus.ejs","hash":"9859e0717d8e76a31001c3cafd320f85c78f3776","modified":1685263902295},{"_id":"themes/archer/layout/_partial/comment/gitalk.ejs","hash":"609d9b867d9aae7984dcc233ed31f6d073f9d3a0","modified":1685263902296},{"_id":"themes/archer/layout/_partial/comment/gitment.ejs","hash":"d3040d5613313bee8010c6b77359bf96ece0e84b","modified":1685263902297},{"_id":"themes/archer/layout/_partial/comment/livere.ejs","hash":"15dd256b459522515d7601239e21cf5d849930ca","modified":1685263902297},{"_id":"themes/archer/layout/_partial/comment/utteranc.ejs","hash":"d120a1b0732f7d6033dbd789dea58e23603c10aa","modified":1685263902298},{"_id":"themes/archer/layout/_partial/comment/waline.ejs","hash":"4eafb4aab531b5997061c435b461712d6385b4e1","modified":1685263902300},{"_id":"themes/archer/layout/_partial/critical-css/critical-style.ejs","hash":"74988d738cbd070cc4a921f947b7fcdb5183c405","modified":1685263902302},{"_id":"themes/archer/layout/_partial/math/mathjax.ejs","hash":"65c1203fcb652894b5edaa7b686009cfd5211f72","modified":1685263902304},{"_id":"themes/archer/layout/_partial/comment/youyan.ejs","hash":"b56d493eebace62db42b30c12fd9df8fde961d0d","modified":1685263902300},{"_id":"themes/archer/layout/_partial/script/font-loader.ejs","hash":"245943b4153047c9efb874c4c27e88fd9ed3c341","modified":1685263902306},{"_id":"themes/archer/layout/_partial/comment/valine.ejs","hash":"e96796398f3ade42b8ba4354b51890ec586d7843","modified":1685263902299},{"_id":"themes/archer/layout/_partial/sidebar/base-sidebar.ejs","hash":"84c9747859051f5df7843ad704f8fac6c3021847","modified":1685263902307},{"_id":"themes/archer/layout/_partial/sidebar/sidebar-archives.ejs","hash":"89bf250c14366682def9b1667339d55dff234f21","modified":1685263902307},{"_id":"themes/archer/layout/_partial/sidebar/sidebar-categories.ejs","hash":"9316847cb59357787c3ef4b9a3f572a96d14cb00","modified":1685263902308},{"_id":"themes/archer/layout/_partial/sidebar/sidebar-tags.ejs","hash":"3b856404884c52173af2c9be165a1b23fd3caa70","modified":1685263902309},{"_id":"themes/archer/src/scss/_partial/_404.scss","hash":"b5eaa29de016b5c7838a5791198bcc6003385b65","modified":1685263902398},{"_id":"themes/archer/src/scss/_dark/_common-dark.scss","hash":"d768ff4ded26f321a73e425748400779659f51b6","modified":1685263902384},{"_id":"themes/archer/src/scss/_partial/_index-page.scss","hash":"57bc461726ecddcad36f58a034952a59b98805a6","modified":1685263902401},{"_id":"themes/archer/src/scss/_partial/_post-page.scss","hash":"b557cec951b5b5f707ed297a4b1159edaa1c2124","modified":1685263902406},{"_id":"themes/archer/src/scss/_partial/_algolia.scss","hash":"2bf49a3ffdc12cb7c1581690a383b66f0d0f2ddd","modified":1685263902399},{"_id":"themes/archer/src/scss/_dark/_partial/_algolia-dark.scss","hash":"2576dd0957e01ba76f90e21b91db3e4b48f84bd5","modified":1685263902385},{"_id":"themes/archer/src/scss/_dark/_partial/_index-page-dark.scss","hash":"fe31715d8ab240e9207bb907786854badfdd1e72","modified":1685263902386},{"_id":"themes/archer/src/scss/_dark/_partial/_post-page-dark.scss","hash":"8f30799613a40a55edfea2c90e525fb356099813","modified":1685263902390},{"_id":"themes/archer/src/scss/_mobile/_partial/_index-page-mobile.scss","hash":"b8af32962b11463b5f94891aa1d7de9ae95a68cf","modified":1685263902395},{"_id":"themes/archer/src/scss/_partial/_comment/_gitalk.scss","hash":"846893051295b8b66301b31274f0c787cc32cc0a","modified":1685263902400},{"_id":"themes/archer/src/scss/_partial/_partial/_footer-fixed.scss","hash":"806c3eefac1e07493eab03849420143635e45828","modified":1685263902402},{"_id":"themes/archer/src/scss/_partial/_partial/_footer.scss","hash":"0e27384366412a4da56ece046cc9e7530abf679d","modified":1685263902402},{"_id":"themes/archer/src/scss/_partial/_partial/_header.scss","hash":"3c09e93464bff03582765e101eb2db6f42179efc","modified":1685263902403},{"_id":"themes/archer/src/scss/_partial/_partial/_intro.scss","hash":"32ef36e1b2fc298323ea09f2b7ffce3be175d58d","modified":1685263902404},{"_id":"themes/archer/src/scss/_partial/_partial/_paginator.scss","hash":"1e4510959f51b5d4d3c5781468c77d25546ce905","modified":1685263902404},{"_id":"themes/archer/src/scss/_partial/_partial/_profile.scss","hash":"eba73d0e1ff0997446efbe5655b449a80967c8c1","modified":1685263902405},{"_id":"themes/archer/src/scss/_partial/_post/_writing-enhance.scss","hash":"12f52673d487c720a8ea49a31db5a37630e5b33f","modified":1685263902408},{"_id":"themes/archer/src/scss/_partial/_partial/_scrollbar.scss","hash":"04f57efb3c9a586dfba742fe63606ebac98d936a","modified":1685263902405},{"_id":"themes/archer/src/scss/_partial/_post/_code.scss","hash":"87840eec79fb6970516e735d26a5b320d1cb846d","modified":1685263902407},{"_id":"themes/archer/src/scss/_partial/_sidebar/_sidebar-archive.scss","hash":"f97ea429dcb4d371cecf34c9c8f7d3a40fc11e11","modified":1685263902409},{"_id":"themes/archer/src/scss/_partial/_sidebar/_sidebar-tags.scss","hash":"7f20bdb96b402663a0e2bfcf7f4827198611a3c4","modified":1685263902409},{"_id":"themes/archer/src/scss/_dark/_partial/_partial/_footer-dark.scss","hash":"b169fbdf0e85497021ea521db247939a723aa9b3","modified":1685263902387},{"_id":"themes/archer/src/scss/_partial/_sidebar/_sidebar.scss","hash":"3ecc4abc4de9a3f134e8c032d46e7562afab6916","modified":1685263902410},{"_id":"themes/archer/src/scss/_dark/_partial/_partial/_footer-fixed-dark.scss","hash":"7da8ef87e04efce102140ac8dcce01b9596f513b","modified":1685263902388},{"_id":"themes/archer/src/scss/_dark/_partial/_comment/_gitalk-dark.scss","hash":"979ed66ccce5e1b02b7c5b73d80f211c0abde0f1","modified":1685263902386},{"_id":"themes/archer/src/scss/_dark/_partial/_partial/_profile-dark.scss","hash":"f6f21504c2212fadc80fc0157b03c14acad29b4a","modified":1685263902389},{"_id":"themes/archer/src/scss/_dark/_partial/_partial/_header-dark.scss","hash":"6e18d4d079a4fd151c8d81bdc70c91f63faf6c47","modified":1685263902389},{"_id":"themes/archer/src/scss/_dark/_partial/_post/_code-dark.scss","hash":"310ac0c38accd652b16eafbb068fdb7d27fce729","modified":1685263902391},{"_id":"themes/archer/src/scss/_dark/_partial/_sidebar/_sidebar-dark.scss","hash":"8ad0191162833248ba821d4f2f4453c344254649","modified":1685263902392},{"_id":"themes/archer/src/scss/_dark/_partial/_sidebar/_sidebar-tags-dark.scss","hash":"2e2f208e25dd2d86a8ecff1bc2d20f604084fa05","modified":1685263902393},{"_id":"themes/archer/src/scss/_mobile/_partial/_post/_writing-enhance-mobile.scss","hash":"27f6775c5fbb04f53440050fca312b94f48088f1","modified":1685263902396},{"_id":"themes/archer/src/scss/_dark/_partial/_sidebar/_sidebar-archive-dark.scss","hash":"71f50003fe109ed40d6fdad835b7cdc8ab19bf97","modified":1685263902392},{"_id":"themes/archer/src/scss/_mobile/_partial/_sidebar/_sidebar-tags-mobile.scss","hash":"68acfc8b7c5df5cd945365ba9c0620df2cd5e515","modified":1685263902397},{"_id":"themes/archer/source/css/style.css.map","hash":"bbbc01e4d434b0c477818074517ef9a5cf1d490a","modified":1685263902327},{"_id":"themes/archer/source/font/Oswald-Regular.ttf","hash":"965d729546a43a8490ad4cf33c25ac475682100c","modified":1685263902329},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff","hash":"12eef75e1ad3eca9dae42b65505010ce4464a315","modified":1685263902331},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff2","hash":"f5991289ec17884cb641da0646d278d36702a190","modified":1685263902332},{"_id":"themes/archer/source/intro/404-bg.jpg","hash":"3afb5bb26f4ff0bd0e0a28df955c8aa7d746d3c5","modified":1685263902334},{"_id":"themes/archer/source/lib/jquery.min.js","hash":"156837f75f6600ccb602b4efcbd393636c33f35e","modified":1685263902341},{"_id":"themes/archer/source/intro/about-bg.jpg","hash":"ab388276822417cc4e703312c14e20280ec783b3","modified":1685263902336},{"_id":"themes/archer/source/intro/post-bg.jpg","hash":"525fafb2238c27754d8fa751f143ff1de9b8482d","modified":1685263902340},{"_id":"themes/archer/source/scripts/search.js","hash":"2dcdb2d9e6e468367136dd24d4ad0b1485d14f51","modified":1685263902364},{"_id":"themes/archer/source/scripts/share.js.map","hash":"32cf05ef916145fef08b3bbe7bc497b8ae8ccf0c","modified":1685263902371},{"_id":"themes/archer/source/assets/wechat.jpg","hash":"89d61b98e3b2b98f37858c3a819db81b137ca747","modified":1666858034622},{"_id":"themes/archer/source/assets/favicon.ico","hash":"d4e5b47afb45e66fca737f554c5743e6f2f18bec","modified":1666841975888},{"_id":"themes/archer/docs/snap.png","hash":"0b2a8bf016f6eed576abfdcdb7dcf8de51c12562","modified":1685263902283},{"_id":"themes/archer/source/intro/index-bg.jpg","hash":"96b52e177b8bc53e64ec6ee1e10b2b6a4e13083b","modified":1685263902338},{"_id":"themes/archer/package-lock.json","hash":"3bc9644ebfbe74bf11d023ee2d67301fde1f60a9","modified":1685263902314},{"_id":"themes/archer/source/avatar/avatar.jpg","hash":"c88d242c40e25488cee762ae17cf0fa9a87cf422","modified":1666841630270},{"_id":"themes/archer/source/scripts/search.js.map","hash":"1af45c08a62a5fa84a4f4f1fb4aaab0ba8e0f652","modified":1685263902369},{"_id":"themes/archer/source/scripts/main.js","hash":"11d31739ec0609f932f65b77234fc9c66872a060","modified":1685263902353},{"_id":"themes/archer/source/scripts/main.js.map","hash":"e8a5aa8538c5d181f0d6780c4a1f09c7d6663fd0","modified":1685263902362},{"_id":"themes/archer/source/intro/home-bg.jpg","hash":"4bd723fe913445f7489d60d886c9ded33500309d","modified":1666837618325},{"_id":"public/atom.xml","hash":"21a9bc11b11a9585fb282a6bcfed1410414272cd","modified":1685279924806},{"_id":"public/content.json","hash":"5b154dd45bae0a8536b829aaaaa5578e8295045c","modified":1685279924806},{"_id":"public/404.html","hash":"3c8ed480c27f4feaa70706f39db61295d19cfc6e","modified":1685279924806},{"_id":"public/about/index.html","hash":"2a0138ca2c57cb41ec44e1d56e4a64d18b73dba5","modified":1685279924806},{"_id":"public/2023/05/28/React中使用Hooks的正确姿势/index.html","hash":"23031205cdeeebde5e09035aa7b4d9a999c4ade6","modified":1685279924806},{"_id":"public/2023/05/28/React Hooks-useState逻辑实现/index.html","hash":"08c6e2603918d7a5199912969b649d7dbcdf4478","modified":1685279924806},{"_id":"public/2023/05/28/React Fiber架构/index.html","hash":"6f50abcd9454eb7f52399865c1a1e6ba82f5bf62","modified":1685279924806},{"_id":"public/2023/05/28/React15的三个Will生命周期为什么会在Fiber出现后被废弃/index.html","hash":"eb2d269d652adfadb58143bd44f761b374a1e2b9","modified":1685279924806},{"_id":"public/2023/05/28/ES Modules的实现原理/index.html","hash":"832a24aedb2feb63cccfc829abe65102557136b3","modified":1685279924806},{"_id":"public/2023/05/28/迭代器（iterator）、可迭代对象、生成器（generator）到底是什么/index.html","hash":"8af37954643197271e72ccbbeb91ebf0852fa37a","modified":1685279924806},{"_id":"public/2023/05/28/手写依赖收集（Proxy和Reflect）/index.html","hash":"9e6d6c7fc7fbcae6433d39a6221e935b69cacb75","modified":1685279924806},{"_id":"public/2023/05/27/Nest.js中如何使用HTTP五种数据传输方式/index.html","hash":"b22015599e9ba610083178a4f3b4084414d4f443","modified":1685279924806},{"_id":"public/2023/05/20/JS如何实现图片压缩/index.html","hash":"f5b9d63f97abf33f29b85d8e94d119fb8590090a","modified":1685279924806},{"_id":"public/2023/05/18/Concurrency-封装并发请求/index.html","hash":"6bedcaed8da87fb9ab67ffbe66742d36f7b3bebd","modified":1685279924806},{"_id":"public/2023/03/08/Node.JS中的事件循环 Event Loop/index.html","hash":"40c8f0d8d9d2cafbe0d3aa0ba4f15ec347080e23","modified":1685279924806},{"_id":"public/2023/03/07/JavaScript在浏览器中的事件循环/index.html","hash":"862692b8502329c65277213608c307e9b97c0216","modified":1685279924806},{"_id":"public/2023/03/01/CommonJS模块化引入的实质与使用/index.html","hash":"31b14c8b7131d87d401e03fdecd87e2f8fb2061c","modified":1685279924806},{"_id":"public/2023/02/21/useSwiper/index.html","hash":"56dd07bd5cda44aa272fbd36f8195d7867ebd0d0","modified":1685279924806},{"_id":"public/categories/前端/index.html","hash":"9df607b492ae1a3ef450e20098a6a1ba13fa1541","modified":1685279924806},{"_id":"public/categories/前端/page/2/index.html","hash":"a76451c6cd6af14c5d85db0fe5bd3c71f72d1e66","modified":1685279924806},{"_id":"public/categories/后端/index.html","hash":"83d2ffb83f5a96c776531fdc731d0bb483c57d66","modified":1685279924806},{"_id":"public/archives/index.html","hash":"3e023354d6ae366fd46247aac52f38459206c2aa","modified":1685279924806},{"_id":"public/archives/page/2/index.html","hash":"dd8960e300bcaa84c41e97358fbfed0a7b6b3133","modified":1685279924806},{"_id":"public/archives/2023/page/2/index.html","hash":"5c825b1c450bd5478b9ada606ca65a7ab6568e87","modified":1685279924806},{"_id":"public/archives/2023/index.html","hash":"d94862f69c7d5ba15f8b4e43f94edf2703833282","modified":1685279924806},{"_id":"public/archives/2023/02/index.html","hash":"a90a86d3253c890b32ebb6759a701712518869e0","modified":1685279924806},{"_id":"public/index.html","hash":"6fe95a64ac242cf1e14cfc3f2690ea87809ab7bd","modified":1685279924806},{"_id":"public/archives/2023/03/index.html","hash":"5afd7a1f8cda40c37949eba7fe071bbeb561f955","modified":1685279924806},{"_id":"public/archives/2023/05/index.html","hash":"cb125f1a0478ac46199cd3a29df2accc4973b8f2","modified":1685279924806},{"_id":"public/page/2/index.html","hash":"350f11b061ea9dba8fdffd4ddd2ffc3e0853e3bc","modified":1685279924806},{"_id":"public/tags/JavaScript/index.html","hash":"ea114bbc82e45ff36122e1c77228f8871b480a16","modified":1685279924806},{"_id":"public/tags/Node-js/index.html","hash":"d497dcac6a5eb03f733489f19052a2431920e01d","modified":1685279924806},{"_id":"public/tags/并发请求/index.html","hash":"9dc9b69b95200c1d33192736992448a7f2d40f9c","modified":1685279924806},{"_id":"public/tags/React/index.html","hash":"e8db4f663a6f277bf0dc975d1634552e8b311b85","modified":1685279924806},{"_id":"public/tags/Vue/index.html","hash":"d789ee56418f09d20811e49b26440a7633b2c352","modified":1685279924806},{"_id":"public/tags/Mobile/index.html","hash":"22677704df06d85aefffc892c249bf8aab28389e","modified":1685279924806},{"_id":"public/tags/TepyScript/index.html","hash":"76bc3f544e8885169dc19f9020319db9b1499682","modified":1685279924806},{"_id":"public/tags/Nest-js/index.html","hash":"bb0da01a743f38d9b576b9ec2e74446a0e2ced85","modified":1685279924806},{"_id":"public/css/mobile.css.map","hash":"c9f9dade45b119ae2eb7a93be0160baef4d494f8","modified":1685279924806},{"_id":"public/css/dark.css.map","hash":"f49556935deae49df3158c2eb2265464129ef978","modified":1685279924806},{"_id":"public/font/Source Sans Pro.woff","hash":"a6722c9b6439b7a020a9be3d3178970757a9265c","modified":1685279924806},{"_id":"public/font/Source Sans Pro.woff2","hash":"da65f527a8da65d5eb6721626d28cfdb46ab104a","modified":1685279924806},{"_id":"public/scripts/customFontLoader.js.map","hash":"562be3e71da177c343b1b726925536dccc6a3c03","modified":1685279924806},{"_id":"public/scripts/dark.js.map","hash":"cd67c01806a5918af4c0b90e97a73915448d35ec","modified":1685279924806},{"_id":"public/scripts/search.js.LICENSE.txt","hash":"0fdfc6844a6c5bbf2ecfb3fe038412afb398b9e6","modified":1685279924806},{"_id":"public/assets/algolia_logo.svg","hash":"16505f61f19ba65f629dfd033f14ee9abcf18756","modified":1685279924806},{"_id":"public/assets/beian.png","hash":"a99df13e8eb11db86edebf6e5ac246eb59f4b3c4","modified":1685279924806},{"_id":"public/scripts/main.js.LICENSE.txt","hash":"821bf670591761f55c867aa192e12a7d841dde18","modified":1685279924806},{"_id":"public/assets/loading.svg","hash":"85082b002bae1335114b71550350907884187e38","modified":1685279924806},{"_id":"public/assets/algolia/algoliasearchLite.min.js","hash":"284416885e4e80e27fa4eae6fc305f4de15b914c","modified":1685279924806},{"_id":"public/css/style.css.map","hash":"bbbc01e4d434b0c477818074517ef9a5cf1d490a","modified":1685279924806},{"_id":"public/font/Oswald-Regular.ttf","hash":"965d729546a43a8490ad4cf33c25ac475682100c","modified":1685279924806},{"_id":"public/font/SourceCodePro-Regular.ttf.woff","hash":"12eef75e1ad3eca9dae42b65505010ce4464a315","modified":1685279924806},{"_id":"public/font/SourceCodePro-Regular.ttf.woff2","hash":"f5991289ec17884cb641da0646d278d36702a190","modified":1685279924806},{"_id":"public/intro/404-bg.jpg","hash":"3afb5bb26f4ff0bd0e0a28df955c8aa7d746d3c5","modified":1685279924806},{"_id":"public/assets/algolia/algoliasearchLite.js","hash":"e56ad6b82caf69066de545201014291fc961635e","modified":1685279924806},{"_id":"public/assets/algolia/algoliasearch.min.js","hash":"a3b131a9a47ccc16f4dd8988fabb6d306548db2f","modified":1685279924806},{"_id":"public/css/dark.css","hash":"4db211216f16a5e66d4d499158f4005a1bbb39f5","modified":1685279924806},{"_id":"public/css/mobile.css","hash":"acb0dfcce26ec93f59c6ec4936006abbe8daefee","modified":1685279924806},{"_id":"public/lib/webfontloader.min.js","hash":"4c69aeb4e4f355912503d1c460e8e7aa6ea6963e","modified":1685279924806},{"_id":"public/scripts/customFontLoader.js","hash":"52b1dea9a9535da759d719f387fca64338a19a22","modified":1685279924806},{"_id":"public/scripts/dark.js","hash":"b0b3b400432f1913c57c817e3d8ad40dbfeebabc","modified":1685279924806},{"_id":"public/css/style.css","hash":"130f6e996686900271a3ee2019367cfc40ab6234","modified":1685279924806},{"_id":"public/lib/jquery.min.js","hash":"ad886e472b3557f3dc7dfa2bc43468ab8d1cef5b","modified":1685279924806},{"_id":"public/scripts/share.js","hash":"002a7ef013c192651d58ca338cd5510b335f89ef","modified":1685279924806},{"_id":"public/scripts/search.js","hash":"4b4cfa64c6723efa2522cd104a4ce79d2a8c8ab3","modified":1685279924806},{"_id":"public/intro/about-bg.jpg","hash":"ab388276822417cc4e703312c14e20280ec783b3","modified":1685279924806},{"_id":"public/intro/post-bg.jpg","hash":"525fafb2238c27754d8fa751f143ff1de9b8482d","modified":1685279924806},{"_id":"public/scripts/share.js.map","hash":"32cf05ef916145fef08b3bbe7bc497b8ae8ccf0c","modified":1685279924806},{"_id":"public/assets/algolia/algoliasearch.js","hash":"6948fcdf071e4983e784e8c458cf201536f77792","modified":1685279924806},{"_id":"public/scripts/main.js","hash":"b1c2d1752bfb1c9b6b82647c490770cc88091a9e","modified":1685279924806},{"_id":"public/assets/wechat.jpg","hash":"89d61b98e3b2b98f37858c3a819db81b137ca747","modified":1685279924806},{"_id":"public/assets/favicon.ico","hash":"d4e5b47afb45e66fca737f554c5743e6f2f18bec","modified":1685279924806},{"_id":"public/intro/index-bg.jpg","hash":"96b52e177b8bc53e64ec6ee1e10b2b6a4e13083b","modified":1685279924806},{"_id":"public/avatar/avatar.jpg","hash":"c88d242c40e25488cee762ae17cf0fa9a87cf422","modified":1685279924806},{"_id":"public/scripts/search.js.map","hash":"1af45c08a62a5fa84a4f4f1fb4aaab0ba8e0f652","modified":1685279924806},{"_id":"public/scripts/main.js.map","hash":"e8a5aa8538c5d181f0d6780c4a1f09c7d6663fd0","modified":1685279924806},{"_id":"public/intro/home-bg.jpg","hash":"4bd723fe913445f7489d60d886c9ded33500309d","modified":1685279924806}],"Category":[{"name":"前端","_id":"cli7g5ksd00040svh4jr236d4"},{"name":"后端","_id":"cli7g5ksi00090svhaw5ral7s"}],"Data":[],"Page":[{"layout":"404","title":"[404]","description":"May the Force be with you :&#41;","_content":"","source":"404.md","raw":"---\nlayout: 404\ntitle: \"[404]\"\ndescription: \"May the Force be with you :&#41;\"\n---","date":"2023-05-28T09:01:05.705Z","updated":"2023-05-28T09:01:05.705Z","path":"404.html","comments":1,"_id":"cli7g5ks500000svh2p268nv5","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"Skills","layout":"about","_content":"\n## JavaScript\n## TypeScript\n## C++\n## Golang\n## React\n## Vue3\n## Nest.js\n## Next.js\n## Nuxt.js\n## Docker\n## MySQL\n## Linux\n","source":"about/index.md","raw":"---\ntitle: Skills\nlayout: about\n---\n\n## JavaScript\n## TypeScript\n## C++\n## Golang\n## React\n## Vue3\n## Nest.js\n## Next.js\n## Nuxt.js\n## Docker\n## MySQL\n## Linux\n","date":"2023-05-28T08:59:42.221Z","updated":"2023-05-28T08:59:42.221Z","path":"about/index.html","comments":1,"_id":"cli7g5ksb00020svh9sth0q99","content":"<h2 id=\"JavaScript\"><a href=\"#JavaScript\" class=\"headerlink\" title=\"JavaScript\"></a>JavaScript</h2><h2 id=\"TypeScript\"><a href=\"#TypeScript\" class=\"headerlink\" title=\"TypeScript\"></a>TypeScript</h2><h2 id=\"C\"><a href=\"#C\" class=\"headerlink\" title=\"C++\"></a>C++</h2><h2 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h2><h2 id=\"React\"><a href=\"#React\" class=\"headerlink\" title=\"React\"></a>React</h2><h2 id=\"Vue3\"><a href=\"#Vue3\" class=\"headerlink\" title=\"Vue3\"></a>Vue3</h2><h2 id=\"Nest-js\"><a href=\"#Nest-js\" class=\"headerlink\" title=\"Nest.js\"></a>Nest.js</h2><h2 id=\"Next-js\"><a href=\"#Next-js\" class=\"headerlink\" title=\"Next.js\"></a>Next.js</h2><h2 id=\"Nuxt-js\"><a href=\"#Nuxt-js\" class=\"headerlink\" title=\"Nuxt.js\"></a>Nuxt.js</h2><h2 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h2><h2 id=\"MySQL\"><a href=\"#MySQL\" class=\"headerlink\" title=\"MySQL\"></a>MySQL</h2><h2 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux\"></a>Linux</h2>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"JavaScript\"><a href=\"#JavaScript\" class=\"headerlink\" title=\"JavaScript\"></a>JavaScript</h2><h2 id=\"TypeScript\"><a href=\"#TypeScript\" class=\"headerlink\" title=\"TypeScript\"></a>TypeScript</h2><h2 id=\"C\"><a href=\"#C\" class=\"headerlink\" title=\"C++\"></a>C++</h2><h2 id=\"Golang\"><a href=\"#Golang\" class=\"headerlink\" title=\"Golang\"></a>Golang</h2><h2 id=\"React\"><a href=\"#React\" class=\"headerlink\" title=\"React\"></a>React</h2><h2 id=\"Vue3\"><a href=\"#Vue3\" class=\"headerlink\" title=\"Vue3\"></a>Vue3</h2><h2 id=\"Nest-js\"><a href=\"#Nest-js\" class=\"headerlink\" title=\"Nest.js\"></a>Nest.js</h2><h2 id=\"Next-js\"><a href=\"#Next-js\" class=\"headerlink\" title=\"Next.js\"></a>Next.js</h2><h2 id=\"Nuxt-js\"><a href=\"#Nuxt-js\" class=\"headerlink\" title=\"Nuxt.js\"></a>Nuxt.js</h2><h2 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h2><h2 id=\"MySQL\"><a href=\"#MySQL\" class=\"headerlink\" title=\"MySQL\"></a>MySQL</h2><h2 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux\"></a>Linux</h2>"}],"Post":[{"title":"JS如何实现图片压缩","date":"2023-05-20T13:59:00.000Z","_content":"\n\n## 前言\n\n<img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a82edb207c814cd09c2c6b0627829478~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\">\n关于图片压缩这一般都是由后端来完成~，但是前端掌握这项技能也是必不可少的。\n\n## 图片压缩思路\n\n我们读取源图片之后，利用`canvas`画板画出源图片，然后利用`toDataURL`这个API转换成`base64`的格式\n\n需要FileReade这个对象去reader图片，并且利用reader.onload这个监听事件完成图片压缩。\n\n## 源码\n\n### index.html文件\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Document</title>\n    <style>\n        .hide{\n            display: none;\n        }\n        .show{\n            display: initial;\n        }\n        .img-preview{\n            width: 300px;\n        }\n    </style>\n</head>\n<body>\n    <p>\n        <input type=\"file\"  id=\"imgFileSelector\" value=\"请选择图片\">  \n    </p> \n    <p>\n        <img id=\"originImgPreview\" class=\"img-preview  hide\">\n    </p>\n    <p>\n        <img id=\"compressedImgPreview\" class=\"img-preview hide\">\n    </p>\n\n    <script src=\"./index.js\" type=\"module\" ></script>\n</body>\n</html>\n```\n\n因为img元素既不是`块级元素`也不是`行内级元素`，所以添加类`.show`时需要设置为`display:initial`。\n\n### index.js文件\n\n```js\n//获取HTML元素\nconst oImageFileSelector=document.querySelector(\"#imgFileSelector\")\nconst oOriginImgPreview=document.querySelector(\"#originImgPreview\")\nconst oCompressedImgPreview=document.querySelector(\"#compressedImgPreview\")\n//创建reader对象\nconst reader=new FileReader()\n\nlet imgFile=null\nlet quality=90\nlet compressedImgSrc=\"\"\n\n//构建IMG_TYPES表\nconst IMG_TYPES={\n    \"image/jpeg\":\"image/jepg\",\n    \"image/png\":\"image/png\",\n    \"image/gif\":\"image/gif\",\n    \"image/jpg\":\"image/jpg\"\n}\n\nfunction init (){\n    bindEvent()\n}\n//构建绑定事件函数\nfunction bindEvent(){\n    oImageFileSelector.addEventListener(\"change\",handleFileSelectorChange,false)\n}\n\nfunction handleFileSelectorChange(e){\n    console.log(1)\n    imgFile=e.target.files[0]\n    console.log(imgFile)\n    //判断imgFile是否存在并且imgFile的类型是否为IMG_TYPES表中的类型\n    if(!imgFile || !IMG_TYPES[imgFile.type] ){\n        alert(\"请选择正确格式的图片\")\n        setImgFileEmpty()\n        return\n    }\n    setImgPreview(imgFile)\n\n}\n\n//初始化imgFile\nfunction setImgFileEmpty(){\n    oImageFileSelector.value=\"\"\n    imgFile=null\n    setPreviewVisible(oOriginImgPreview,false)\n    setPreviewVisible(oCompressedImgPreview,false)\n}\n\nfunction setImgPreview(imgFile){\n    if( imgFile instanceof File){\n        reader.onload=async ()=>{\n            const originImgSrc=reader.result\n            \n            const compressedImgSrc=await createCompressedImage({\n                imgSrc:originImgSrc,\n                type:imgFile.type\n            })\n            console.log(compressedImgSrc)\n            \n            console.log(\"未压缩\",originImgSrc.length)\n            console.log(\"压缩后\",compressedImgSrc.length)\n            oOriginImgPreview.src=originImgSrc\n            setPreviewVisible(oOriginImgPreview,true)\n            oCompressedImgPreview.src=compressedImgSrc\n            setPreviewVisible(oCompressedImgPreview,true)\n        }\n\n        reader.readAsDataURL(imgFile)\n    }\n}\n\nfunction createCompressedImage ({\n    imgSrc,\n    type\n}){\n    const oCan=document.createElement(\"canvas\")\n    const oImg=document.createElement(\"img\")\n    const context=oCan.getContext(\"2d\")\n\n    oImg.src=imgSrc\n    //因为通过onload事件触发回调函数，所以需要Promise的resolve回调传回值并接收\n    return new Promise((resolve)=>{\n        oImg.onload=()=>{\n            const imageWidth=oImg.width\n            const imageHeight=oImg.height\n    \n            oCan.width=imageWidth\n            oCan.height=imageHeight\n            \n            //利用canvas的drawImage函数去画出源图像\n            context.drawImage(oImg,0,0,imageWidth,imageHeight)\n            \n            const compressedImgSrc = doCompress(oCan, type, imgSrc)\n            resolve(compressedImgSrc)\n        }\n    })\n}\n\n//创建递归函数，如果压缩的文件大小大于源文件就继续压缩\nfunction doCompress (canvas,type,imgSrc){\n    compressedImgSrc=canvas.toDataURL(type,quality/100)\n\n    if(compressedImgSrc.length >=imgSrc.length && quality>10){\n        quality-=10\n        doCompress(canvas,type,imgSrc)\n    }\n    return compressedImgSrc\n}\n\n//是否显示img元素\nfunction setPreviewVisible (node,visible){\n    switch(visible){\n        case true:\n            node.classList.remove(\"hide\")\n            node.classList.add(\"show\")\n            break\n        case false:\n            node.classList.remove(\"show\")\n            node.classList.add(\"hide\")\n            break\n        default:\n            break\n    }\n}\n\ninit()\n\n```\n\n需要注意的是，我们是通过oImg.onload来执行压缩代码的，所以我们需要用Promise的resolve回调来传出值，通过async、await来接收值。\n","source":"_posts/JS如何实现图片压缩.md","raw":"---\ntitle: JS如何实现图片压缩\ndate: 2023/05/20/ 21:59\ntag: \n - JavaScript\ncategory:\n - 前端\n---\n\n\n## 前言\n\n<img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a82edb207c814cd09c2c6b0627829478~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\">\n关于图片压缩这一般都是由后端来完成~，但是前端掌握这项技能也是必不可少的。\n\n## 图片压缩思路\n\n我们读取源图片之后，利用`canvas`画板画出源图片，然后利用`toDataURL`这个API转换成`base64`的格式\n\n需要FileReade这个对象去reader图片，并且利用reader.onload这个监听事件完成图片压缩。\n\n## 源码\n\n### index.html文件\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Document</title>\n    <style>\n        .hide{\n            display: none;\n        }\n        .show{\n            display: initial;\n        }\n        .img-preview{\n            width: 300px;\n        }\n    </style>\n</head>\n<body>\n    <p>\n        <input type=\"file\"  id=\"imgFileSelector\" value=\"请选择图片\">  \n    </p> \n    <p>\n        <img id=\"originImgPreview\" class=\"img-preview  hide\">\n    </p>\n    <p>\n        <img id=\"compressedImgPreview\" class=\"img-preview hide\">\n    </p>\n\n    <script src=\"./index.js\" type=\"module\" ></script>\n</body>\n</html>\n```\n\n因为img元素既不是`块级元素`也不是`行内级元素`，所以添加类`.show`时需要设置为`display:initial`。\n\n### index.js文件\n\n```js\n//获取HTML元素\nconst oImageFileSelector=document.querySelector(\"#imgFileSelector\")\nconst oOriginImgPreview=document.querySelector(\"#originImgPreview\")\nconst oCompressedImgPreview=document.querySelector(\"#compressedImgPreview\")\n//创建reader对象\nconst reader=new FileReader()\n\nlet imgFile=null\nlet quality=90\nlet compressedImgSrc=\"\"\n\n//构建IMG_TYPES表\nconst IMG_TYPES={\n    \"image/jpeg\":\"image/jepg\",\n    \"image/png\":\"image/png\",\n    \"image/gif\":\"image/gif\",\n    \"image/jpg\":\"image/jpg\"\n}\n\nfunction init (){\n    bindEvent()\n}\n//构建绑定事件函数\nfunction bindEvent(){\n    oImageFileSelector.addEventListener(\"change\",handleFileSelectorChange,false)\n}\n\nfunction handleFileSelectorChange(e){\n    console.log(1)\n    imgFile=e.target.files[0]\n    console.log(imgFile)\n    //判断imgFile是否存在并且imgFile的类型是否为IMG_TYPES表中的类型\n    if(!imgFile || !IMG_TYPES[imgFile.type] ){\n        alert(\"请选择正确格式的图片\")\n        setImgFileEmpty()\n        return\n    }\n    setImgPreview(imgFile)\n\n}\n\n//初始化imgFile\nfunction setImgFileEmpty(){\n    oImageFileSelector.value=\"\"\n    imgFile=null\n    setPreviewVisible(oOriginImgPreview,false)\n    setPreviewVisible(oCompressedImgPreview,false)\n}\n\nfunction setImgPreview(imgFile){\n    if( imgFile instanceof File){\n        reader.onload=async ()=>{\n            const originImgSrc=reader.result\n            \n            const compressedImgSrc=await createCompressedImage({\n                imgSrc:originImgSrc,\n                type:imgFile.type\n            })\n            console.log(compressedImgSrc)\n            \n            console.log(\"未压缩\",originImgSrc.length)\n            console.log(\"压缩后\",compressedImgSrc.length)\n            oOriginImgPreview.src=originImgSrc\n            setPreviewVisible(oOriginImgPreview,true)\n            oCompressedImgPreview.src=compressedImgSrc\n            setPreviewVisible(oCompressedImgPreview,true)\n        }\n\n        reader.readAsDataURL(imgFile)\n    }\n}\n\nfunction createCompressedImage ({\n    imgSrc,\n    type\n}){\n    const oCan=document.createElement(\"canvas\")\n    const oImg=document.createElement(\"img\")\n    const context=oCan.getContext(\"2d\")\n\n    oImg.src=imgSrc\n    //因为通过onload事件触发回调函数，所以需要Promise的resolve回调传回值并接收\n    return new Promise((resolve)=>{\n        oImg.onload=()=>{\n            const imageWidth=oImg.width\n            const imageHeight=oImg.height\n    \n            oCan.width=imageWidth\n            oCan.height=imageHeight\n            \n            //利用canvas的drawImage函数去画出源图像\n            context.drawImage(oImg,0,0,imageWidth,imageHeight)\n            \n            const compressedImgSrc = doCompress(oCan, type, imgSrc)\n            resolve(compressedImgSrc)\n        }\n    })\n}\n\n//创建递归函数，如果压缩的文件大小大于源文件就继续压缩\nfunction doCompress (canvas,type,imgSrc){\n    compressedImgSrc=canvas.toDataURL(type,quality/100)\n\n    if(compressedImgSrc.length >=imgSrc.length && quality>10){\n        quality-=10\n        doCompress(canvas,type,imgSrc)\n    }\n    return compressedImgSrc\n}\n\n//是否显示img元素\nfunction setPreviewVisible (node,visible){\n    switch(visible){\n        case true:\n            node.classList.remove(\"hide\")\n            node.classList.add(\"show\")\n            break\n        case false:\n            node.classList.remove(\"show\")\n            node.classList.add(\"hide\")\n            break\n        default:\n            break\n    }\n}\n\ninit()\n\n```\n\n需要注意的是，我们是通过oImg.onload来执行压缩代码的，所以我们需要用Promise的resolve回调来传出值，通过async、await来接收值。\n","slug":"JS如何实现图片压缩","published":1,"updated":"2023-05-28T11:49:42.397Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ks800010svh3zhc36rg","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a82edb207c814cd09c2c6b0627829478~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\">\n关于图片压缩这一般都是由后端来完成~，但是前端掌握这项技能也是必不可少的。\n\n<h2 id=\"图片压缩思路\"><a href=\"#图片压缩思路\" class=\"headerlink\" title=\"图片压缩思路\"></a>图片压缩思路</h2><p>我们读取源图片之后，利用<code>canvas</code>画板画出源图片，然后利用<code>toDataURL</code>这个API转换成<code>base64</code>的格式</p>\n<p>需要FileReade这个对象去reader图片，并且利用reader.onload这个监听事件完成图片压缩。</p>\n<h2 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h2><h3 id=\"index-html文件\"><a href=\"#index-html文件\" class=\"headerlink\" title=\"index.html文件\"></a>index.html文件</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;en&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">&quot;X-UA-Compatible&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;viewport&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>Document<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-css\"></span></span><br><span class=\"line\"><span class=\"language-css\">        <span class=\"selector-class\">.hide</span>&#123;</span></span><br><span class=\"line\"><span class=\"language-css\">            <span class=\"attribute\">display</span>: none;</span></span><br><span class=\"line\"><span class=\"language-css\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-css\">        <span class=\"selector-class\">.show</span>&#123;</span></span><br><span class=\"line\"><span class=\"language-css\">            <span class=\"attribute\">display</span>: initial;</span></span><br><span class=\"line\"><span class=\"language-css\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-css\">        <span class=\"selector-class\">.img-preview</span>&#123;</span></span><br><span class=\"line\"><span class=\"language-css\">            <span class=\"attribute\">width</span>: <span class=\"number\">300px</span>;</span></span><br><span class=\"line\"><span class=\"language-css\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-css\">    </span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;file&quot;</span>  <span class=\"attr\">id</span>=<span class=\"string\">&quot;imgFileSelector&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;请选择图片&quot;</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;originImgPreview&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;img-preview  hide&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;compressedImgPreview&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;img-preview hide&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;./index.js&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;module&quot;</span> &gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>因为img元素既不是<code>块级元素</code>也不是<code>行内级元素</code>，所以添加类<code>.show</code>时需要设置为<code>display:initial</code>。</p>\n<h3 id=\"index-js文件\"><a href=\"#index-js文件\" class=\"headerlink\" title=\"index.js文件\"></a>index.js文件</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//获取HTML元素</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> oImageFileSelector=<span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&quot;#imgFileSelector&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> oOriginImgPreview=<span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&quot;#originImgPreview&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> oCompressedImgPreview=<span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&quot;#compressedImgPreview&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">//创建reader对象</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> reader=<span class=\"keyword\">new</span> <span class=\"title class_\">FileReader</span>()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> imgFile=<span class=\"literal\">null</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> quality=<span class=\"number\">90</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> compressedImgSrc=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//构建IMG_TYPES表</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">IMG_TYPES</span>=&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;image/jpeg&quot;</span>:<span class=\"string\">&quot;image/jepg&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;image/png&quot;</span>:<span class=\"string\">&quot;image/png&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;image/gif&quot;</span>:<span class=\"string\">&quot;image/gif&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;image/jpg&quot;</span>:<span class=\"string\">&quot;image/jpg&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">init</span> ()&#123;</span><br><span class=\"line\">    <span class=\"title function_\">bindEvent</span>()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//构建绑定事件函数</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">bindEvent</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    oImageFileSelector.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;change&quot;</span>,handleFileSelectorChange,<span class=\"literal\">false</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">handleFileSelectorChange</span>(<span class=\"params\">e</span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">    imgFile=e.<span class=\"property\">target</span>.<span class=\"property\">files</span>[<span class=\"number\">0</span>]</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(imgFile)</span><br><span class=\"line\">    <span class=\"comment\">//判断imgFile是否存在并且imgFile的类型是否为IMG_TYPES表中的类型</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!imgFile || !<span class=\"variable constant_\">IMG_TYPES</span>[imgFile.<span class=\"property\">type</span>] )&#123;</span><br><span class=\"line\">        <span class=\"title function_\">alert</span>(<span class=\"string\">&quot;请选择正确格式的图片&quot;</span>)</span><br><span class=\"line\">        <span class=\"title function_\">setImgFileEmpty</span>()</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">setImgPreview</span>(imgFile)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化imgFile</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">setImgFileEmpty</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    oImageFileSelector.<span class=\"property\">value</span>=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    imgFile=<span class=\"literal\">null</span></span><br><span class=\"line\">    <span class=\"title function_\">setPreviewVisible</span>(oOriginImgPreview,<span class=\"literal\">false</span>)</span><br><span class=\"line\">    <span class=\"title function_\">setPreviewVisible</span>(oCompressedImgPreview,<span class=\"literal\">false</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">setImgPreview</span>(<span class=\"params\">imgFile</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( imgFile <span class=\"keyword\">instanceof</span> <span class=\"title class_\">File</span>)&#123;</span><br><span class=\"line\">        reader.<span class=\"property\">onload</span>=<span class=\"keyword\">async</span> ()=&gt;&#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> originImgSrc=reader.<span class=\"property\">result</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">const</span> compressedImgSrc=<span class=\"keyword\">await</span> <span class=\"title function_\">createCompressedImage</span>(&#123;</span><br><span class=\"line\">                <span class=\"attr\">imgSrc</span>:originImgSrc,</span><br><span class=\"line\">                <span class=\"attr\">type</span>:imgFile.<span class=\"property\">type</span></span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(compressedImgSrc)</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;未压缩&quot;</span>,originImgSrc.<span class=\"property\">length</span>)</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;压缩后&quot;</span>,compressedImgSrc.<span class=\"property\">length</span>)</span><br><span class=\"line\">            oOriginImgPreview.<span class=\"property\">src</span>=originImgSrc</span><br><span class=\"line\">            <span class=\"title function_\">setPreviewVisible</span>(oOriginImgPreview,<span class=\"literal\">true</span>)</span><br><span class=\"line\">            oCompressedImgPreview.<span class=\"property\">src</span>=compressedImgSrc</span><br><span class=\"line\">            <span class=\"title function_\">setPreviewVisible</span>(oCompressedImgPreview,<span class=\"literal\">true</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        reader.<span class=\"title function_\">readAsDataURL</span>(imgFile)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">createCompressedImage</span> (&#123;</span><br><span class=\"line\">    imgSrc,</span><br><span class=\"line\">    type</span><br><span class=\"line\">&#125;)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> oCan=<span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&quot;canvas&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> oImg=<span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&quot;img&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> context=oCan.<span class=\"title function_\">getContext</span>(<span class=\"string\">&quot;2d&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    oImg.<span class=\"property\">src</span>=imgSrc</span><br><span class=\"line\">    <span class=\"comment\">//因为通过onload事件触发回调函数，所以需要Promise的resolve回调传回值并接收</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        oImg.<span class=\"property\">onload</span>=<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> imageWidth=oImg.<span class=\"property\">width</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> imageHeight=oImg.<span class=\"property\">height</span></span><br><span class=\"line\">    </span><br><span class=\"line\">            oCan.<span class=\"property\">width</span>=imageWidth</span><br><span class=\"line\">            oCan.<span class=\"property\">height</span>=imageHeight</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//利用canvas的drawImage函数去画出源图像</span></span><br><span class=\"line\">            context.<span class=\"title function_\">drawImage</span>(oImg,<span class=\"number\">0</span>,<span class=\"number\">0</span>,imageWidth,imageHeight)</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">const</span> compressedImgSrc = <span class=\"title function_\">doCompress</span>(oCan, type, imgSrc)</span><br><span class=\"line\">            <span class=\"title function_\">resolve</span>(compressedImgSrc)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//创建递归函数，如果压缩的文件大小大于源文件就继续压缩</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">doCompress</span> (canvas,type,imgSrc)&#123;</span><br><span class=\"line\">    compressedImgSrc=canvas.<span class=\"title function_\">toDataURL</span>(type,quality/<span class=\"number\">100</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(compressedImgSrc.<span class=\"property\">length</span> &gt;=imgSrc.<span class=\"property\">length</span> &amp;&amp; quality&gt;<span class=\"number\">10</span>)&#123;</span><br><span class=\"line\">        quality-=<span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"title function_\">doCompress</span>(canvas,type,imgSrc)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> compressedImgSrc</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//是否显示img元素</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">setPreviewVisible</span> (node,visible)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(visible)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"attr\">true</span>:</span><br><span class=\"line\">            node.<span class=\"property\">classList</span>.<span class=\"title function_\">remove</span>(<span class=\"string\">&quot;hide&quot;</span>)</span><br><span class=\"line\">            node.<span class=\"property\">classList</span>.<span class=\"title function_\">add</span>(<span class=\"string\">&quot;show&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"attr\">false</span>:</span><br><span class=\"line\">            node.<span class=\"property\">classList</span>.<span class=\"title function_\">remove</span>(<span class=\"string\">&quot;show&quot;</span>)</span><br><span class=\"line\">            node.<span class=\"property\">classList</span>.<span class=\"title function_\">add</span>(<span class=\"string\">&quot;hide&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"attr\">default</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">init</span>()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>需要注意的是，我们是通过oImg.onload来执行压缩代码的，所以我们需要用Promise的resolve回调来传出值，通过async、await来接收值。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a82edb207c814cd09c2c6b0627829478~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\">\n关于图片压缩这一般都是由后端来完成~，但是前端掌握这项技能也是必不可少的。\n\n<h2 id=\"图片压缩思路\"><a href=\"#图片压缩思路\" class=\"headerlink\" title=\"图片压缩思路\"></a>图片压缩思路</h2><p>我们读取源图片之后，利用<code>canvas</code>画板画出源图片，然后利用<code>toDataURL</code>这个API转换成<code>base64</code>的格式</p>\n<p>需要FileReade这个对象去reader图片，并且利用reader.onload这个监听事件完成图片压缩。</p>\n<h2 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h2><h3 id=\"index-html文件\"><a href=\"#index-html文件\" class=\"headerlink\" title=\"index.html文件\"></a>index.html文件</h3><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;en&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">charset</span>=<span class=\"string\">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">http-equiv</span>=<span class=\"string\">&quot;X-UA-Compatible&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;viewport&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>Document<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-css\"></span></span><br><span class=\"line\"><span class=\"language-css\">        <span class=\"selector-class\">.hide</span>&#123;</span></span><br><span class=\"line\"><span class=\"language-css\">            <span class=\"attribute\">display</span>: none;</span></span><br><span class=\"line\"><span class=\"language-css\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-css\">        <span class=\"selector-class\">.show</span>&#123;</span></span><br><span class=\"line\"><span class=\"language-css\">            <span class=\"attribute\">display</span>: initial;</span></span><br><span class=\"line\"><span class=\"language-css\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-css\">        <span class=\"selector-class\">.img-preview</span>&#123;</span></span><br><span class=\"line\"><span class=\"language-css\">            <span class=\"attribute\">width</span>: <span class=\"number\">300px</span>;</span></span><br><span class=\"line\"><span class=\"language-css\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-css\">    </span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;file&quot;</span>  <span class=\"attr\">id</span>=<span class=\"string\">&quot;imgFileSelector&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;请选择图片&quot;</span>&gt;</span>  </span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span> </span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;originImgPreview&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;img-preview  hide&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;compressedImgPreview&quot;</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;img-preview hide&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">p</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;./index.js&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;module&quot;</span> &gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>因为img元素既不是<code>块级元素</code>也不是<code>行内级元素</code>，所以添加类<code>.show</code>时需要设置为<code>display:initial</code>。</p>\n<h3 id=\"index-js文件\"><a href=\"#index-js文件\" class=\"headerlink\" title=\"index.js文件\"></a>index.js文件</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//获取HTML元素</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> oImageFileSelector=<span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&quot;#imgFileSelector&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> oOriginImgPreview=<span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&quot;#originImgPreview&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> oCompressedImgPreview=<span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&quot;#compressedImgPreview&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\">//创建reader对象</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> reader=<span class=\"keyword\">new</span> <span class=\"title class_\">FileReader</span>()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> imgFile=<span class=\"literal\">null</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> quality=<span class=\"number\">90</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> compressedImgSrc=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//构建IMG_TYPES表</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">IMG_TYPES</span>=&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;image/jpeg&quot;</span>:<span class=\"string\">&quot;image/jepg&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;image/png&quot;</span>:<span class=\"string\">&quot;image/png&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;image/gif&quot;</span>:<span class=\"string\">&quot;image/gif&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;image/jpg&quot;</span>:<span class=\"string\">&quot;image/jpg&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">init</span> ()&#123;</span><br><span class=\"line\">    <span class=\"title function_\">bindEvent</span>()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//构建绑定事件函数</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">bindEvent</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    oImageFileSelector.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;change&quot;</span>,handleFileSelectorChange,<span class=\"literal\">false</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">handleFileSelectorChange</span>(<span class=\"params\">e</span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">    imgFile=e.<span class=\"property\">target</span>.<span class=\"property\">files</span>[<span class=\"number\">0</span>]</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(imgFile)</span><br><span class=\"line\">    <span class=\"comment\">//判断imgFile是否存在并且imgFile的类型是否为IMG_TYPES表中的类型</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!imgFile || !<span class=\"variable constant_\">IMG_TYPES</span>[imgFile.<span class=\"property\">type</span>] )&#123;</span><br><span class=\"line\">        <span class=\"title function_\">alert</span>(<span class=\"string\">&quot;请选择正确格式的图片&quot;</span>)</span><br><span class=\"line\">        <span class=\"title function_\">setImgFileEmpty</span>()</span><br><span class=\"line\">        <span class=\"keyword\">return</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">setImgPreview</span>(imgFile)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//初始化imgFile</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">setImgFileEmpty</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    oImageFileSelector.<span class=\"property\">value</span>=<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    imgFile=<span class=\"literal\">null</span></span><br><span class=\"line\">    <span class=\"title function_\">setPreviewVisible</span>(oOriginImgPreview,<span class=\"literal\">false</span>)</span><br><span class=\"line\">    <span class=\"title function_\">setPreviewVisible</span>(oCompressedImgPreview,<span class=\"literal\">false</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">setImgPreview</span>(<span class=\"params\">imgFile</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>( imgFile <span class=\"keyword\">instanceof</span> <span class=\"title class_\">File</span>)&#123;</span><br><span class=\"line\">        reader.<span class=\"property\">onload</span>=<span class=\"keyword\">async</span> ()=&gt;&#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> originImgSrc=reader.<span class=\"property\">result</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">const</span> compressedImgSrc=<span class=\"keyword\">await</span> <span class=\"title function_\">createCompressedImage</span>(&#123;</span><br><span class=\"line\">                <span class=\"attr\">imgSrc</span>:originImgSrc,</span><br><span class=\"line\">                <span class=\"attr\">type</span>:imgFile.<span class=\"property\">type</span></span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(compressedImgSrc)</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;未压缩&quot;</span>,originImgSrc.<span class=\"property\">length</span>)</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;压缩后&quot;</span>,compressedImgSrc.<span class=\"property\">length</span>)</span><br><span class=\"line\">            oOriginImgPreview.<span class=\"property\">src</span>=originImgSrc</span><br><span class=\"line\">            <span class=\"title function_\">setPreviewVisible</span>(oOriginImgPreview,<span class=\"literal\">true</span>)</span><br><span class=\"line\">            oCompressedImgPreview.<span class=\"property\">src</span>=compressedImgSrc</span><br><span class=\"line\">            <span class=\"title function_\">setPreviewVisible</span>(oCompressedImgPreview,<span class=\"literal\">true</span>)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        reader.<span class=\"title function_\">readAsDataURL</span>(imgFile)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">createCompressedImage</span> (&#123;</span><br><span class=\"line\">    imgSrc,</span><br><span class=\"line\">    type</span><br><span class=\"line\">&#125;)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> oCan=<span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&quot;canvas&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> oImg=<span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&quot;img&quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> context=oCan.<span class=\"title function_\">getContext</span>(<span class=\"string\">&quot;2d&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    oImg.<span class=\"property\">src</span>=imgSrc</span><br><span class=\"line\">    <span class=\"comment\">//因为通过onload事件触发回调函数，所以需要Promise的resolve回调传回值并接收</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        oImg.<span class=\"property\">onload</span>=<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> imageWidth=oImg.<span class=\"property\">width</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> imageHeight=oImg.<span class=\"property\">height</span></span><br><span class=\"line\">    </span><br><span class=\"line\">            oCan.<span class=\"property\">width</span>=imageWidth</span><br><span class=\"line\">            oCan.<span class=\"property\">height</span>=imageHeight</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"comment\">//利用canvas的drawImage函数去画出源图像</span></span><br><span class=\"line\">            context.<span class=\"title function_\">drawImage</span>(oImg,<span class=\"number\">0</span>,<span class=\"number\">0</span>,imageWidth,imageHeight)</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">const</span> compressedImgSrc = <span class=\"title function_\">doCompress</span>(oCan, type, imgSrc)</span><br><span class=\"line\">            <span class=\"title function_\">resolve</span>(compressedImgSrc)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//创建递归函数，如果压缩的文件大小大于源文件就继续压缩</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">doCompress</span> (canvas,type,imgSrc)&#123;</span><br><span class=\"line\">    compressedImgSrc=canvas.<span class=\"title function_\">toDataURL</span>(type,quality/<span class=\"number\">100</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(compressedImgSrc.<span class=\"property\">length</span> &gt;=imgSrc.<span class=\"property\">length</span> &amp;&amp; quality&gt;<span class=\"number\">10</span>)&#123;</span><br><span class=\"line\">        quality-=<span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"title function_\">doCompress</span>(canvas,type,imgSrc)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> compressedImgSrc</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//是否显示img元素</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">setPreviewVisible</span> (node,visible)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">switch</span>(visible)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"attr\">true</span>:</span><br><span class=\"line\">            node.<span class=\"property\">classList</span>.<span class=\"title function_\">remove</span>(<span class=\"string\">&quot;hide&quot;</span>)</span><br><span class=\"line\">            node.<span class=\"property\">classList</span>.<span class=\"title function_\">add</span>(<span class=\"string\">&quot;show&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"attr\">false</span>:</span><br><span class=\"line\">            node.<span class=\"property\">classList</span>.<span class=\"title function_\">remove</span>(<span class=\"string\">&quot;show&quot;</span>)</span><br><span class=\"line\">            node.<span class=\"property\">classList</span>.<span class=\"title function_\">add</span>(<span class=\"string\">&quot;hide&quot;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"attr\">default</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_\">init</span>()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>需要注意的是，我们是通过oImg.onload来执行压缩代码的，所以我们需要用Promise的resolve回调来传出值，通过async、await来接收值。</p>\n"},{"title":"CommonJS模块化引入的实质与使用","date":"2023-03-01T12:43:00.000Z","_content":"\n## 前言\n**在Javascript的ES6没有推出时，在社区中推出了很多模块化的规范，其中有AMD、CMD、CommonJS，如今AMD、CMD规范的使用已经很少了，CommonJS与ES6模块化的使用非常常见，那么CommonJS与ES6模块化的引用实质具体是什么呢？**\n\n## CommonJS的使用与实质\n**Node.js中使用的就是CommonJS的模块化规范，下面，我将以Node.js的代码，演示如何使用CommonJS**\n\n### CommonJS如何导出\n**CommonJS的导出方法主要有两种，一种为exports={}，另一种为module.exports={}**\n\n```js\nconst name=\"1in\"\n\n//可以直接对exports对象进行赋值\nexports.name=name\n```\n**以上使用exports对象直接导出，下面我们来看看用module.exports对象导出的方法**\n```js\nconst name=\"1in\"\n\nmodule.exports={\n    name:name\n}\n//也可以使用ES6中的对象简写方法\nmodule.exports={\n    name\n}\n//也可以直接对module.exports对象进行赋值\nmodule.exports.name=name\n```\n**根据上边的代码我们可以发现，为什么exports和module.exports的导出方法一模一样呢，那为什么还需要设置两种的导出方法。**\n\n**实际上，Node.js在底层实现中，有 module.exports=exports 这行代码，Node.js在模块间实际导出的是module.exports，而exports的对象引用是赋值给module.exports的**\n\n**所以，当我们用到module.exports导出时，不可以在用exports导出了，因为一旦使用module.exports={name:name} exports就不会将对象地址赋值给module.exports了。又因为module.exports才是真正导出的方法，所以，module.exports指向哪个地址，哪个地址的对象就会被导出**\n\n**那么为什么会有一个exports导出方法呢，实际上，Node.js是为了符合CommonJS的规范，设定了一个exports的导出方法。**\n\n### CommonJS的导入\n```js\n\nconst { name }=require(\"./demo.js\")\n\n```\n\n**当我们exports什么没有都没有导出时，exports就是一个空对象**\n\n```js\nexports={\n    \n}\n\nconsole.log(exports)\n```\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7af6aa3688e540c1900f7304859e3752~tplv-k3u1fbpfcp-watermark.image?)\n\n**所以每一个模块中都会有一个exports全局对象，默认为空对象，exports指向一个对象，就意味，Node.js在内存里开辟一个新的空间，这个空间就是exports和module.exports指向的空间，当给exports和module.exports对象赋值是，就相当于给这个开辟的空间赋值，所以，另一个的模块能够获取引入别的模块导出的值，就是因为require也指向这个空间，并从里边取值。**\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9909822cfcac45d3965a2c454e0658dc~tplv-k3u1fbpfcp-watermark.image?)\n\n\n**所以，当一个模块导出用exports或者module.exports导出后，设置一个定时器，更改name的值，会导致require接收到的值改变吗？**\n\n```js\n//demo1.js\n\nlet name='1in'\n\nexports.name=name\n\nsetTimeout(()=>{\n    name='1lin-----'\n},1000)\nconsole.log(name)\n```\n\n```\n//demo2.js\n\nconst {name} =require('./demo')\nsetTimeout(()=>{\n    console.log(\"两秒后重新读取\")\n    console.log(name)\n},2000)\n\nconsole.log(name)\n```\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2fc16c1aac94b35b0ba547aaa1f3cc1~tplv-k3u1fbpfcp-watermark.image?)\n**那么我们将name设置成一个对象导出呢?**\n\n```js\n//demo1.js\n\nlet name= {\n    name:'1in'\n}\n\nsetTimeout(()=>{\n    name.name='1lin-----'\n},1000)\n\nexports.name=name\n\nconsole.log(name)\n```\n\n```js\n//demo2.js\n\nlet {name} =require(\"./demo\")\n\nconsole.log(name.name)\n\nsetTimeout(()=>{\n    console.log(\"两秒后重新读取\")\n    console.log(name.name)\n},2000)\n```\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cce9e6f06d60486cb95969dac14e6a0c~tplv-k3u1fbpfcp-watermark.image?)\n\n**当我们导出的是一个对象时，导出后，可以利用地址找到这个对象并修改这个对象的属性，就导致了第二种结果，当导出的数据为基本数据类型时，我们没有对应的指针，就无法修改这个导出的值。**","source":"_posts/CommonJS模块化引入的实质与使用.md","raw":"---\ntitle: CommonJS模块化引入的实质与使用\ndate: 2023/03/01/ 20:43\ntag: Node.js\ncategory:\n - 后端\n---\n\n## 前言\n**在Javascript的ES6没有推出时，在社区中推出了很多模块化的规范，其中有AMD、CMD、CommonJS，如今AMD、CMD规范的使用已经很少了，CommonJS与ES6模块化的使用非常常见，那么CommonJS与ES6模块化的引用实质具体是什么呢？**\n\n## CommonJS的使用与实质\n**Node.js中使用的就是CommonJS的模块化规范，下面，我将以Node.js的代码，演示如何使用CommonJS**\n\n### CommonJS如何导出\n**CommonJS的导出方法主要有两种，一种为exports={}，另一种为module.exports={}**\n\n```js\nconst name=\"1in\"\n\n//可以直接对exports对象进行赋值\nexports.name=name\n```\n**以上使用exports对象直接导出，下面我们来看看用module.exports对象导出的方法**\n```js\nconst name=\"1in\"\n\nmodule.exports={\n    name:name\n}\n//也可以使用ES6中的对象简写方法\nmodule.exports={\n    name\n}\n//也可以直接对module.exports对象进行赋值\nmodule.exports.name=name\n```\n**根据上边的代码我们可以发现，为什么exports和module.exports的导出方法一模一样呢，那为什么还需要设置两种的导出方法。**\n\n**实际上，Node.js在底层实现中，有 module.exports=exports 这行代码，Node.js在模块间实际导出的是module.exports，而exports的对象引用是赋值给module.exports的**\n\n**所以，当我们用到module.exports导出时，不可以在用exports导出了，因为一旦使用module.exports={name:name} exports就不会将对象地址赋值给module.exports了。又因为module.exports才是真正导出的方法，所以，module.exports指向哪个地址，哪个地址的对象就会被导出**\n\n**那么为什么会有一个exports导出方法呢，实际上，Node.js是为了符合CommonJS的规范，设定了一个exports的导出方法。**\n\n### CommonJS的导入\n```js\n\nconst { name }=require(\"./demo.js\")\n\n```\n\n**当我们exports什么没有都没有导出时，exports就是一个空对象**\n\n```js\nexports={\n    \n}\n\nconsole.log(exports)\n```\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7af6aa3688e540c1900f7304859e3752~tplv-k3u1fbpfcp-watermark.image?)\n\n**所以每一个模块中都会有一个exports全局对象，默认为空对象，exports指向一个对象，就意味，Node.js在内存里开辟一个新的空间，这个空间就是exports和module.exports指向的空间，当给exports和module.exports对象赋值是，就相当于给这个开辟的空间赋值，所以，另一个的模块能够获取引入别的模块导出的值，就是因为require也指向这个空间，并从里边取值。**\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9909822cfcac45d3965a2c454e0658dc~tplv-k3u1fbpfcp-watermark.image?)\n\n\n**所以，当一个模块导出用exports或者module.exports导出后，设置一个定时器，更改name的值，会导致require接收到的值改变吗？**\n\n```js\n//demo1.js\n\nlet name='1in'\n\nexports.name=name\n\nsetTimeout(()=>{\n    name='1lin-----'\n},1000)\nconsole.log(name)\n```\n\n```\n//demo2.js\n\nconst {name} =require('./demo')\nsetTimeout(()=>{\n    console.log(\"两秒后重新读取\")\n    console.log(name)\n},2000)\n\nconsole.log(name)\n```\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2fc16c1aac94b35b0ba547aaa1f3cc1~tplv-k3u1fbpfcp-watermark.image?)\n**那么我们将name设置成一个对象导出呢?**\n\n```js\n//demo1.js\n\nlet name= {\n    name:'1in'\n}\n\nsetTimeout(()=>{\n    name.name='1lin-----'\n},1000)\n\nexports.name=name\n\nconsole.log(name)\n```\n\n```js\n//demo2.js\n\nlet {name} =require(\"./demo\")\n\nconsole.log(name.name)\n\nsetTimeout(()=>{\n    console.log(\"两秒后重新读取\")\n    console.log(name.name)\n},2000)\n```\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cce9e6f06d60486cb95969dac14e6a0c~tplv-k3u1fbpfcp-watermark.image?)\n\n**当我们导出的是一个对象时，导出后，可以利用地址找到这个对象并修改这个对象的属性，就导致了第二种结果，当导出的数据为基本数据类型时，我们没有对应的指针，就无法修改这个导出的值。**","slug":"CommonJS模块化引入的实质与使用","published":1,"updated":"2023-05-28T11:57:54.446Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksc00030svhcpkq04tm","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p><strong>在Javascript的ES6没有推出时，在社区中推出了很多模块化的规范，其中有AMD、CMD、CommonJS，如今AMD、CMD规范的使用已经很少了，CommonJS与ES6模块化的使用非常常见，那么CommonJS与ES6模块化的引用实质具体是什么呢？</strong></p>\n<h2 id=\"CommonJS的使用与实质\"><a href=\"#CommonJS的使用与实质\" class=\"headerlink\" title=\"CommonJS的使用与实质\"></a>CommonJS的使用与实质</h2><p><strong>Node.js中使用的就是CommonJS的模块化规范，下面，我将以Node.js的代码，演示如何使用CommonJS</strong></p>\n<h3 id=\"CommonJS如何导出\"><a href=\"#CommonJS如何导出\" class=\"headerlink\" title=\"CommonJS如何导出\"></a>CommonJS如何导出</h3><p><strong>CommonJS的导出方法主要有两种，一种为exports&#x3D;{}，另一种为module.exports&#x3D;{}</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> name=<span class=\"string\">&quot;1in&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//可以直接对exports对象进行赋值</span></span><br><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">name</span>=name</span><br></pre></td></tr></table></figure>\n<p><strong>以上使用exports对象直接导出，下面我们来看看用module.exports对象导出的方法</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> name=<span class=\"string\">&quot;1in&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span>=&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:name</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//也可以使用ES6中的对象简写方法</span></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span>=&#123;</span><br><span class=\"line\">    name</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//也可以直接对module.exports对象进行赋值</span></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span>.<span class=\"property\">name</span>=name</span><br></pre></td></tr></table></figure>\n<p><strong>根据上边的代码我们可以发现，为什么exports和module.exports的导出方法一模一样呢，那为什么还需要设置两种的导出方法。</strong></p>\n<p><strong>实际上，Node.js在底层实现中，有 module.exports&#x3D;exports 这行代码，Node.js在模块间实际导出的是module.exports，而exports的对象引用是赋值给module.exports的</strong></p>\n<p><strong>所以，当我们用到module.exports导出时，不可以在用exports导出了，因为一旦使用module.exports&#x3D;{name:name} exports就不会将对象地址赋值给module.exports了。又因为module.exports才是真正导出的方法，所以，module.exports指向哪个地址，哪个地址的对象就会被导出</strong></p>\n<p><strong>那么为什么会有一个exports导出方法呢，实际上，Node.js是为了符合CommonJS的规范，设定了一个exports的导出方法。</strong></p>\n<h3 id=\"CommonJS的导入\"><a href=\"#CommonJS的导入\" class=\"headerlink\" title=\"CommonJS的导入\"></a>CommonJS的导入</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; name &#125;=<span class=\"built_in\">require</span>(<span class=\"string\">&quot;./demo.js&quot;</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>当我们exports什么没有都没有导出时，exports就是一个空对象</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">exports</span>=&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"built_in\">exports</span>)</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7af6aa3688e540c1900f7304859e3752~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>所以每一个模块中都会有一个exports全局对象，默认为空对象，exports指向一个对象，就意味，Node.js在内存里开辟一个新的空间，这个空间就是exports和module.exports指向的空间，当给exports和module.exports对象赋值是，就相当于给这个开辟的空间赋值，所以，另一个的模块能够获取引入别的模块导出的值，就是因为require也指向这个空间，并从里边取值。</strong></p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9909822cfcac45d3965a2c454e0658dc~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>所以，当一个模块导出用exports或者module.exports导出后，设置一个定时器，更改name的值，会导致require接收到的值改变吗？</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//demo1.js</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> name=<span class=\"string\">&#x27;1in&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">name</span>=name</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    name=<span class=\"string\">&#x27;1lin-----&#x27;</span></span><br><span class=\"line\">&#125;,<span class=\"number\">1000</span>)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//demo2.js</span><br><span class=\"line\"></span><br><span class=\"line\">const &#123;name&#125; =require(&#x27;./demo&#x27;)</span><br><span class=\"line\">setTimeout(()=&gt;&#123;</span><br><span class=\"line\">    console.log(&quot;两秒后重新读取&quot;)</span><br><span class=\"line\">    console.log(name)</span><br><span class=\"line\">&#125;,2000)</span><br><span class=\"line\"></span><br><span class=\"line\">console.log(name)</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2fc16c1aac94b35b0ba547aaa1f3cc1~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>那么我们将name设置成一个对象导出呢?</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//demo1.js</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> name= &#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&#x27;1in&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    name.<span class=\"property\">name</span>=<span class=\"string\">&#x27;1lin-----&#x27;</span></span><br><span class=\"line\">&#125;,<span class=\"number\">1000</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">name</span>=name</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//demo2.js</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> &#123;name&#125; =<span class=\"built_in\">require</span>(<span class=\"string\">&quot;./demo&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name.<span class=\"property\">name</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;两秒后重新读取&quot;</span>)</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name.<span class=\"property\">name</span>)</span><br><span class=\"line\">&#125;,<span class=\"number\">2000</span>)</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cce9e6f06d60486cb95969dac14e6a0c~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>当我们导出的是一个对象时，导出后，可以利用地址找到这个对象并修改这个对象的属性，就导致了第二种结果，当导出的数据为基本数据类型时，我们没有对应的指针，就无法修改这个导出的值。</strong></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p><strong>在Javascript的ES6没有推出时，在社区中推出了很多模块化的规范，其中有AMD、CMD、CommonJS，如今AMD、CMD规范的使用已经很少了，CommonJS与ES6模块化的使用非常常见，那么CommonJS与ES6模块化的引用实质具体是什么呢？</strong></p>\n<h2 id=\"CommonJS的使用与实质\"><a href=\"#CommonJS的使用与实质\" class=\"headerlink\" title=\"CommonJS的使用与实质\"></a>CommonJS的使用与实质</h2><p><strong>Node.js中使用的就是CommonJS的模块化规范，下面，我将以Node.js的代码，演示如何使用CommonJS</strong></p>\n<h3 id=\"CommonJS如何导出\"><a href=\"#CommonJS如何导出\" class=\"headerlink\" title=\"CommonJS如何导出\"></a>CommonJS如何导出</h3><p><strong>CommonJS的导出方法主要有两种，一种为exports&#x3D;{}，另一种为module.exports&#x3D;{}</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> name=<span class=\"string\">&quot;1in&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//可以直接对exports对象进行赋值</span></span><br><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">name</span>=name</span><br></pre></td></tr></table></figure>\n<p><strong>以上使用exports对象直接导出，下面我们来看看用module.exports对象导出的方法</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> name=<span class=\"string\">&quot;1in&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span>=&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:name</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//也可以使用ES6中的对象简写方法</span></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span>=&#123;</span><br><span class=\"line\">    name</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//也可以直接对module.exports对象进行赋值</span></span><br><span class=\"line\"><span class=\"variable language_\">module</span>.<span class=\"property\">exports</span>.<span class=\"property\">name</span>=name</span><br></pre></td></tr></table></figure>\n<p><strong>根据上边的代码我们可以发现，为什么exports和module.exports的导出方法一模一样呢，那为什么还需要设置两种的导出方法。</strong></p>\n<p><strong>实际上，Node.js在底层实现中，有 module.exports&#x3D;exports 这行代码，Node.js在模块间实际导出的是module.exports，而exports的对象引用是赋值给module.exports的</strong></p>\n<p><strong>所以，当我们用到module.exports导出时，不可以在用exports导出了，因为一旦使用module.exports&#x3D;{name:name} exports就不会将对象地址赋值给module.exports了。又因为module.exports才是真正导出的方法，所以，module.exports指向哪个地址，哪个地址的对象就会被导出</strong></p>\n<p><strong>那么为什么会有一个exports导出方法呢，实际上，Node.js是为了符合CommonJS的规范，设定了一个exports的导出方法。</strong></p>\n<h3 id=\"CommonJS的导入\"><a href=\"#CommonJS的导入\" class=\"headerlink\" title=\"CommonJS的导入\"></a>CommonJS的导入</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123; name &#125;=<span class=\"built_in\">require</span>(<span class=\"string\">&quot;./demo.js&quot;</span>)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><strong>当我们exports什么没有都没有导出时，exports就是一个空对象</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">exports</span>=&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"built_in\">exports</span>)</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7af6aa3688e540c1900f7304859e3752~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>所以每一个模块中都会有一个exports全局对象，默认为空对象，exports指向一个对象，就意味，Node.js在内存里开辟一个新的空间，这个空间就是exports和module.exports指向的空间，当给exports和module.exports对象赋值是，就相当于给这个开辟的空间赋值，所以，另一个的模块能够获取引入别的模块导出的值，就是因为require也指向这个空间，并从里边取值。</strong></p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9909822cfcac45d3965a2c454e0658dc~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>所以，当一个模块导出用exports或者module.exports导出后，设置一个定时器，更改name的值，会导致require接收到的值改变吗？</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//demo1.js</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> name=<span class=\"string\">&#x27;1in&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">name</span>=name</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    name=<span class=\"string\">&#x27;1lin-----&#x27;</span></span><br><span class=\"line\">&#125;,<span class=\"number\">1000</span>)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//demo2.js</span><br><span class=\"line\"></span><br><span class=\"line\">const &#123;name&#125; =require(&#x27;./demo&#x27;)</span><br><span class=\"line\">setTimeout(()=&gt;&#123;</span><br><span class=\"line\">    console.log(&quot;两秒后重新读取&quot;)</span><br><span class=\"line\">    console.log(name)</span><br><span class=\"line\">&#125;,2000)</span><br><span class=\"line\"></span><br><span class=\"line\">console.log(name)</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2fc16c1aac94b35b0ba547aaa1f3cc1~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>那么我们将name设置成一个对象导出呢?</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//demo1.js</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> name= &#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&#x27;1in&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    name.<span class=\"property\">name</span>=<span class=\"string\">&#x27;1lin-----&#x27;</span></span><br><span class=\"line\">&#125;,<span class=\"number\">1000</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">name</span>=name</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//demo2.js</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> &#123;name&#125; =<span class=\"built_in\">require</span>(<span class=\"string\">&quot;./demo&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name.<span class=\"property\">name</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;两秒后重新读取&quot;</span>)</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name.<span class=\"property\">name</span>)</span><br><span class=\"line\">&#125;,<span class=\"number\">2000</span>)</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cce9e6f06d60486cb95969dac14e6a0c~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>当我们导出的是一个对象时，导出后，可以利用地址找到这个对象并修改这个对象的属性，就导致了第二种结果，当导出的数据为基本数据类型时，我们没有对应的指针，就无法修改这个导出的值。</strong></p>\n"},{"title":"Concurrency-封装并发请求","date":"2023-05-18T14:22:00.000Z","_content":"\n## Concurrency\n并发请求在平时做项目时经常出现，一般我们可以用Promise.all配合Promise.race可以解决这个问题，我们也可以自己封装一个class去解决这个并发请求。\n\n## 封装需求\n用class封装一个ConcurrencyRequest，将所有的请求task通过push函数添加至该class中的taskQueue，并且在new的同时，指定maxConcurrencyRequest，最后，我们可以使用ConcurrencyRequest.responses查看响应结果。\n\n## 目录结构\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/964ad603374842ce9383db13055d0ce7~tplv-k3u1fbpfcp-watermark.image?)\n\n### index.js\n因为自己模拟了9个请求，所以代码会有些长并且有很多重复~可以跳过重复，查看核心代码\n```js\nimport ConcurrencyRequest from \"./ConcurrencyRequest.js\";\n\nconst BASE_URL=\"http://localhost:5000/\"\n\nfunction getTest1(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test1').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest2(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test2').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest3(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test3').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest4(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test4').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest5(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test5').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest6(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test6').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest7(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test7').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest8(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test8').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest9(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test9').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nconst taskQueue=[\n    getTest1,\n    getTest2,\n    getTest3,\n    getTest4,\n    getTest5,\n    getTest6,\n    getTest7,\n    getTest8,\n    getTest9,\n]\n\nconst concurrencyRequest =new ConcurrencyRequest(\n    {\n        maxConcurrencyRequest:2\n    }\n)\nfor (let task of taskQueue){\n    concurrencyRequest.push(task);\n}\nconsole.log(concurrencyRequest.responses)\n```\n### ConcurrencyRequest.js\n```js\nexport default class ConcurrencyRequest{\n    constructor({\n        maxConcurrencyRequest\n    }){\n        //获取到传入的最大并发量\n        this.maxConcurrencyRequest=maxConcurrencyRequest;\n        //声明任务队列\n        this.taskQueue=[];\n        //声明最后获得的信息对象\n        this.responses={};\n\n        //因为在new ConcurrencyRequest后要push task才可以执行并发，所以把执行并发的时机放到push task之后\n        setTimeout(()=>{\n            this._doRequest();\n        },0)\n    }\n\n    push(task){\n        //将请求任务push到任务队列中\n        this.taskQueue.push(task);\n    }\n\n    _doRequest(){\n        //如果任务队列中没任务时，就不做请求，直接return\n        if(!this.taskQueue.length){\n            return\n        }\n        //获取最小值\n        const minConcurrencyRequest=getMinCount(\n            this.maxConcurrencyRequest,\n            this.taskQueue.length);\n        \n        for(let i=0;i<minConcurrencyRequest;i++){\n            const task=this.taskQueue.shift();\n            //因为我们需要保证同时最多只能有指定数请求所以我们在请求前需要-1\n            this.maxConcurrencyRequest--;\n            this._runTask(task);\n        }\n        \n\n    }\n\n    _runTask(task){\n        task().then((res)=>{\n            this.responses[task.name]={\n                result:res,\n                error:null\n            }\n        }).catch((error)=>{\n            this.responses[task.name]={\n                result:null,\n                error:error\n            }\n        }).finally(()=>{\n            //请求完成后+1\n            this.maxConcurrencyRequest++;\n            this._doRequest();\n        })\n    }\n\n}\n\nfunction getMinCount(count1,count2){\n    return Math.min(count1,count2)\n}\n```\n### server-index.js\n用express启动的服务器后台，模拟了九个接口，代码有重复，可以直接跳过~\n```js\nconst express =require(\"express\");\n\nconst app=express();\n\napp.all('*',(req,res,next)=>{\n    //设置请求头，解决跨域\n    res.header('Access-Control-Allow-Origin','*');\n    //允许get方法访问\n    res.header('Access-Control-Allow--Methods','GET');\n    next();\n})\n\napp.get('/test1',(req,res)=>{\n    res.send(\"test1\")\n})\n\napp.get('/test2',(req,res)=>{\n    res.send(\"test2\")\n})\n\napp.get('/test3',(req,res)=>{\n    res.send(\"test3\")\n})\n\napp.get('/test4',(req,res)=>{\n    res.send(\"test4\")\n})\n\napp.get('/test5',(req,res)=>{\n    res.send(\"test5\")\n})\n\napp.get('/test6',(req,res)=>{\n    res.send(\"test6\")\n})\n\napp.get('/test7',(req,res)=>{\n    res.send(\"test7\")\n})\n\napp.get('/test8',(req,res)=>{\n    res.send(\"test8\")\n})\n\napp.get('/test9',(req,res)=>{\n    res.send(\"test9\")\n})\n\n\n\n\n\napp.listen(5000,()=>{\n    console.log(\"服务器启动咯~\")\n})\n```\n### 执行结果\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc401529e5904f6f961294b2dd283909~tplv-k3u1fbpfcp-watermark.image?)\n\n## 总结\n1. 首先需要注意我们并发执行的时机，因为需要所有的task push到taskQueue中才执行，所以我们需要将执行函数用setTimeout包裹（放入宏任务队列）。\n2. 因为同时只能请求我们指定的请求数，所以我们需要在每一次请求前将maxConcurrencyRequest-1，当请求完成时+1。\n","source":"_posts/Concurrency-封装并发请求.md","raw":"---\ntitle: Concurrency-封装并发请求\ndate: 2023/05/18/ 22:22\ntag: \n - JavaScript\n - 并发请求\ncategory:\n - 前端\n---\n\n## Concurrency\n并发请求在平时做项目时经常出现，一般我们可以用Promise.all配合Promise.race可以解决这个问题，我们也可以自己封装一个class去解决这个并发请求。\n\n## 封装需求\n用class封装一个ConcurrencyRequest，将所有的请求task通过push函数添加至该class中的taskQueue，并且在new的同时，指定maxConcurrencyRequest，最后，我们可以使用ConcurrencyRequest.responses查看响应结果。\n\n## 目录结构\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/964ad603374842ce9383db13055d0ce7~tplv-k3u1fbpfcp-watermark.image?)\n\n### index.js\n因为自己模拟了9个请求，所以代码会有些长并且有很多重复~可以跳过重复，查看核心代码\n```js\nimport ConcurrencyRequest from \"./ConcurrencyRequest.js\";\n\nconst BASE_URL=\"http://localhost:5000/\"\n\nfunction getTest1(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test1').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest2(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test2').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest3(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test3').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest4(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test4').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest5(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test5').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest6(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test6').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest7(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test7').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest8(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test8').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nfunction getTest9(){\n    return new Promise((resolve,reject)=>{\n        setTimeout(()=>{\n            axios.get(BASE_URL+'test9').then((res)=>{\n                resolve(res)\n            }).catch(err=>{\n                reject(err)\n            })\n        },2000)\n    })\n}\n\nconst taskQueue=[\n    getTest1,\n    getTest2,\n    getTest3,\n    getTest4,\n    getTest5,\n    getTest6,\n    getTest7,\n    getTest8,\n    getTest9,\n]\n\nconst concurrencyRequest =new ConcurrencyRequest(\n    {\n        maxConcurrencyRequest:2\n    }\n)\nfor (let task of taskQueue){\n    concurrencyRequest.push(task);\n}\nconsole.log(concurrencyRequest.responses)\n```\n### ConcurrencyRequest.js\n```js\nexport default class ConcurrencyRequest{\n    constructor({\n        maxConcurrencyRequest\n    }){\n        //获取到传入的最大并发量\n        this.maxConcurrencyRequest=maxConcurrencyRequest;\n        //声明任务队列\n        this.taskQueue=[];\n        //声明最后获得的信息对象\n        this.responses={};\n\n        //因为在new ConcurrencyRequest后要push task才可以执行并发，所以把执行并发的时机放到push task之后\n        setTimeout(()=>{\n            this._doRequest();\n        },0)\n    }\n\n    push(task){\n        //将请求任务push到任务队列中\n        this.taskQueue.push(task);\n    }\n\n    _doRequest(){\n        //如果任务队列中没任务时，就不做请求，直接return\n        if(!this.taskQueue.length){\n            return\n        }\n        //获取最小值\n        const minConcurrencyRequest=getMinCount(\n            this.maxConcurrencyRequest,\n            this.taskQueue.length);\n        \n        for(let i=0;i<minConcurrencyRequest;i++){\n            const task=this.taskQueue.shift();\n            //因为我们需要保证同时最多只能有指定数请求所以我们在请求前需要-1\n            this.maxConcurrencyRequest--;\n            this._runTask(task);\n        }\n        \n\n    }\n\n    _runTask(task){\n        task().then((res)=>{\n            this.responses[task.name]={\n                result:res,\n                error:null\n            }\n        }).catch((error)=>{\n            this.responses[task.name]={\n                result:null,\n                error:error\n            }\n        }).finally(()=>{\n            //请求完成后+1\n            this.maxConcurrencyRequest++;\n            this._doRequest();\n        })\n    }\n\n}\n\nfunction getMinCount(count1,count2){\n    return Math.min(count1,count2)\n}\n```\n### server-index.js\n用express启动的服务器后台，模拟了九个接口，代码有重复，可以直接跳过~\n```js\nconst express =require(\"express\");\n\nconst app=express();\n\napp.all('*',(req,res,next)=>{\n    //设置请求头，解决跨域\n    res.header('Access-Control-Allow-Origin','*');\n    //允许get方法访问\n    res.header('Access-Control-Allow--Methods','GET');\n    next();\n})\n\napp.get('/test1',(req,res)=>{\n    res.send(\"test1\")\n})\n\napp.get('/test2',(req,res)=>{\n    res.send(\"test2\")\n})\n\napp.get('/test3',(req,res)=>{\n    res.send(\"test3\")\n})\n\napp.get('/test4',(req,res)=>{\n    res.send(\"test4\")\n})\n\napp.get('/test5',(req,res)=>{\n    res.send(\"test5\")\n})\n\napp.get('/test6',(req,res)=>{\n    res.send(\"test6\")\n})\n\napp.get('/test7',(req,res)=>{\n    res.send(\"test7\")\n})\n\napp.get('/test8',(req,res)=>{\n    res.send(\"test8\")\n})\n\napp.get('/test9',(req,res)=>{\n    res.send(\"test9\")\n})\n\n\n\n\n\napp.listen(5000,()=>{\n    console.log(\"服务器启动咯~\")\n})\n```\n### 执行结果\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc401529e5904f6f961294b2dd283909~tplv-k3u1fbpfcp-watermark.image?)\n\n## 总结\n1. 首先需要注意我们并发执行的时机，因为需要所有的task push到taskQueue中才执行，所以我们需要将执行函数用setTimeout包裹（放入宏任务队列）。\n2. 因为同时只能请求我们指定的请求数，所以我们需要在每一次请求前将maxConcurrencyRequest-1，当请求完成时+1。\n","slug":"Concurrency-封装并发请求","published":1,"updated":"2023-05-28T11:48:56.581Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksg00060svhevfi0ivn","content":"<h2 id=\"Concurrency\"><a href=\"#Concurrency\" class=\"headerlink\" title=\"Concurrency\"></a>Concurrency</h2><p>并发请求在平时做项目时经常出现，一般我们可以用Promise.all配合Promise.race可以解决这个问题，我们也可以自己封装一个class去解决这个并发请求。</p>\n<h2 id=\"封装需求\"><a href=\"#封装需求\" class=\"headerlink\" title=\"封装需求\"></a>封装需求</h2><p>用class封装一个ConcurrencyRequest，将所有的请求task通过push函数添加至该class中的taskQueue，并且在new的同时，指定maxConcurrencyRequest，最后，我们可以使用ConcurrencyRequest.responses查看响应结果。</p>\n<h2 id=\"目录结构\"><a href=\"#目录结构\" class=\"headerlink\" title=\"目录结构\"></a>目录结构</h2><p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/964ad603374842ce9383db13055d0ce7~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"index-js\"><a href=\"#index-js\" class=\"headerlink\" title=\"index.js\"></a>index.js</h3><p>因为自己模拟了9个请求，所以代码会有些长并且有很多重复~可以跳过重复，查看核心代码</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"title class_\">ConcurrencyRequest</span> <span class=\"keyword\">from</span> <span class=\"string\">&quot;./ConcurrencyRequest.js&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">BASE_URL</span>=<span class=\"string\">&quot;http://localhost:5000/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest1</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test1&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest2</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test2&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest3</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test3&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest4</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test4&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest5</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test5&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest6</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test6&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest7</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test7&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest8</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test8&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest9</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test9&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> taskQueue=[</span><br><span class=\"line\">    getTest1,</span><br><span class=\"line\">    getTest2,</span><br><span class=\"line\">    getTest3,</span><br><span class=\"line\">    getTest4,</span><br><span class=\"line\">    getTest5,</span><br><span class=\"line\">    getTest6,</span><br><span class=\"line\">    getTest7,</span><br><span class=\"line\">    getTest8,</span><br><span class=\"line\">    getTest9,</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> concurrencyRequest =<span class=\"keyword\">new</span> <span class=\"title class_\">ConcurrencyRequest</span>(</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"attr\">maxConcurrencyRequest</span>:<span class=\"number\">2</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> task <span class=\"keyword\">of</span> taskQueue)&#123;</span><br><span class=\"line\">    concurrencyRequest.<span class=\"title function_\">push</span>(task);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(concurrencyRequest.<span class=\"property\">responses</span>)</span><br></pre></td></tr></table></figure>\n<h3 id=\"ConcurrencyRequest-js\"><a href=\"#ConcurrencyRequest-js\" class=\"headerlink\" title=\"ConcurrencyRequest.js\"></a>ConcurrencyRequest.js</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ConcurrencyRequest</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">&#123;</span></span><br><span class=\"line\"><span class=\"params\">        maxConcurrencyRequest</span></span><br><span class=\"line\"><span class=\"params\">    &#125;</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//获取到传入的最大并发量</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">maxConcurrencyRequest</span>=maxConcurrencyRequest;</span><br><span class=\"line\">        <span class=\"comment\">//声明任务队列</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>=[];</span><br><span class=\"line\">        <span class=\"comment\">//声明最后获得的信息对象</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">responses</span>=&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//因为在new ConcurrencyRequest后要push task才可以执行并发，所以把执行并发的时机放到push task之后</span></span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">_doRequest</span>();</span><br><span class=\"line\">        &#125;,<span class=\"number\">0</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">push</span>(<span class=\"params\">task</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//将请求任务push到任务队列中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>.<span class=\"title function_\">push</span>(task);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">_doRequest</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果任务队列中没任务时，就不做请求，直接return</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>.<span class=\"property\">length</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//获取最小值</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> minConcurrencyRequest=<span class=\"title function_\">getMinCount</span>(</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">maxConcurrencyRequest</span>,</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>.<span class=\"property\">length</span>);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">let</span> i=<span class=\"number\">0</span>;i&lt;minConcurrencyRequest;i++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> task=<span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>.<span class=\"title function_\">shift</span>();</span><br><span class=\"line\">            <span class=\"comment\">//因为我们需要保证同时最多只能有指定数请求所以我们在请求前需要-1</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">maxConcurrencyRequest</span>--;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">_runTask</span>(task);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">_runTask</span>(<span class=\"params\">task</span>)&#123;</span><br><span class=\"line\">        <span class=\"title function_\">task</span>().<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">responses</span>[task.<span class=\"property\">name</span>]=&#123;</span><br><span class=\"line\">                <span class=\"attr\">result</span>:res,</span><br><span class=\"line\">                <span class=\"attr\">error</span>:<span class=\"literal\">null</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\">(<span class=\"params\">error</span>)=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">responses</span>[task.<span class=\"property\">name</span>]=&#123;</span><br><span class=\"line\">                <span class=\"attr\">result</span>:<span class=\"literal\">null</span>,</span><br><span class=\"line\">                <span class=\"attr\">error</span>:error</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).<span class=\"title function_\">finally</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"comment\">//请求完成后+1</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">maxConcurrencyRequest</span>++;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">_doRequest</span>();</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getMinCount</span>(<span class=\"params\">count1,count2</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(count1,count2)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"server-index-js\"><a href=\"#server-index-js\" class=\"headerlink\" title=\"server-index.js\"></a>server-index.js</h3><p>用express启动的服务器后台，模拟了九个接口，代码有重复，可以直接跳过~</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> express =<span class=\"built_in\">require</span>(<span class=\"string\">&quot;express&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app=<span class=\"title function_\">express</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">all</span>(<span class=\"string\">&#x27;*&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res,next</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//设置请求头，解决跨域</span></span><br><span class=\"line\">    res.<span class=\"title function_\">header</span>(<span class=\"string\">&#x27;Access-Control-Allow-Origin&#x27;</span>,<span class=\"string\">&#x27;*&#x27;</span>);</span><br><span class=\"line\">    <span class=\"comment\">//允许get方法访问</span></span><br><span class=\"line\">    res.<span class=\"title function_\">header</span>(<span class=\"string\">&#x27;Access-Control-Allow--Methods&#x27;</span>,<span class=\"string\">&#x27;GET&#x27;</span>);</span><br><span class=\"line\">    <span class=\"title function_\">next</span>();</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test1&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test1&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test2&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test2&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test3&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test3&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test4&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test4&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test5&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test5&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test6&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test6&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test7&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test7&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test8&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test8&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test9&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test9&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">listen</span>(<span class=\"number\">5000</span>,<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;服务器启动咯~&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<h3 id=\"执行结果\"><a href=\"#执行结果\" class=\"headerlink\" title=\"执行结果\"></a>执行结果</h3><p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc401529e5904f6f961294b2dd283909~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>首先需要注意我们并发执行的时机，因为需要所有的task push到taskQueue中才执行，所以我们需要将执行函数用setTimeout包裹（放入宏任务队列）。</li>\n<li>因为同时只能请求我们指定的请求数，所以我们需要在每一次请求前将maxConcurrencyRequest-1，当请求完成时+1。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Concurrency\"><a href=\"#Concurrency\" class=\"headerlink\" title=\"Concurrency\"></a>Concurrency</h2><p>并发请求在平时做项目时经常出现，一般我们可以用Promise.all配合Promise.race可以解决这个问题，我们也可以自己封装一个class去解决这个并发请求。</p>\n<h2 id=\"封装需求\"><a href=\"#封装需求\" class=\"headerlink\" title=\"封装需求\"></a>封装需求</h2><p>用class封装一个ConcurrencyRequest，将所有的请求task通过push函数添加至该class中的taskQueue，并且在new的同时，指定maxConcurrencyRequest，最后，我们可以使用ConcurrencyRequest.responses查看响应结果。</p>\n<h2 id=\"目录结构\"><a href=\"#目录结构\" class=\"headerlink\" title=\"目录结构\"></a>目录结构</h2><p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/964ad603374842ce9383db13055d0ce7~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"index-js\"><a href=\"#index-js\" class=\"headerlink\" title=\"index.js\"></a>index.js</h3><p>因为自己模拟了9个请求，所以代码会有些长并且有很多重复~可以跳过重复，查看核心代码</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> <span class=\"title class_\">ConcurrencyRequest</span> <span class=\"keyword\">from</span> <span class=\"string\">&quot;./ConcurrencyRequest.js&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">BASE_URL</span>=<span class=\"string\">&quot;http://localhost:5000/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest1</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test1&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest2</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test2&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest3</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test3&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest4</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test4&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest5</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test5&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest6</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test6&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest7</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test7&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest8</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test8&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getTest9</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"function\">(<span class=\"params\">resolve,reject</span>)=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            axios.<span class=\"title function_\">get</span>(<span class=\"variable constant_\">BASE_URL</span>+<span class=\"string\">&#x27;test9&#x27;</span>).<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">resolve</span>(res)</span><br><span class=\"line\">            &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\"><span class=\"params\">err</span>=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"title function_\">reject</span>(err)</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;,<span class=\"number\">2000</span>)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> taskQueue=[</span><br><span class=\"line\">    getTest1,</span><br><span class=\"line\">    getTest2,</span><br><span class=\"line\">    getTest3,</span><br><span class=\"line\">    getTest4,</span><br><span class=\"line\">    getTest5,</span><br><span class=\"line\">    getTest6,</span><br><span class=\"line\">    getTest7,</span><br><span class=\"line\">    getTest8,</span><br><span class=\"line\">    getTest9,</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> concurrencyRequest =<span class=\"keyword\">new</span> <span class=\"title class_\">ConcurrencyRequest</span>(</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"attr\">maxConcurrencyRequest</span>:<span class=\"number\">2</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> task <span class=\"keyword\">of</span> taskQueue)&#123;</span><br><span class=\"line\">    concurrencyRequest.<span class=\"title function_\">push</span>(task);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(concurrencyRequest.<span class=\"property\">responses</span>)</span><br></pre></td></tr></table></figure>\n<h3 id=\"ConcurrencyRequest-js\"><a href=\"#ConcurrencyRequest-js\" class=\"headerlink\" title=\"ConcurrencyRequest.js\"></a>ConcurrencyRequest.js</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ConcurrencyRequest</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\">&#123;</span></span><br><span class=\"line\"><span class=\"params\">        maxConcurrencyRequest</span></span><br><span class=\"line\"><span class=\"params\">    &#125;</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//获取到传入的最大并发量</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">maxConcurrencyRequest</span>=maxConcurrencyRequest;</span><br><span class=\"line\">        <span class=\"comment\">//声明任务队列</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>=[];</span><br><span class=\"line\">        <span class=\"comment\">//声明最后获得的信息对象</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">responses</span>=&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//因为在new ConcurrencyRequest后要push task才可以执行并发，所以把执行并发的时机放到push task之后</span></span><br><span class=\"line\">        <span class=\"built_in\">setTimeout</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">_doRequest</span>();</span><br><span class=\"line\">        &#125;,<span class=\"number\">0</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">push</span>(<span class=\"params\">task</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//将请求任务push到任务队列中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>.<span class=\"title function_\">push</span>(task);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">_doRequest</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//如果任务队列中没任务时，就不做请求，直接return</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>.<span class=\"property\">length</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">//获取最小值</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> minConcurrencyRequest=<span class=\"title function_\">getMinCount</span>(</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">maxConcurrencyRequest</span>,</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>.<span class=\"property\">length</span>);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">let</span> i=<span class=\"number\">0</span>;i&lt;minConcurrencyRequest;i++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> task=<span class=\"variable language_\">this</span>.<span class=\"property\">taskQueue</span>.<span class=\"title function_\">shift</span>();</span><br><span class=\"line\">            <span class=\"comment\">//因为我们需要保证同时最多只能有指定数请求所以我们在请求前需要-1</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">maxConcurrencyRequest</span>--;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">_runTask</span>(task);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_\">_runTask</span>(<span class=\"params\">task</span>)&#123;</span><br><span class=\"line\">        <span class=\"title function_\">task</span>().<span class=\"title function_\">then</span>(<span class=\"function\">(<span class=\"params\">res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">responses</span>[task.<span class=\"property\">name</span>]=&#123;</span><br><span class=\"line\">                <span class=\"attr\">result</span>:res,</span><br><span class=\"line\">                <span class=\"attr\">error</span>:<span class=\"literal\">null</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).<span class=\"title function_\">catch</span>(<span class=\"function\">(<span class=\"params\">error</span>)=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">responses</span>[task.<span class=\"property\">name</span>]=&#123;</span><br><span class=\"line\">                <span class=\"attr\">result</span>:<span class=\"literal\">null</span>,</span><br><span class=\"line\">                <span class=\"attr\">error</span>:error</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;).<span class=\"title function_\">finally</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"comment\">//请求完成后+1</span></span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">maxConcurrencyRequest</span>++;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"title function_\">_doRequest</span>();</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getMinCount</span>(<span class=\"params\">count1,count2</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title class_\">Math</span>.<span class=\"title function_\">min</span>(count1,count2)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"server-index-js\"><a href=\"#server-index-js\" class=\"headerlink\" title=\"server-index.js\"></a>server-index.js</h3><p>用express启动的服务器后台，模拟了九个接口，代码有重复，可以直接跳过~</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> express =<span class=\"built_in\">require</span>(<span class=\"string\">&quot;express&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app=<span class=\"title function_\">express</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">all</span>(<span class=\"string\">&#x27;*&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res,next</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//设置请求头，解决跨域</span></span><br><span class=\"line\">    res.<span class=\"title function_\">header</span>(<span class=\"string\">&#x27;Access-Control-Allow-Origin&#x27;</span>,<span class=\"string\">&#x27;*&#x27;</span>);</span><br><span class=\"line\">    <span class=\"comment\">//允许get方法访问</span></span><br><span class=\"line\">    res.<span class=\"title function_\">header</span>(<span class=\"string\">&#x27;Access-Control-Allow--Methods&#x27;</span>,<span class=\"string\">&#x27;GET&#x27;</span>);</span><br><span class=\"line\">    <span class=\"title function_\">next</span>();</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test1&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test1&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test2&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test2&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test3&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test3&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test4&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test4&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test5&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test5&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test6&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test6&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test7&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test7&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test8&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test8&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/test9&#x27;</span>,<span class=\"function\">(<span class=\"params\">req,res</span>)=&gt;</span>&#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(<span class=\"string\">&quot;test9&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">listen</span>(<span class=\"number\">5000</span>,<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&quot;服务器启动咯~&quot;</span>)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<h3 id=\"执行结果\"><a href=\"#执行结果\" class=\"headerlink\" title=\"执行结果\"></a>执行结果</h3><p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dc401529e5904f6f961294b2dd283909~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>首先需要注意我们并发执行的时机，因为需要所有的task push到taskQueue中才执行，所以我们需要将执行函数用setTimeout包裹（放入宏任务队列）。</li>\n<li>因为同时只能请求我们指定的请求数，所以我们需要在每一次请求前将maxConcurrencyRequest-1，当请求完成时+1。</li>\n</ol>\n"},{"title":"JavaScript在浏览器中的事件循环","date":"2023-03-07T13:08:00.000Z","_content":"**由于Javascript是单线程执行，所以有同步和异步的概念，正因为有同步和异步的概念，所以需要单线程逐步执行同步和异步的事件。**\n\n**Javascript执行时，同步按顺序执行，遇到异步函数则会放到异步队列中等待执行，所以Javascript中的同步代码最优先执行。**\n\n\n![1678190653124.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31a201bb483b4d4ab01395443645b26e~tplv-k3u1fbpfcp-watermark.image?)\n\n**javascript每一次执行函数都是一个入栈和出栈的过程，执行时入栈，执行完出栈。**\n\n## 浏览器中的事件循环\n**在浏览器中，JavaScript的任务队列实际上分为宏任务和微任务队列，浏览器优先执行微任务，当微任务执行完时，才会执行宏任务，但每一次执行一个宏任务后，浏览器会查看微任务队列中是否存有未执行的任务，如果有，则会将微任务队列执行完，再去执行宏任务，反复如此，直至任务队列全部执行完成。**\n\n## 宏任务（MacroTask）\n**常见的宏任务有Event（监听事件）、setTimeout、setInterval、（ajax callback），在每一次执行完一个宏任务后，浏览器就会检查微任务队列是否有任务。也就是宏任务执行之前，必须保证微任务队列是空的；如果不为空，那么就先执行微任务队列中的任务（回调）。**\n\n## 微任务（MicroTask）\n**常见的微任务有Promise.then（）的回调、Mutation Observer API、queueMicrotask（），微任务优先执行。**\n\n## 举个🌰\n```js\nsetTimeout(function (){\n    console.log('set1');\n    new Promise(function (resolve){\n        resolve();\n    }).then(function (){\n        new Promise(function (resolve){\n            resolve();\n        }).then(function (){\n            console.log('then4');\n        });\n        console.log('then2');\n    });\n});\nnew Promise(function (resolve){\n    console.log('pr1');\n    resolve();\n}).then(function (){\n    console.log('then1');\n});\nsetTimeout(function (){\n    console.log('set2');\n});\nconsole.log(2);\nqueueMicrotask(()=>{\n    console.log('queueMicrotask1')\n});\nnew Promise(function (resolve){\n    resolve();\n}).then(function (){\n    console.log('then3');\n});\n```\n**根据浏览器事件循环的逻辑，以上代码的输出顺序是怎么样的呢？**\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89ffc12f09b0499785110a2c4ff03d2e~tplv-k3u1fbpfcp-watermark.image?)\n\n**首先，我们画一个宏任务队列（MacroTaskQueue）和一个微任务队列（MircroTaskQueue），根据上述的任务队列执行顺序可以推断出上述的结果。**\n**当我们遇到第一个setTimeout时，将它先放入宏任务队列，遇到Promise函数时，函数体内的函数照常同步执行，所以第一个输出\"pr1\",因为第一个Primose执行了resolve函数，所以resolve的回调需要执行，所以将第一个Promise.then的回调放入微任务队列，同样遇到第二个setTimeout时，直接放入宏任务队列，遇到console.log（2）时，直接执行，因为这是同步的，所以输出2，遇到queueMicrotask（）函数时，直接放入微任务队列，接下来遇到最后一个Promise函数，同样，将Promise.then的回调函数放入微任务队列中，随后我们看微任务队列，执行微任务队列里边的函数，首先输出\"then1\"(第一个Promise.then的回调输出)，然后执行queueMicrotask（）函数（输出\"queueMicrotask1\"），随后输出\"then3\"（第二个Promise.then的回调输出），这时微任务队列执行完成，开始执行宏任务队列，执行第一个setTimeout函数，输出\"set1\",同样遇到Promise.then的回调函数时，放入微任务队列，分别先后输出\"then2\"和\"then4\"，最后，执行最后一个setTimeout函数，输出\"set2\",到此，全部输出完毕。**\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ff5c6a4247c4d1ead61412814ba12ca~tplv-k3u1fbpfcp-watermark.image?)\n**如图，浏览器中的执行结果跟我们输出的结果一致。**\n\n## 结论\n1. 浏览器的任务队列分为微任务队列和宏任务队列\n2. 微任务队列优先于宏任务队列执行\n3. 在每一次执行完一个宏任务后，浏览器就会检查微任务队列是否有任务\n4. 宏任务执行之前，必须保证微任务队列是空的；如果不为空，那么就先执行微任务队列中的任务（回调）\n5. 常见的微任务有Promise.then（）的回调、Mutation Observer API、queueMicrotask（）\n6. 常见的宏任务有Event（监听事件）、setTimeout、setInterval、（ajax callback）\n","source":"_posts/JavaScript在浏览器中的事件循环.md","raw":"---\ntitle: JavaScript在浏览器中的事件循环\ndate: 2023/03/07/ 21:08\ntag: JavaScript\ncategory:\n - 前端\n---\n**由于Javascript是单线程执行，所以有同步和异步的概念，正因为有同步和异步的概念，所以需要单线程逐步执行同步和异步的事件。**\n\n**Javascript执行时，同步按顺序执行，遇到异步函数则会放到异步队列中等待执行，所以Javascript中的同步代码最优先执行。**\n\n\n![1678190653124.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31a201bb483b4d4ab01395443645b26e~tplv-k3u1fbpfcp-watermark.image?)\n\n**javascript每一次执行函数都是一个入栈和出栈的过程，执行时入栈，执行完出栈。**\n\n## 浏览器中的事件循环\n**在浏览器中，JavaScript的任务队列实际上分为宏任务和微任务队列，浏览器优先执行微任务，当微任务执行完时，才会执行宏任务，但每一次执行一个宏任务后，浏览器会查看微任务队列中是否存有未执行的任务，如果有，则会将微任务队列执行完，再去执行宏任务，反复如此，直至任务队列全部执行完成。**\n\n## 宏任务（MacroTask）\n**常见的宏任务有Event（监听事件）、setTimeout、setInterval、（ajax callback），在每一次执行完一个宏任务后，浏览器就会检查微任务队列是否有任务。也就是宏任务执行之前，必须保证微任务队列是空的；如果不为空，那么就先执行微任务队列中的任务（回调）。**\n\n## 微任务（MicroTask）\n**常见的微任务有Promise.then（）的回调、Mutation Observer API、queueMicrotask（），微任务优先执行。**\n\n## 举个🌰\n```js\nsetTimeout(function (){\n    console.log('set1');\n    new Promise(function (resolve){\n        resolve();\n    }).then(function (){\n        new Promise(function (resolve){\n            resolve();\n        }).then(function (){\n            console.log('then4');\n        });\n        console.log('then2');\n    });\n});\nnew Promise(function (resolve){\n    console.log('pr1');\n    resolve();\n}).then(function (){\n    console.log('then1');\n});\nsetTimeout(function (){\n    console.log('set2');\n});\nconsole.log(2);\nqueueMicrotask(()=>{\n    console.log('queueMicrotask1')\n});\nnew Promise(function (resolve){\n    resolve();\n}).then(function (){\n    console.log('then3');\n});\n```\n**根据浏览器事件循环的逻辑，以上代码的输出顺序是怎么样的呢？**\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89ffc12f09b0499785110a2c4ff03d2e~tplv-k3u1fbpfcp-watermark.image?)\n\n**首先，我们画一个宏任务队列（MacroTaskQueue）和一个微任务队列（MircroTaskQueue），根据上述的任务队列执行顺序可以推断出上述的结果。**\n**当我们遇到第一个setTimeout时，将它先放入宏任务队列，遇到Promise函数时，函数体内的函数照常同步执行，所以第一个输出\"pr1\",因为第一个Primose执行了resolve函数，所以resolve的回调需要执行，所以将第一个Promise.then的回调放入微任务队列，同样遇到第二个setTimeout时，直接放入宏任务队列，遇到console.log（2）时，直接执行，因为这是同步的，所以输出2，遇到queueMicrotask（）函数时，直接放入微任务队列，接下来遇到最后一个Promise函数，同样，将Promise.then的回调函数放入微任务队列中，随后我们看微任务队列，执行微任务队列里边的函数，首先输出\"then1\"(第一个Promise.then的回调输出)，然后执行queueMicrotask（）函数（输出\"queueMicrotask1\"），随后输出\"then3\"（第二个Promise.then的回调输出），这时微任务队列执行完成，开始执行宏任务队列，执行第一个setTimeout函数，输出\"set1\",同样遇到Promise.then的回调函数时，放入微任务队列，分别先后输出\"then2\"和\"then4\"，最后，执行最后一个setTimeout函数，输出\"set2\",到此，全部输出完毕。**\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ff5c6a4247c4d1ead61412814ba12ca~tplv-k3u1fbpfcp-watermark.image?)\n**如图，浏览器中的执行结果跟我们输出的结果一致。**\n\n## 结论\n1. 浏览器的任务队列分为微任务队列和宏任务队列\n2. 微任务队列优先于宏任务队列执行\n3. 在每一次执行完一个宏任务后，浏览器就会检查微任务队列是否有任务\n4. 宏任务执行之前，必须保证微任务队列是空的；如果不为空，那么就先执行微任务队列中的任务（回调）\n5. 常见的微任务有Promise.then（）的回调、Mutation Observer API、queueMicrotask（）\n6. 常见的宏任务有Event（监听事件）、setTimeout、setInterval、（ajax callback）\n","slug":"JavaScript在浏览器中的事件循环","published":1,"updated":"2023-05-28T11:40:05.565Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksh00070svhgytm0hzt","content":"<p><strong>由于Javascript是单线程执行，所以有同步和异步的概念，正因为有同步和异步的概念，所以需要单线程逐步执行同步和异步的事件。</strong></p>\n<p><strong>Javascript执行时，同步按顺序执行，遇到异步函数则会放到异步队列中等待执行，所以Javascript中的同步代码最优先执行。</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31a201bb483b4d4ab01395443645b26e~tplv-k3u1fbpfcp-watermark.image\" alt=\"1678190653124.png\"></p>\n<p><strong>javascript每一次执行函数都是一个入栈和出栈的过程，执行时入栈，执行完出栈。</strong></p>\n<h2 id=\"浏览器中的事件循环\"><a href=\"#浏览器中的事件循环\" class=\"headerlink\" title=\"浏览器中的事件循环\"></a>浏览器中的事件循环</h2><p><strong>在浏览器中，JavaScript的任务队列实际上分为宏任务和微任务队列，浏览器优先执行微任务，当微任务执行完时，才会执行宏任务，但每一次执行一个宏任务后，浏览器会查看微任务队列中是否存有未执行的任务，如果有，则会将微任务队列执行完，再去执行宏任务，反复如此，直至任务队列全部执行完成。</strong></p>\n<h2 id=\"宏任务（MacroTask）\"><a href=\"#宏任务（MacroTask）\" class=\"headerlink\" title=\"宏任务（MacroTask）\"></a>宏任务（MacroTask）</h2><p><strong>常见的宏任务有Event（监听事件）、setTimeout、setInterval、（ajax callback），在每一次执行完一个宏任务后，浏览器就会检查微任务队列是否有任务。也就是宏任务执行之前，必须保证微任务队列是空的；如果不为空，那么就先执行微任务队列中的任务（回调）。</strong></p>\n<h2 id=\"微任务（MicroTask）\"><a href=\"#微任务（MicroTask）\" class=\"headerlink\" title=\"微任务（MicroTask）\"></a>微任务（MicroTask）</h2><p><strong>常见的微任务有Promise.then（）的回调、Mutation Observer API、queueMicrotask（），微任务优先执行。</strong></p>\n<h2 id=\"举个🌰\"><a href=\"#举个🌰\" class=\"headerlink\" title=\"举个🌰\"></a>举个🌰</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;set1&#x27;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>)&#123;</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">    &#125;).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>)&#123;</span><br><span class=\"line\">            <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">        &#125;).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;then4&#x27;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;then2&#x27;</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;pr1&#x27;</span>);</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">&#125;).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;then1&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;set2&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\"><span class=\"title function_\">queueMicrotask</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;queueMicrotask1&#x27;</span>)</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">&#125;).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;then3&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p><strong>根据浏览器事件循环的逻辑，以上代码的输出顺序是怎么样的呢？</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89ffc12f09b0499785110a2c4ff03d2e~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>首先，我们画一个宏任务队列（MacroTaskQueue）和一个微任务队列（MircroTaskQueue），根据上述的任务队列执行顺序可以推断出上述的结果。</strong><br><strong>当我们遇到第一个setTimeout时，将它先放入宏任务队列，遇到Promise函数时，函数体内的函数照常同步执行，所以第一个输出”pr1”,因为第一个Primose执行了resolve函数，所以resolve的回调需要执行，所以将第一个Promise.then的回调放入微任务队列，同样遇到第二个setTimeout时，直接放入宏任务队列，遇到console.log（2）时，直接执行，因为这是同步的，所以输出2，遇到queueMicrotask（）函数时，直接放入微任务队列，接下来遇到最后一个Promise函数，同样，将Promise.then的回调函数放入微任务队列中，随后我们看微任务队列，执行微任务队列里边的函数，首先输出”then1”(第一个Promise.then的回调输出)，然后执行queueMicrotask（）函数（输出”queueMicrotask1”），随后输出”then3”（第二个Promise.then的回调输出），这时微任务队列执行完成，开始执行宏任务队列，执行第一个setTimeout函数，输出”set1”,同样遇到Promise.then的回调函数时，放入微任务队列，分别先后输出”then2”和”then4”，最后，执行最后一个setTimeout函数，输出”set2”,到此，全部输出完毕。</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ff5c6a4247c4d1ead61412814ba12ca~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>如图，浏览器中的执行结果跟我们输出的结果一致。</strong></p>\n<h2 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h2><ol>\n<li>浏览器的任务队列分为微任务队列和宏任务队列</li>\n<li>微任务队列优先于宏任务队列执行</li>\n<li>在每一次执行完一个宏任务后，浏览器就会检查微任务队列是否有任务</li>\n<li>宏任务执行之前，必须保证微任务队列是空的；如果不为空，那么就先执行微任务队列中的任务（回调）</li>\n<li>常见的微任务有Promise.then（）的回调、Mutation Observer API、queueMicrotask（）</li>\n<li>常见的宏任务有Event（监听事件）、setTimeout、setInterval、（ajax callback）</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p><strong>由于Javascript是单线程执行，所以有同步和异步的概念，正因为有同步和异步的概念，所以需要单线程逐步执行同步和异步的事件。</strong></p>\n<p><strong>Javascript执行时，同步按顺序执行，遇到异步函数则会放到异步队列中等待执行，所以Javascript中的同步代码最优先执行。</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31a201bb483b4d4ab01395443645b26e~tplv-k3u1fbpfcp-watermark.image\" alt=\"1678190653124.png\"></p>\n<p><strong>javascript每一次执行函数都是一个入栈和出栈的过程，执行时入栈，执行完出栈。</strong></p>\n<h2 id=\"浏览器中的事件循环\"><a href=\"#浏览器中的事件循环\" class=\"headerlink\" title=\"浏览器中的事件循环\"></a>浏览器中的事件循环</h2><p><strong>在浏览器中，JavaScript的任务队列实际上分为宏任务和微任务队列，浏览器优先执行微任务，当微任务执行完时，才会执行宏任务，但每一次执行一个宏任务后，浏览器会查看微任务队列中是否存有未执行的任务，如果有，则会将微任务队列执行完，再去执行宏任务，反复如此，直至任务队列全部执行完成。</strong></p>\n<h2 id=\"宏任务（MacroTask）\"><a href=\"#宏任务（MacroTask）\" class=\"headerlink\" title=\"宏任务（MacroTask）\"></a>宏任务（MacroTask）</h2><p><strong>常见的宏任务有Event（监听事件）、setTimeout、setInterval、（ajax callback），在每一次执行完一个宏任务后，浏览器就会检查微任务队列是否有任务。也就是宏任务执行之前，必须保证微任务队列是空的；如果不为空，那么就先执行微任务队列中的任务（回调）。</strong></p>\n<h2 id=\"微任务（MicroTask）\"><a href=\"#微任务（MicroTask）\" class=\"headerlink\" title=\"微任务（MicroTask）\"></a>微任务（MicroTask）</h2><p><strong>常见的微任务有Promise.then（）的回调、Mutation Observer API、queueMicrotask（），微任务优先执行。</strong></p>\n<h2 id=\"举个🌰\"><a href=\"#举个🌰\" class=\"headerlink\" title=\"举个🌰\"></a>举个🌰</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;set1&#x27;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>)&#123;</span><br><span class=\"line\">        <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">    &#125;).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>)&#123;</span><br><span class=\"line\">            <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">        &#125;).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;then4&#x27;</span>);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;then2&#x27;</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;pr1&#x27;</span>);</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">&#125;).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;then1&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;set2&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"number\">2</span>);</span><br><span class=\"line\"><span class=\"title function_\">queueMicrotask</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;queueMicrotask1&#x27;</span>)</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span>(<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">&#125;).<span class=\"title function_\">then</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;then3&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p><strong>根据浏览器事件循环的逻辑，以上代码的输出顺序是怎么样的呢？</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89ffc12f09b0499785110a2c4ff03d2e~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>首先，我们画一个宏任务队列（MacroTaskQueue）和一个微任务队列（MircroTaskQueue），根据上述的任务队列执行顺序可以推断出上述的结果。</strong><br><strong>当我们遇到第一个setTimeout时，将它先放入宏任务队列，遇到Promise函数时，函数体内的函数照常同步执行，所以第一个输出”pr1”,因为第一个Primose执行了resolve函数，所以resolve的回调需要执行，所以将第一个Promise.then的回调放入微任务队列，同样遇到第二个setTimeout时，直接放入宏任务队列，遇到console.log（2）时，直接执行，因为这是同步的，所以输出2，遇到queueMicrotask（）函数时，直接放入微任务队列，接下来遇到最后一个Promise函数，同样，将Promise.then的回调函数放入微任务队列中，随后我们看微任务队列，执行微任务队列里边的函数，首先输出”then1”(第一个Promise.then的回调输出)，然后执行queueMicrotask（）函数（输出”queueMicrotask1”），随后输出”then3”（第二个Promise.then的回调输出），这时微任务队列执行完成，开始执行宏任务队列，执行第一个setTimeout函数，输出”set1”,同样遇到Promise.then的回调函数时，放入微任务队列，分别先后输出”then2”和”then4”，最后，执行最后一个setTimeout函数，输出”set2”,到此，全部输出完毕。</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ff5c6a4247c4d1ead61412814ba12ca~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>如图，浏览器中的执行结果跟我们输出的结果一致。</strong></p>\n<h2 id=\"结论\"><a href=\"#结论\" class=\"headerlink\" title=\"结论\"></a>结论</h2><ol>\n<li>浏览器的任务队列分为微任务队列和宏任务队列</li>\n<li>微任务队列优先于宏任务队列执行</li>\n<li>在每一次执行完一个宏任务后，浏览器就会检查微任务队列是否有任务</li>\n<li>宏任务执行之前，必须保证微任务队列是空的；如果不为空，那么就先执行微任务队列中的任务（回调）</li>\n<li>常见的微任务有Promise.then（）的回调、Mutation Observer API、queueMicrotask（）</li>\n<li>常见的宏任务有Event（监听事件）、setTimeout、setInterval、（ajax callback）</li>\n</ol>\n"},{"title":"Node.JS中的事件循环 Event Loop","date":"2023-03-08T14:18:00.000Z","_content":"\n\n<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/262b606c572641ffbeaaf9014fab4276~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\n##  前言\n**JavaScript中的事件循环（Event loop）在浏览器中和Node.JS中是有一定的不同，浏览器中的事件循环可以参考这篇[（JavaScript在浏览器中的事件循环）](https://juejin.cn/post/7207743145998860325)，那么在Node.JS中的事件循环具体是什么呢？我总结了以下不同。**\n\n**Javascript执行时，同步按顺序执行，遇到异步函数则会放到异步队列中等待执行，所以Javascript中的同步代码最优先执行。在Node.JS中也是如此，所以同步函数永远优先执行。**\n\n**Node的事件循环更复杂，它也分为微任务和宏任务**\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9b481a3600c4e898e587cf13eadf284~tplv-k3u1fbpfcp-watermark.image?)\n\n## 宏任务（MacroTask）\n**在Node.js中，常见的宏任务事件循环有，setTimeout、setInterval、IO事件、setImmediate、close事件，但是，Node中的事件循环不止一个宏任务队列，它主要分为四种宏任务队列，并且宏任务队列也有优先级之分，四种队列按优先级排序，如下**\n\n1. timer queque：setTimeout、setInterval；\n2. poll queue：IO事件；\n3. check queue：setImmediate；\n4. close queue：close事件；\n\n## 微任务（MicroTask）\n**在Node.js中，常见的微任务事件循环有，Promise的then回调、process.nextTick、queueMicrotask，同样，Node中的事件循环不止一个微任务队列，它主要分为两种微任务队列，同样的，微任务队列也有优先级之分，两种队列按优先级排序，如下**\n\n1.next tick queue：process.nextTick；\n2.other queue：Promise的then回调、queueMicrotask；\n\n## 执行顺序\n**大局上的执行顺序与浏览器中的执行顺序相同，优先执行微任务，待微任务队列执行完成后，执行宏任务队列，只不过微任务队列与宏任务队列进行了细分以及优先级的细分。**\n\n**同样，当微任务执行完时，才会执行宏任务，但每一次执行一个宏任务后，浏览器会查看微任务队列中是否存有未执行的任务，如果有，则会将微任务队列执行完，再去执行宏任务，反复如此，直至任务队列全部执行完成。**\n\n## 举个🌰\n**根据上边的总结，判断以下代码的输出结果**\n\n```js\nasync function async1 () {\n    console. log('async1 end')\n    await async2()\n    console.log('async1 end')\n}\n\nasync function async2(){\n    console.log('async2')\n}\nconsole.log('script start')\n        \nsetTimeout (function () {\n    console.log('setTimeout2')\n},0)\nsetTimeout(function (){\n    console.log('setTimeout2')\n},300)\nsetImmediate ( () => console. log ('setImmediate'));\nprocess.nextTick(() => console. log('nextTick1'));\nasync1();\nprocess.nextTick(() => console. log ('nextTick2' ));\nnew Promise (function (resolve) {\n    console.log('promise1')\n    resolve();\n    console.log('promise2')\n}).then (function () {\n    console. log ('promise3')\n})\n\nconsole. log ('script end')\n```\n**在上边的代码中我们遇到了async、await函数，在async函数中，执行await函数的下一行代码，我们可以当成一个Promise.then的回调，将它放入微任务中的other队列，因为setTimeout2有300ms的延迟入列，所以优先于setImmediate输出。**\n\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/753a3f12ac674045b0d923950e11533f~tplv-k3u1fbpfcp-watermark.image?)\n\n**根据上述的总结，我们可以画出对应的队列一一入列，然后依照优先级依次执行，执行出的结果如图所示**\n\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/689e7b3051ba47f5b456c4617269f108~tplv-k3u1fbpfcp-watermark.image?)\n\n**可见，我们按照总结推断出的console.log与输出完全一致。**\n\n## 陷阱题目！\n**那么，我们接下来看一下这个代码**\n```js\nsetTimeout (function () {\n    console.log('setTimeout')\n},0)\nsetImmediate (\n    () => console. log ('setImmediate'));\n```\n**我们先执行一次看一下结果，想必大家已经有了结果。**\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/121a265a47e645bb879cfbc263480d65~tplv-k3u1fbpfcp-watermark.image?)\n**那我们再次执行，看看会有什么结果呢？**\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8eaa7c1728644dea9c38fed2e2da29d3~tplv-k3u1fbpfcp-watermark.image?)\n**为什么两次执行结果不一样呢？**\n\n**因为当Node.js开始初始化加载事件循环时，如果初始化过快，setTimeout（timer）没有加载到任务队列，就会先执行setImmediate，执行完后，发现有timer微任务，就会再执行timer微任务队列，当初始化的时间小于setTimeout（timer）加载到任务队列的时间时，当Node.js开始执行事件循环时，setTimeout（timer）就已经加载到timer微任务队列了，所以就会根据优先级执行，所以就会产生这两种不同的结果。**\n\n## 总结\n1. Node中的事件循环不止一个宏任务队列，它主要分为四种宏任务队列\n2. Node中的事件循环不止一个微任务队列，它主要分为两种微任务队列\n3. 常见的宏任务事件循环有，setTimeout、setInterval、IO事件、setImmediate、close事件\n4. 常见的微任务事件循环有，Promise的then回调、process.nextTick、queueMicrotask","source":"_posts/Node.JS中的事件循环 Event Loop.md","raw":"---\ntitle: Node.JS中的事件循环 Event Loop\ndate: 2023/03/08/ 22:18\ntag: Node.js\ncategory:\n - 后端\n---\n\n\n<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/262b606c572641ffbeaaf9014fab4276~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\n##  前言\n**JavaScript中的事件循环（Event loop）在浏览器中和Node.JS中是有一定的不同，浏览器中的事件循环可以参考这篇[（JavaScript在浏览器中的事件循环）](https://juejin.cn/post/7207743145998860325)，那么在Node.JS中的事件循环具体是什么呢？我总结了以下不同。**\n\n**Javascript执行时，同步按顺序执行，遇到异步函数则会放到异步队列中等待执行，所以Javascript中的同步代码最优先执行。在Node.JS中也是如此，所以同步函数永远优先执行。**\n\n**Node的事件循环更复杂，它也分为微任务和宏任务**\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9b481a3600c4e898e587cf13eadf284~tplv-k3u1fbpfcp-watermark.image?)\n\n## 宏任务（MacroTask）\n**在Node.js中，常见的宏任务事件循环有，setTimeout、setInterval、IO事件、setImmediate、close事件，但是，Node中的事件循环不止一个宏任务队列，它主要分为四种宏任务队列，并且宏任务队列也有优先级之分，四种队列按优先级排序，如下**\n\n1. timer queque：setTimeout、setInterval；\n2. poll queue：IO事件；\n3. check queue：setImmediate；\n4. close queue：close事件；\n\n## 微任务（MicroTask）\n**在Node.js中，常见的微任务事件循环有，Promise的then回调、process.nextTick、queueMicrotask，同样，Node中的事件循环不止一个微任务队列，它主要分为两种微任务队列，同样的，微任务队列也有优先级之分，两种队列按优先级排序，如下**\n\n1.next tick queue：process.nextTick；\n2.other queue：Promise的then回调、queueMicrotask；\n\n## 执行顺序\n**大局上的执行顺序与浏览器中的执行顺序相同，优先执行微任务，待微任务队列执行完成后，执行宏任务队列，只不过微任务队列与宏任务队列进行了细分以及优先级的细分。**\n\n**同样，当微任务执行完时，才会执行宏任务，但每一次执行一个宏任务后，浏览器会查看微任务队列中是否存有未执行的任务，如果有，则会将微任务队列执行完，再去执行宏任务，反复如此，直至任务队列全部执行完成。**\n\n## 举个🌰\n**根据上边的总结，判断以下代码的输出结果**\n\n```js\nasync function async1 () {\n    console. log('async1 end')\n    await async2()\n    console.log('async1 end')\n}\n\nasync function async2(){\n    console.log('async2')\n}\nconsole.log('script start')\n        \nsetTimeout (function () {\n    console.log('setTimeout2')\n},0)\nsetTimeout(function (){\n    console.log('setTimeout2')\n},300)\nsetImmediate ( () => console. log ('setImmediate'));\nprocess.nextTick(() => console. log('nextTick1'));\nasync1();\nprocess.nextTick(() => console. log ('nextTick2' ));\nnew Promise (function (resolve) {\n    console.log('promise1')\n    resolve();\n    console.log('promise2')\n}).then (function () {\n    console. log ('promise3')\n})\n\nconsole. log ('script end')\n```\n**在上边的代码中我们遇到了async、await函数，在async函数中，执行await函数的下一行代码，我们可以当成一个Promise.then的回调，将它放入微任务中的other队列，因为setTimeout2有300ms的延迟入列，所以优先于setImmediate输出。**\n\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/753a3f12ac674045b0d923950e11533f~tplv-k3u1fbpfcp-watermark.image?)\n\n**根据上述的总结，我们可以画出对应的队列一一入列，然后依照优先级依次执行，执行出的结果如图所示**\n\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/689e7b3051ba47f5b456c4617269f108~tplv-k3u1fbpfcp-watermark.image?)\n\n**可见，我们按照总结推断出的console.log与输出完全一致。**\n\n## 陷阱题目！\n**那么，我们接下来看一下这个代码**\n```js\nsetTimeout (function () {\n    console.log('setTimeout')\n},0)\nsetImmediate (\n    () => console. log ('setImmediate'));\n```\n**我们先执行一次看一下结果，想必大家已经有了结果。**\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/121a265a47e645bb879cfbc263480d65~tplv-k3u1fbpfcp-watermark.image?)\n**那我们再次执行，看看会有什么结果呢？**\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8eaa7c1728644dea9c38fed2e2da29d3~tplv-k3u1fbpfcp-watermark.image?)\n**为什么两次执行结果不一样呢？**\n\n**因为当Node.js开始初始化加载事件循环时，如果初始化过快，setTimeout（timer）没有加载到任务队列，就会先执行setImmediate，执行完后，发现有timer微任务，就会再执行timer微任务队列，当初始化的时间小于setTimeout（timer）加载到任务队列的时间时，当Node.js开始执行事件循环时，setTimeout（timer）就已经加载到timer微任务队列了，所以就会根据优先级执行，所以就会产生这两种不同的结果。**\n\n## 总结\n1. Node中的事件循环不止一个宏任务队列，它主要分为四种宏任务队列\n2. Node中的事件循环不止一个微任务队列，它主要分为两种微任务队列\n3. 常见的宏任务事件循环有，setTimeout、setInterval、IO事件、setImmediate、close事件\n4. 常见的微任务事件循环有，Promise的then回调、process.nextTick、queueMicrotask","slug":"Node.JS中的事件循环 Event Loop","published":1,"updated":"2023-05-28T11:57:16.531Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksi00080svheambc667","content":"<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/262b606c572641ffbeaaf9014fab4276~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p><strong>JavaScript中的事件循环（Event loop）在浏览器中和Node.JS中是有一定的不同，浏览器中的事件循环可以参考这篇<a href=\"https://juejin.cn/post/7207743145998860325\">（JavaScript在浏览器中的事件循环）</a>，那么在Node.JS中的事件循环具体是什么呢？我总结了以下不同。</strong></p>\n<p><strong>Javascript执行时，同步按顺序执行，遇到异步函数则会放到异步队列中等待执行，所以Javascript中的同步代码最优先执行。在Node.JS中也是如此，所以同步函数永远优先执行。</strong></p>\n<p><strong>Node的事件循环更复杂，它也分为微任务和宏任务</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9b481a3600c4e898e587cf13eadf284~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h2 id=\"宏任务（MacroTask）\"><a href=\"#宏任务（MacroTask）\" class=\"headerlink\" title=\"宏任务（MacroTask）\"></a>宏任务（MacroTask）</h2><p><strong>在Node.js中，常见的宏任务事件循环有，setTimeout、setInterval、IO事件、setImmediate、close事件，但是，Node中的事件循环不止一个宏任务队列，它主要分为四种宏任务队列，并且宏任务队列也有优先级之分，四种队列按优先级排序，如下</strong></p>\n<ol>\n<li>timer queque：setTimeout、setInterval；</li>\n<li>poll queue：IO事件；</li>\n<li>check queue：setImmediate；</li>\n<li>close queue：close事件；</li>\n</ol>\n<h2 id=\"微任务（MicroTask）\"><a href=\"#微任务（MicroTask）\" class=\"headerlink\" title=\"微任务（MicroTask）\"></a>微任务（MicroTask）</h2><p><strong>在Node.js中，常见的微任务事件循环有，Promise的then回调、process.nextTick、queueMicrotask，同样，Node中的事件循环不止一个微任务队列，它主要分为两种微任务队列，同样的，微任务队列也有优先级之分，两种队列按优先级排序，如下</strong></p>\n<p>1.next tick queue：process.nextTick；<br>2.other queue：Promise的then回调、queueMicrotask；</p>\n<h2 id=\"执行顺序\"><a href=\"#执行顺序\" class=\"headerlink\" title=\"执行顺序\"></a>执行顺序</h2><p><strong>大局上的执行顺序与浏览器中的执行顺序相同，优先执行微任务，待微任务队列执行完成后，执行宏任务队列，只不过微任务队列与宏任务队列进行了细分以及优先级的细分。</strong></p>\n<p><strong>同样，当微任务执行完时，才会执行宏任务，但每一次执行一个宏任务后，浏览器会查看微任务队列中是否存有未执行的任务，如果有，则会将微任务队列执行完，再去执行宏任务，反复如此，直至任务队列全部执行完成。</strong></p>\n<h2 id=\"举个🌰\"><a href=\"#举个🌰\" class=\"headerlink\" title=\"举个🌰\"></a>举个🌰</h2><p><strong>根据上边的总结，判断以下代码的输出结果</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">async1</span> () &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>. <span class=\"title function_\">log</span>(<span class=\"string\">&#x27;async1 end&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">await</span> <span class=\"title function_\">async2</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;async1 end&#x27;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">async2</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;async2&#x27;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;script start&#x27;</span>)</span><br><span class=\"line\">        </span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span> (<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;setTimeout2&#x27;</span>)</span><br><span class=\"line\">&#125;,<span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;setTimeout2&#x27;</span>)</span><br><span class=\"line\">&#125;,<span class=\"number\">300</span>)</span><br><span class=\"line\">setImmediate ( <span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;setImmediate&#x27;</span>));</span><br><span class=\"line\">process.<span class=\"title function_\">nextTick</span>(<span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>. <span class=\"title function_\">log</span>(<span class=\"string\">&#x27;nextTick1&#x27;</span>));</span><br><span class=\"line\"><span class=\"title function_\">async1</span>();</span><br><span class=\"line\">process.<span class=\"title function_\">nextTick</span>(<span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;nextTick2&#x27;</span> ));</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span> (<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;promise1&#x27;</span>)</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;promise2&#x27;</span>)</span><br><span class=\"line\">&#125;).<span class=\"property\">then</span> (<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;promise3&#x27;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;script end&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p><strong>在上边的代码中我们遇到了async、await函数，在async函数中，执行await函数的下一行代码，我们可以当成一个Promise.then的回调，将它放入微任务中的other队列，因为setTimeout2有300ms的延迟入列，所以优先于setImmediate输出。</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/753a3f12ac674045b0d923950e11533f~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>根据上述的总结，我们可以画出对应的队列一一入列，然后依照优先级依次执行，执行出的结果如图所示</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/689e7b3051ba47f5b456c4617269f108~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>可见，我们按照总结推断出的console.log与输出完全一致。</strong></p>\n<h2 id=\"陷阱题目！\"><a href=\"#陷阱题目！\" class=\"headerlink\" title=\"陷阱题目！\"></a>陷阱题目！</h2><p><strong>那么，我们接下来看一下这个代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">setTimeout</span> (<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;setTimeout&#x27;</span>)</span><br><span class=\"line\">&#125;,<span class=\"number\">0</span>)</span><br><span class=\"line\">setImmediate (</span><br><span class=\"line\">    <span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;setImmediate&#x27;</span>));</span><br></pre></td></tr></table></figure>\n<p><strong>我们先执行一次看一下结果，想必大家已经有了结果。</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/121a265a47e645bb879cfbc263480d65~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>那我们再次执行，看看会有什么结果呢？</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8eaa7c1728644dea9c38fed2e2da29d3~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>为什么两次执行结果不一样呢？</strong></p>\n<p><strong>因为当Node.js开始初始化加载事件循环时，如果初始化过快，setTimeout（timer）没有加载到任务队列，就会先执行setImmediate，执行完后，发现有timer微任务，就会再执行timer微任务队列，当初始化的时间小于setTimeout（timer）加载到任务队列的时间时，当Node.js开始执行事件循环时，setTimeout（timer）就已经加载到timer微任务队列了，所以就会根据优先级执行，所以就会产生这两种不同的结果。</strong></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>Node中的事件循环不止一个宏任务队列，它主要分为四种宏任务队列</li>\n<li>Node中的事件循环不止一个微任务队列，它主要分为两种微任务队列</li>\n<li>常见的宏任务事件循环有，setTimeout、setInterval、IO事件、setImmediate、close事件</li>\n<li>常见的微任务事件循环有，Promise的then回调、process.nextTick、queueMicrotask</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/262b606c572641ffbeaaf9014fab4276~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p><strong>JavaScript中的事件循环（Event loop）在浏览器中和Node.JS中是有一定的不同，浏览器中的事件循环可以参考这篇<a href=\"https://juejin.cn/post/7207743145998860325\">（JavaScript在浏览器中的事件循环）</a>，那么在Node.JS中的事件循环具体是什么呢？我总结了以下不同。</strong></p>\n<p><strong>Javascript执行时，同步按顺序执行，遇到异步函数则会放到异步队列中等待执行，所以Javascript中的同步代码最优先执行。在Node.JS中也是如此，所以同步函数永远优先执行。</strong></p>\n<p><strong>Node的事件循环更复杂，它也分为微任务和宏任务</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9b481a3600c4e898e587cf13eadf284~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h2 id=\"宏任务（MacroTask）\"><a href=\"#宏任务（MacroTask）\" class=\"headerlink\" title=\"宏任务（MacroTask）\"></a>宏任务（MacroTask）</h2><p><strong>在Node.js中，常见的宏任务事件循环有，setTimeout、setInterval、IO事件、setImmediate、close事件，但是，Node中的事件循环不止一个宏任务队列，它主要分为四种宏任务队列，并且宏任务队列也有优先级之分，四种队列按优先级排序，如下</strong></p>\n<ol>\n<li>timer queque：setTimeout、setInterval；</li>\n<li>poll queue：IO事件；</li>\n<li>check queue：setImmediate；</li>\n<li>close queue：close事件；</li>\n</ol>\n<h2 id=\"微任务（MicroTask）\"><a href=\"#微任务（MicroTask）\" class=\"headerlink\" title=\"微任务（MicroTask）\"></a>微任务（MicroTask）</h2><p><strong>在Node.js中，常见的微任务事件循环有，Promise的then回调、process.nextTick、queueMicrotask，同样，Node中的事件循环不止一个微任务队列，它主要分为两种微任务队列，同样的，微任务队列也有优先级之分，两种队列按优先级排序，如下</strong></p>\n<p>1.next tick queue：process.nextTick；<br>2.other queue：Promise的then回调、queueMicrotask；</p>\n<h2 id=\"执行顺序\"><a href=\"#执行顺序\" class=\"headerlink\" title=\"执行顺序\"></a>执行顺序</h2><p><strong>大局上的执行顺序与浏览器中的执行顺序相同，优先执行微任务，待微任务队列执行完成后，执行宏任务队列，只不过微任务队列与宏任务队列进行了细分以及优先级的细分。</strong></p>\n<p><strong>同样，当微任务执行完时，才会执行宏任务，但每一次执行一个宏任务后，浏览器会查看微任务队列中是否存有未执行的任务，如果有，则会将微任务队列执行完，再去执行宏任务，反复如此，直至任务队列全部执行完成。</strong></p>\n<h2 id=\"举个🌰\"><a href=\"#举个🌰\" class=\"headerlink\" title=\"举个🌰\"></a>举个🌰</h2><p><strong>根据上边的总结，判断以下代码的输出结果</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">async1</span> () &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>. <span class=\"title function_\">log</span>(<span class=\"string\">&#x27;async1 end&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">await</span> <span class=\"title function_\">async2</span>()</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;async1 end&#x27;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">async2</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;async2&#x27;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;script start&#x27;</span>)</span><br><span class=\"line\">        </span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span> (<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;setTimeout2&#x27;</span>)</span><br><span class=\"line\">&#125;,<span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"built_in\">setTimeout</span>(<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;setTimeout2&#x27;</span>)</span><br><span class=\"line\">&#125;,<span class=\"number\">300</span>)</span><br><span class=\"line\">setImmediate ( <span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;setImmediate&#x27;</span>));</span><br><span class=\"line\">process.<span class=\"title function_\">nextTick</span>(<span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>. <span class=\"title function_\">log</span>(<span class=\"string\">&#x27;nextTick1&#x27;</span>));</span><br><span class=\"line\"><span class=\"title function_\">async1</span>();</span><br><span class=\"line\">process.<span class=\"title function_\">nextTick</span>(<span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;nextTick2&#x27;</span> ));</span><br><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Promise</span> (<span class=\"keyword\">function</span> (<span class=\"params\">resolve</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;promise1&#x27;</span>)</span><br><span class=\"line\">    <span class=\"title function_\">resolve</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;promise2&#x27;</span>)</span><br><span class=\"line\">&#125;).<span class=\"property\">then</span> (<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;promise3&#x27;</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;script end&#x27;</span>)</span><br></pre></td></tr></table></figure>\n<p><strong>在上边的代码中我们遇到了async、await函数，在async函数中，执行await函数的下一行代码，我们可以当成一个Promise.then的回调，将它放入微任务中的other队列，因为setTimeout2有300ms的延迟入列，所以优先于setImmediate输出。</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/753a3f12ac674045b0d923950e11533f~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>根据上述的总结，我们可以画出对应的队列一一入列，然后依照优先级依次执行，执行出的结果如图所示</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/689e7b3051ba47f5b456c4617269f108~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p><strong>可见，我们按照总结推断出的console.log与输出完全一致。</strong></p>\n<h2 id=\"陷阱题目！\"><a href=\"#陷阱题目！\" class=\"headerlink\" title=\"陷阱题目！\"></a>陷阱题目！</h2><p><strong>那么，我们接下来看一下这个代码</strong></p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">setTimeout</span> (<span class=\"keyword\">function</span> (<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;setTimeout&#x27;</span>)</span><br><span class=\"line\">&#125;,<span class=\"number\">0</span>)</span><br><span class=\"line\">setImmediate (</span><br><span class=\"line\">    <span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>. log (<span class=\"string\">&#x27;setImmediate&#x27;</span>));</span><br></pre></td></tr></table></figure>\n<p><strong>我们先执行一次看一下结果，想必大家已经有了结果。</strong></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/121a265a47e645bb879cfbc263480d65~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>那我们再次执行，看看会有什么结果呢？</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8eaa7c1728644dea9c38fed2e2da29d3~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>为什么两次执行结果不一样呢？</strong></p>\n<p><strong>因为当Node.js开始初始化加载事件循环时，如果初始化过快，setTimeout（timer）没有加载到任务队列，就会先执行setImmediate，执行完后，发现有timer微任务，就会再执行timer微任务队列，当初始化的时间小于setTimeout（timer）加载到任务队列的时间时，当Node.js开始执行事件循环时，setTimeout（timer）就已经加载到timer微任务队列了，所以就会根据优先级执行，所以就会产生这两种不同的结果。</strong></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>Node中的事件循环不止一个宏任务队列，它主要分为四种宏任务队列</li>\n<li>Node中的事件循环不止一个微任务队列，它主要分为两种微任务队列</li>\n<li>常见的宏任务事件循环有，setTimeout、setInterval、IO事件、setImmediate、close事件</li>\n<li>常见的微任务事件循环有，Promise的then回调、process.nextTick、queueMicrotask</li>\n</ol>\n"},{"title":"React Fiber架构","date":"2023-05-28T11:45:35.591Z","sticky":100,"_content":"\n\n## 前言\n\n<img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9449275c49dd47609943a39b8c2f087a~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n在了解React Fiber架构之前，我们得从React 15中的栈调和（stack Reconciler）入手。\n\n在React15中，因为使用的是不可打断stack Reconciler的同步渲染，所以当调和时间很长时间，就会导致Javascript线程长时间霸占主线程，进而导致渲染卡顿、卡死、交互时间长时间无响应等问题，所以React团队在React16做出了改变-Fiber。\n\n## React 调和过程是怎样的\n**调和（Reconciliation），又译为 协调。**\n### React调和与diff算法\n调和指的是将虚拟 DOM 映射到真实 DOM 的过程，Diff 过程只是其中一个环节。\n\nReact 源码结构佐证了这一点：React 从大的板块上将源码划分为 Core、Renderer、Reconciler 三部分。\n\n其中 Reconciler 调和器所做的工作是一系列的，包括组件的挂载、卸载、更新等过程，其中更新过程涉及对 Diff 算法的调用。\n\n所以，`调和 !== Diff`。但 Diff 确实是调和过程中最具有代表性的一环。\n\n根据 Diff 实现形式的不同，调和过程被划分为 以 React 15 为主的\"栈调和\" 以及 以 React 16 为主的\"Fiber 调和\"。\n\n### React 15\n当我们通过`render`和`setState`进行组件渲染和更新的时候，`React`主要有两个阶段：\n\n-   **协调阶段Reconciler**：通过`diff`算法递归比较新旧两棵虚拟`dom`树，计算出需要改变的部分`patch`。\n-   **渲染阶段Renderer**：负责将`patch`批量更新到真实`dom`。\n\n \n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c39f3f10123460a80cbdacafd742dc8~tplv-k3u1fbpfcp-watermark.image?)\n\n### React 16\n`react 16`新增**Scheduler**阶段；并且重构了**Reconciler**，即 **`Fiber` Reconciler**。\n\n-   **调度器Scheduler**：调度任务的执行，优先级高的任务会先进入协调阶段。\n-   **协调器Reconciler**：负责找出变化的组件，可以中断更新过程。\n-   **渲染器Renderer**：负责将变化的组件渲染到页面上。\n\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/408e614fc1584ac4ac480835cc5f5111~tplv-k3u1fbpfcp-watermark.image?)\n\n## Fiber架构是如何解决问题的\nFiber架构的应用目的是实现“增量渲染”\n\n实现增量渲染的目的，是为了实现任务的可中断，可恢复，并给不同的任务赋予不同的优先级，最终达成更加顺滑的用户体验。\n\nFiber架构的重要特征就是可以被打断的异步渲染模式，Fiber架构的核心就是：可中断、可恢复与优先级，每个更新任务都会被赋予一个优先级，若发现B的优先级高于当前任务A的优先级，那么当前处于Reconciler层的A任务就会被打断，将B任务推进Reconciler层，当B任务调和完成时，根据优先级排序，A任务将会重新推入Reconciler层，继续它的渲染之旅，这便是可恢复。\n\n 每一个工作单元都接受Scheduler（调度器）的优先级调度。\n \n ## Fiber架构中的diff算法\n ### fiber node\n 在React中，每一个React元素都会有对应的一个fiber node，与React元素不同的是，fiber node不会在每一次渲染时重新创建这些fiber node。\n \n ### fiber tree\n fiber tree是一个链表结构，它通过`fiber`节点的`return、child、sibling`属性进行连接。\n \n ### current Tree、workInProgress Tree\n在 React 中最多存在两颗 Fiber 树，当前屏幕上 DOM 结构对相应的 Fiber 树称为 current Fiber 树(首次渲染时会得到第一个Fiber树)，在内存中构建的 Fiber 树称为 workInProgress Fiber 树。其中，Diff 算法的计算过程就是生成 workInProgress Fiber 树的过程，每次页面状态更新都会产生新的 workInProgress Fiber 树，当 workInProgress Fiber 树构建完成后交给 Renderer 渲染在页面上，之后在 React 中使用根节点的 current 指针完成由 current Fieber 树到 workInProgress Fiber 树的切换，此时\n\nworkInProgress Fiber 树就成为了 current Fiber 树，完成 DOM 更新。\n\n### 如何构建workInProgress Tree\nDiff 算法的本质是对比 JSX 对象和 current Fiber 节点，然后根据对比结果生成 workInProgress Fiber 节点，进而生成\n\nworkInProgress Fiber 树。其中需要执行相关操作的 Fiber 节点将会被打上 flags 标记，之后 Renderer 渲染器基于 Diff 过程中打上 flags 标记的 Fiber 节点**链接**成的**链表**进行相关的 DOM 操作。\n\n所以在构建workInProgress Fiber时我们也会复用current Fiber未发生改变的fiber node，如果对比current Fiber和JSX对象，得到有差异的fiber node则会重新创建（不会复用）。\n\n### 提示\n\n-   **在构建`Fiber`树的过程中，`Fiber Reconciler`会将需要更新的节点信息保存在`Effect List`当中，在`commit`阶段时进行批量更新。**\n-   构建`workInProgress tree`的过程就是`diff`的过程，通过`requestIdleCallback`来调度执行一组任务。\n\n## Renderer（渲染）\n\n### commit阶段\n处理`Effect List`：包含更新`dom`、调用组件生命周期函数、更新`ref`等内部状态。\n\n### 注意！！！\n\n**commit**阶段是不可中断的，是一次执行完成的，此阶段不能暂停，否则会出现UI更新不连续的现象。此阶段需要根据effect list，将所有更新都 commit 到DOM树上。（因为Reconciler是在用户察觉不到的情况下运行，所以可中断、可恢复影响不到用户体验）。\n## 总结\n1. 相较于 React15，React16 利用 Scheduler 和基于 Fiber 节点的链表结构的虚拟 DOM 实现了可中断异步 DOM 更新，改善了页面 DOM 层级过深时造成的页面卡顿现象。React16 中的虚拟 DOM 树是由 Fiber 节点链接成的 Fiber 树，其中的每一个 Fiber 节点都有与之相对应的真实 DOM 节点。\n2. 在 React 中最多存在两颗 Fiber 树，current Fiber 树和 workInProgress Fiber 树，Diff 算法的本质就是对比 current Fiber 节点和 JSX 对象，然后生成 workInProgress Fiber 树。根据同级的节点数量将 Diff 算法分为两类，单节点 Diff 和多节点 Diff。\n3. `调和 !== Diff`。但 Diff 确实是调和过程中最具有代表性的一环。\n4. **commit**阶段是不可中断的，是一次执行完成的，此阶段不能暂停，否则会出现UI更新不连续的现象。此阶段需要根据effect list，将所有更新都 commit 到DOM树上。（因为Reconciler是在用户察觉不到的情况下运行，所以可中断、可恢复影响不到用户体验）。\n\n\n\n  \n\n\n","source":"_posts/React Fiber架构.md","raw":"---\ntitle: React Fiber架构\ndate: 2023/04/26 21-24\ntag: React\nsticky: 100\ncategory:\n - 前端\n---\n\n\n## 前言\n\n<img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9449275c49dd47609943a39b8c2f087a~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n在了解React Fiber架构之前，我们得从React 15中的栈调和（stack Reconciler）入手。\n\n在React15中，因为使用的是不可打断stack Reconciler的同步渲染，所以当调和时间很长时间，就会导致Javascript线程长时间霸占主线程，进而导致渲染卡顿、卡死、交互时间长时间无响应等问题，所以React团队在React16做出了改变-Fiber。\n\n## React 调和过程是怎样的\n**调和（Reconciliation），又译为 协调。**\n### React调和与diff算法\n调和指的是将虚拟 DOM 映射到真实 DOM 的过程，Diff 过程只是其中一个环节。\n\nReact 源码结构佐证了这一点：React 从大的板块上将源码划分为 Core、Renderer、Reconciler 三部分。\n\n其中 Reconciler 调和器所做的工作是一系列的，包括组件的挂载、卸载、更新等过程，其中更新过程涉及对 Diff 算法的调用。\n\n所以，`调和 !== Diff`。但 Diff 确实是调和过程中最具有代表性的一环。\n\n根据 Diff 实现形式的不同，调和过程被划分为 以 React 15 为主的\"栈调和\" 以及 以 React 16 为主的\"Fiber 调和\"。\n\n### React 15\n当我们通过`render`和`setState`进行组件渲染和更新的时候，`React`主要有两个阶段：\n\n-   **协调阶段Reconciler**：通过`diff`算法递归比较新旧两棵虚拟`dom`树，计算出需要改变的部分`patch`。\n-   **渲染阶段Renderer**：负责将`patch`批量更新到真实`dom`。\n\n \n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c39f3f10123460a80cbdacafd742dc8~tplv-k3u1fbpfcp-watermark.image?)\n\n### React 16\n`react 16`新增**Scheduler**阶段；并且重构了**Reconciler**，即 **`Fiber` Reconciler**。\n\n-   **调度器Scheduler**：调度任务的执行，优先级高的任务会先进入协调阶段。\n-   **协调器Reconciler**：负责找出变化的组件，可以中断更新过程。\n-   **渲染器Renderer**：负责将变化的组件渲染到页面上。\n\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/408e614fc1584ac4ac480835cc5f5111~tplv-k3u1fbpfcp-watermark.image?)\n\n## Fiber架构是如何解决问题的\nFiber架构的应用目的是实现“增量渲染”\n\n实现增量渲染的目的，是为了实现任务的可中断，可恢复，并给不同的任务赋予不同的优先级，最终达成更加顺滑的用户体验。\n\nFiber架构的重要特征就是可以被打断的异步渲染模式，Fiber架构的核心就是：可中断、可恢复与优先级，每个更新任务都会被赋予一个优先级，若发现B的优先级高于当前任务A的优先级，那么当前处于Reconciler层的A任务就会被打断，将B任务推进Reconciler层，当B任务调和完成时，根据优先级排序，A任务将会重新推入Reconciler层，继续它的渲染之旅，这便是可恢复。\n\n 每一个工作单元都接受Scheduler（调度器）的优先级调度。\n \n ## Fiber架构中的diff算法\n ### fiber node\n 在React中，每一个React元素都会有对应的一个fiber node，与React元素不同的是，fiber node不会在每一次渲染时重新创建这些fiber node。\n \n ### fiber tree\n fiber tree是一个链表结构，它通过`fiber`节点的`return、child、sibling`属性进行连接。\n \n ### current Tree、workInProgress Tree\n在 React 中最多存在两颗 Fiber 树，当前屏幕上 DOM 结构对相应的 Fiber 树称为 current Fiber 树(首次渲染时会得到第一个Fiber树)，在内存中构建的 Fiber 树称为 workInProgress Fiber 树。其中，Diff 算法的计算过程就是生成 workInProgress Fiber 树的过程，每次页面状态更新都会产生新的 workInProgress Fiber 树，当 workInProgress Fiber 树构建完成后交给 Renderer 渲染在页面上，之后在 React 中使用根节点的 current 指针完成由 current Fieber 树到 workInProgress Fiber 树的切换，此时\n\nworkInProgress Fiber 树就成为了 current Fiber 树，完成 DOM 更新。\n\n### 如何构建workInProgress Tree\nDiff 算法的本质是对比 JSX 对象和 current Fiber 节点，然后根据对比结果生成 workInProgress Fiber 节点，进而生成\n\nworkInProgress Fiber 树。其中需要执行相关操作的 Fiber 节点将会被打上 flags 标记，之后 Renderer 渲染器基于 Diff 过程中打上 flags 标记的 Fiber 节点**链接**成的**链表**进行相关的 DOM 操作。\n\n所以在构建workInProgress Fiber时我们也会复用current Fiber未发生改变的fiber node，如果对比current Fiber和JSX对象，得到有差异的fiber node则会重新创建（不会复用）。\n\n### 提示\n\n-   **在构建`Fiber`树的过程中，`Fiber Reconciler`会将需要更新的节点信息保存在`Effect List`当中，在`commit`阶段时进行批量更新。**\n-   构建`workInProgress tree`的过程就是`diff`的过程，通过`requestIdleCallback`来调度执行一组任务。\n\n## Renderer（渲染）\n\n### commit阶段\n处理`Effect List`：包含更新`dom`、调用组件生命周期函数、更新`ref`等内部状态。\n\n### 注意！！！\n\n**commit**阶段是不可中断的，是一次执行完成的，此阶段不能暂停，否则会出现UI更新不连续的现象。此阶段需要根据effect list，将所有更新都 commit 到DOM树上。（因为Reconciler是在用户察觉不到的情况下运行，所以可中断、可恢复影响不到用户体验）。\n## 总结\n1. 相较于 React15，React16 利用 Scheduler 和基于 Fiber 节点的链表结构的虚拟 DOM 实现了可中断异步 DOM 更新，改善了页面 DOM 层级过深时造成的页面卡顿现象。React16 中的虚拟 DOM 树是由 Fiber 节点链接成的 Fiber 树，其中的每一个 Fiber 节点都有与之相对应的真实 DOM 节点。\n2. 在 React 中最多存在两颗 Fiber 树，current Fiber 树和 workInProgress Fiber 树，Diff 算法的本质就是对比 current Fiber 节点和 JSX 对象，然后生成 workInProgress Fiber 树。根据同级的节点数量将 Diff 算法分为两类，单节点 Diff 和多节点 Diff。\n3. `调和 !== Diff`。但 Diff 确实是调和过程中最具有代表性的一环。\n4. **commit**阶段是不可中断的，是一次执行完成的，此阶段不能暂停，否则会出现UI更新不连续的现象。此阶段需要根据effect list，将所有更新都 commit 到DOM树上。（因为Reconciler是在用户察觉不到的情况下运行，所以可中断、可恢复影响不到用户体验）。\n\n\n\n  \n\n\n","slug":"React Fiber架构","published":1,"updated":"2023-05-28T11:52:38.833Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksj000c0svh88fk2si9","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9449275c49dd47609943a39b8c2f087a~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n在了解React Fiber架构之前，我们得从React 15中的栈调和（stack Reconciler）入手。\n\n<p>在React15中，因为使用的是不可打断stack Reconciler的同步渲染，所以当调和时间很长时间，就会导致Javascript线程长时间霸占主线程，进而导致渲染卡顿、卡死、交互时间长时间无响应等问题，所以React团队在React16做出了改变-Fiber。</p>\n<h2 id=\"React-调和过程是怎样的\"><a href=\"#React-调和过程是怎样的\" class=\"headerlink\" title=\"React 调和过程是怎样的\"></a>React 调和过程是怎样的</h2><p><strong>调和（Reconciliation），又译为 协调。</strong></p>\n<h3 id=\"React调和与diff算法\"><a href=\"#React调和与diff算法\" class=\"headerlink\" title=\"React调和与diff算法\"></a>React调和与diff算法</h3><p>调和指的是将虚拟 DOM 映射到真实 DOM 的过程，Diff 过程只是其中一个环节。</p>\n<p>React 源码结构佐证了这一点：React 从大的板块上将源码划分为 Core、Renderer、Reconciler 三部分。</p>\n<p>其中 Reconciler 调和器所做的工作是一系列的，包括组件的挂载、卸载、更新等过程，其中更新过程涉及对 Diff 算法的调用。</p>\n<p>所以，<code>调和 !== Diff</code>。但 Diff 确实是调和过程中最具有代表性的一环。</p>\n<p>根据 Diff 实现形式的不同，调和过程被划分为 以 React 15 为主的”栈调和” 以及 以 React 16 为主的”Fiber 调和”。</p>\n<h3 id=\"React-15\"><a href=\"#React-15\" class=\"headerlink\" title=\"React 15\"></a>React 15</h3><p>当我们通过<code>render</code>和<code>setState</code>进行组件渲染和更新的时候，<code>React</code>主要有两个阶段：</p>\n<ul>\n<li><strong>协调阶段Reconciler</strong>：通过<code>diff</code>算法递归比较新旧两棵虚拟<code>dom</code>树，计算出需要改变的部分<code>patch</code>。</li>\n<li><strong>渲染阶段Renderer</strong>：负责将<code>patch</code>批量更新到真实<code>dom</code>。</li>\n</ul>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c39f3f10123460a80cbdacafd742dc8~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"React-16\"><a href=\"#React-16\" class=\"headerlink\" title=\"React 16\"></a>React 16</h3><p><code>react 16</code>新增<strong>Scheduler</strong>阶段；并且重构了<strong>Reconciler</strong>，即 <strong><code>Fiber</code> Reconciler</strong>。</p>\n<ul>\n<li><strong>调度器Scheduler</strong>：调度任务的执行，优先级高的任务会先进入协调阶段。</li>\n<li><strong>协调器Reconciler</strong>：负责找出变化的组件，可以中断更新过程。</li>\n<li><strong>渲染器Renderer</strong>：负责将变化的组件渲染到页面上。</li>\n</ul>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/408e614fc1584ac4ac480835cc5f5111~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h2 id=\"Fiber架构是如何解决问题的\"><a href=\"#Fiber架构是如何解决问题的\" class=\"headerlink\" title=\"Fiber架构是如何解决问题的\"></a>Fiber架构是如何解决问题的</h2><p>Fiber架构的应用目的是实现“增量渲染”</p>\n<p>实现增量渲染的目的，是为了实现任务的可中断，可恢复，并给不同的任务赋予不同的优先级，最终达成更加顺滑的用户体验。</p>\n<p>Fiber架构的重要特征就是可以被打断的异步渲染模式，Fiber架构的核心就是：可中断、可恢复与优先级，每个更新任务都会被赋予一个优先级，若发现B的优先级高于当前任务A的优先级，那么当前处于Reconciler层的A任务就会被打断，将B任务推进Reconciler层，当B任务调和完成时，根据优先级排序，A任务将会重新推入Reconciler层，继续它的渲染之旅，这便是可恢复。</p>\n<p> 每一个工作单元都接受Scheduler（调度器）的优先级调度。</p>\n<h2 id=\"Fiber架构中的diff算法\"><a href=\"#Fiber架构中的diff算法\" class=\"headerlink\" title=\"Fiber架构中的diff算法\"></a>Fiber架构中的diff算法</h2><h3 id=\"fiber-node\"><a href=\"#fiber-node\" class=\"headerlink\" title=\"fiber node\"></a>fiber node</h3><p> 在React中，每一个React元素都会有对应的一个fiber node，与React元素不同的是，fiber node不会在每一次渲染时重新创建这些fiber node。</p>\n<h3 id=\"fiber-tree\"><a href=\"#fiber-tree\" class=\"headerlink\" title=\"fiber tree\"></a>fiber tree</h3><p> fiber tree是一个链表结构，它通过<code>fiber</code>节点的<code>return、child、sibling</code>属性进行连接。</p>\n<h3 id=\"current-Tree、workInProgress-Tree\"><a href=\"#current-Tree、workInProgress-Tree\" class=\"headerlink\" title=\"current Tree、workInProgress Tree\"></a>current Tree、workInProgress Tree</h3><p>在 React 中最多存在两颗 Fiber 树，当前屏幕上 DOM 结构对相应的 Fiber 树称为 current Fiber 树(首次渲染时会得到第一个Fiber树)，在内存中构建的 Fiber 树称为 workInProgress Fiber 树。其中，Diff 算法的计算过程就是生成 workInProgress Fiber 树的过程，每次页面状态更新都会产生新的 workInProgress Fiber 树，当 workInProgress Fiber 树构建完成后交给 Renderer 渲染在页面上，之后在 React 中使用根节点的 current 指针完成由 current Fieber 树到 workInProgress Fiber 树的切换，此时</p>\n<p>workInProgress Fiber 树就成为了 current Fiber 树，完成 DOM 更新。</p>\n<h3 id=\"如何构建workInProgress-Tree\"><a href=\"#如何构建workInProgress-Tree\" class=\"headerlink\" title=\"如何构建workInProgress Tree\"></a>如何构建workInProgress Tree</h3><p>Diff 算法的本质是对比 JSX 对象和 current Fiber 节点，然后根据对比结果生成 workInProgress Fiber 节点，进而生成</p>\n<p>workInProgress Fiber 树。其中需要执行相关操作的 Fiber 节点将会被打上 flags 标记，之后 Renderer 渲染器基于 Diff 过程中打上 flags 标记的 Fiber 节点<strong>链接</strong>成的<strong>链表</strong>进行相关的 DOM 操作。</p>\n<p>所以在构建workInProgress Fiber时我们也会复用current Fiber未发生改变的fiber node，如果对比current Fiber和JSX对象，得到有差异的fiber node则会重新创建（不会复用）。</p>\n<h3 id=\"提示\"><a href=\"#提示\" class=\"headerlink\" title=\"提示\"></a>提示</h3><ul>\n<li><strong>在构建<code>Fiber</code>树的过程中，<code>Fiber Reconciler</code>会将需要更新的节点信息保存在<code>Effect List</code>当中，在<code>commit</code>阶段时进行批量更新。</strong></li>\n<li>构建<code>workInProgress tree</code>的过程就是<code>diff</code>的过程，通过<code>requestIdleCallback</code>来调度执行一组任务。</li>\n</ul>\n<h2 id=\"Renderer（渲染）\"><a href=\"#Renderer（渲染）\" class=\"headerlink\" title=\"Renderer（渲染）\"></a>Renderer（渲染）</h2><h3 id=\"commit阶段\"><a href=\"#commit阶段\" class=\"headerlink\" title=\"commit阶段\"></a>commit阶段</h3><p>处理<code>Effect List</code>：包含更新<code>dom</code>、调用组件生命周期函数、更新<code>ref</code>等内部状态。</p>\n<h3 id=\"注意！！！\"><a href=\"#注意！！！\" class=\"headerlink\" title=\"注意！！！\"></a>注意！！！</h3><p><strong>commit</strong>阶段是不可中断的，是一次执行完成的，此阶段不能暂停，否则会出现UI更新不连续的现象。此阶段需要根据effect list，将所有更新都 commit 到DOM树上。（因为Reconciler是在用户察觉不到的情况下运行，所以可中断、可恢复影响不到用户体验）。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>相较于 React15，React16 利用 Scheduler 和基于 Fiber 节点的链表结构的虚拟 DOM 实现了可中断异步 DOM 更新，改善了页面 DOM 层级过深时造成的页面卡顿现象。React16 中的虚拟 DOM 树是由 Fiber 节点链接成的 Fiber 树，其中的每一个 Fiber 节点都有与之相对应的真实 DOM 节点。</li>\n<li>在 React 中最多存在两颗 Fiber 树，current Fiber 树和 workInProgress Fiber 树，Diff 算法的本质就是对比 current Fiber 节点和 JSX 对象，然后生成 workInProgress Fiber 树。根据同级的节点数量将 Diff 算法分为两类，单节点 Diff 和多节点 Diff。</li>\n<li><code>调和 !== Diff</code>。但 Diff 确实是调和过程中最具有代表性的一环。</li>\n<li><strong>commit</strong>阶段是不可中断的，是一次执行完成的，此阶段不能暂停，否则会出现UI更新不连续的现象。此阶段需要根据effect list，将所有更新都 commit 到DOM树上。（因为Reconciler是在用户察觉不到的情况下运行，所以可中断、可恢复影响不到用户体验）。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9449275c49dd47609943a39b8c2f087a~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n在了解React Fiber架构之前，我们得从React 15中的栈调和（stack Reconciler）入手。\n\n<p>在React15中，因为使用的是不可打断stack Reconciler的同步渲染，所以当调和时间很长时间，就会导致Javascript线程长时间霸占主线程，进而导致渲染卡顿、卡死、交互时间长时间无响应等问题，所以React团队在React16做出了改变-Fiber。</p>\n<h2 id=\"React-调和过程是怎样的\"><a href=\"#React-调和过程是怎样的\" class=\"headerlink\" title=\"React 调和过程是怎样的\"></a>React 调和过程是怎样的</h2><p><strong>调和（Reconciliation），又译为 协调。</strong></p>\n<h3 id=\"React调和与diff算法\"><a href=\"#React调和与diff算法\" class=\"headerlink\" title=\"React调和与diff算法\"></a>React调和与diff算法</h3><p>调和指的是将虚拟 DOM 映射到真实 DOM 的过程，Diff 过程只是其中一个环节。</p>\n<p>React 源码结构佐证了这一点：React 从大的板块上将源码划分为 Core、Renderer、Reconciler 三部分。</p>\n<p>其中 Reconciler 调和器所做的工作是一系列的，包括组件的挂载、卸载、更新等过程，其中更新过程涉及对 Diff 算法的调用。</p>\n<p>所以，<code>调和 !== Diff</code>。但 Diff 确实是调和过程中最具有代表性的一环。</p>\n<p>根据 Diff 实现形式的不同，调和过程被划分为 以 React 15 为主的”栈调和” 以及 以 React 16 为主的”Fiber 调和”。</p>\n<h3 id=\"React-15\"><a href=\"#React-15\" class=\"headerlink\" title=\"React 15\"></a>React 15</h3><p>当我们通过<code>render</code>和<code>setState</code>进行组件渲染和更新的时候，<code>React</code>主要有两个阶段：</p>\n<ul>\n<li><strong>协调阶段Reconciler</strong>：通过<code>diff</code>算法递归比较新旧两棵虚拟<code>dom</code>树，计算出需要改变的部分<code>patch</code>。</li>\n<li><strong>渲染阶段Renderer</strong>：负责将<code>patch</code>批量更新到真实<code>dom</code>。</li>\n</ul>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c39f3f10123460a80cbdacafd742dc8~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"React-16\"><a href=\"#React-16\" class=\"headerlink\" title=\"React 16\"></a>React 16</h3><p><code>react 16</code>新增<strong>Scheduler</strong>阶段；并且重构了<strong>Reconciler</strong>，即 <strong><code>Fiber</code> Reconciler</strong>。</p>\n<ul>\n<li><strong>调度器Scheduler</strong>：调度任务的执行，优先级高的任务会先进入协调阶段。</li>\n<li><strong>协调器Reconciler</strong>：负责找出变化的组件，可以中断更新过程。</li>\n<li><strong>渲染器Renderer</strong>：负责将变化的组件渲染到页面上。</li>\n</ul>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/408e614fc1584ac4ac480835cc5f5111~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h2 id=\"Fiber架构是如何解决问题的\"><a href=\"#Fiber架构是如何解决问题的\" class=\"headerlink\" title=\"Fiber架构是如何解决问题的\"></a>Fiber架构是如何解决问题的</h2><p>Fiber架构的应用目的是实现“增量渲染”</p>\n<p>实现增量渲染的目的，是为了实现任务的可中断，可恢复，并给不同的任务赋予不同的优先级，最终达成更加顺滑的用户体验。</p>\n<p>Fiber架构的重要特征就是可以被打断的异步渲染模式，Fiber架构的核心就是：可中断、可恢复与优先级，每个更新任务都会被赋予一个优先级，若发现B的优先级高于当前任务A的优先级，那么当前处于Reconciler层的A任务就会被打断，将B任务推进Reconciler层，当B任务调和完成时，根据优先级排序，A任务将会重新推入Reconciler层，继续它的渲染之旅，这便是可恢复。</p>\n<p> 每一个工作单元都接受Scheduler（调度器）的优先级调度。</p>\n<h2 id=\"Fiber架构中的diff算法\"><a href=\"#Fiber架构中的diff算法\" class=\"headerlink\" title=\"Fiber架构中的diff算法\"></a>Fiber架构中的diff算法</h2><h3 id=\"fiber-node\"><a href=\"#fiber-node\" class=\"headerlink\" title=\"fiber node\"></a>fiber node</h3><p> 在React中，每一个React元素都会有对应的一个fiber node，与React元素不同的是，fiber node不会在每一次渲染时重新创建这些fiber node。</p>\n<h3 id=\"fiber-tree\"><a href=\"#fiber-tree\" class=\"headerlink\" title=\"fiber tree\"></a>fiber tree</h3><p> fiber tree是一个链表结构，它通过<code>fiber</code>节点的<code>return、child、sibling</code>属性进行连接。</p>\n<h3 id=\"current-Tree、workInProgress-Tree\"><a href=\"#current-Tree、workInProgress-Tree\" class=\"headerlink\" title=\"current Tree、workInProgress Tree\"></a>current Tree、workInProgress Tree</h3><p>在 React 中最多存在两颗 Fiber 树，当前屏幕上 DOM 结构对相应的 Fiber 树称为 current Fiber 树(首次渲染时会得到第一个Fiber树)，在内存中构建的 Fiber 树称为 workInProgress Fiber 树。其中，Diff 算法的计算过程就是生成 workInProgress Fiber 树的过程，每次页面状态更新都会产生新的 workInProgress Fiber 树，当 workInProgress Fiber 树构建完成后交给 Renderer 渲染在页面上，之后在 React 中使用根节点的 current 指针完成由 current Fieber 树到 workInProgress Fiber 树的切换，此时</p>\n<p>workInProgress Fiber 树就成为了 current Fiber 树，完成 DOM 更新。</p>\n<h3 id=\"如何构建workInProgress-Tree\"><a href=\"#如何构建workInProgress-Tree\" class=\"headerlink\" title=\"如何构建workInProgress Tree\"></a>如何构建workInProgress Tree</h3><p>Diff 算法的本质是对比 JSX 对象和 current Fiber 节点，然后根据对比结果生成 workInProgress Fiber 节点，进而生成</p>\n<p>workInProgress Fiber 树。其中需要执行相关操作的 Fiber 节点将会被打上 flags 标记，之后 Renderer 渲染器基于 Diff 过程中打上 flags 标记的 Fiber 节点<strong>链接</strong>成的<strong>链表</strong>进行相关的 DOM 操作。</p>\n<p>所以在构建workInProgress Fiber时我们也会复用current Fiber未发生改变的fiber node，如果对比current Fiber和JSX对象，得到有差异的fiber node则会重新创建（不会复用）。</p>\n<h3 id=\"提示\"><a href=\"#提示\" class=\"headerlink\" title=\"提示\"></a>提示</h3><ul>\n<li><strong>在构建<code>Fiber</code>树的过程中，<code>Fiber Reconciler</code>会将需要更新的节点信息保存在<code>Effect List</code>当中，在<code>commit</code>阶段时进行批量更新。</strong></li>\n<li>构建<code>workInProgress tree</code>的过程就是<code>diff</code>的过程，通过<code>requestIdleCallback</code>来调度执行一组任务。</li>\n</ul>\n<h2 id=\"Renderer（渲染）\"><a href=\"#Renderer（渲染）\" class=\"headerlink\" title=\"Renderer（渲染）\"></a>Renderer（渲染）</h2><h3 id=\"commit阶段\"><a href=\"#commit阶段\" class=\"headerlink\" title=\"commit阶段\"></a>commit阶段</h3><p>处理<code>Effect List</code>：包含更新<code>dom</code>、调用组件生命周期函数、更新<code>ref</code>等内部状态。</p>\n<h3 id=\"注意！！！\"><a href=\"#注意！！！\" class=\"headerlink\" title=\"注意！！！\"></a>注意！！！</h3><p><strong>commit</strong>阶段是不可中断的，是一次执行完成的，此阶段不能暂停，否则会出现UI更新不连续的现象。此阶段需要根据effect list，将所有更新都 commit 到DOM树上。（因为Reconciler是在用户察觉不到的情况下运行，所以可中断、可恢复影响不到用户体验）。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>相较于 React15，React16 利用 Scheduler 和基于 Fiber 节点的链表结构的虚拟 DOM 实现了可中断异步 DOM 更新，改善了页面 DOM 层级过深时造成的页面卡顿现象。React16 中的虚拟 DOM 树是由 Fiber 节点链接成的 Fiber 树，其中的每一个 Fiber 节点都有与之相对应的真实 DOM 节点。</li>\n<li>在 React 中最多存在两颗 Fiber 树，current Fiber 树和 workInProgress Fiber 树，Diff 算法的本质就是对比 current Fiber 节点和 JSX 对象，然后生成 workInProgress Fiber 树。根据同级的节点数量将 Diff 算法分为两类，单节点 Diff 和多节点 Diff。</li>\n<li><code>调和 !== Diff</code>。但 Diff 确实是调和过程中最具有代表性的一环。</li>\n<li><strong>commit</strong>阶段是不可中断的，是一次执行完成的，此阶段不能暂停，否则会出现UI更新不连续的现象。此阶段需要根据effect list，将所有更新都 commit 到DOM树上。（因为Reconciler是在用户察觉不到的情况下运行，所以可中断、可恢复影响不到用户体验）。</li>\n</ol>\n"},{"title":"React Hooks-useState逻辑实现","date":"2023-05-28T11:46:24.482Z","_content":"\n\n##  前言\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/517040d5c49445ac955147e113e61ee1~tplv-k3u1fbpfcp-watermark.image?)\n在React中，我们经常使用useState这个Hooks，那么这个Hooks的实现逻辑是怎样的呢，下边我总结了一下这个Hooks的实现逻辑。\n\n## 关于useState\nuseState是在函数式组件中用来管理状态的一个Hooks，弥补了函数式组件没有状态这一缺点。\n\n在React中，state是以链表的形式存在，并在每一次的更新时，实现state批量更新，也就是说，在React中，当state变化时，会先暂存在更新最后统一实现。\n\n**注意**useState不可以在if这样的条件语句中使用，否则会出现批量更新混淆错误。这也是React官方严厉禁止的。\n\n## useState实现逻辑\n首先，我们要明白，useState是通过return出一个数组，这个数组有两个参数，第一个参数是维护的状态值，第二个参数是改变状态值的函数。\n\n### 为什么useState不返回一个对象而返回一个数组呢？\n因为返回值为数组时，结构时可以直接起别名，而用对象解构时，起别名的过程需要:（冒号）,这样就会繁琐。\n\n### useState的结构\n通过React源码，我们可以发现，useState中是用链表的形式存储着state，所以当我们实现逻辑复现的时候，就得需要通过数组去存储state值和setState函数（简单的逻辑复现暂时用数组）。\n\n## 源码\n```js\nconst MyReact=(\n    ()=>{\n        const states =[ ]\n        const stateSetters=[]\n\n        let stateIndex=0\n\n        function createState(initialState,stateIndex){\n            return states[stateIndex]!==undefined ? states[stateIndex] : initialState\n        }\n\n        function createStateSetters(stateIndex){\n            return function (newState){\n                if(typeof newState===\"function\"){\n                    states[stateIndex]=newState(states[stateIndex])\n                }\n                else{\n                    states[stateIndex]=newState\n                }\n\n                render()\n            }\n        }\n        function useState(initialState){\n            const  _state=createState(initialState,stateIndex)\n\n            if(!stateSetters[stateIndex]){\n                stateSetters.push(createStateSetters(stateIndex))\n            }\n            const _setState=stateSetters[stateIndex]\n\n            stateIndex++\n            return [_state,_setState]\n        }\n\n        function render(){\n            stateIndex=0\n            ReactDOM.render(\n                <App />,\n                document.querySelector('#app')\n            )\n        }\n\n        return {\n            useState\n        }\n    }\n\n)()\n\n\nconst {useState}=MyReact\n\nexport default function App(){\n    const [count,setCount]=useState(0)\n\n    return (\n        <div>\n            <h1>{count}</h1>\n            <button onClick={()=>{setCount(count+1)}}>ADD +1</button>\n        </div>\n    )\n}\n```\n接下来，我们逐步分析源码。\n\n我们都知道，使用useState时需要传入一个init值，所以我们需要接收一个init值，通过createState这个函数，将init值保存在states数组中。在这里，需要做一个判断，如果不等于undefined时，将值设置为**states[stateIndex]**（防止重复初始化，因为render函数调用后，重新执行useState，我们需要保留render调用前的状态值）。\n\n在createStateSetters函数中，根据传入的newState值，返回顶一个setState。\n\nuseState的第二个参数，有两种传参形式，一种是传入一个值，一种是传入一个函数，所以我们得需要typeof判断一下是否传入的参数是函数，如果是函数，我们就调用这个函数，并且将这个函数的返回值赋值给states[stateIndex]，如果不是函数，则直接将newState值赋值给states[stateIndex]。\n\n当我们执行一次useState函数值后，将stateIndex+1，确保下一次的useState函数可以正常的将state和setState存入到正确的数组位置。\n\n最后，我们需要在每一次的render函数调用时，将stateIndex重置为0，因为render函数调用后会重新执行useState。\n","source":"_posts/React Hooks-useState逻辑实现.md","raw":"---\ntitle: React Hooks-useState逻辑实现\ndate: 2023/05/09 20-16\ntag: React\ncategory:\n - 前端\n---\n\n\n##  前言\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/517040d5c49445ac955147e113e61ee1~tplv-k3u1fbpfcp-watermark.image?)\n在React中，我们经常使用useState这个Hooks，那么这个Hooks的实现逻辑是怎样的呢，下边我总结了一下这个Hooks的实现逻辑。\n\n## 关于useState\nuseState是在函数式组件中用来管理状态的一个Hooks，弥补了函数式组件没有状态这一缺点。\n\n在React中，state是以链表的形式存在，并在每一次的更新时，实现state批量更新，也就是说，在React中，当state变化时，会先暂存在更新最后统一实现。\n\n**注意**useState不可以在if这样的条件语句中使用，否则会出现批量更新混淆错误。这也是React官方严厉禁止的。\n\n## useState实现逻辑\n首先，我们要明白，useState是通过return出一个数组，这个数组有两个参数，第一个参数是维护的状态值，第二个参数是改变状态值的函数。\n\n### 为什么useState不返回一个对象而返回一个数组呢？\n因为返回值为数组时，结构时可以直接起别名，而用对象解构时，起别名的过程需要:（冒号）,这样就会繁琐。\n\n### useState的结构\n通过React源码，我们可以发现，useState中是用链表的形式存储着state，所以当我们实现逻辑复现的时候，就得需要通过数组去存储state值和setState函数（简单的逻辑复现暂时用数组）。\n\n## 源码\n```js\nconst MyReact=(\n    ()=>{\n        const states =[ ]\n        const stateSetters=[]\n\n        let stateIndex=0\n\n        function createState(initialState,stateIndex){\n            return states[stateIndex]!==undefined ? states[stateIndex] : initialState\n        }\n\n        function createStateSetters(stateIndex){\n            return function (newState){\n                if(typeof newState===\"function\"){\n                    states[stateIndex]=newState(states[stateIndex])\n                }\n                else{\n                    states[stateIndex]=newState\n                }\n\n                render()\n            }\n        }\n        function useState(initialState){\n            const  _state=createState(initialState,stateIndex)\n\n            if(!stateSetters[stateIndex]){\n                stateSetters.push(createStateSetters(stateIndex))\n            }\n            const _setState=stateSetters[stateIndex]\n\n            stateIndex++\n            return [_state,_setState]\n        }\n\n        function render(){\n            stateIndex=0\n            ReactDOM.render(\n                <App />,\n                document.querySelector('#app')\n            )\n        }\n\n        return {\n            useState\n        }\n    }\n\n)()\n\n\nconst {useState}=MyReact\n\nexport default function App(){\n    const [count,setCount]=useState(0)\n\n    return (\n        <div>\n            <h1>{count}</h1>\n            <button onClick={()=>{setCount(count+1)}}>ADD +1</button>\n        </div>\n    )\n}\n```\n接下来，我们逐步分析源码。\n\n我们都知道，使用useState时需要传入一个init值，所以我们需要接收一个init值，通过createState这个函数，将init值保存在states数组中。在这里，需要做一个判断，如果不等于undefined时，将值设置为**states[stateIndex]**（防止重复初始化，因为render函数调用后，重新执行useState，我们需要保留render调用前的状态值）。\n\n在createStateSetters函数中，根据传入的newState值，返回顶一个setState。\n\nuseState的第二个参数，有两种传参形式，一种是传入一个值，一种是传入一个函数，所以我们得需要typeof判断一下是否传入的参数是函数，如果是函数，我们就调用这个函数，并且将这个函数的返回值赋值给states[stateIndex]，如果不是函数，则直接将newState值赋值给states[stateIndex]。\n\n当我们执行一次useState函数值后，将stateIndex+1，确保下一次的useState函数可以正常的将state和setState存入到正确的数组位置。\n\n最后，我们需要在每一次的render函数调用时，将stateIndex重置为0，因为render函数调用后会重新执行useState。\n","slug":"React Hooks-useState逻辑实现","published":1,"updated":"2023-05-28T11:46:55.833Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksk000e0svhdc884duf","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/517040d5c49445ac955147e113e61ee1~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br>在React中，我们经常使用useState这个Hooks，那么这个Hooks的实现逻辑是怎样的呢，下边我总结了一下这个Hooks的实现逻辑。</p>\n<h2 id=\"关于useState\"><a href=\"#关于useState\" class=\"headerlink\" title=\"关于useState\"></a>关于useState</h2><p>useState是在函数式组件中用来管理状态的一个Hooks，弥补了函数式组件没有状态这一缺点。</p>\n<p>在React中，state是以链表的形式存在，并在每一次的更新时，实现state批量更新，也就是说，在React中，当state变化时，会先暂存在更新最后统一实现。</p>\n<p><strong>注意</strong>useState不可以在if这样的条件语句中使用，否则会出现批量更新混淆错误。这也是React官方严厉禁止的。</p>\n<h2 id=\"useState实现逻辑\"><a href=\"#useState实现逻辑\" class=\"headerlink\" title=\"useState实现逻辑\"></a>useState实现逻辑</h2><p>首先，我们要明白，useState是通过return出一个数组，这个数组有两个参数，第一个参数是维护的状态值，第二个参数是改变状态值的函数。</p>\n<h3 id=\"为什么useState不返回一个对象而返回一个数组呢？\"><a href=\"#为什么useState不返回一个对象而返回一个数组呢？\" class=\"headerlink\" title=\"为什么useState不返回一个对象而返回一个数组呢？\"></a>为什么useState不返回一个对象而返回一个数组呢？</h3><p>因为返回值为数组时，结构时可以直接起别名，而用对象解构时，起别名的过程需要:（冒号）,这样就会繁琐。</p>\n<h3 id=\"useState的结构\"><a href=\"#useState的结构\" class=\"headerlink\" title=\"useState的结构\"></a>useState的结构</h3><p>通过React源码，我们可以发现，useState中是用链表的形式存储着state，所以当我们实现逻辑复现的时候，就得需要通过数组去存储state值和setState函数（简单的逻辑复现暂时用数组）。</p>\n<h2 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyReact</span>=(</span><br><span class=\"line\">    <span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> states =[ ]</span><br><span class=\"line\">        <span class=\"keyword\">const</span> stateSetters=[]</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> stateIndex=<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">function</span> <span class=\"title function_\">createState</span>(<span class=\"params\">initialState,stateIndex</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> states[stateIndex]!==<span class=\"literal\">undefined</span> ? states[stateIndex] : initialState</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">function</span> <span class=\"title function_\">createStateSetters</span>(<span class=\"params\">stateIndex</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">function</span> (<span class=\"params\">newState</span>)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(<span class=\"keyword\">typeof</span> newState===<span class=\"string\">&quot;function&quot;</span>)&#123;</span><br><span class=\"line\">                    states[stateIndex]=<span class=\"title function_\">newState</span>(states[stateIndex])</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                    states[stateIndex]=newState</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"title function_\">render</span>()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">function</span> <span class=\"title function_\">useState</span>(<span class=\"params\">initialState</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span>  _state=<span class=\"title function_\">createState</span>(initialState,stateIndex)</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(!stateSetters[stateIndex])&#123;</span><br><span class=\"line\">                stateSetters.<span class=\"title function_\">push</span>(<span class=\"title function_\">createStateSetters</span>(stateIndex))</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> _setState=stateSetters[stateIndex]</span><br><span class=\"line\"></span><br><span class=\"line\">            stateIndex++</span><br><span class=\"line\">            <span class=\"keyword\">return</span> [_state,_setState]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">function</span> <span class=\"title function_\">render</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">            stateIndex=<span class=\"number\">0</span></span><br><span class=\"line\">            <span class=\"title class_\">ReactDOM</span>.<span class=\"title function_\">render</span>(</span><br><span class=\"line\">                <span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">App</span> /&gt;</span></span>,</span><br><span class=\"line\">                <span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&#x27;#app&#x27;</span>)</span><br><span class=\"line\">            )</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">            useState</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">)()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123;useState&#125;=<span class=\"title class_\">MyReact</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"keyword\">function</span> <span class=\"title function_\">App</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> [count,setCount]=<span class=\"title function_\">useState</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (</span><br><span class=\"line\">        <span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">            <span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span>&#123;count&#125;<span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">            <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">onClick</span>=<span class=\"string\">&#123;()</span>=&gt;</span>&#123;setCount(count+1)&#125;&#125;&gt;ADD +1<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">        <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span></span><br><span class=\"line\">    )</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>接下来，我们逐步分析源码。</p>\n<p>我们都知道，使用useState时需要传入一个init值，所以我们需要接收一个init值，通过createState这个函数，将init值保存在states数组中。在这里，需要做一个判断，如果不等于undefined时，将值设置为**states[stateIndex]**（防止重复初始化，因为render函数调用后，重新执行useState，我们需要保留render调用前的状态值）。</p>\n<p>在createStateSetters函数中，根据传入的newState值，返回顶一个setState。</p>\n<p>useState的第二个参数，有两种传参形式，一种是传入一个值，一种是传入一个函数，所以我们得需要typeof判断一下是否传入的参数是函数，如果是函数，我们就调用这个函数，并且将这个函数的返回值赋值给states[stateIndex]，如果不是函数，则直接将newState值赋值给states[stateIndex]。</p>\n<p>当我们执行一次useState函数值后，将stateIndex+1，确保下一次的useState函数可以正常的将state和setState存入到正确的数组位置。</p>\n<p>最后，我们需要在每一次的render函数调用时，将stateIndex重置为0，因为render函数调用后会重新执行useState。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/517040d5c49445ac955147e113e61ee1~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br>在React中，我们经常使用useState这个Hooks，那么这个Hooks的实现逻辑是怎样的呢，下边我总结了一下这个Hooks的实现逻辑。</p>\n<h2 id=\"关于useState\"><a href=\"#关于useState\" class=\"headerlink\" title=\"关于useState\"></a>关于useState</h2><p>useState是在函数式组件中用来管理状态的一个Hooks，弥补了函数式组件没有状态这一缺点。</p>\n<p>在React中，state是以链表的形式存在，并在每一次的更新时，实现state批量更新，也就是说，在React中，当state变化时，会先暂存在更新最后统一实现。</p>\n<p><strong>注意</strong>useState不可以在if这样的条件语句中使用，否则会出现批量更新混淆错误。这也是React官方严厉禁止的。</p>\n<h2 id=\"useState实现逻辑\"><a href=\"#useState实现逻辑\" class=\"headerlink\" title=\"useState实现逻辑\"></a>useState实现逻辑</h2><p>首先，我们要明白，useState是通过return出一个数组，这个数组有两个参数，第一个参数是维护的状态值，第二个参数是改变状态值的函数。</p>\n<h3 id=\"为什么useState不返回一个对象而返回一个数组呢？\"><a href=\"#为什么useState不返回一个对象而返回一个数组呢？\" class=\"headerlink\" title=\"为什么useState不返回一个对象而返回一个数组呢？\"></a>为什么useState不返回一个对象而返回一个数组呢？</h3><p>因为返回值为数组时，结构时可以直接起别名，而用对象解构时，起别名的过程需要:（冒号）,这样就会繁琐。</p>\n<h3 id=\"useState的结构\"><a href=\"#useState的结构\" class=\"headerlink\" title=\"useState的结构\"></a>useState的结构</h3><p>通过React源码，我们可以发现，useState中是用链表的形式存储着state，所以当我们实现逻辑复现的时候，就得需要通过数组去存储state值和setState函数（简单的逻辑复现暂时用数组）。</p>\n<h2 id=\"源码\"><a href=\"#源码\" class=\"headerlink\" title=\"源码\"></a>源码</h2><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title class_\">MyReact</span>=(</span><br><span class=\"line\">    <span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> states =[ ]</span><br><span class=\"line\">        <span class=\"keyword\">const</span> stateSetters=[]</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> stateIndex=<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">function</span> <span class=\"title function_\">createState</span>(<span class=\"params\">initialState,stateIndex</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> states[stateIndex]!==<span class=\"literal\">undefined</span> ? states[stateIndex] : initialState</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">function</span> <span class=\"title function_\">createStateSetters</span>(<span class=\"params\">stateIndex</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">function</span> (<span class=\"params\">newState</span>)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(<span class=\"keyword\">typeof</span> newState===<span class=\"string\">&quot;function&quot;</span>)&#123;</span><br><span class=\"line\">                    states[stateIndex]=<span class=\"title function_\">newState</span>(states[stateIndex])</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                    states[stateIndex]=newState</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"title function_\">render</span>()</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">function</span> <span class=\"title function_\">useState</span>(<span class=\"params\">initialState</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span>  _state=<span class=\"title function_\">createState</span>(initialState,stateIndex)</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span>(!stateSetters[stateIndex])&#123;</span><br><span class=\"line\">                stateSetters.<span class=\"title function_\">push</span>(<span class=\"title function_\">createStateSetters</span>(stateIndex))</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> _setState=stateSetters[stateIndex]</span><br><span class=\"line\"></span><br><span class=\"line\">            stateIndex++</span><br><span class=\"line\">            <span class=\"keyword\">return</span> [_state,_setState]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">function</span> <span class=\"title function_\">render</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">            stateIndex=<span class=\"number\">0</span></span><br><span class=\"line\">            <span class=\"title class_\">ReactDOM</span>.<span class=\"title function_\">render</span>(</span><br><span class=\"line\">                <span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">App</span> /&gt;</span></span>,</span><br><span class=\"line\">                <span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&#x27;#app&#x27;</span>)</span><br><span class=\"line\">            )</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">            useState</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">)()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> &#123;useState&#125;=<span class=\"title class_\">MyReact</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">default</span> <span class=\"keyword\">function</span> <span class=\"title function_\">App</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> [count,setCount]=<span class=\"title function_\">useState</span>(<span class=\"number\">0</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (</span><br><span class=\"line\">        <span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">            <span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span>&#123;count&#125;<span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">            <span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">onClick</span>=<span class=\"string\">&#123;()</span>=&gt;</span>&#123;setCount(count+1)&#125;&#125;&gt;ADD +1<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"language-xml\">        <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span></span><br><span class=\"line\">    )</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>接下来，我们逐步分析源码。</p>\n<p>我们都知道，使用useState时需要传入一个init值，所以我们需要接收一个init值，通过createState这个函数，将init值保存在states数组中。在这里，需要做一个判断，如果不等于undefined时，将值设置为**states[stateIndex]**（防止重复初始化，因为render函数调用后，重新执行useState，我们需要保留render调用前的状态值）。</p>\n<p>在createStateSetters函数中，根据传入的newState值，返回顶一个setState。</p>\n<p>useState的第二个参数，有两种传参形式，一种是传入一个值，一种是传入一个函数，所以我们得需要typeof判断一下是否传入的参数是函数，如果是函数，我们就调用这个函数，并且将这个函数的返回值赋值给states[stateIndex]，如果不是函数，则直接将newState值赋值给states[stateIndex]。</p>\n<p>当我们执行一次useState函数值后，将stateIndex+1，确保下一次的useState函数可以正常的将state和setState存入到正确的数组位置。</p>\n<p>最后，我们需要在每一次的render函数调用时，将stateIndex重置为0，因为render函数调用后会重新执行useState。</p>\n"},{"title":"React15的三个Will生命周期为什么会在Fiber出现后被废弃","data":"2023/04/11 21-50","_content":"\n\n## 前言\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07b352c9afa74a6680f92c4f396ea7a4~tplv-k3u1fbpfcp-watermark.image?)\nReact16出现Fiber之后就废弃了React15中的三个Will生命周期钩子，并新推出两个生命周期钩子，具体原因我们得从生命周期和Fiber架构具体了解。\n\n###  React15生命周期\n\n在React15中，组件的生命周期分为三大类，组件挂载、组件更新、组件卸载。\n<img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a656a71c94af420881f275ee912c7613~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\n#### 组件挂载\n在组件挂载时，触发两个生命周期的钩子，分别是componentWillMount（组件挂载前）、componentDidMount（组件挂载后），一般的请求都放在componentDidMount中。\n\n#### 组件更新 \n在组件更新时，首先会调用componentWillReceiveProps这个生命周期钩子，那么这个生命周期钩子的执行时机是什么时候呢？如果我们从这个钩子的名字来看，当组件接收的props值发生改变时，这个生命周期钩子会执行，这样的答案对也不对，正确的执行时机应该是父组件重新渲染时，会调用这个钩子。\n\n其次，会根据shouldComponentUpdate这个钩子的返回值来判断是否更新，开发者也可以通过这个钩子来决定组件是否更新，随后就是componentWillUpdate和componentDidUpdate，分别是组件更新前和更新后的生命周期钩子\n\n#### 组件卸载\n在组件卸载时，会调用componentWillUnmount这个生命周期钩子\n\n### React16生命周期\n在React16中，组件的生命周期也分为三大类，组件挂载，组件更新，组件卸载，与React15不同的是因为Fiber的引入，删除了三个Will生命周期的钩子，引入了两个getDerivedStateFromProps和getSnapshotBeforeUpdate。\n\n<img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75d3c7a1b9e24f18b0d184dd22fa5d13~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\ngetDerivedStateFromProps 会在调用 render 方法之前调用，即在渲染 DOM 元素之前会调用，并且在初始挂载及后续更新时都会被调用。\n\n####  getDerivedStateFromProps\nstatic getDerivedStateFromProps(props, state)\n\nstate 的值在任何时候都取决于 props。\n\ngetDerivedStateFromProps 的存在只有一个目的：让组件在 props 变化时更新 state。\n\n该方法返回一个对象用于更新 state，如果返回 null 则不更新任何内容。\n\ngetDerivedStateFromProps是一个静态方法\n\n注意！！！\n\ngetDerivedStateFromProps不是componentWillMount的替代品，componentWillMount的存在不仅“鸡肋”而且危险，因此它不值得被“代替”，它就应该被废弃，getDerivedStateFromProps有且仅有一个用途：使用props来派生/更新state\n\nReact团队直接从命名层面约束了它的用途，getDerivedStateFromProps在更新和挂载两个阶段都会“出境”\n\ngetDerivedStateFromProps方法对state的更新动作并非“覆盖”式的更新，而是针对某个属性的定向更新\n\ngetDerivedStateFromProps是作为一个试图代替componentWillReceiveProps的API而出现的\n\ngetDerivedStateFromProps不能完全和componentWillReceiveProps划等号\n\n\n#### getSnapshotBeforeUpdate\n\ngetSnapshotBeforeUpdate() 方法在最近一次渲染输出（提交到 DOM 节点）之前调用。\n\n在 getSnapshotBeforeUpdate() 方法中，我们可以访问更新前的 props 和 state。\n\ngetSnapshotBeforeUpdate() 方法需要与 componentDidUpdate() 方法一起使用，否则会出现错误。\n\n## 为什么出现Fiber\n在React15中，因为使用的是不可打断stack Reconciler的同步渲染，所以当调和时间很长时间，就会导致Javascript线程长时间霸占主线程，进而导致渲染卡顿、卡死、交互时间长时间无响应等问题，所以React团队在React16做出了改变-Fiber\n\n### Fiber是如何解决问题的\n因为stack Reconciler是一个宏大的任务且是深度遍历，避免不了长时间霸占主线程，所以Fiber就将一个宏大的任务差分成许多工作单元，每个工作单元都有自己的优先级，每个工作单元都是可中断、可恢复的\n\n所以Fiber架构由原先的Reconciler、Renderer两层变为了Scheduler、Reconciler、Renderer三层\n\n![95a3b93cd26c70b77f0f6735020451c.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ba2f5c0f73743b4b7425dd0c3723a3b~tplv-k3u1fbpfcp-watermark.image?)\n\n![bd53e295df3871f70b3d51fb1ff7aa9.jpg](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e108b30b7fe74335ba6dd15e1e1010ab~tplv-k3u1fbpfcp-watermark.image?)\n\nFiber架构的应用目的是实现“增量渲染”\n\n实现增量渲染的目的，是为了实现任务的可中断，可恢复，并给不同的任务赋予不同的优先级，最终达成更加顺滑的用户体验\n\nFiber架构的重要特征就是可以被打断的异步渲染模式，Fiber架构的核心就是：可中断、可恢复与优先级，每个更新任务都会被赋予一个优先级，若发现B的优先级高于当前任务A的优先级，那么当前处于Reconciler层的A任务就会被打断，将B任务推进Reconciler层，当B任务调和完成时，根据优先级排序，A任务将会重新推入Reconciler层，继续它的渲染之旅，这便是可恢复。\n\n## 废弃三个Will钩子的原因\ncomponentWillMount、componentWillUpdate、componentWillReceiveProps这三个钩子常年被开发者滥用，是产生副作用的重灾区，在Fiber中，因为所有的工作单元都是可中断，可继续的，所以会导致这三个钩子重复调用，导致不可想象的局面，所以这三个钩子随着Fiber的出现废弃是必然的。\n\n","source":"_posts/React15的三个Will生命周期为什么会在Fiber出现后被废弃.md","raw":"---\ntitle: React15的三个Will生命周期为什么会在Fiber出现后被废弃\ndata: 2023/04/11 21-50\ntag: React\ncategory:\n - 前端\n---\n\n\n## 前言\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07b352c9afa74a6680f92c4f396ea7a4~tplv-k3u1fbpfcp-watermark.image?)\nReact16出现Fiber之后就废弃了React15中的三个Will生命周期钩子，并新推出两个生命周期钩子，具体原因我们得从生命周期和Fiber架构具体了解。\n\n###  React15生命周期\n\n在React15中，组件的生命周期分为三大类，组件挂载、组件更新、组件卸载。\n<img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a656a71c94af420881f275ee912c7613~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\n#### 组件挂载\n在组件挂载时，触发两个生命周期的钩子，分别是componentWillMount（组件挂载前）、componentDidMount（组件挂载后），一般的请求都放在componentDidMount中。\n\n#### 组件更新 \n在组件更新时，首先会调用componentWillReceiveProps这个生命周期钩子，那么这个生命周期钩子的执行时机是什么时候呢？如果我们从这个钩子的名字来看，当组件接收的props值发生改变时，这个生命周期钩子会执行，这样的答案对也不对，正确的执行时机应该是父组件重新渲染时，会调用这个钩子。\n\n其次，会根据shouldComponentUpdate这个钩子的返回值来判断是否更新，开发者也可以通过这个钩子来决定组件是否更新，随后就是componentWillUpdate和componentDidUpdate，分别是组件更新前和更新后的生命周期钩子\n\n#### 组件卸载\n在组件卸载时，会调用componentWillUnmount这个生命周期钩子\n\n### React16生命周期\n在React16中，组件的生命周期也分为三大类，组件挂载，组件更新，组件卸载，与React15不同的是因为Fiber的引入，删除了三个Will生命周期的钩子，引入了两个getDerivedStateFromProps和getSnapshotBeforeUpdate。\n\n<img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75d3c7a1b9e24f18b0d184dd22fa5d13~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\ngetDerivedStateFromProps 会在调用 render 方法之前调用，即在渲染 DOM 元素之前会调用，并且在初始挂载及后续更新时都会被调用。\n\n####  getDerivedStateFromProps\nstatic getDerivedStateFromProps(props, state)\n\nstate 的值在任何时候都取决于 props。\n\ngetDerivedStateFromProps 的存在只有一个目的：让组件在 props 变化时更新 state。\n\n该方法返回一个对象用于更新 state，如果返回 null 则不更新任何内容。\n\ngetDerivedStateFromProps是一个静态方法\n\n注意！！！\n\ngetDerivedStateFromProps不是componentWillMount的替代品，componentWillMount的存在不仅“鸡肋”而且危险，因此它不值得被“代替”，它就应该被废弃，getDerivedStateFromProps有且仅有一个用途：使用props来派生/更新state\n\nReact团队直接从命名层面约束了它的用途，getDerivedStateFromProps在更新和挂载两个阶段都会“出境”\n\ngetDerivedStateFromProps方法对state的更新动作并非“覆盖”式的更新，而是针对某个属性的定向更新\n\ngetDerivedStateFromProps是作为一个试图代替componentWillReceiveProps的API而出现的\n\ngetDerivedStateFromProps不能完全和componentWillReceiveProps划等号\n\n\n#### getSnapshotBeforeUpdate\n\ngetSnapshotBeforeUpdate() 方法在最近一次渲染输出（提交到 DOM 节点）之前调用。\n\n在 getSnapshotBeforeUpdate() 方法中，我们可以访问更新前的 props 和 state。\n\ngetSnapshotBeforeUpdate() 方法需要与 componentDidUpdate() 方法一起使用，否则会出现错误。\n\n## 为什么出现Fiber\n在React15中，因为使用的是不可打断stack Reconciler的同步渲染，所以当调和时间很长时间，就会导致Javascript线程长时间霸占主线程，进而导致渲染卡顿、卡死、交互时间长时间无响应等问题，所以React团队在React16做出了改变-Fiber\n\n### Fiber是如何解决问题的\n因为stack Reconciler是一个宏大的任务且是深度遍历，避免不了长时间霸占主线程，所以Fiber就将一个宏大的任务差分成许多工作单元，每个工作单元都有自己的优先级，每个工作单元都是可中断、可恢复的\n\n所以Fiber架构由原先的Reconciler、Renderer两层变为了Scheduler、Reconciler、Renderer三层\n\n![95a3b93cd26c70b77f0f6735020451c.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ba2f5c0f73743b4b7425dd0c3723a3b~tplv-k3u1fbpfcp-watermark.image?)\n\n![bd53e295df3871f70b3d51fb1ff7aa9.jpg](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e108b30b7fe74335ba6dd15e1e1010ab~tplv-k3u1fbpfcp-watermark.image?)\n\nFiber架构的应用目的是实现“增量渲染”\n\n实现增量渲染的目的，是为了实现任务的可中断，可恢复，并给不同的任务赋予不同的优先级，最终达成更加顺滑的用户体验\n\nFiber架构的重要特征就是可以被打断的异步渲染模式，Fiber架构的核心就是：可中断、可恢复与优先级，每个更新任务都会被赋予一个优先级，若发现B的优先级高于当前任务A的优先级，那么当前处于Reconciler层的A任务就会被打断，将B任务推进Reconciler层，当B任务调和完成时，根据优先级排序，A任务将会重新推入Reconciler层，继续它的渲染之旅，这便是可恢复。\n\n## 废弃三个Will钩子的原因\ncomponentWillMount、componentWillUpdate、componentWillReceiveProps这三个钩子常年被开发者滥用，是产生副作用的重灾区，在Fiber中，因为所有的工作单元都是可中断，可继续的，所以会导致这三个钩子重复调用，导致不可想象的局面，所以这三个钩子随着Fiber的出现废弃是必然的。\n\n","slug":"React15的三个Will生命周期为什么会在Fiber出现后被废弃","published":1,"date":"2023-05-28T11:44:29.802Z","updated":"2023-05-28T11:53:54.852Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksm000i0svh612t6iqy","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07b352c9afa74a6680f92c4f396ea7a4~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br>React16出现Fiber之后就废弃了React15中的三个Will生命周期钩子，并新推出两个生命周期钩子，具体原因我们得从生命周期和Fiber架构具体了解。</p>\n<h3 id=\"React15生命周期\"><a href=\"#React15生命周期\" class=\"headerlink\" title=\"React15生命周期\"></a>React15生命周期</h3><p>在React15中，组件的生命周期分为三大类，组件挂载、组件更新、组件卸载。<br><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a656a71c94af420881f275ee912c7613~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" /></p>\n<h4 id=\"组件挂载\"><a href=\"#组件挂载\" class=\"headerlink\" title=\"组件挂载\"></a>组件挂载</h4><p>在组件挂载时，触发两个生命周期的钩子，分别是componentWillMount（组件挂载前）、componentDidMount（组件挂载后），一般的请求都放在componentDidMount中。</p>\n<h4 id=\"组件更新\"><a href=\"#组件更新\" class=\"headerlink\" title=\"组件更新\"></a>组件更新</h4><p>在组件更新时，首先会调用componentWillReceiveProps这个生命周期钩子，那么这个生命周期钩子的执行时机是什么时候呢？如果我们从这个钩子的名字来看，当组件接收的props值发生改变时，这个生命周期钩子会执行，这样的答案对也不对，正确的执行时机应该是父组件重新渲染时，会调用这个钩子。</p>\n<p>其次，会根据shouldComponentUpdate这个钩子的返回值来判断是否更新，开发者也可以通过这个钩子来决定组件是否更新，随后就是componentWillUpdate和componentDidUpdate，分别是组件更新前和更新后的生命周期钩子</p>\n<h4 id=\"组件卸载\"><a href=\"#组件卸载\" class=\"headerlink\" title=\"组件卸载\"></a>组件卸载</h4><p>在组件卸载时，会调用componentWillUnmount这个生命周期钩子</p>\n<h3 id=\"React16生命周期\"><a href=\"#React16生命周期\" class=\"headerlink\" title=\"React16生命周期\"></a>React16生命周期</h3><p>在React16中，组件的生命周期也分为三大类，组件挂载，组件更新，组件卸载，与React15不同的是因为Fiber的引入，删除了三个Will生命周期的钩子，引入了两个getDerivedStateFromProps和getSnapshotBeforeUpdate。</p>\n<img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75d3c7a1b9e24f18b0d184dd22fa5d13~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\n<p>getDerivedStateFromProps 会在调用 render 方法之前调用，即在渲染 DOM 元素之前会调用，并且在初始挂载及后续更新时都会被调用。</p>\n<h4 id=\"getDerivedStateFromProps\"><a href=\"#getDerivedStateFromProps\" class=\"headerlink\" title=\"getDerivedStateFromProps\"></a>getDerivedStateFromProps</h4><p>static getDerivedStateFromProps(props, state)</p>\n<p>state 的值在任何时候都取决于 props。</p>\n<p>getDerivedStateFromProps 的存在只有一个目的：让组件在 props 变化时更新 state。</p>\n<p>该方法返回一个对象用于更新 state，如果返回 null 则不更新任何内容。</p>\n<p>getDerivedStateFromProps是一个静态方法</p>\n<p>注意！！！</p>\n<p>getDerivedStateFromProps不是componentWillMount的替代品，componentWillMount的存在不仅“鸡肋”而且危险，因此它不值得被“代替”，它就应该被废弃，getDerivedStateFromProps有且仅有一个用途：使用props来派生&#x2F;更新state</p>\n<p>React团队直接从命名层面约束了它的用途，getDerivedStateFromProps在更新和挂载两个阶段都会“出境”</p>\n<p>getDerivedStateFromProps方法对state的更新动作并非“覆盖”式的更新，而是针对某个属性的定向更新</p>\n<p>getDerivedStateFromProps是作为一个试图代替componentWillReceiveProps的API而出现的</p>\n<p>getDerivedStateFromProps不能完全和componentWillReceiveProps划等号</p>\n<h4 id=\"getSnapshotBeforeUpdate\"><a href=\"#getSnapshotBeforeUpdate\" class=\"headerlink\" title=\"getSnapshotBeforeUpdate\"></a>getSnapshotBeforeUpdate</h4><p>getSnapshotBeforeUpdate() 方法在最近一次渲染输出（提交到 DOM 节点）之前调用。</p>\n<p>在 getSnapshotBeforeUpdate() 方法中，我们可以访问更新前的 props 和 state。</p>\n<p>getSnapshotBeforeUpdate() 方法需要与 componentDidUpdate() 方法一起使用，否则会出现错误。</p>\n<h2 id=\"为什么出现Fiber\"><a href=\"#为什么出现Fiber\" class=\"headerlink\" title=\"为什么出现Fiber\"></a>为什么出现Fiber</h2><p>在React15中，因为使用的是不可打断stack Reconciler的同步渲染，所以当调和时间很长时间，就会导致Javascript线程长时间霸占主线程，进而导致渲染卡顿、卡死、交互时间长时间无响应等问题，所以React团队在React16做出了改变-Fiber</p>\n<h3 id=\"Fiber是如何解决问题的\"><a href=\"#Fiber是如何解决问题的\" class=\"headerlink\" title=\"Fiber是如何解决问题的\"></a>Fiber是如何解决问题的</h3><p>因为stack Reconciler是一个宏大的任务且是深度遍历，避免不了长时间霸占主线程，所以Fiber就将一个宏大的任务差分成许多工作单元，每个工作单元都有自己的优先级，每个工作单元都是可中断、可恢复的</p>\n<p>所以Fiber架构由原先的Reconciler、Renderer两层变为了Scheduler、Reconciler、Renderer三层</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ba2f5c0f73743b4b7425dd0c3723a3b~tplv-k3u1fbpfcp-watermark.image\" alt=\"95a3b93cd26c70b77f0f6735020451c.jpg\"></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e108b30b7fe74335ba6dd15e1e1010ab~tplv-k3u1fbpfcp-watermark.image\" alt=\"bd53e295df3871f70b3d51fb1ff7aa9.jpg\"></p>\n<p>Fiber架构的应用目的是实现“增量渲染”</p>\n<p>实现增量渲染的目的，是为了实现任务的可中断，可恢复，并给不同的任务赋予不同的优先级，最终达成更加顺滑的用户体验</p>\n<p>Fiber架构的重要特征就是可以被打断的异步渲染模式，Fiber架构的核心就是：可中断、可恢复与优先级，每个更新任务都会被赋予一个优先级，若发现B的优先级高于当前任务A的优先级，那么当前处于Reconciler层的A任务就会被打断，将B任务推进Reconciler层，当B任务调和完成时，根据优先级排序，A任务将会重新推入Reconciler层，继续它的渲染之旅，这便是可恢复。</p>\n<h2 id=\"废弃三个Will钩子的原因\"><a href=\"#废弃三个Will钩子的原因\" class=\"headerlink\" title=\"废弃三个Will钩子的原因\"></a>废弃三个Will钩子的原因</h2><p>componentWillMount、componentWillUpdate、componentWillReceiveProps这三个钩子常年被开发者滥用，是产生副作用的重灾区，在Fiber中，因为所有的工作单元都是可中断，可继续的，所以会导致这三个钩子重复调用，导致不可想象的局面，所以这三个钩子随着Fiber的出现废弃是必然的。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07b352c9afa74a6680f92c4f396ea7a4~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br>React16出现Fiber之后就废弃了React15中的三个Will生命周期钩子，并新推出两个生命周期钩子，具体原因我们得从生命周期和Fiber架构具体了解。</p>\n<h3 id=\"React15生命周期\"><a href=\"#React15生命周期\" class=\"headerlink\" title=\"React15生命周期\"></a>React15生命周期</h3><p>在React15中，组件的生命周期分为三大类，组件挂载、组件更新、组件卸载。<br><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a656a71c94af420881f275ee912c7613~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" /></p>\n<h4 id=\"组件挂载\"><a href=\"#组件挂载\" class=\"headerlink\" title=\"组件挂载\"></a>组件挂载</h4><p>在组件挂载时，触发两个生命周期的钩子，分别是componentWillMount（组件挂载前）、componentDidMount（组件挂载后），一般的请求都放在componentDidMount中。</p>\n<h4 id=\"组件更新\"><a href=\"#组件更新\" class=\"headerlink\" title=\"组件更新\"></a>组件更新</h4><p>在组件更新时，首先会调用componentWillReceiveProps这个生命周期钩子，那么这个生命周期钩子的执行时机是什么时候呢？如果我们从这个钩子的名字来看，当组件接收的props值发生改变时，这个生命周期钩子会执行，这样的答案对也不对，正确的执行时机应该是父组件重新渲染时，会调用这个钩子。</p>\n<p>其次，会根据shouldComponentUpdate这个钩子的返回值来判断是否更新，开发者也可以通过这个钩子来决定组件是否更新，随后就是componentWillUpdate和componentDidUpdate，分别是组件更新前和更新后的生命周期钩子</p>\n<h4 id=\"组件卸载\"><a href=\"#组件卸载\" class=\"headerlink\" title=\"组件卸载\"></a>组件卸载</h4><p>在组件卸载时，会调用componentWillUnmount这个生命周期钩子</p>\n<h3 id=\"React16生命周期\"><a href=\"#React16生命周期\" class=\"headerlink\" title=\"React16生命周期\"></a>React16生命周期</h3><p>在React16中，组件的生命周期也分为三大类，组件挂载，组件更新，组件卸载，与React15不同的是因为Fiber的引入，删除了三个Will生命周期的钩子，引入了两个getDerivedStateFromProps和getSnapshotBeforeUpdate。</p>\n<img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/75d3c7a1b9e24f18b0d184dd22fa5d13~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\n\n<p>getDerivedStateFromProps 会在调用 render 方法之前调用，即在渲染 DOM 元素之前会调用，并且在初始挂载及后续更新时都会被调用。</p>\n<h4 id=\"getDerivedStateFromProps\"><a href=\"#getDerivedStateFromProps\" class=\"headerlink\" title=\"getDerivedStateFromProps\"></a>getDerivedStateFromProps</h4><p>static getDerivedStateFromProps(props, state)</p>\n<p>state 的值在任何时候都取决于 props。</p>\n<p>getDerivedStateFromProps 的存在只有一个目的：让组件在 props 变化时更新 state。</p>\n<p>该方法返回一个对象用于更新 state，如果返回 null 则不更新任何内容。</p>\n<p>getDerivedStateFromProps是一个静态方法</p>\n<p>注意！！！</p>\n<p>getDerivedStateFromProps不是componentWillMount的替代品，componentWillMount的存在不仅“鸡肋”而且危险，因此它不值得被“代替”，它就应该被废弃，getDerivedStateFromProps有且仅有一个用途：使用props来派生&#x2F;更新state</p>\n<p>React团队直接从命名层面约束了它的用途，getDerivedStateFromProps在更新和挂载两个阶段都会“出境”</p>\n<p>getDerivedStateFromProps方法对state的更新动作并非“覆盖”式的更新，而是针对某个属性的定向更新</p>\n<p>getDerivedStateFromProps是作为一个试图代替componentWillReceiveProps的API而出现的</p>\n<p>getDerivedStateFromProps不能完全和componentWillReceiveProps划等号</p>\n<h4 id=\"getSnapshotBeforeUpdate\"><a href=\"#getSnapshotBeforeUpdate\" class=\"headerlink\" title=\"getSnapshotBeforeUpdate\"></a>getSnapshotBeforeUpdate</h4><p>getSnapshotBeforeUpdate() 方法在最近一次渲染输出（提交到 DOM 节点）之前调用。</p>\n<p>在 getSnapshotBeforeUpdate() 方法中，我们可以访问更新前的 props 和 state。</p>\n<p>getSnapshotBeforeUpdate() 方法需要与 componentDidUpdate() 方法一起使用，否则会出现错误。</p>\n<h2 id=\"为什么出现Fiber\"><a href=\"#为什么出现Fiber\" class=\"headerlink\" title=\"为什么出现Fiber\"></a>为什么出现Fiber</h2><p>在React15中，因为使用的是不可打断stack Reconciler的同步渲染，所以当调和时间很长时间，就会导致Javascript线程长时间霸占主线程，进而导致渲染卡顿、卡死、交互时间长时间无响应等问题，所以React团队在React16做出了改变-Fiber</p>\n<h3 id=\"Fiber是如何解决问题的\"><a href=\"#Fiber是如何解决问题的\" class=\"headerlink\" title=\"Fiber是如何解决问题的\"></a>Fiber是如何解决问题的</h3><p>因为stack Reconciler是一个宏大的任务且是深度遍历，避免不了长时间霸占主线程，所以Fiber就将一个宏大的任务差分成许多工作单元，每个工作单元都有自己的优先级，每个工作单元都是可中断、可恢复的</p>\n<p>所以Fiber架构由原先的Reconciler、Renderer两层变为了Scheduler、Reconciler、Renderer三层</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ba2f5c0f73743b4b7425dd0c3723a3b~tplv-k3u1fbpfcp-watermark.image\" alt=\"95a3b93cd26c70b77f0f6735020451c.jpg\"></p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e108b30b7fe74335ba6dd15e1e1010ab~tplv-k3u1fbpfcp-watermark.image\" alt=\"bd53e295df3871f70b3d51fb1ff7aa9.jpg\"></p>\n<p>Fiber架构的应用目的是实现“增量渲染”</p>\n<p>实现增量渲染的目的，是为了实现任务的可中断，可恢复，并给不同的任务赋予不同的优先级，最终达成更加顺滑的用户体验</p>\n<p>Fiber架构的重要特征就是可以被打断的异步渲染模式，Fiber架构的核心就是：可中断、可恢复与优先级，每个更新任务都会被赋予一个优先级，若发现B的优先级高于当前任务A的优先级，那么当前处于Reconciler层的A任务就会被打断，将B任务推进Reconciler层，当B任务调和完成时，根据优先级排序，A任务将会重新推入Reconciler层，继续它的渲染之旅，这便是可恢复。</p>\n<h2 id=\"废弃三个Will钩子的原因\"><a href=\"#废弃三个Will钩子的原因\" class=\"headerlink\" title=\"废弃三个Will钩子的原因\"></a>废弃三个Will钩子的原因</h2><p>componentWillMount、componentWillUpdate、componentWillReceiveProps这三个钩子常年被开发者滥用，是产生副作用的重灾区，在Fiber中，因为所有的工作单元都是可中断，可继续的，所以会导致这三个钩子重复调用，导致不可想象的局面，所以这三个钩子随着Fiber的出现废弃是必然的。</p>\n"},{"title":"React中使用Hooks的正确姿势","date":"2023-05-28T11:47:06.808Z","_content":"\n## 前言\n\n<img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5678f6490cc347fa9f71c0272caf27eb~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\nHooks是React为函数式组件提供的工具箱，可以由开发者自由搭配，这也是React的函数式组件轻量的原因。\n\nClass组件固然好，但是用于解决小规模问题，犹如大炮打蚊子，太过于繁重，函数式组件的出现，就解决了这一问题。\n\n所以就Hooks而言对函数式组件的重要是不言而喻的。\n\n现如今React官方也推崇函数式组件，React的理念就是吃进数据吐出视图（数据驱动视图），函数式组件正好印证了这一点。\n\n下面就由我来总结一下在React函数式组件中使用Hooks的正确姿势。\n\n## useState\n**为函数式组件解决了无法实现管理状态的缺点**\n\n1. 不可以在**循环/判断**语句中使用，因为useState的底层实现是以链表的形式实现，更新是以批量更新的方式去更新，如果在**循环和/判断语句中去使用**会破坏链表的更新顺序，使得更新混淆等问题。\n2. useState是异步更新（只要state还在React的掌控之中就是异步更新的，SetTimeout会帮助state逃脱React的掌控），如果需要同步更新请使用**flushSync**这个官方推出的API（非必要不建议同步更新），因为每一次的state更新就去改变视图，则会频繁更新，浪费性能，React在每一次的state更新时，暂存这个state，当state改变完时，则会去完成批量更新。\n\n## useEffect和useLayoutEffect\n**为函数式组件解决了没有生命周期的缺点（可以模拟生命周期）**\n1. 主要模拟三个生命周期，componentDidMount（组件挂载后，第二个参数为[]）、componentDidUpdate（组件更新后，第二个参数为[需要监听的属性值]）、componentDidUnmount（组件销毁后，通过return返回函数）\n2. 第二个参数为浅层比较，不要传递对象进行比较。\n3. useLayoutEffect的出现顾名思义就是为了解决布局而出现的，它的触发时机在DOM更新之前获取DOM元素并且执行，所以它是同步渲染的。\n4. useEffect，它的触发时机是DOM更新之后获取DOM元素并且执行，所以它是异步渲染的，React官方推荐我们在useEffect解决不了的场景下再去使用useLayoutEffect，但是我们需要明白，两个Hooks的执行时机不同，并且时间也不同，一个是异步渲染，一个是同步渲染。\n5. 一般向后端发送请求时，常常使用useEffect模拟componentDidMount这个生命周期去发送请求。\n\n## useCallback\n**为函数式组件提供缓存函数的功能**\n1. 当我们使用React.memo缓存组件时，如果我们用父组件向这个子组件传递了一个函数，因为函数是引用数据类型，当父组件每一次更新时，这个函数的引用都会改变，所以这个时候我们就需要去用useCallBack缓存这个函数搭配React.memo避免子组件重复渲染。\n2. 同样，第二个参数为浅层比较，不要传递对象进行比较。\n\n## useMemo\n**为函数式组件提供缓存数据的功能**\n1. 当我们通过属性计算出一个属性时，我们可以使用useMemo这个Hooks缓存这个计算出的属性，避免组件刷新时，重复计算，达到性能优化的作用。\n2. 同样，第二个参数为浅层比较，不要传递对象进行比较。\n\n## 函数式组件需要避免的问题\n因为函数式组件每一次渲染都会重新执行，所以需要将常量放到函数外部，避免重复定义，浪费性能，如果定义的是一个常量函数，且需要用到函数内部的变量做计算，那么一定要用到useCallback缓存这个函数。\n\n### React.memo VS React.useMemo\nReact.memo是一个高阶组件，它的作用类似于React.pureComponent，但在Hooks的场景下，更推荐使用React.useMemo。\n\n可以通过分拆组件的方式阻断重渲染，但使用React.useMemo可以实现更精细化的控制。\n\n考虑到更宽广的使用场景和维护性，推荐使用React.useMemo。\n","source":"_posts/React中使用Hooks的正确姿势.md","raw":"---\ntitle: React中使用Hooks的正确姿势\ndate: 2023/05/17 22-59\ntag: React\ncategory:\n - 前端\n---\n\n## 前言\n\n<img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5678f6490cc347fa9f71c0272caf27eb~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\nHooks是React为函数式组件提供的工具箱，可以由开发者自由搭配，这也是React的函数式组件轻量的原因。\n\nClass组件固然好，但是用于解决小规模问题，犹如大炮打蚊子，太过于繁重，函数式组件的出现，就解决了这一问题。\n\n所以就Hooks而言对函数式组件的重要是不言而喻的。\n\n现如今React官方也推崇函数式组件，React的理念就是吃进数据吐出视图（数据驱动视图），函数式组件正好印证了这一点。\n\n下面就由我来总结一下在React函数式组件中使用Hooks的正确姿势。\n\n## useState\n**为函数式组件解决了无法实现管理状态的缺点**\n\n1. 不可以在**循环/判断**语句中使用，因为useState的底层实现是以链表的形式实现，更新是以批量更新的方式去更新，如果在**循环和/判断语句中去使用**会破坏链表的更新顺序，使得更新混淆等问题。\n2. useState是异步更新（只要state还在React的掌控之中就是异步更新的，SetTimeout会帮助state逃脱React的掌控），如果需要同步更新请使用**flushSync**这个官方推出的API（非必要不建议同步更新），因为每一次的state更新就去改变视图，则会频繁更新，浪费性能，React在每一次的state更新时，暂存这个state，当state改变完时，则会去完成批量更新。\n\n## useEffect和useLayoutEffect\n**为函数式组件解决了没有生命周期的缺点（可以模拟生命周期）**\n1. 主要模拟三个生命周期，componentDidMount（组件挂载后，第二个参数为[]）、componentDidUpdate（组件更新后，第二个参数为[需要监听的属性值]）、componentDidUnmount（组件销毁后，通过return返回函数）\n2. 第二个参数为浅层比较，不要传递对象进行比较。\n3. useLayoutEffect的出现顾名思义就是为了解决布局而出现的，它的触发时机在DOM更新之前获取DOM元素并且执行，所以它是同步渲染的。\n4. useEffect，它的触发时机是DOM更新之后获取DOM元素并且执行，所以它是异步渲染的，React官方推荐我们在useEffect解决不了的场景下再去使用useLayoutEffect，但是我们需要明白，两个Hooks的执行时机不同，并且时间也不同，一个是异步渲染，一个是同步渲染。\n5. 一般向后端发送请求时，常常使用useEffect模拟componentDidMount这个生命周期去发送请求。\n\n## useCallback\n**为函数式组件提供缓存函数的功能**\n1. 当我们使用React.memo缓存组件时，如果我们用父组件向这个子组件传递了一个函数，因为函数是引用数据类型，当父组件每一次更新时，这个函数的引用都会改变，所以这个时候我们就需要去用useCallBack缓存这个函数搭配React.memo避免子组件重复渲染。\n2. 同样，第二个参数为浅层比较，不要传递对象进行比较。\n\n## useMemo\n**为函数式组件提供缓存数据的功能**\n1. 当我们通过属性计算出一个属性时，我们可以使用useMemo这个Hooks缓存这个计算出的属性，避免组件刷新时，重复计算，达到性能优化的作用。\n2. 同样，第二个参数为浅层比较，不要传递对象进行比较。\n\n## 函数式组件需要避免的问题\n因为函数式组件每一次渲染都会重新执行，所以需要将常量放到函数外部，避免重复定义，浪费性能，如果定义的是一个常量函数，且需要用到函数内部的变量做计算，那么一定要用到useCallback缓存这个函数。\n\n### React.memo VS React.useMemo\nReact.memo是一个高阶组件，它的作用类似于React.pureComponent，但在Hooks的场景下，更推荐使用React.useMemo。\n\n可以通过分拆组件的方式阻断重渲染，但使用React.useMemo可以实现更精细化的控制。\n\n考虑到更宽广的使用场景和维护性，推荐使用React.useMemo。\n","slug":"React中使用Hooks的正确姿势","published":1,"updated":"2023-05-28T11:54:50.817Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksn000l0svh74yd1zd3","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5678f6490cc347fa9f71c0272caf27eb~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\nHooks是React为函数式组件提供的工具箱，可以由开发者自由搭配，这也是React的函数式组件轻量的原因。\n\n<p>Class组件固然好，但是用于解决小规模问题，犹如大炮打蚊子，太过于繁重，函数式组件的出现，就解决了这一问题。</p>\n<p>所以就Hooks而言对函数式组件的重要是不言而喻的。</p>\n<p>现如今React官方也推崇函数式组件，React的理念就是吃进数据吐出视图（数据驱动视图），函数式组件正好印证了这一点。</p>\n<p>下面就由我来总结一下在React函数式组件中使用Hooks的正确姿势。</p>\n<h2 id=\"useState\"><a href=\"#useState\" class=\"headerlink\" title=\"useState\"></a>useState</h2><p><strong>为函数式组件解决了无法实现管理状态的缺点</strong></p>\n<ol>\n<li>不可以在<strong>循环&#x2F;判断</strong>语句中使用，因为useState的底层实现是以链表的形式实现，更新是以批量更新的方式去更新，如果在<strong>循环和&#x2F;判断语句中去使用</strong>会破坏链表的更新顺序，使得更新混淆等问题。</li>\n<li>useState是异步更新（只要state还在React的掌控之中就是异步更新的，SetTimeout会帮助state逃脱React的掌控），如果需要同步更新请使用<strong>flushSync</strong>这个官方推出的API（非必要不建议同步更新），因为每一次的state更新就去改变视图，则会频繁更新，浪费性能，React在每一次的state更新时，暂存这个state，当state改变完时，则会去完成批量更新。</li>\n</ol>\n<h2 id=\"useEffect和useLayoutEffect\"><a href=\"#useEffect和useLayoutEffect\" class=\"headerlink\" title=\"useEffect和useLayoutEffect\"></a>useEffect和useLayoutEffect</h2><p><strong>为函数式组件解决了没有生命周期的缺点（可以模拟生命周期）</strong></p>\n<ol>\n<li>主要模拟三个生命周期，componentDidMount（组件挂载后，第二个参数为[]）、componentDidUpdate（组件更新后，第二个参数为[需要监听的属性值]）、componentDidUnmount（组件销毁后，通过return返回函数）</li>\n<li>第二个参数为浅层比较，不要传递对象进行比较。</li>\n<li>useLayoutEffect的出现顾名思义就是为了解决布局而出现的，它的触发时机在DOM更新之前获取DOM元素并且执行，所以它是同步渲染的。</li>\n<li>useEffect，它的触发时机是DOM更新之后获取DOM元素并且执行，所以它是异步渲染的，React官方推荐我们在useEffect解决不了的场景下再去使用useLayoutEffect，但是我们需要明白，两个Hooks的执行时机不同，并且时间也不同，一个是异步渲染，一个是同步渲染。</li>\n<li>一般向后端发送请求时，常常使用useEffect模拟componentDidMount这个生命周期去发送请求。</li>\n</ol>\n<h2 id=\"useCallback\"><a href=\"#useCallback\" class=\"headerlink\" title=\"useCallback\"></a>useCallback</h2><p><strong>为函数式组件提供缓存函数的功能</strong></p>\n<ol>\n<li>当我们使用React.memo缓存组件时，如果我们用父组件向这个子组件传递了一个函数，因为函数是引用数据类型，当父组件每一次更新时，这个函数的引用都会改变，所以这个时候我们就需要去用useCallBack缓存这个函数搭配React.memo避免子组件重复渲染。</li>\n<li>同样，第二个参数为浅层比较，不要传递对象进行比较。</li>\n</ol>\n<h2 id=\"useMemo\"><a href=\"#useMemo\" class=\"headerlink\" title=\"useMemo\"></a>useMemo</h2><p><strong>为函数式组件提供缓存数据的功能</strong></p>\n<ol>\n<li>当我们通过属性计算出一个属性时，我们可以使用useMemo这个Hooks缓存这个计算出的属性，避免组件刷新时，重复计算，达到性能优化的作用。</li>\n<li>同样，第二个参数为浅层比较，不要传递对象进行比较。</li>\n</ol>\n<h2 id=\"函数式组件需要避免的问题\"><a href=\"#函数式组件需要避免的问题\" class=\"headerlink\" title=\"函数式组件需要避免的问题\"></a>函数式组件需要避免的问题</h2><p>因为函数式组件每一次渲染都会重新执行，所以需要将常量放到函数外部，避免重复定义，浪费性能，如果定义的是一个常量函数，且需要用到函数内部的变量做计算，那么一定要用到useCallback缓存这个函数。</p>\n<h3 id=\"React-memo-VS-React-useMemo\"><a href=\"#React-memo-VS-React-useMemo\" class=\"headerlink\" title=\"React.memo VS React.useMemo\"></a>React.memo VS React.useMemo</h3><p>React.memo是一个高阶组件，它的作用类似于React.pureComponent，但在Hooks的场景下，更推荐使用React.useMemo。</p>\n<p>可以通过分拆组件的方式阻断重渲染，但使用React.useMemo可以实现更精细化的控制。</p>\n<p>考虑到更宽广的使用场景和维护性，推荐使用React.useMemo。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5678f6490cc347fa9f71c0272caf27eb~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\" />\nHooks是React为函数式组件提供的工具箱，可以由开发者自由搭配，这也是React的函数式组件轻量的原因。\n\n<p>Class组件固然好，但是用于解决小规模问题，犹如大炮打蚊子，太过于繁重，函数式组件的出现，就解决了这一问题。</p>\n<p>所以就Hooks而言对函数式组件的重要是不言而喻的。</p>\n<p>现如今React官方也推崇函数式组件，React的理念就是吃进数据吐出视图（数据驱动视图），函数式组件正好印证了这一点。</p>\n<p>下面就由我来总结一下在React函数式组件中使用Hooks的正确姿势。</p>\n<h2 id=\"useState\"><a href=\"#useState\" class=\"headerlink\" title=\"useState\"></a>useState</h2><p><strong>为函数式组件解决了无法实现管理状态的缺点</strong></p>\n<ol>\n<li>不可以在<strong>循环&#x2F;判断</strong>语句中使用，因为useState的底层实现是以链表的形式实现，更新是以批量更新的方式去更新，如果在<strong>循环和&#x2F;判断语句中去使用</strong>会破坏链表的更新顺序，使得更新混淆等问题。</li>\n<li>useState是异步更新（只要state还在React的掌控之中就是异步更新的，SetTimeout会帮助state逃脱React的掌控），如果需要同步更新请使用<strong>flushSync</strong>这个官方推出的API（非必要不建议同步更新），因为每一次的state更新就去改变视图，则会频繁更新，浪费性能，React在每一次的state更新时，暂存这个state，当state改变完时，则会去完成批量更新。</li>\n</ol>\n<h2 id=\"useEffect和useLayoutEffect\"><a href=\"#useEffect和useLayoutEffect\" class=\"headerlink\" title=\"useEffect和useLayoutEffect\"></a>useEffect和useLayoutEffect</h2><p><strong>为函数式组件解决了没有生命周期的缺点（可以模拟生命周期）</strong></p>\n<ol>\n<li>主要模拟三个生命周期，componentDidMount（组件挂载后，第二个参数为[]）、componentDidUpdate（组件更新后，第二个参数为[需要监听的属性值]）、componentDidUnmount（组件销毁后，通过return返回函数）</li>\n<li>第二个参数为浅层比较，不要传递对象进行比较。</li>\n<li>useLayoutEffect的出现顾名思义就是为了解决布局而出现的，它的触发时机在DOM更新之前获取DOM元素并且执行，所以它是同步渲染的。</li>\n<li>useEffect，它的触发时机是DOM更新之后获取DOM元素并且执行，所以它是异步渲染的，React官方推荐我们在useEffect解决不了的场景下再去使用useLayoutEffect，但是我们需要明白，两个Hooks的执行时机不同，并且时间也不同，一个是异步渲染，一个是同步渲染。</li>\n<li>一般向后端发送请求时，常常使用useEffect模拟componentDidMount这个生命周期去发送请求。</li>\n</ol>\n<h2 id=\"useCallback\"><a href=\"#useCallback\" class=\"headerlink\" title=\"useCallback\"></a>useCallback</h2><p><strong>为函数式组件提供缓存函数的功能</strong></p>\n<ol>\n<li>当我们使用React.memo缓存组件时，如果我们用父组件向这个子组件传递了一个函数，因为函数是引用数据类型，当父组件每一次更新时，这个函数的引用都会改变，所以这个时候我们就需要去用useCallBack缓存这个函数搭配React.memo避免子组件重复渲染。</li>\n<li>同样，第二个参数为浅层比较，不要传递对象进行比较。</li>\n</ol>\n<h2 id=\"useMemo\"><a href=\"#useMemo\" class=\"headerlink\" title=\"useMemo\"></a>useMemo</h2><p><strong>为函数式组件提供缓存数据的功能</strong></p>\n<ol>\n<li>当我们通过属性计算出一个属性时，我们可以使用useMemo这个Hooks缓存这个计算出的属性，避免组件刷新时，重复计算，达到性能优化的作用。</li>\n<li>同样，第二个参数为浅层比较，不要传递对象进行比较。</li>\n</ol>\n<h2 id=\"函数式组件需要避免的问题\"><a href=\"#函数式组件需要避免的问题\" class=\"headerlink\" title=\"函数式组件需要避免的问题\"></a>函数式组件需要避免的问题</h2><p>因为函数式组件每一次渲染都会重新执行，所以需要将常量放到函数外部，避免重复定义，浪费性能，如果定义的是一个常量函数，且需要用到函数内部的变量做计算，那么一定要用到useCallback缓存这个函数。</p>\n<h3 id=\"React-memo-VS-React-useMemo\"><a href=\"#React-memo-VS-React-useMemo\" class=\"headerlink\" title=\"React.memo VS React.useMemo\"></a>React.memo VS React.useMemo</h3><p>React.memo是一个高阶组件，它的作用类似于React.pureComponent，但在Hooks的场景下，更推荐使用React.useMemo。</p>\n<p>可以通过分拆组件的方式阻断重渲染，但使用React.useMemo可以实现更精细化的控制。</p>\n<p>考虑到更宽广的使用场景和维护性，推荐使用React.useMemo。</p>\n"},{"title":"H5端中遇到的手势滑动问题——封装useSwipe Hooks","date":"2023-02-21T12:24:00.000Z","_content":"\n\n**在做H5端页面时，避免不了遇到手势滑动问题，就此问题，我封装了一个Hooks（useSwipe）来解决这个问题，下面，我将一步步讲解useSwipe的封装过程**\n\n**下述源码引用了部分Vue的核心API，用Jsx语法编写**\n**全部代码均为TypeScript编写**\n## 完整源码\n```tsx\nimport { computed, onMounted,onUnmounted,Ref,ref } from \"vue\";\n\ntype Point={\n    x:number,\n    y:number\n}\n\ninterface Options{\n    beforeStart?:(e:TouchEvent)=> void\n    beforeMove?:(e:TouchEvent)=> void\n    beforeEnd?:(e:TouchEvent)=> void\n    afterStart?:(e:TouchEvent)=> void\n    afterMove?:(e:TouchEvent)=> void\n    afterEnd?:(e:TouchEvent)=> void\n}\nexport const useSwipe=(element:Ref<HTMLElement | undefined>,options?:Options)=>{\n    const start =ref<Point>()\n    const end =ref<Point>()\n    const swipeing=ref(false)\n\n    const distance=computed(()=>{\n        if(!start.value || !end.value){ return undefined}\n        return{\n            x:end.value.x-start.value.x,\n            y:end.value.y-start.value.y\n        }\n    })\n\n    const direction=computed(()=>{\n        if(!swipeing.value){return \"\"}\n        if(!distance.value){return \"\"}\n        const { x , y } =distance.value\n        if(Math.abs(x)>Math.abs(y)){\n            return x>0? \"right\" : \"left\"\n        }\n        else{\n            return y>0? \"down\" : \"up\"\n        }\n    })\n    const onStart=(e:TouchEvent)=>{\n        options?.beforeStart?.(e)\n        start.value={\n            x:e.touches[0].clientX,\n            y:e.touches[0].clientY\n        }\n        options?.afterStart?.(e)\n    }\n    const onMove=(e:TouchEvent)=>{\n        options?.beforeMove?.(e)\n        end.value={\n            x:e.touches[0].clientX,\n            y:e.touches[0].clientY\n        }\n        swipeing.value=true\n        options?.afterMove?.(e)\n    }\n    const onEnd=(e:TouchEvent)=>{\n        options?.beforeEnd?.(e)\n        swipeing.value=false\n        options?.afterEnd?.(e)\n    }\n    onMounted(()=>{\n        element.value?.addEventListener(\"touchstart\",onStart)\n        element.value?.addEventListener(\"touchmove\",onMove)\n        element.value?.addEventListener(\"touchend\",onEnd)\n    })\n    onUnmounted(()=>{\n        element.value?.removeEventListener(\"touchstart\",onStart)\n        element.value?.removeEventListener(\"touchmove\",onMove)\n        element.value?.removeEventListener(\"touchend\",onEnd)\n    })\n\n    return {\n        swipeing ,distance,direction \n    }\n}\n```\n## 核心思路\n**1. 当用户点击屏幕时，记录此时点击的屏幕坐标，当用户移动时，记录移动过程中的屏幕坐标，最后做差，即可判别用户的滑动行为**\n**2. 同时需要return出相应的参数，例如distance（屏幕坐标的差值）、direction（用户的滑动行为）、swipeing（用户是否在滑动中）**\n## 代码编写\n**首先我们得声明记录屏幕坐标的类型Point，Point类型中有x坐标和y坐标，均为number类型，代码如下**\n```tsx\ntype Point={x:number,y:number}\n```\n**接下来，useSwipe函数需要接受那些参数呢？这个时候，我们就要明白，useSwipe是指定用户在规定的DOM元素中的手势滑动行为，所以useSwipe需要接受一个HTML元素，我们也可以规定一个不定参数去接收对应的函数，去增加useSwipe的可扩展性。**\n```tsx\nconst useSwipe=(element:Ref<HTMLElement | undefined>,options?:Options)=>{}\n```\n**注意！我们这里element接收的是一个ref类型，所以我们传入的DOM元素必须绑定ref并传入，此时element的类型也有可能undefined，因为你所传入的ref也有可能没有绑定DOM元素，这里的options是一个对象，里边可以传入六个不定函数，分别为beforeStart、beforeMove、beforeEnd、afterStart、afterMove、afterEnd，这六个参数分别在用户开始滑动、滑动中、滑动结束的前后调用，函数具体内容可自定义。所以，此时我们要声明一下options的类型。**\n```tsx\ninterface Options{\n    beforeStart?:(e:TouchEvent)=> void\n    beforeMove?:(e:TouchEvent)=> void\n    beforeEnd?:(e:TouchEvent)=> void\n    afterStart?:(e:TouchEvent)=> void\n    afterMove?:(e:TouchEvent)=> void\n    afterEnd?:(e:TouchEvent)=> void\n}\n```\n**接下来，我们可以开始具体实现useSwipe了，首先，我们得声明一下记录用户起始坐标和记录用户移动过程中坐标以及记录用户是否在移动的变量。**\n```tsx\n    const start =ref<Point>()\n    const end =ref<Point>()\n    const swipeing=ref(false)\n```\n**有了记录的变量之后，就可以给element添加事件，touchstart、touchmove、touchend，当用户touchstart时，记录用户的起始坐标，并将swipeing置为true，当用户touchmove时，记录用户的移动坐标，当用户touchend时，将swipeing置为false。并在执行这些代码前后分别执行可自定义的options中的函数**\n```tsx\n    const onStart=(e:TouchEvent)=>{\n        options?.beforeStart?.(e)\n        start.value={\n            x:e.touches[0].clientX,\n            y:e.touches[0].clientY\n        }\n        options?.afterStart?.(e)\n    }\n    const onMove=(e:TouchEvent)=>{\n        options?.beforeMove?.(e)\n        end.value={\n            x:e.touches[0].clientX,\n            y:e.touches[0].clientY\n        }\n        swipeing.value=true\n        options?.afterMove?.(e)\n    }\n    const onEnd=(e:TouchEvent)=>{\n        options?.beforeEnd?.(e)\n        swipeing.value=false\n        options?.afterEnd?.(e)\n    }\n```\n**接下来就可以把对应的事件绑定到element DOM元素上,此时我们需要Vue中的onMounted钩子（当DOM元素全部挂载到页面上时，绑定监听事件）**\n```tsx\nonMounted(()=>{\n        element.value?.addEventListener(\"touchstart\",onStart)\n        element.value?.addEventListener(\"touchmove\",onMove)\n        element.value?.addEventListener(\"touchend\",onEnd)\n    })\n```\n**有了start坐标以及end坐标后，我们可以继续封装distance以及direction函数。**\n\n**distance和direction函数均用Vue中的computed方法去管理return出的值。**\n\n**distance函数，根据end和start对应的x坐标和y坐标做差即可得出distance，distance的类型也为Point，内含x坐标和y坐标**\n\n**direction函数，根据做差后的x值和y值作比较，分别判断出用户是左右滑动还是上下滑动，判断出上下滑动还是水平滑动后，通过正负值判断出方向。因为direction是在滑动过程中去判断出方向，所以我们通过swipeing变量防止没有滑动时direction去判断方向**\n```tsx\n    const distance=computed(()=>{\n        if(!start.value || !end.value){ return undefined}\n        return{\n            x:end.value.x-start.value.x,\n            y:end.value.y-start.value.y\n        }\n    })\n\n    const direction=computed(()=>{\n        if(!swipeing.value){return \"\"}\n        if(!distance.value){return \"\"}\n        const { x , y } =distance.value\n        if(Math.abs(x)>Math.abs(y)){\n            return x>0? \"right\" : \"left\"\n        }\n        else{\n            return y>0? \"down\" : \"up\"\n        }\n    })\n```\n**最后，需要在DOM元素销毁后，移除绑定的监听事件**\n```tsx\nonUnmounted(()=>{\n        element.value?.removeEventListener(\"touchstart\",onStart)\n        element.value?.removeEventListener(\"touchmove\",onMove)\n        element.value?.removeEventListener(\"touchend\",onEnd)\n    })\n```\n","source":"_posts/useSwiper.md","raw":"---\ntitle: H5端中遇到的手势滑动问题——封装useSwipe Hooks\ndate: 2023/02/21 20:24\ntags: \n  - Vue\n  - Mobile\ncategory: 前端\n---\n\n\n**在做H5端页面时，避免不了遇到手势滑动问题，就此问题，我封装了一个Hooks（useSwipe）来解决这个问题，下面，我将一步步讲解useSwipe的封装过程**\n\n**下述源码引用了部分Vue的核心API，用Jsx语法编写**\n**全部代码均为TypeScript编写**\n## 完整源码\n```tsx\nimport { computed, onMounted,onUnmounted,Ref,ref } from \"vue\";\n\ntype Point={\n    x:number,\n    y:number\n}\n\ninterface Options{\n    beforeStart?:(e:TouchEvent)=> void\n    beforeMove?:(e:TouchEvent)=> void\n    beforeEnd?:(e:TouchEvent)=> void\n    afterStart?:(e:TouchEvent)=> void\n    afterMove?:(e:TouchEvent)=> void\n    afterEnd?:(e:TouchEvent)=> void\n}\nexport const useSwipe=(element:Ref<HTMLElement | undefined>,options?:Options)=>{\n    const start =ref<Point>()\n    const end =ref<Point>()\n    const swipeing=ref(false)\n\n    const distance=computed(()=>{\n        if(!start.value || !end.value){ return undefined}\n        return{\n            x:end.value.x-start.value.x,\n            y:end.value.y-start.value.y\n        }\n    })\n\n    const direction=computed(()=>{\n        if(!swipeing.value){return \"\"}\n        if(!distance.value){return \"\"}\n        const { x , y } =distance.value\n        if(Math.abs(x)>Math.abs(y)){\n            return x>0? \"right\" : \"left\"\n        }\n        else{\n            return y>0? \"down\" : \"up\"\n        }\n    })\n    const onStart=(e:TouchEvent)=>{\n        options?.beforeStart?.(e)\n        start.value={\n            x:e.touches[0].clientX,\n            y:e.touches[0].clientY\n        }\n        options?.afterStart?.(e)\n    }\n    const onMove=(e:TouchEvent)=>{\n        options?.beforeMove?.(e)\n        end.value={\n            x:e.touches[0].clientX,\n            y:e.touches[0].clientY\n        }\n        swipeing.value=true\n        options?.afterMove?.(e)\n    }\n    const onEnd=(e:TouchEvent)=>{\n        options?.beforeEnd?.(e)\n        swipeing.value=false\n        options?.afterEnd?.(e)\n    }\n    onMounted(()=>{\n        element.value?.addEventListener(\"touchstart\",onStart)\n        element.value?.addEventListener(\"touchmove\",onMove)\n        element.value?.addEventListener(\"touchend\",onEnd)\n    })\n    onUnmounted(()=>{\n        element.value?.removeEventListener(\"touchstart\",onStart)\n        element.value?.removeEventListener(\"touchmove\",onMove)\n        element.value?.removeEventListener(\"touchend\",onEnd)\n    })\n\n    return {\n        swipeing ,distance,direction \n    }\n}\n```\n## 核心思路\n**1. 当用户点击屏幕时，记录此时点击的屏幕坐标，当用户移动时，记录移动过程中的屏幕坐标，最后做差，即可判别用户的滑动行为**\n**2. 同时需要return出相应的参数，例如distance（屏幕坐标的差值）、direction（用户的滑动行为）、swipeing（用户是否在滑动中）**\n## 代码编写\n**首先我们得声明记录屏幕坐标的类型Point，Point类型中有x坐标和y坐标，均为number类型，代码如下**\n```tsx\ntype Point={x:number,y:number}\n```\n**接下来，useSwipe函数需要接受那些参数呢？这个时候，我们就要明白，useSwipe是指定用户在规定的DOM元素中的手势滑动行为，所以useSwipe需要接受一个HTML元素，我们也可以规定一个不定参数去接收对应的函数，去增加useSwipe的可扩展性。**\n```tsx\nconst useSwipe=(element:Ref<HTMLElement | undefined>,options?:Options)=>{}\n```\n**注意！我们这里element接收的是一个ref类型，所以我们传入的DOM元素必须绑定ref并传入，此时element的类型也有可能undefined，因为你所传入的ref也有可能没有绑定DOM元素，这里的options是一个对象，里边可以传入六个不定函数，分别为beforeStart、beforeMove、beforeEnd、afterStart、afterMove、afterEnd，这六个参数分别在用户开始滑动、滑动中、滑动结束的前后调用，函数具体内容可自定义。所以，此时我们要声明一下options的类型。**\n```tsx\ninterface Options{\n    beforeStart?:(e:TouchEvent)=> void\n    beforeMove?:(e:TouchEvent)=> void\n    beforeEnd?:(e:TouchEvent)=> void\n    afterStart?:(e:TouchEvent)=> void\n    afterMove?:(e:TouchEvent)=> void\n    afterEnd?:(e:TouchEvent)=> void\n}\n```\n**接下来，我们可以开始具体实现useSwipe了，首先，我们得声明一下记录用户起始坐标和记录用户移动过程中坐标以及记录用户是否在移动的变量。**\n```tsx\n    const start =ref<Point>()\n    const end =ref<Point>()\n    const swipeing=ref(false)\n```\n**有了记录的变量之后，就可以给element添加事件，touchstart、touchmove、touchend，当用户touchstart时，记录用户的起始坐标，并将swipeing置为true，当用户touchmove时，记录用户的移动坐标，当用户touchend时，将swipeing置为false。并在执行这些代码前后分别执行可自定义的options中的函数**\n```tsx\n    const onStart=(e:TouchEvent)=>{\n        options?.beforeStart?.(e)\n        start.value={\n            x:e.touches[0].clientX,\n            y:e.touches[0].clientY\n        }\n        options?.afterStart?.(e)\n    }\n    const onMove=(e:TouchEvent)=>{\n        options?.beforeMove?.(e)\n        end.value={\n            x:e.touches[0].clientX,\n            y:e.touches[0].clientY\n        }\n        swipeing.value=true\n        options?.afterMove?.(e)\n    }\n    const onEnd=(e:TouchEvent)=>{\n        options?.beforeEnd?.(e)\n        swipeing.value=false\n        options?.afterEnd?.(e)\n    }\n```\n**接下来就可以把对应的事件绑定到element DOM元素上,此时我们需要Vue中的onMounted钩子（当DOM元素全部挂载到页面上时，绑定监听事件）**\n```tsx\nonMounted(()=>{\n        element.value?.addEventListener(\"touchstart\",onStart)\n        element.value?.addEventListener(\"touchmove\",onMove)\n        element.value?.addEventListener(\"touchend\",onEnd)\n    })\n```\n**有了start坐标以及end坐标后，我们可以继续封装distance以及direction函数。**\n\n**distance和direction函数均用Vue中的computed方法去管理return出的值。**\n\n**distance函数，根据end和start对应的x坐标和y坐标做差即可得出distance，distance的类型也为Point，内含x坐标和y坐标**\n\n**direction函数，根据做差后的x值和y值作比较，分别判断出用户是左右滑动还是上下滑动，判断出上下滑动还是水平滑动后，通过正负值判断出方向。因为direction是在滑动过程中去判断出方向，所以我们通过swipeing变量防止没有滑动时direction去判断方向**\n```tsx\n    const distance=computed(()=>{\n        if(!start.value || !end.value){ return undefined}\n        return{\n            x:end.value.x-start.value.x,\n            y:end.value.y-start.value.y\n        }\n    })\n\n    const direction=computed(()=>{\n        if(!swipeing.value){return \"\"}\n        if(!distance.value){return \"\"}\n        const { x , y } =distance.value\n        if(Math.abs(x)>Math.abs(y)){\n            return x>0? \"right\" : \"left\"\n        }\n        else{\n            return y>0? \"down\" : \"up\"\n        }\n    })\n```\n**最后，需要在DOM元素销毁后，移除绑定的监听事件**\n```tsx\nonUnmounted(()=>{\n        element.value?.removeEventListener(\"touchstart\",onStart)\n        element.value?.removeEventListener(\"touchmove\",onMove)\n        element.value?.removeEventListener(\"touchend\",onEnd)\n    })\n```\n","slug":"useSwiper","published":1,"updated":"2023-05-28T11:39:04.292Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5kso000p0svh4fwgayp7","content":"<p><strong>在做H5端页面时，避免不了遇到手势滑动问题，就此问题，我封装了一个Hooks（useSwipe）来解决这个问题，下面，我将一步步讲解useSwipe的封装过程</strong></p>\n<p><strong>下述源码引用了部分Vue的核心API，用Jsx语法编写</strong><br><strong>全部代码均为TypeScript编写</strong></p>\n<h2 id=\"完整源码\"><a href=\"#完整源码\" class=\"headerlink\" title=\"完整源码\"></a>完整源码</h2><figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123; computed, onMounted,onUnmounted,<span class=\"title class_\">Ref</span>,ref &#125; <span class=\"keyword\">from</span> <span class=\"string\">&quot;vue&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"title class_\">Point</span>=&#123;</span><br><span class=\"line\">    <span class=\"attr\">x</span>:<span class=\"built_in\">number</span>,</span><br><span class=\"line\">    <span class=\"attr\">y</span>:<span class=\"built_in\">number</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">interface</span> <span class=\"title class_\">Options</span>&#123;</span><br><span class=\"line\">    beforeStart?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    beforeMove?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    beforeEnd?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterStart?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterMove?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterEnd?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> <span class=\"title function_\">useSwipe</span>=(<span class=\"params\">element:Ref&lt;HTMLElement | <span class=\"literal\">undefined</span>&gt;,options?:Options</span>)=&gt;&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> start =ref&lt;<span class=\"title class_\">Point</span>&gt;()</span><br><span class=\"line\">    <span class=\"keyword\">const</span> end =ref&lt;<span class=\"title class_\">Point</span>&gt;()</span><br><span class=\"line\">    <span class=\"keyword\">const</span> swipeing=<span class=\"title function_\">ref</span>(<span class=\"literal\">false</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> distance=<span class=\"title function_\">computed</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!start.<span class=\"property\">value</span> || !end.<span class=\"property\">value</span>)&#123; <span class=\"keyword\">return</span> <span class=\"literal\">undefined</span>&#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>&#123;</span><br><span class=\"line\">            <span class=\"attr\">x</span>:end.<span class=\"property\">value</span>.<span class=\"property\">x</span>-start.<span class=\"property\">value</span>.<span class=\"property\">x</span>,</span><br><span class=\"line\">            <span class=\"attr\">y</span>:end.<span class=\"property\">value</span>.<span class=\"property\">y</span>-start.<span class=\"property\">value</span>.<span class=\"property\">y</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> direction=<span class=\"title function_\">computed</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!swipeing.<span class=\"property\">value</span>)&#123;<span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!distance.<span class=\"property\">value</span>)&#123;<span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> &#123; x , y &#125; =distance.<span class=\"property\">value</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(x)&gt;<span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(y))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> x&gt;<span class=\"number\">0</span>? <span class=\"string\">&quot;right&quot;</span> : <span class=\"string\">&quot;left&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> y&gt;<span class=\"number\">0</span>? <span class=\"string\">&quot;down&quot;</span> : <span class=\"string\">&quot;up&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title function_\">onStart</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">        options?.<span class=\"property\">beforeStart</span>?.(e)</span><br><span class=\"line\">        start.<span class=\"property\">value</span>=&#123;</span><br><span class=\"line\">            <span class=\"attr\">x</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">            <span class=\"attr\">y</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        options?.<span class=\"property\">afterStart</span>?.(e)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title function_\">onMove</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">        options?.<span class=\"property\">beforeMove</span>?.(e)</span><br><span class=\"line\">        end.<span class=\"property\">value</span>=&#123;</span><br><span class=\"line\">            <span class=\"attr\">x</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">            <span class=\"attr\">y</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        swipeing.<span class=\"property\">value</span>=<span class=\"literal\">true</span></span><br><span class=\"line\">        options?.<span class=\"property\">afterMove</span>?.(e)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title function_\">onEnd</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">        options?.<span class=\"property\">beforeEnd</span>?.(e)</span><br><span class=\"line\">        swipeing.<span class=\"property\">value</span>=<span class=\"literal\">false</span></span><br><span class=\"line\">        options?.<span class=\"property\">afterEnd</span>?.(e)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">onMounted</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchstart&quot;</span>,onStart)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchmove&quot;</span>,onMove)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchend&quot;</span>,onEnd)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"title function_\">onUnmounted</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchstart&quot;</span>,onStart)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchmove&quot;</span>,onMove)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchend&quot;</span>,onEnd)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">        swipeing ,distance,direction </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"核心思路\"><a href=\"#核心思路\" class=\"headerlink\" title=\"核心思路\"></a>核心思路</h2><p><strong>1. 当用户点击屏幕时，记录此时点击的屏幕坐标，当用户移动时，记录移动过程中的屏幕坐标，最后做差，即可判别用户的滑动行为</strong><br><strong>2. 同时需要return出相应的参数，例如distance（屏幕坐标的差值）、direction（用户的滑动行为）、swipeing（用户是否在滑动中）</strong></p>\n<h2 id=\"代码编写\"><a href=\"#代码编写\" class=\"headerlink\" title=\"代码编写\"></a>代码编写</h2><p><strong>首先我们得声明记录屏幕坐标的类型Point，Point类型中有x坐标和y坐标，均为number类型，代码如下</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"title class_\">Point</span>=&#123;<span class=\"attr\">x</span>:<span class=\"built_in\">number</span>,<span class=\"attr\">y</span>:<span class=\"built_in\">number</span>&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>接下来，useSwipe函数需要接受那些参数呢？这个时候，我们就要明白，useSwipe是指定用户在规定的DOM元素中的手势滑动行为，所以useSwipe需要接受一个HTML元素，我们也可以规定一个不定参数去接收对应的函数，去增加useSwipe的可扩展性。</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">useSwipe</span>=(<span class=\"params\">element:Ref&lt;HTMLElement | <span class=\"literal\">undefined</span>&gt;,options?:Options</span>)=&gt;&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>注意！我们这里element接收的是一个ref类型，所以我们传入的DOM元素必须绑定ref并传入，此时element的类型也有可能undefined，因为你所传入的ref也有可能没有绑定DOM元素，这里的options是一个对象，里边可以传入六个不定函数，分别为beforeStart、beforeMove、beforeEnd、afterStart、afterMove、afterEnd，这六个参数分别在用户开始滑动、滑动中、滑动结束的前后调用，函数具体内容可自定义。所以，此时我们要声明一下options的类型。</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">interface</span> <span class=\"title class_\">Options</span>&#123;</span><br><span class=\"line\">    beforeStart?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    beforeMove?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    beforeEnd?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterStart?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterMove?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterEnd?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>接下来，我们可以开始具体实现useSwipe了，首先，我们得声明一下记录用户起始坐标和记录用户移动过程中坐标以及记录用户是否在移动的变量。</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> start =ref&lt;<span class=\"title class_\">Point</span>&gt;()</span><br><span class=\"line\"><span class=\"keyword\">const</span> end =ref&lt;<span class=\"title class_\">Point</span>&gt;()</span><br><span class=\"line\"><span class=\"keyword\">const</span> swipeing=<span class=\"title function_\">ref</span>(<span class=\"literal\">false</span>)</span><br></pre></td></tr></table></figure>\n<p><strong>有了记录的变量之后，就可以给element添加事件，touchstart、touchmove、touchend，当用户touchstart时，记录用户的起始坐标，并将swipeing置为true，当用户touchmove时，记录用户的移动坐标，当用户touchend时，将swipeing置为false。并在执行这些代码前后分别执行可自定义的options中的函数</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onStart</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">    options?.<span class=\"property\">beforeStart</span>?.(e)</span><br><span class=\"line\">    start.<span class=\"property\">value</span>=&#123;</span><br><span class=\"line\">        <span class=\"attr\">x</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">        <span class=\"attr\">y</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    options?.<span class=\"property\">afterStart</span>?.(e)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onMove</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">    options?.<span class=\"property\">beforeMove</span>?.(e)</span><br><span class=\"line\">    end.<span class=\"property\">value</span>=&#123;</span><br><span class=\"line\">        <span class=\"attr\">x</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">        <span class=\"attr\">y</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    swipeing.<span class=\"property\">value</span>=<span class=\"literal\">true</span></span><br><span class=\"line\">    options?.<span class=\"property\">afterMove</span>?.(e)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onEnd</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">    options?.<span class=\"property\">beforeEnd</span>?.(e)</span><br><span class=\"line\">    swipeing.<span class=\"property\">value</span>=<span class=\"literal\">false</span></span><br><span class=\"line\">    options?.<span class=\"property\">afterEnd</span>?.(e)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>接下来就可以把对应的事件绑定到element DOM元素上,此时我们需要Vue中的onMounted钩子（当DOM元素全部挂载到页面上时，绑定监听事件）</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">onMounted</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchstart&quot;</span>,onStart)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchmove&quot;</span>,onMove)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchend&quot;</span>,onEnd)</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n<p><strong>有了start坐标以及end坐标后，我们可以继续封装distance以及direction函数。</strong></p>\n<p><strong>distance和direction函数均用Vue中的computed方法去管理return出的值。</strong></p>\n<p><strong>distance函数，根据end和start对应的x坐标和y坐标做差即可得出distance，distance的类型也为Point，内含x坐标和y坐标</strong></p>\n<p><strong>direction函数，根据做差后的x值和y值作比较，分别判断出用户是左右滑动还是上下滑动，判断出上下滑动还是水平滑动后，通过正负值判断出方向。因为direction是在滑动过程中去判断出方向，所以我们通过swipeing变量防止没有滑动时direction去判断方向</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> distance=<span class=\"title function_\">computed</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!start.<span class=\"property\">value</span> || !end.<span class=\"property\">value</span>)&#123; <span class=\"keyword\">return</span> <span class=\"literal\">undefined</span>&#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>&#123;</span><br><span class=\"line\">        <span class=\"attr\">x</span>:end.<span class=\"property\">value</span>.<span class=\"property\">x</span>-start.<span class=\"property\">value</span>.<span class=\"property\">x</span>,</span><br><span class=\"line\">        <span class=\"attr\">y</span>:end.<span class=\"property\">value</span>.<span class=\"property\">y</span>-start.<span class=\"property\">value</span>.<span class=\"property\">y</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> direction=<span class=\"title function_\">computed</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!swipeing.<span class=\"property\">value</span>)&#123;<span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!distance.<span class=\"property\">value</span>)&#123;<span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; x , y &#125; =distance.<span class=\"property\">value</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(x)&gt;<span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(y))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> x&gt;<span class=\"number\">0</span>? <span class=\"string\">&quot;right&quot;</span> : <span class=\"string\">&quot;left&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> y&gt;<span class=\"number\">0</span>? <span class=\"string\">&quot;down&quot;</span> : <span class=\"string\">&quot;up&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p><strong>最后，需要在DOM元素销毁后，移除绑定的监听事件</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">onUnmounted</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchstart&quot;</span>,onStart)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchmove&quot;</span>,onMove)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchend&quot;</span>,onEnd)</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<p><strong>在做H5端页面时，避免不了遇到手势滑动问题，就此问题，我封装了一个Hooks（useSwipe）来解决这个问题，下面，我将一步步讲解useSwipe的封装过程</strong></p>\n<p><strong>下述源码引用了部分Vue的核心API，用Jsx语法编写</strong><br><strong>全部代码均为TypeScript编写</strong></p>\n<h2 id=\"完整源码\"><a href=\"#完整源码\" class=\"headerlink\" title=\"完整源码\"></a>完整源码</h2><figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123; computed, onMounted,onUnmounted,<span class=\"title class_\">Ref</span>,ref &#125; <span class=\"keyword\">from</span> <span class=\"string\">&quot;vue&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"title class_\">Point</span>=&#123;</span><br><span class=\"line\">    <span class=\"attr\">x</span>:<span class=\"built_in\">number</span>,</span><br><span class=\"line\">    <span class=\"attr\">y</span>:<span class=\"built_in\">number</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">interface</span> <span class=\"title class_\">Options</span>&#123;</span><br><span class=\"line\">    beforeStart?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    beforeMove?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    beforeEnd?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterStart?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterMove?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterEnd?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> <span class=\"title function_\">useSwipe</span>=(<span class=\"params\">element:Ref&lt;HTMLElement | <span class=\"literal\">undefined</span>&gt;,options?:Options</span>)=&gt;&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> start =ref&lt;<span class=\"title class_\">Point</span>&gt;()</span><br><span class=\"line\">    <span class=\"keyword\">const</span> end =ref&lt;<span class=\"title class_\">Point</span>&gt;()</span><br><span class=\"line\">    <span class=\"keyword\">const</span> swipeing=<span class=\"title function_\">ref</span>(<span class=\"literal\">false</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> distance=<span class=\"title function_\">computed</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!start.<span class=\"property\">value</span> || !end.<span class=\"property\">value</span>)&#123; <span class=\"keyword\">return</span> <span class=\"literal\">undefined</span>&#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>&#123;</span><br><span class=\"line\">            <span class=\"attr\">x</span>:end.<span class=\"property\">value</span>.<span class=\"property\">x</span>-start.<span class=\"property\">value</span>.<span class=\"property\">x</span>,</span><br><span class=\"line\">            <span class=\"attr\">y</span>:end.<span class=\"property\">value</span>.<span class=\"property\">y</span>-start.<span class=\"property\">value</span>.<span class=\"property\">y</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">const</span> direction=<span class=\"title function_\">computed</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!swipeing.<span class=\"property\">value</span>)&#123;<span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!distance.<span class=\"property\">value</span>)&#123;<span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> &#123; x , y &#125; =distance.<span class=\"property\">value</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(x)&gt;<span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(y))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> x&gt;<span class=\"number\">0</span>? <span class=\"string\">&quot;right&quot;</span> : <span class=\"string\">&quot;left&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> y&gt;<span class=\"number\">0</span>? <span class=\"string\">&quot;down&quot;</span> : <span class=\"string\">&quot;up&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title function_\">onStart</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">        options?.<span class=\"property\">beforeStart</span>?.(e)</span><br><span class=\"line\">        start.<span class=\"property\">value</span>=&#123;</span><br><span class=\"line\">            <span class=\"attr\">x</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">            <span class=\"attr\">y</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        options?.<span class=\"property\">afterStart</span>?.(e)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title function_\">onMove</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">        options?.<span class=\"property\">beforeMove</span>?.(e)</span><br><span class=\"line\">        end.<span class=\"property\">value</span>=&#123;</span><br><span class=\"line\">            <span class=\"attr\">x</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">            <span class=\"attr\">y</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        swipeing.<span class=\"property\">value</span>=<span class=\"literal\">true</span></span><br><span class=\"line\">        options?.<span class=\"property\">afterMove</span>?.(e)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> <span class=\"title function_\">onEnd</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">        options?.<span class=\"property\">beforeEnd</span>?.(e)</span><br><span class=\"line\">        swipeing.<span class=\"property\">value</span>=<span class=\"literal\">false</span></span><br><span class=\"line\">        options?.<span class=\"property\">afterEnd</span>?.(e)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">onMounted</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchstart&quot;</span>,onStart)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchmove&quot;</span>,onMove)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchend&quot;</span>,onEnd)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    <span class=\"title function_\">onUnmounted</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchstart&quot;</span>,onStart)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchmove&quot;</span>,onMove)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchend&quot;</span>,onEnd)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">        swipeing ,distance,direction </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"核心思路\"><a href=\"#核心思路\" class=\"headerlink\" title=\"核心思路\"></a>核心思路</h2><p><strong>1. 当用户点击屏幕时，记录此时点击的屏幕坐标，当用户移动时，记录移动过程中的屏幕坐标，最后做差，即可判别用户的滑动行为</strong><br><strong>2. 同时需要return出相应的参数，例如distance（屏幕坐标的差值）、direction（用户的滑动行为）、swipeing（用户是否在滑动中）</strong></p>\n<h2 id=\"代码编写\"><a href=\"#代码编写\" class=\"headerlink\" title=\"代码编写\"></a>代码编写</h2><p><strong>首先我们得声明记录屏幕坐标的类型Point，Point类型中有x坐标和y坐标，均为number类型，代码如下</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"title class_\">Point</span>=&#123;<span class=\"attr\">x</span>:<span class=\"built_in\">number</span>,<span class=\"attr\">y</span>:<span class=\"built_in\">number</span>&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>接下来，useSwipe函数需要接受那些参数呢？这个时候，我们就要明白，useSwipe是指定用户在规定的DOM元素中的手势滑动行为，所以useSwipe需要接受一个HTML元素，我们也可以规定一个不定参数去接收对应的函数，去增加useSwipe的可扩展性。</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">useSwipe</span>=(<span class=\"params\">element:Ref&lt;HTMLElement | <span class=\"literal\">undefined</span>&gt;,options?:Options</span>)=&gt;&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>注意！我们这里element接收的是一个ref类型，所以我们传入的DOM元素必须绑定ref并传入，此时element的类型也有可能undefined，因为你所传入的ref也有可能没有绑定DOM元素，这里的options是一个对象，里边可以传入六个不定函数，分别为beforeStart、beforeMove、beforeEnd、afterStart、afterMove、afterEnd，这六个参数分别在用户开始滑动、滑动中、滑动结束的前后调用，函数具体内容可自定义。所以，此时我们要声明一下options的类型。</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">interface</span> <span class=\"title class_\">Options</span>&#123;</span><br><span class=\"line\">    beforeStart?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    beforeMove?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    beforeEnd?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterStart?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterMove?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">    afterEnd?:<span class=\"function\">(<span class=\"params\">e:TouchEvent</span>)=&gt;</span> <span class=\"built_in\">void</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>接下来，我们可以开始具体实现useSwipe了，首先，我们得声明一下记录用户起始坐标和记录用户移动过程中坐标以及记录用户是否在移动的变量。</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> start =ref&lt;<span class=\"title class_\">Point</span>&gt;()</span><br><span class=\"line\"><span class=\"keyword\">const</span> end =ref&lt;<span class=\"title class_\">Point</span>&gt;()</span><br><span class=\"line\"><span class=\"keyword\">const</span> swipeing=<span class=\"title function_\">ref</span>(<span class=\"literal\">false</span>)</span><br></pre></td></tr></table></figure>\n<p><strong>有了记录的变量之后，就可以给element添加事件，touchstart、touchmove、touchend，当用户touchstart时，记录用户的起始坐标，并将swipeing置为true，当用户touchmove时，记录用户的移动坐标，当用户touchend时，将swipeing置为false。并在执行这些代码前后分别执行可自定义的options中的函数</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onStart</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">    options?.<span class=\"property\">beforeStart</span>?.(e)</span><br><span class=\"line\">    start.<span class=\"property\">value</span>=&#123;</span><br><span class=\"line\">        <span class=\"attr\">x</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">        <span class=\"attr\">y</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    options?.<span class=\"property\">afterStart</span>?.(e)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onMove</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">    options?.<span class=\"property\">beforeMove</span>?.(e)</span><br><span class=\"line\">    end.<span class=\"property\">value</span>=&#123;</span><br><span class=\"line\">        <span class=\"attr\">x</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientX</span>,</span><br><span class=\"line\">        <span class=\"attr\">y</span>:e.<span class=\"property\">touches</span>[<span class=\"number\">0</span>].<span class=\"property\">clientY</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    swipeing.<span class=\"property\">value</span>=<span class=\"literal\">true</span></span><br><span class=\"line\">    options?.<span class=\"property\">afterMove</span>?.(e)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">onEnd</span>=(<span class=\"params\">e:TouchEvent</span>)=&gt;&#123;</span><br><span class=\"line\">    options?.<span class=\"property\">beforeEnd</span>?.(e)</span><br><span class=\"line\">    swipeing.<span class=\"property\">value</span>=<span class=\"literal\">false</span></span><br><span class=\"line\">    options?.<span class=\"property\">afterEnd</span>?.(e)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>接下来就可以把对应的事件绑定到element DOM元素上,此时我们需要Vue中的onMounted钩子（当DOM元素全部挂载到页面上时，绑定监听事件）</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">onMounted</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchstart&quot;</span>,onStart)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchmove&quot;</span>,onMove)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">addEventListener</span>(<span class=\"string\">&quot;touchend&quot;</span>,onEnd)</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n<p><strong>有了start坐标以及end坐标后，我们可以继续封装distance以及direction函数。</strong></p>\n<p><strong>distance和direction函数均用Vue中的computed方法去管理return出的值。</strong></p>\n<p><strong>distance函数，根据end和start对应的x坐标和y坐标做差即可得出distance，distance的类型也为Point，内含x坐标和y坐标</strong></p>\n<p><strong>direction函数，根据做差后的x值和y值作比较，分别判断出用户是左右滑动还是上下滑动，判断出上下滑动还是水平滑动后，通过正负值判断出方向。因为direction是在滑动过程中去判断出方向，所以我们通过swipeing变量防止没有滑动时direction去判断方向</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> distance=<span class=\"title function_\">computed</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!start.<span class=\"property\">value</span> || !end.<span class=\"property\">value</span>)&#123; <span class=\"keyword\">return</span> <span class=\"literal\">undefined</span>&#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>&#123;</span><br><span class=\"line\">        <span class=\"attr\">x</span>:end.<span class=\"property\">value</span>.<span class=\"property\">x</span>-start.<span class=\"property\">value</span>.<span class=\"property\">x</span>,</span><br><span class=\"line\">        <span class=\"attr\">y</span>:end.<span class=\"property\">value</span>.<span class=\"property\">y</span>-start.<span class=\"property\">value</span>.<span class=\"property\">y</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> direction=<span class=\"title function_\">computed</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!swipeing.<span class=\"property\">value</span>)&#123;<span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!distance.<span class=\"property\">value</span>)&#123;<span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> &#123; x , y &#125; =distance.<span class=\"property\">value</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(x)&gt;<span class=\"title class_\">Math</span>.<span class=\"title function_\">abs</span>(y))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> x&gt;<span class=\"number\">0</span>? <span class=\"string\">&quot;right&quot;</span> : <span class=\"string\">&quot;left&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> y&gt;<span class=\"number\">0</span>? <span class=\"string\">&quot;down&quot;</span> : <span class=\"string\">&quot;up&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p><strong>最后，需要在DOM元素销毁后，移除绑定的监听事件</strong></p>\n<figure class=\"highlight tsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_\">onUnmounted</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchstart&quot;</span>,onStart)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchmove&quot;</span>,onMove)</span><br><span class=\"line\">        element.<span class=\"property\">value</span>?.<span class=\"title function_\">removeEventListener</span>(<span class=\"string\">&quot;touchend&quot;</span>,onEnd)</span><br><span class=\"line\">    &#125;)</span><br></pre></td></tr></table></figure>\n"},{"title":"手写依赖收集（Proxy和Reflect）","date":"2023-05-28T11:41:11.433Z","sticky":100,"_content":"\n\n## 响应式是什么？🙄\n在手写依赖收集之前，我们需要明白响应式到底是什么，假设，我们有一个对象info，info对象内有name、age两个属性元素，代码如下\n```js\nconst info={\n    name:\"1in\",\n    age:20\n}\n```\n此时我们有一个watchFn函数，依赖于info.name执行，代码如下\n```js\nconsole.log(info.name)\n```\n每当我们info中的name改变时，watchFn函数因为依赖了info.name,所以watchFn函数就自动执行，这就是响应式，那么我们怎么监听info.name的变动呢？这时我们需要用到Proxy，在Vue2中使用的是Object.defineProperty，而在Vue3中则使用的就是Proxy。\n\n## Proxy的基本使用\nProxy的汉译就是代理，具体基本用法如下\n```js\n//声明一个对象info\nconst info={\n    name:\"1in\",\n    age:20\n}\n\n//将对象info与Proxy绑定关系\nconst infoProxy=new Proxy(info,{\n    get(target, key, receiver) {\n      \n       return Reflect.get(target,key,receiver)\n},\n    set(target, key, newValue, receiver) {\n    \n        Reflect.set(target,key,newValue,receiver)\n}\n```\n此时，我们就可以在get，set方法中具体监听info对象，[Proxy具体用法](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy)，[Reflect具体用法](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect)。\n\n## 依赖收集（响应式原理）\n手写源码如下\n```js\n//保存当前响应式函数\nlet activeReactiveFn=null\nclass Depend{\n    constructor() {\n        this.reactiveFns=new Set()\n    }\n    addDepend(reactiveFn){\n        this.reactiveFns.add(reactiveFn)\n    }\n    depend(){\n        if(activeReactiveFn){\n            this.reactiveFns.add(activeReactiveFn)\n        }\n    }\n    notify(){\n        this.reactiveFns.forEach(fn=>{\n            fn()\n        })\n    }\n}\n\n//封装一个响应式函数\nfunction watchFn(fn){\n    activeReactiveFn=fn\n    fn()\n    activeReactiveFn=null\n}\n\n//封装一个获取depend函数\nconst targetMap=new WeakMap()\nfunction getDepend(target,key){\n    //根据target获取map\n    let map=targetMap.get(target)\n    if(!map){\n        map = new Map()\n        targetMap.set(target,map)\n    }\n    //根据key获取depend\n    let depend=map.get(key)\n    if(!depend){\n        depend = new Depend()\n        map.set(key,depend)\n    }\n    return depend\n}\n\n//Vue3响应式原理Proxy\nfunction reactive(obj){\n    return new Proxy(obj,{\n        get(target, key, receiver) {\n            //依赖收集\n            //根据target，key获取对应的depend\n            const depend=getDepend(target,key)\n            //给depend添加函数\n            // depend.addDepend(activeReactiveFn)\n            depend.depend()\n\n            return Reflect.get(target,key,receiver)\n        },\n        set(target, key, newValue, receiver) {\n            Reflect.set(target,key,newValue,receiver)\n            // depend.notify()\n            const depend=getDepend(target,key)\n            depend.notify()\n        }\n    })\n}\n\nconst info={\n    name:\"1in\",\n    age:20\n}\nconst infoProxy=reactive(info)\nwatchFn(()=>{\n    console.log(infoProxy.name)\n})\ninfoProxy.name=\"1in.\"\n```\n首先，我们需要声明一个Set数据结构reactiveFns来存储watchFn函数（可以用数组来存储，但是数组的值可以重复，可能会导致收集的依赖函数重复，所以这里我们用Set数据结构，防止重复。），因为watchFn函数不止一个，并且我们需要依次执行所有的watchFn函数，所以我们需要创建一个class来声明这些方法。\n```js\n//创建一个class\nclass Depend{\n    constructor() {\n        //利用Set数据结构防止收集的依赖函数重复\n        this.reactiveFns=new Set()\n    }\n    addDepend(reactiveFn){\n        //将依赖函数添加到Set数据结构中\n        this.reactiveFns.add(reactiveFn)\n    }\n    \n    notify(){\n        //利用forEach遍历Set数据结构，依次执行watchFn函数\n        this.reactiveFns.forEach(fn=>{\n            fn()\n        })\n    }\n}\n```\n随后我们就可以创建一个reactive函数，传入一个obj对象，返回一个响应式（Proxy）的对象，自动绑定为响应式。\n```js\nfunction reactive(obj){\n    return new Proxy(obj,{\n        get(target, key, receiver) {\n            \n            return Reflect.get(target,key,receiver)\n        },\n        set(target, key, newValue, receiver) {\n            Reflect.set(target,key,newValue,receiver)\n            \n        }\n    })\n}\n```\n接下来，我们就可以为对象中的每一个元素属性进行依赖收集，在这里我们用到了WeakMap以及Map数据结构，因为每一个元素的依赖都不一样，所以每一个元素都要new一个Depend对象存储在Map数据结构中（一个Map对应着一个对象），最终用WeakMap将所有的Map存储起来，这里用WeakMap的原因是WeakMap的key是弱引用，当存储的Map指针指向为null时，这个Map就会被GC垃圾回收，可以防止内存泄漏。\n\n<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42643cc767a64613a11b1889b39c1eb2~tplv-k3u1fbpfcp-watermark.image?\" alt=\"c42897359ca89d8cf08d9383051236a.jpg\" width=\"100%\" />\n\n所以接下来我们需要构造一个getDepend函数。\n```js\n//创建一个WeakMap的数据结构\nconst targetMap=new WeakMap()\nfunction getDepend(target,key){\n    //根据target获取map\n    let map=targetMap.get(target)\n    //第一次get肯定没有map，所以需要new\n    if(!map){\n        map = new Map()\n        targetMap.set(target,map)\n    }\n    //根据key获取depend\n    let depend=map.get(key)\n    //第一次get肯定没有depend，所以需要new\n    if(!depend){\n        depend = new Depend()\n        map.set(key,depend)\n    }\n    return depend\n}\n```\n当我们构造了一个getDepend函数之后，我们就可以在Proxy中添加getDepend函数，完成响应式。\n\n\n在此之前我们需要构造watchFn函数。\n```\nfunction watchFn(fn){\n    fn()\n}\n```\n\n```js\nnew Proxy(obj,{\n    get(target, key, receiver) {\n        //依赖收集\n        //根据target，key获取对应的depend\n        const depend=getDepend(target,key)\n        //给depend添加函数\n        depend.addDepend(activeReactiveFn)\n\n        return Reflect.get(target,key,receiver)\n    },\n    set(target, key, newValue, receiver) {\n        Reflect.set(target,key,newValue,receiver)\n        // depend.notify()\n        const depend=getDepend(target,key)\n        depend.notify()\n    }\n```\n在set方法中，调用notify（）方法执行所有的watchFn函数，在get方法中，收集所有的依赖函数，因为依赖函数依赖对象中的元素属性，所以当依赖函数调用时，会调用Proxy中的get方法，所以我们可以在get方法中进行依赖函数的收集，所以，我们需要在全局声明一个activeReactiveFn=null,当依赖函数调用之前，使activeReactiveFn指向这个依赖函数，当依赖函数调用get方法时，将这个依赖函数添加到reactiveFns中。具体代码如下\n```js\nlet activeReactiveFn=null\n\nfunction watchFn(fn){\n    activeReactiveFn=fn\n    fn()\n    activeReactiveFn=null\n}\n\n```\n当然，我们也可以对addDepend进行优化，也就是说我们直接可以调用depend.depend()函数，自动添加依赖函数到reactiveFns中，不用传参，所以我们需要在class中添加一个depend（）方法。\n```\nclass Depend{\n    constructor() {\n        this.reactiveFns=new Set()\n    }\n    addDepend(reactiveFn){\n        this.reactiveFns.add(reactiveFn)\n    }\n    depend(){\n        if(activeReactiveFn){\n            this.reactiveFns.add(activeReactiveFn)\n        }\n    }\n    notify(){\n        this.reactiveFns.forEach(fn=>{\n            fn()\n        })\n    }\n}\n```\n随后，我们就可以在get方法中这样调用。\n\n```\nget(target, key, receiver) {\n    //依赖收集\n    //根据target，key获取对应的depend\n    const depend=getDepend(target,key)\n    //给depend添加函数\n    // depend.addDepend(activeReactiveFn)\n    depend.depend()\n\n    return Reflect.get(target,key,receiver)\n},\n```\n\n至此，Proxy的依赖收集，手写结束！🥳🥳🥳。\n\n## 总结 🥂\n1. 对象中的每一个元素属性都有对应的一个Depend对象（reactiveFns）。\n2. 使用WeakMap存储对象（Map），使用Map存储Depend对象。\n3. 使用Set数据结构来存储reactiveFns，防止收集依赖函数重复。\n4. 使用Proxy中的set方法来执行reactiveFns。\n5. 使用Proxy中的get方法来收集依赖函数。\n\n\n\n","source":"_posts/手写依赖收集（Proxy和Reflect）.md","raw":"---\ntitle: 手写依赖收集（Proxy和Reflect）\ndate: 2023/03/27 22-18\ntag: JavaScript\nsticky: 100\ncategory:\n - 前端\n---\n\n\n## 响应式是什么？🙄\n在手写依赖收集之前，我们需要明白响应式到底是什么，假设，我们有一个对象info，info对象内有name、age两个属性元素，代码如下\n```js\nconst info={\n    name:\"1in\",\n    age:20\n}\n```\n此时我们有一个watchFn函数，依赖于info.name执行，代码如下\n```js\nconsole.log(info.name)\n```\n每当我们info中的name改变时，watchFn函数因为依赖了info.name,所以watchFn函数就自动执行，这就是响应式，那么我们怎么监听info.name的变动呢？这时我们需要用到Proxy，在Vue2中使用的是Object.defineProperty，而在Vue3中则使用的就是Proxy。\n\n## Proxy的基本使用\nProxy的汉译就是代理，具体基本用法如下\n```js\n//声明一个对象info\nconst info={\n    name:\"1in\",\n    age:20\n}\n\n//将对象info与Proxy绑定关系\nconst infoProxy=new Proxy(info,{\n    get(target, key, receiver) {\n      \n       return Reflect.get(target,key,receiver)\n},\n    set(target, key, newValue, receiver) {\n    \n        Reflect.set(target,key,newValue,receiver)\n}\n```\n此时，我们就可以在get，set方法中具体监听info对象，[Proxy具体用法](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy)，[Reflect具体用法](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect)。\n\n## 依赖收集（响应式原理）\n手写源码如下\n```js\n//保存当前响应式函数\nlet activeReactiveFn=null\nclass Depend{\n    constructor() {\n        this.reactiveFns=new Set()\n    }\n    addDepend(reactiveFn){\n        this.reactiveFns.add(reactiveFn)\n    }\n    depend(){\n        if(activeReactiveFn){\n            this.reactiveFns.add(activeReactiveFn)\n        }\n    }\n    notify(){\n        this.reactiveFns.forEach(fn=>{\n            fn()\n        })\n    }\n}\n\n//封装一个响应式函数\nfunction watchFn(fn){\n    activeReactiveFn=fn\n    fn()\n    activeReactiveFn=null\n}\n\n//封装一个获取depend函数\nconst targetMap=new WeakMap()\nfunction getDepend(target,key){\n    //根据target获取map\n    let map=targetMap.get(target)\n    if(!map){\n        map = new Map()\n        targetMap.set(target,map)\n    }\n    //根据key获取depend\n    let depend=map.get(key)\n    if(!depend){\n        depend = new Depend()\n        map.set(key,depend)\n    }\n    return depend\n}\n\n//Vue3响应式原理Proxy\nfunction reactive(obj){\n    return new Proxy(obj,{\n        get(target, key, receiver) {\n            //依赖收集\n            //根据target，key获取对应的depend\n            const depend=getDepend(target,key)\n            //给depend添加函数\n            // depend.addDepend(activeReactiveFn)\n            depend.depend()\n\n            return Reflect.get(target,key,receiver)\n        },\n        set(target, key, newValue, receiver) {\n            Reflect.set(target,key,newValue,receiver)\n            // depend.notify()\n            const depend=getDepend(target,key)\n            depend.notify()\n        }\n    })\n}\n\nconst info={\n    name:\"1in\",\n    age:20\n}\nconst infoProxy=reactive(info)\nwatchFn(()=>{\n    console.log(infoProxy.name)\n})\ninfoProxy.name=\"1in.\"\n```\n首先，我们需要声明一个Set数据结构reactiveFns来存储watchFn函数（可以用数组来存储，但是数组的值可以重复，可能会导致收集的依赖函数重复，所以这里我们用Set数据结构，防止重复。），因为watchFn函数不止一个，并且我们需要依次执行所有的watchFn函数，所以我们需要创建一个class来声明这些方法。\n```js\n//创建一个class\nclass Depend{\n    constructor() {\n        //利用Set数据结构防止收集的依赖函数重复\n        this.reactiveFns=new Set()\n    }\n    addDepend(reactiveFn){\n        //将依赖函数添加到Set数据结构中\n        this.reactiveFns.add(reactiveFn)\n    }\n    \n    notify(){\n        //利用forEach遍历Set数据结构，依次执行watchFn函数\n        this.reactiveFns.forEach(fn=>{\n            fn()\n        })\n    }\n}\n```\n随后我们就可以创建一个reactive函数，传入一个obj对象，返回一个响应式（Proxy）的对象，自动绑定为响应式。\n```js\nfunction reactive(obj){\n    return new Proxy(obj,{\n        get(target, key, receiver) {\n            \n            return Reflect.get(target,key,receiver)\n        },\n        set(target, key, newValue, receiver) {\n            Reflect.set(target,key,newValue,receiver)\n            \n        }\n    })\n}\n```\n接下来，我们就可以为对象中的每一个元素属性进行依赖收集，在这里我们用到了WeakMap以及Map数据结构，因为每一个元素的依赖都不一样，所以每一个元素都要new一个Depend对象存储在Map数据结构中（一个Map对应着一个对象），最终用WeakMap将所有的Map存储起来，这里用WeakMap的原因是WeakMap的key是弱引用，当存储的Map指针指向为null时，这个Map就会被GC垃圾回收，可以防止内存泄漏。\n\n<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42643cc767a64613a11b1889b39c1eb2~tplv-k3u1fbpfcp-watermark.image?\" alt=\"c42897359ca89d8cf08d9383051236a.jpg\" width=\"100%\" />\n\n所以接下来我们需要构造一个getDepend函数。\n```js\n//创建一个WeakMap的数据结构\nconst targetMap=new WeakMap()\nfunction getDepend(target,key){\n    //根据target获取map\n    let map=targetMap.get(target)\n    //第一次get肯定没有map，所以需要new\n    if(!map){\n        map = new Map()\n        targetMap.set(target,map)\n    }\n    //根据key获取depend\n    let depend=map.get(key)\n    //第一次get肯定没有depend，所以需要new\n    if(!depend){\n        depend = new Depend()\n        map.set(key,depend)\n    }\n    return depend\n}\n```\n当我们构造了一个getDepend函数之后，我们就可以在Proxy中添加getDepend函数，完成响应式。\n\n\n在此之前我们需要构造watchFn函数。\n```\nfunction watchFn(fn){\n    fn()\n}\n```\n\n```js\nnew Proxy(obj,{\n    get(target, key, receiver) {\n        //依赖收集\n        //根据target，key获取对应的depend\n        const depend=getDepend(target,key)\n        //给depend添加函数\n        depend.addDepend(activeReactiveFn)\n\n        return Reflect.get(target,key,receiver)\n    },\n    set(target, key, newValue, receiver) {\n        Reflect.set(target,key,newValue,receiver)\n        // depend.notify()\n        const depend=getDepend(target,key)\n        depend.notify()\n    }\n```\n在set方法中，调用notify（）方法执行所有的watchFn函数，在get方法中，收集所有的依赖函数，因为依赖函数依赖对象中的元素属性，所以当依赖函数调用时，会调用Proxy中的get方法，所以我们可以在get方法中进行依赖函数的收集，所以，我们需要在全局声明一个activeReactiveFn=null,当依赖函数调用之前，使activeReactiveFn指向这个依赖函数，当依赖函数调用get方法时，将这个依赖函数添加到reactiveFns中。具体代码如下\n```js\nlet activeReactiveFn=null\n\nfunction watchFn(fn){\n    activeReactiveFn=fn\n    fn()\n    activeReactiveFn=null\n}\n\n```\n当然，我们也可以对addDepend进行优化，也就是说我们直接可以调用depend.depend()函数，自动添加依赖函数到reactiveFns中，不用传参，所以我们需要在class中添加一个depend（）方法。\n```\nclass Depend{\n    constructor() {\n        this.reactiveFns=new Set()\n    }\n    addDepend(reactiveFn){\n        this.reactiveFns.add(reactiveFn)\n    }\n    depend(){\n        if(activeReactiveFn){\n            this.reactiveFns.add(activeReactiveFn)\n        }\n    }\n    notify(){\n        this.reactiveFns.forEach(fn=>{\n            fn()\n        })\n    }\n}\n```\n随后，我们就可以在get方法中这样调用。\n\n```\nget(target, key, receiver) {\n    //依赖收集\n    //根据target，key获取对应的depend\n    const depend=getDepend(target,key)\n    //给depend添加函数\n    // depend.addDepend(activeReactiveFn)\n    depend.depend()\n\n    return Reflect.get(target,key,receiver)\n},\n```\n\n至此，Proxy的依赖收集，手写结束！🥳🥳🥳。\n\n## 总结 🥂\n1. 对象中的每一个元素属性都有对应的一个Depend对象（reactiveFns）。\n2. 使用WeakMap存储对象（Map），使用Map存储Depend对象。\n3. 使用Set数据结构来存储reactiveFns，防止收集依赖函数重复。\n4. 使用Proxy中的set方法来执行reactiveFns。\n5. 使用Proxy中的get方法来收集依赖函数。\n\n\n\n","slug":"手写依赖收集（Proxy和Reflect）","published":1,"updated":"2023-05-28T11:52:46.521Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksp000r0svh678iay4u","content":"<h2 id=\"响应式是什么？🙄\"><a href=\"#响应式是什么？🙄\" class=\"headerlink\" title=\"响应式是什么？🙄\"></a>响应式是什么？🙄</h2><p>在手写依赖收集之前，我们需要明白响应式到底是什么，假设，我们有一个对象info，info对象内有name、age两个属性元素，代码如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> info=&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时我们有一个watchFn函数，依赖于info.name执行，代码如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(info.<span class=\"property\">name</span>)</span><br></pre></td></tr></table></figure>\n<p>每当我们info中的name改变时，watchFn函数因为依赖了info.name,所以watchFn函数就自动执行，这就是响应式，那么我们怎么监听info.name的变动呢？这时我们需要用到Proxy，在Vue2中使用的是Object.defineProperty，而在Vue3中则使用的就是Proxy。</p>\n<h2 id=\"Proxy的基本使用\"><a href=\"#Proxy的基本使用\" class=\"headerlink\" title=\"Proxy的基本使用\"></a>Proxy的基本使用</h2><p>Proxy的汉译就是代理，具体基本用法如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//声明一个对象info</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> info=&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//将对象info与Proxy绑定关系</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> infoProxy=<span class=\"keyword\">new</span> <span class=\"title class_\">Proxy</span>(info,&#123;</span><br><span class=\"line\">    <span class=\"title function_\">get</span>(<span class=\"params\">target, key, receiver</span>) &#123;</span><br><span class=\"line\">      </span><br><span class=\"line\">       <span class=\"keyword\">return</span> <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">get</span>(target,key,receiver)</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">    <span class=\"title function_\">set</span>(<span class=\"params\">target, key, newValue, receiver</span>) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">set</span>(target,key,newValue,receiver)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时，我们就可以在get，set方法中具体监听info对象，<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy\">Proxy具体用法</a>，<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect\">Reflect具体用法</a>。</p>\n<h2 id=\"依赖收集（响应式原理）\"><a href=\"#依赖收集（响应式原理）\" class=\"headerlink\" title=\"依赖收集（响应式原理）\"></a>依赖收集（响应式原理）</h2><p>手写源码如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//保存当前响应式函数</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> activeReactiveFn=<span class=\"literal\">null</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Depend</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>=<span class=\"keyword\">new</span> <span class=\"title class_\">Set</span>()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">addDepend</span>(<span class=\"params\">reactiveFn</span>)&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">add</span>(reactiveFn)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">depend</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(activeReactiveFn)&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">add</span>(activeReactiveFn)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">notify</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">fn</span>=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"title function_\">fn</span>()</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//封装一个响应式函数</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">watchFn</span>(<span class=\"params\">fn</span>)&#123;</span><br><span class=\"line\">    activeReactiveFn=fn</span><br><span class=\"line\">    <span class=\"title function_\">fn</span>()</span><br><span class=\"line\">    activeReactiveFn=<span class=\"literal\">null</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//封装一个获取depend函数</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> targetMap=<span class=\"keyword\">new</span> <span class=\"title class_\">WeakMap</span>()</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getDepend</span>(<span class=\"params\">target,key</span>)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//根据target获取map</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> map=targetMap.<span class=\"title function_\">get</span>(target)</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!map)&#123;</span><br><span class=\"line\">        map = <span class=\"keyword\">new</span> <span class=\"title class_\">Map</span>()</span><br><span class=\"line\">        targetMap.<span class=\"title function_\">set</span>(target,map)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//根据key获取depend</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> depend=map.<span class=\"title function_\">get</span>(key)</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!depend)&#123;</span><br><span class=\"line\">        depend = <span class=\"keyword\">new</span> <span class=\"title class_\">Depend</span>()</span><br><span class=\"line\">        map.<span class=\"title function_\">set</span>(key,depend)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> depend</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//Vue3响应式原理Proxy</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">reactive</span>(<span class=\"params\">obj</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Proxy</span>(obj,&#123;</span><br><span class=\"line\">        <span class=\"title function_\">get</span>(<span class=\"params\">target, key, receiver</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//依赖收集</span></span><br><span class=\"line\">            <span class=\"comment\">//根据target，key获取对应的depend</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> depend=<span class=\"title function_\">getDepend</span>(target,key)</span><br><span class=\"line\">            <span class=\"comment\">//给depend添加函数</span></span><br><span class=\"line\">            <span class=\"comment\">// depend.addDepend(activeReactiveFn)</span></span><br><span class=\"line\">            depend.<span class=\"title function_\">depend</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">get</span>(target,key,receiver)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"title function_\">set</span>(<span class=\"params\">target, key, newValue, receiver</span>) &#123;</span><br><span class=\"line\">            <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">set</span>(target,key,newValue,receiver)</span><br><span class=\"line\">            <span class=\"comment\">// depend.notify()</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> depend=<span class=\"title function_\">getDepend</span>(target,key)</span><br><span class=\"line\">            depend.<span class=\"title function_\">notify</span>()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> info=&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> infoProxy=<span class=\"title function_\">reactive</span>(info)</span><br><span class=\"line\"><span class=\"title function_\">watchFn</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(infoProxy.<span class=\"property\">name</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">infoProxy.<span class=\"property\">name</span>=<span class=\"string\">&quot;1in.&quot;</span></span><br></pre></td></tr></table></figure>\n<p>首先，我们需要声明一个Set数据结构reactiveFns来存储watchFn函数（可以用数组来存储，但是数组的值可以重复，可能会导致收集的依赖函数重复，所以这里我们用Set数据结构，防止重复。），因为watchFn函数不止一个，并且我们需要依次执行所有的watchFn函数，所以我们需要创建一个class来声明这些方法。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//创建一个class</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Depend</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//利用Set数据结构防止收集的依赖函数重复</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>=<span class=\"keyword\">new</span> <span class=\"title class_\">Set</span>()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">addDepend</span>(<span class=\"params\">reactiveFn</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//将依赖函数添加到Set数据结构中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">add</span>(reactiveFn)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"title function_\">notify</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//利用forEach遍历Set数据结构，依次执行watchFn函数</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">fn</span>=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"title function_\">fn</span>()</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>随后我们就可以创建一个reactive函数，传入一个obj对象，返回一个响应式（Proxy）的对象，自动绑定为响应式。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">reactive</span>(<span class=\"params\">obj</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Proxy</span>(obj,&#123;</span><br><span class=\"line\">        <span class=\"title function_\">get</span>(<span class=\"params\">target, key, receiver</span>) &#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">get</span>(target,key,receiver)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"title function_\">set</span>(<span class=\"params\">target, key, newValue, receiver</span>) &#123;</span><br><span class=\"line\">            <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">set</span>(target,key,newValue,receiver)</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>接下来，我们就可以为对象中的每一个元素属性进行依赖收集，在这里我们用到了WeakMap以及Map数据结构，因为每一个元素的依赖都不一样，所以每一个元素都要new一个Depend对象存储在Map数据结构中（一个Map对应着一个对象），最终用WeakMap将所有的Map存储起来，这里用WeakMap的原因是WeakMap的key是弱引用，当存储的Map指针指向为null时，这个Map就会被GC垃圾回收，可以防止内存泄漏。</p>\n<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42643cc767a64613a11b1889b39c1eb2~tplv-k3u1fbpfcp-watermark.image?\" alt=\"c42897359ca89d8cf08d9383051236a.jpg\" width=\"100%\" />\n\n<p>所以接下来我们需要构造一个getDepend函数。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//创建一个WeakMap的数据结构</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> targetMap=<span class=\"keyword\">new</span> <span class=\"title class_\">WeakMap</span>()</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getDepend</span>(<span class=\"params\">target,key</span>)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//根据target获取map</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> map=targetMap.<span class=\"title function_\">get</span>(target)</span><br><span class=\"line\">    <span class=\"comment\">//第一次get肯定没有map，所以需要new</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!map)&#123;</span><br><span class=\"line\">        map = <span class=\"keyword\">new</span> <span class=\"title class_\">Map</span>()</span><br><span class=\"line\">        targetMap.<span class=\"title function_\">set</span>(target,map)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//根据key获取depend</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> depend=map.<span class=\"title function_\">get</span>(key)</span><br><span class=\"line\">    <span class=\"comment\">//第一次get肯定没有depend，所以需要new</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!depend)&#123;</span><br><span class=\"line\">        depend = <span class=\"keyword\">new</span> <span class=\"title class_\">Depend</span>()</span><br><span class=\"line\">        map.<span class=\"title function_\">set</span>(key,depend)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> depend</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当我们构造了一个getDepend函数之后，我们就可以在Proxy中添加getDepend函数，完成响应式。</p>\n<p>在此之前我们需要构造watchFn函数。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function watchFn(fn)&#123;</span><br><span class=\"line\">    fn()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Proxy</span>(obj,&#123;</span><br><span class=\"line\">    <span class=\"title function_\">get</span>(<span class=\"params\">target, key, receiver</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//依赖收集</span></span><br><span class=\"line\">        <span class=\"comment\">//根据target，key获取对应的depend</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> depend=<span class=\"title function_\">getDepend</span>(target,key)</span><br><span class=\"line\">        <span class=\"comment\">//给depend添加函数</span></span><br><span class=\"line\">        depend.<span class=\"title function_\">addDepend</span>(activeReactiveFn)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">get</span>(target,key,receiver)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"title function_\">set</span>(<span class=\"params\">target, key, newValue, receiver</span>) &#123;</span><br><span class=\"line\">        <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">set</span>(target,key,newValue,receiver)</span><br><span class=\"line\">        <span class=\"comment\">// depend.notify()</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> depend=<span class=\"title function_\">getDepend</span>(target,key)</span><br><span class=\"line\">        depend.<span class=\"title function_\">notify</span>()</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>在set方法中，调用notify（）方法执行所有的watchFn函数，在get方法中，收集所有的依赖函数，因为依赖函数依赖对象中的元素属性，所以当依赖函数调用时，会调用Proxy中的get方法，所以我们可以在get方法中进行依赖函数的收集，所以，我们需要在全局声明一个activeReactiveFn&#x3D;null,当依赖函数调用之前，使activeReactiveFn指向这个依赖函数，当依赖函数调用get方法时，将这个依赖函数添加到reactiveFns中。具体代码如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> activeReactiveFn=<span class=\"literal\">null</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">watchFn</span>(<span class=\"params\">fn</span>)&#123;</span><br><span class=\"line\">    activeReactiveFn=fn</span><br><span class=\"line\">    <span class=\"title function_\">fn</span>()</span><br><span class=\"line\">    activeReactiveFn=<span class=\"literal\">null</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>当然，我们也可以对addDepend进行优化，也就是说我们直接可以调用depend.depend()函数，自动添加依赖函数到reactiveFns中，不用传参，所以我们需要在class中添加一个depend（）方法。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Depend&#123;</span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        this.reactiveFns=new Set()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    addDepend(reactiveFn)&#123;</span><br><span class=\"line\">        this.reactiveFns.add(reactiveFn)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    depend()&#123;</span><br><span class=\"line\">        if(activeReactiveFn)&#123;</span><br><span class=\"line\">            this.reactiveFns.add(activeReactiveFn)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    notify()&#123;</span><br><span class=\"line\">        this.reactiveFns.forEach(fn=&gt;&#123;</span><br><span class=\"line\">            fn()</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>随后，我们就可以在get方法中这样调用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">get(target, key, receiver) &#123;</span><br><span class=\"line\">    //依赖收集</span><br><span class=\"line\">    //根据target，key获取对应的depend</span><br><span class=\"line\">    const depend=getDepend(target,key)</span><br><span class=\"line\">    //给depend添加函数</span><br><span class=\"line\">    // depend.addDepend(activeReactiveFn)</span><br><span class=\"line\">    depend.depend()</span><br><span class=\"line\"></span><br><span class=\"line\">    return Reflect.get(target,key,receiver)</span><br><span class=\"line\">&#125;,</span><br></pre></td></tr></table></figure>\n\n<p>至此，Proxy的依赖收集，手写结束！🥳🥳🥳。</p>\n<h2 id=\"总结-🥂\"><a href=\"#总结-🥂\" class=\"headerlink\" title=\"总结 🥂\"></a>总结 🥂</h2><ol>\n<li>对象中的每一个元素属性都有对应的一个Depend对象（reactiveFns）。</li>\n<li>使用WeakMap存储对象（Map），使用Map存储Depend对象。</li>\n<li>使用Set数据结构来存储reactiveFns，防止收集依赖函数重复。</li>\n<li>使用Proxy中的set方法来执行reactiveFns。</li>\n<li>使用Proxy中的get方法来收集依赖函数。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"响应式是什么？🙄\"><a href=\"#响应式是什么？🙄\" class=\"headerlink\" title=\"响应式是什么？🙄\"></a>响应式是什么？🙄</h2><p>在手写依赖收集之前，我们需要明白响应式到底是什么，假设，我们有一个对象info，info对象内有name、age两个属性元素，代码如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> info=&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时我们有一个watchFn函数，依赖于info.name执行，代码如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(info.<span class=\"property\">name</span>)</span><br></pre></td></tr></table></figure>\n<p>每当我们info中的name改变时，watchFn函数因为依赖了info.name,所以watchFn函数就自动执行，这就是响应式，那么我们怎么监听info.name的变动呢？这时我们需要用到Proxy，在Vue2中使用的是Object.defineProperty，而在Vue3中则使用的就是Proxy。</p>\n<h2 id=\"Proxy的基本使用\"><a href=\"#Proxy的基本使用\" class=\"headerlink\" title=\"Proxy的基本使用\"></a>Proxy的基本使用</h2><p>Proxy的汉译就是代理，具体基本用法如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//声明一个对象info</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> info=&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//将对象info与Proxy绑定关系</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> infoProxy=<span class=\"keyword\">new</span> <span class=\"title class_\">Proxy</span>(info,&#123;</span><br><span class=\"line\">    <span class=\"title function_\">get</span>(<span class=\"params\">target, key, receiver</span>) &#123;</span><br><span class=\"line\">      </span><br><span class=\"line\">       <span class=\"keyword\">return</span> <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">get</span>(target,key,receiver)</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">    <span class=\"title function_\">set</span>(<span class=\"params\">target, key, newValue, receiver</span>) &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">        <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">set</span>(target,key,newValue,receiver)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时，我们就可以在get，set方法中具体监听info对象，<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy\">Proxy具体用法</a>，<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Reflect\">Reflect具体用法</a>。</p>\n<h2 id=\"依赖收集（响应式原理）\"><a href=\"#依赖收集（响应式原理）\" class=\"headerlink\" title=\"依赖收集（响应式原理）\"></a>依赖收集（响应式原理）</h2><p>手写源码如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//保存当前响应式函数</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> activeReactiveFn=<span class=\"literal\">null</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Depend</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>=<span class=\"keyword\">new</span> <span class=\"title class_\">Set</span>()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">addDepend</span>(<span class=\"params\">reactiveFn</span>)&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">add</span>(reactiveFn)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">depend</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(activeReactiveFn)&#123;</span><br><span class=\"line\">            <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">add</span>(activeReactiveFn)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">notify</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">fn</span>=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"title function_\">fn</span>()</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//封装一个响应式函数</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">watchFn</span>(<span class=\"params\">fn</span>)&#123;</span><br><span class=\"line\">    activeReactiveFn=fn</span><br><span class=\"line\">    <span class=\"title function_\">fn</span>()</span><br><span class=\"line\">    activeReactiveFn=<span class=\"literal\">null</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//封装一个获取depend函数</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> targetMap=<span class=\"keyword\">new</span> <span class=\"title class_\">WeakMap</span>()</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getDepend</span>(<span class=\"params\">target,key</span>)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//根据target获取map</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> map=targetMap.<span class=\"title function_\">get</span>(target)</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!map)&#123;</span><br><span class=\"line\">        map = <span class=\"keyword\">new</span> <span class=\"title class_\">Map</span>()</span><br><span class=\"line\">        targetMap.<span class=\"title function_\">set</span>(target,map)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//根据key获取depend</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> depend=map.<span class=\"title function_\">get</span>(key)</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!depend)&#123;</span><br><span class=\"line\">        depend = <span class=\"keyword\">new</span> <span class=\"title class_\">Depend</span>()</span><br><span class=\"line\">        map.<span class=\"title function_\">set</span>(key,depend)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> depend</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//Vue3响应式原理Proxy</span></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">reactive</span>(<span class=\"params\">obj</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Proxy</span>(obj,&#123;</span><br><span class=\"line\">        <span class=\"title function_\">get</span>(<span class=\"params\">target, key, receiver</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">//依赖收集</span></span><br><span class=\"line\">            <span class=\"comment\">//根据target，key获取对应的depend</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> depend=<span class=\"title function_\">getDepend</span>(target,key)</span><br><span class=\"line\">            <span class=\"comment\">//给depend添加函数</span></span><br><span class=\"line\">            <span class=\"comment\">// depend.addDepend(activeReactiveFn)</span></span><br><span class=\"line\">            depend.<span class=\"title function_\">depend</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">get</span>(target,key,receiver)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"title function_\">set</span>(<span class=\"params\">target, key, newValue, receiver</span>) &#123;</span><br><span class=\"line\">            <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">set</span>(target,key,newValue,receiver)</span><br><span class=\"line\">            <span class=\"comment\">// depend.notify()</span></span><br><span class=\"line\">            <span class=\"keyword\">const</span> depend=<span class=\"title function_\">getDepend</span>(target,key)</span><br><span class=\"line\">            depend.<span class=\"title function_\">notify</span>()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> info=&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> infoProxy=<span class=\"title function_\">reactive</span>(info)</span><br><span class=\"line\"><span class=\"title function_\">watchFn</span>(<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(infoProxy.<span class=\"property\">name</span>)</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\">infoProxy.<span class=\"property\">name</span>=<span class=\"string\">&quot;1in.&quot;</span></span><br></pre></td></tr></table></figure>\n<p>首先，我们需要声明一个Set数据结构reactiveFns来存储watchFn函数（可以用数组来存储，但是数组的值可以重复，可能会导致收集的依赖函数重复，所以这里我们用Set数据结构，防止重复。），因为watchFn函数不止一个，并且我们需要依次执行所有的watchFn函数，所以我们需要创建一个class来声明这些方法。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//创建一个class</span></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Depend</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_\">constructor</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//利用Set数据结构防止收集的依赖函数重复</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>=<span class=\"keyword\">new</span> <span class=\"title class_\">Set</span>()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_\">addDepend</span>(<span class=\"params\">reactiveFn</span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//将依赖函数添加到Set数据结构中</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">add</span>(reactiveFn)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"title function_\">notify</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"comment\">//利用forEach遍历Set数据结构，依次执行watchFn函数</span></span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">reactiveFns</span>.<span class=\"title function_\">forEach</span>(<span class=\"function\"><span class=\"params\">fn</span>=&gt;</span>&#123;</span><br><span class=\"line\">            <span class=\"title function_\">fn</span>()</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>随后我们就可以创建一个reactive函数，传入一个obj对象，返回一个响应式（Proxy）的对象，自动绑定为响应式。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">reactive</span>(<span class=\"params\">obj</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Proxy</span>(obj,&#123;</span><br><span class=\"line\">        <span class=\"title function_\">get</span>(<span class=\"params\">target, key, receiver</span>) &#123;</span><br><span class=\"line\">            </span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">get</span>(target,key,receiver)</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"title function_\">set</span>(<span class=\"params\">target, key, newValue, receiver</span>) &#123;</span><br><span class=\"line\">            <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">set</span>(target,key,newValue,receiver)</span><br><span class=\"line\">            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>接下来，我们就可以为对象中的每一个元素属性进行依赖收集，在这里我们用到了WeakMap以及Map数据结构，因为每一个元素的依赖都不一样，所以每一个元素都要new一个Depend对象存储在Map数据结构中（一个Map对应着一个对象），最终用WeakMap将所有的Map存储起来，这里用WeakMap的原因是WeakMap的key是弱引用，当存储的Map指针指向为null时，这个Map就会被GC垃圾回收，可以防止内存泄漏。</p>\n<img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/42643cc767a64613a11b1889b39c1eb2~tplv-k3u1fbpfcp-watermark.image?\" alt=\"c42897359ca89d8cf08d9383051236a.jpg\" width=\"100%\" />\n\n<p>所以接下来我们需要构造一个getDepend函数。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//创建一个WeakMap的数据结构</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> targetMap=<span class=\"keyword\">new</span> <span class=\"title class_\">WeakMap</span>()</span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">getDepend</span>(<span class=\"params\">target,key</span>)&#123;</span><br><span class=\"line\">    <span class=\"comment\">//根据target获取map</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> map=targetMap.<span class=\"title function_\">get</span>(target)</span><br><span class=\"line\">    <span class=\"comment\">//第一次get肯定没有map，所以需要new</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!map)&#123;</span><br><span class=\"line\">        map = <span class=\"keyword\">new</span> <span class=\"title class_\">Map</span>()</span><br><span class=\"line\">        targetMap.<span class=\"title function_\">set</span>(target,map)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//根据key获取depend</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> depend=map.<span class=\"title function_\">get</span>(key)</span><br><span class=\"line\">    <span class=\"comment\">//第一次get肯定没有depend，所以需要new</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!depend)&#123;</span><br><span class=\"line\">        depend = <span class=\"keyword\">new</span> <span class=\"title class_\">Depend</span>()</span><br><span class=\"line\">        map.<span class=\"title function_\">set</span>(key,depend)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> depend</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>当我们构造了一个getDepend函数之后，我们就可以在Proxy中添加getDepend函数，完成响应式。</p>\n<p>在此之前我们需要构造watchFn函数。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function watchFn(fn)&#123;</span><br><span class=\"line\">    fn()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">new</span> <span class=\"title class_\">Proxy</span>(obj,&#123;</span><br><span class=\"line\">    <span class=\"title function_\">get</span>(<span class=\"params\">target, key, receiver</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">//依赖收集</span></span><br><span class=\"line\">        <span class=\"comment\">//根据target，key获取对应的depend</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> depend=<span class=\"title function_\">getDepend</span>(target,key)</span><br><span class=\"line\">        <span class=\"comment\">//给depend添加函数</span></span><br><span class=\"line\">        depend.<span class=\"title function_\">addDepend</span>(activeReactiveFn)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">get</span>(target,key,receiver)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"title function_\">set</span>(<span class=\"params\">target, key, newValue, receiver</span>) &#123;</span><br><span class=\"line\">        <span class=\"title class_\">Reflect</span>.<span class=\"title function_\">set</span>(target,key,newValue,receiver)</span><br><span class=\"line\">        <span class=\"comment\">// depend.notify()</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> depend=<span class=\"title function_\">getDepend</span>(target,key)</span><br><span class=\"line\">        depend.<span class=\"title function_\">notify</span>()</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>在set方法中，调用notify（）方法执行所有的watchFn函数，在get方法中，收集所有的依赖函数，因为依赖函数依赖对象中的元素属性，所以当依赖函数调用时，会调用Proxy中的get方法，所以我们可以在get方法中进行依赖函数的收集，所以，我们需要在全局声明一个activeReactiveFn&#x3D;null,当依赖函数调用之前，使activeReactiveFn指向这个依赖函数，当依赖函数调用get方法时，将这个依赖函数添加到reactiveFns中。具体代码如下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> activeReactiveFn=<span class=\"literal\">null</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">watchFn</span>(<span class=\"params\">fn</span>)&#123;</span><br><span class=\"line\">    activeReactiveFn=fn</span><br><span class=\"line\">    <span class=\"title function_\">fn</span>()</span><br><span class=\"line\">    activeReactiveFn=<span class=\"literal\">null</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>当然，我们也可以对addDepend进行优化，也就是说我们直接可以调用depend.depend()函数，自动添加依赖函数到reactiveFns中，不用传参，所以我们需要在class中添加一个depend（）方法。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Depend&#123;</span><br><span class=\"line\">    constructor() &#123;</span><br><span class=\"line\">        this.reactiveFns=new Set()</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    addDepend(reactiveFn)&#123;</span><br><span class=\"line\">        this.reactiveFns.add(reactiveFn)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    depend()&#123;</span><br><span class=\"line\">        if(activeReactiveFn)&#123;</span><br><span class=\"line\">            this.reactiveFns.add(activeReactiveFn)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    notify()&#123;</span><br><span class=\"line\">        this.reactiveFns.forEach(fn=&gt;&#123;</span><br><span class=\"line\">            fn()</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>随后，我们就可以在get方法中这样调用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">get(target, key, receiver) &#123;</span><br><span class=\"line\">    //依赖收集</span><br><span class=\"line\">    //根据target，key获取对应的depend</span><br><span class=\"line\">    const depend=getDepend(target,key)</span><br><span class=\"line\">    //给depend添加函数</span><br><span class=\"line\">    // depend.addDepend(activeReactiveFn)</span><br><span class=\"line\">    depend.depend()</span><br><span class=\"line\"></span><br><span class=\"line\">    return Reflect.get(target,key,receiver)</span><br><span class=\"line\">&#125;,</span><br></pre></td></tr></table></figure>\n\n<p>至此，Proxy的依赖收集，手写结束！🥳🥳🥳。</p>\n<h2 id=\"总结-🥂\"><a href=\"#总结-🥂\" class=\"headerlink\" title=\"总结 🥂\"></a>总结 🥂</h2><ol>\n<li>对象中的每一个元素属性都有对应的一个Depend对象（reactiveFns）。</li>\n<li>使用WeakMap存储对象（Map），使用Map存储Depend对象。</li>\n<li>使用Set数据结构来存储reactiveFns，防止收集依赖函数重复。</li>\n<li>使用Proxy中的set方法来执行reactiveFns。</li>\n<li>使用Proxy中的get方法来收集依赖函数。</li>\n</ol>\n"},{"title":"迭代器（iterator）、可迭代对象、生成器（generator）到底是什么","date":"2023-05-28T11:42:33.118Z","sticky":100,"_content":"\n##  前言\n在JS中，我们常常需要使用async以及await语法来发送网络请求等操作，但是这个语法的背后实现原理到底是什么呢？，我们就得需要了解迭代器（iterator）、可迭代对象、生成器（generator）这些知识点也在各种开源库中，广泛应用。\n\n## 什么是迭代器（iterator）\n在JS中，迭代器是一个对象，这个对象中有一个next（）方法，每次调用会retrun出一个对象，这个对象中有两个参数，done（bool类型）、value（具体的属性值），当迭代未完全完成时，done的值则会一直为false，当value的值为最后一个时，下一次的next（）调用返回的done则为true，表明迭代完全完成，此时的value值为undefined。\n\n下面则是一个简单的迭代器实现\n```js\nconst obj=['1','i','n']\n\nconst iterator=(obj)=>{\n    let index=0\n    return {\n        next(){\n            if(index<obj.length){\n                return {done:false,value:obj[index++]}\n            }\n            else{\n                return {done:true,value:undefined}\n            }\n        }\n    }\n}\n\nconst iteratorObj=iterator(obj)\n\nconsole.log(iteratorObj.next())\nconsole.log(iteratorObj.next())\nconsole.log(iteratorObj.next())\nconsole.log(iteratorObj.next())\n```\n调用四次next（）方法输出结果如下\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7683be7fded5469187808cbefae332b0~tplv-k3u1fbpfcp-watermark.image?)\n每一次调用next（）方法就会返回迭代结果。\n\n## 什么是可迭代对象\n一种很简单的说法就是，具有迭代器的对象就是可迭代对象，但是这个迭代器的名称为[Symbol.iterator]，\n它和迭代器是不同的概念，当一个对象实现了iterable protocol协议时，他就是一个可迭代对象，这个对象的要求是必须实现@@iterator方法，在代码中我们使用Symbol.iterator访问该属性。\n\n以下为简单的可迭代对象代码实现\n```js\nconst iteratorObj={\n    obj:['1','i','n'],\n    [Symbol.iterator]:function (){\n        let index=0\n        return{\n            next:()=>{\n                if(index<this.obj.length){\n                    return {done:false,value:this.obj[index++]}\n                }\n                else{\n                    return {done:true,value:undefined}\n                }\n            } \n        }\n    }\n}\n```\n那么可迭代对象有什么用呢？，我们都知道，for of 遍历的对象都需要是有迭代器的对象，比如Set、Map、Array，所以我们简单实现的这个可迭代对象是可以用 for of 遍历的。\n\n所以我们用for of 遍历输出一些结果，结果如下\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5523e567d5974c42b47172f1d986a49d~tplv-k3u1fbpfcp-watermark.image?)\n**在这里，我们的next（）方法一定要用箭头函数，将this指针绑定为interatorObj**\n\n## 可迭代对象的应用场景\n1. Javascript语法中，for of、展开语法（spread syntax）、yield*（yield*返回的必须是一个可迭代对象）、数组的解构赋值。\n2. 创建一些对象时：new Map([Iterable])、new WeakMap([Iterable])、new Set([Iterable])、new WeakSet([Iterable])。\n3. 一些方法的调用：Promise.all（Iterable）、Promise.race（Iterable）、Array.from（Iterable）。\n\n### 注意！！！\n\n```js\nconst newObj={...obj}\n```\n像这个展开语法，没有用到可迭代对象，而是在ES9（ES2018）中新增的一个特性。\n\n```js\nconst {done,value}=obj\n```\n这种对象的解构赋值也是ES9新增的特性\n\n## 什么是生成器\n生成器是ES6中新增的一种函数控制、使用的方案、它可以让我们更加灵活的控制函数什么时候继续执行、暂停执行等。\n\n平时我们会编写很多的函数，这些函数终止的条件通常是返回值或者发生了异常。\n\n在我们了解生成器之前，我们需要了解生成器函数。\n\n## 生成器函数\n生成器函数也是一个函数，但是和普通的函数有一些区别\n1. 生成器函数需要在function的后面加一个符号：*。\n2. 生成器函数可以通过yield关键字来控制函数的执行流程。\n3. 生成器函数的返回值是一个Generator（生成器）。\n\n生成器事实上是一种特殊的迭代器。\nMDN：Instead,they return a special type of iterator,called a **Generator**\n\n下面是一个简单的生成器函数代码\n```js\nfunction* foo(){\n    const value1='1'\n    console.log(value1)\n    yield\n    const value2='i'\n    console.log(value2)\n    yield\n    const value3='n'\n    console.log(value3)\n    yield\n}\nconst generator=foo()\ngenerator.next()\ngenerator.next()\ngenerator.next()\n```\n执行结果如下\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e17e01defcb94ea0b7fb4a7478bf9dea~tplv-k3u1fbpfcp-watermark.image?)\n生成器函数通过yield关键字控制函数的执行，当我们每一次调用next（）方法时，就会调用yield对应顺序的以下代码。\n\n### yield关键字传出参数\n当然，我们也可以通过在yield后边跟参数，将参数传出，并在next（）方法调用时接收\n\n```js\nfunction* foo(){\n    const value1='1'\n    console.log(value1)\n    yield 'export 1'\n    const value2='i'\n    console.log(value2)\n    yield 'export i'\n    const value3='n'\n    console.log(value3)\n    yield 'export n'\n}\nconst generator=foo()\nconst word1=generator.next()\nconst word2=generator.next()\nconst word3=generator.next()\nconsole.log(word1)\nconsole.log(word2)\nconsole.log(word3)\n```\n输出结果如下\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c510e993c4a42138fa923a81b0af9ce~tplv-k3u1fbpfcp-watermark.image?)\n\n### next（）方法调用传入参数\n当然，我们也可以在next（）方法调用时，传入参数，并用每一次yield执行时接收参数。\n```js\nfunction* foo(){\n    const value1='1'\n    console.log(value1)\n    const s1=yield 'export 1'\n    console.log(s1)\n    const value2='i'\n    console.log(value2)\n    const s2=yield 'export i'\n    console.log(s2)\n    const value3='n'\n    console.log(value3)\n    const s3= yield 'export n'\n    console.log(s3)\n}\nconst generator=foo()\nconst word1=generator.next()\nconst word2=generator.next('incoming 1')\nconst word3=generator.next('incoming i')\nconst word4=generator.next('incoming n')\nconsole.log(word1)\nconsole.log(word2)\nconsole.log(word3)\nconsole.log(word4)\n```\n执行结果如下\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0b82171c6b44685a5a52d383cf17c75~tplv-k3u1fbpfcp-watermark.image?)\n\n### return方法以及throw方法\n通过调用return（）方法可以直接return出函数，不会再执行后边的函数，也无法用yield控制函数执行的过程，next（）方法也无法执行，throw方法则可以抛出异常。通过try catch方法去捕获错误。\n\n## yield*\n在生成器函数中 yield可以传出参数，但是当我们用yield* 传出参数时，传出的参数必须是可迭代对象，async和await语法糖也是用到了yield*实现。\n\n## 总结\n1. 迭代器是一个对象，这个对象中有一个next（）方法，每次调用会retrun出一个对象，这个对象中有两个参数，done（bool类型）、value（具体的属性值）\n2. 当一个对象实现了iterable protocol协议时，他就是一个可迭代对象，这个对象的要求是必须实现@@iterator方法，在代码中我们使用Symbol.iterator访问该属性。\n3. 生成器是ES6中新增的一种函数控制、使用的方案、它可以让我们更加灵活的控制函数什么时候继续执行、暂停执行等。\n4. 生成器事实上是一种特殊的迭代器。\n5. yield关键字传出参数、next（）方法调用传入参数。\n","source":"_posts/迭代器（iterator）、可迭代对象、生成器（generator）到底是什么.md","raw":"---\ntitle: 迭代器（iterator）、可迭代对象、生成器（generator）到底是什么\ndate: 2023/04/03 20-20\ntag: JavaScript\nsticky: 100\ncategory:\n - 前端\n---\n\n##  前言\n在JS中，我们常常需要使用async以及await语法来发送网络请求等操作，但是这个语法的背后实现原理到底是什么呢？，我们就得需要了解迭代器（iterator）、可迭代对象、生成器（generator）这些知识点也在各种开源库中，广泛应用。\n\n## 什么是迭代器（iterator）\n在JS中，迭代器是一个对象，这个对象中有一个next（）方法，每次调用会retrun出一个对象，这个对象中有两个参数，done（bool类型）、value（具体的属性值），当迭代未完全完成时，done的值则会一直为false，当value的值为最后一个时，下一次的next（）调用返回的done则为true，表明迭代完全完成，此时的value值为undefined。\n\n下面则是一个简单的迭代器实现\n```js\nconst obj=['1','i','n']\n\nconst iterator=(obj)=>{\n    let index=0\n    return {\n        next(){\n            if(index<obj.length){\n                return {done:false,value:obj[index++]}\n            }\n            else{\n                return {done:true,value:undefined}\n            }\n        }\n    }\n}\n\nconst iteratorObj=iterator(obj)\n\nconsole.log(iteratorObj.next())\nconsole.log(iteratorObj.next())\nconsole.log(iteratorObj.next())\nconsole.log(iteratorObj.next())\n```\n调用四次next（）方法输出结果如下\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7683be7fded5469187808cbefae332b0~tplv-k3u1fbpfcp-watermark.image?)\n每一次调用next（）方法就会返回迭代结果。\n\n## 什么是可迭代对象\n一种很简单的说法就是，具有迭代器的对象就是可迭代对象，但是这个迭代器的名称为[Symbol.iterator]，\n它和迭代器是不同的概念，当一个对象实现了iterable protocol协议时，他就是一个可迭代对象，这个对象的要求是必须实现@@iterator方法，在代码中我们使用Symbol.iterator访问该属性。\n\n以下为简单的可迭代对象代码实现\n```js\nconst iteratorObj={\n    obj:['1','i','n'],\n    [Symbol.iterator]:function (){\n        let index=0\n        return{\n            next:()=>{\n                if(index<this.obj.length){\n                    return {done:false,value:this.obj[index++]}\n                }\n                else{\n                    return {done:true,value:undefined}\n                }\n            } \n        }\n    }\n}\n```\n那么可迭代对象有什么用呢？，我们都知道，for of 遍历的对象都需要是有迭代器的对象，比如Set、Map、Array，所以我们简单实现的这个可迭代对象是可以用 for of 遍历的。\n\n所以我们用for of 遍历输出一些结果，结果如下\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5523e567d5974c42b47172f1d986a49d~tplv-k3u1fbpfcp-watermark.image?)\n**在这里，我们的next（）方法一定要用箭头函数，将this指针绑定为interatorObj**\n\n## 可迭代对象的应用场景\n1. Javascript语法中，for of、展开语法（spread syntax）、yield*（yield*返回的必须是一个可迭代对象）、数组的解构赋值。\n2. 创建一些对象时：new Map([Iterable])、new WeakMap([Iterable])、new Set([Iterable])、new WeakSet([Iterable])。\n3. 一些方法的调用：Promise.all（Iterable）、Promise.race（Iterable）、Array.from（Iterable）。\n\n### 注意！！！\n\n```js\nconst newObj={...obj}\n```\n像这个展开语法，没有用到可迭代对象，而是在ES9（ES2018）中新增的一个特性。\n\n```js\nconst {done,value}=obj\n```\n这种对象的解构赋值也是ES9新增的特性\n\n## 什么是生成器\n生成器是ES6中新增的一种函数控制、使用的方案、它可以让我们更加灵活的控制函数什么时候继续执行、暂停执行等。\n\n平时我们会编写很多的函数，这些函数终止的条件通常是返回值或者发生了异常。\n\n在我们了解生成器之前，我们需要了解生成器函数。\n\n## 生成器函数\n生成器函数也是一个函数，但是和普通的函数有一些区别\n1. 生成器函数需要在function的后面加一个符号：*。\n2. 生成器函数可以通过yield关键字来控制函数的执行流程。\n3. 生成器函数的返回值是一个Generator（生成器）。\n\n生成器事实上是一种特殊的迭代器。\nMDN：Instead,they return a special type of iterator,called a **Generator**\n\n下面是一个简单的生成器函数代码\n```js\nfunction* foo(){\n    const value1='1'\n    console.log(value1)\n    yield\n    const value2='i'\n    console.log(value2)\n    yield\n    const value3='n'\n    console.log(value3)\n    yield\n}\nconst generator=foo()\ngenerator.next()\ngenerator.next()\ngenerator.next()\n```\n执行结果如下\n\n![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e17e01defcb94ea0b7fb4a7478bf9dea~tplv-k3u1fbpfcp-watermark.image?)\n生成器函数通过yield关键字控制函数的执行，当我们每一次调用next（）方法时，就会调用yield对应顺序的以下代码。\n\n### yield关键字传出参数\n当然，我们也可以通过在yield后边跟参数，将参数传出，并在next（）方法调用时接收\n\n```js\nfunction* foo(){\n    const value1='1'\n    console.log(value1)\n    yield 'export 1'\n    const value2='i'\n    console.log(value2)\n    yield 'export i'\n    const value3='n'\n    console.log(value3)\n    yield 'export n'\n}\nconst generator=foo()\nconst word1=generator.next()\nconst word2=generator.next()\nconst word3=generator.next()\nconsole.log(word1)\nconsole.log(word2)\nconsole.log(word3)\n```\n输出结果如下\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c510e993c4a42138fa923a81b0af9ce~tplv-k3u1fbpfcp-watermark.image?)\n\n### next（）方法调用传入参数\n当然，我们也可以在next（）方法调用时，传入参数，并用每一次yield执行时接收参数。\n```js\nfunction* foo(){\n    const value1='1'\n    console.log(value1)\n    const s1=yield 'export 1'\n    console.log(s1)\n    const value2='i'\n    console.log(value2)\n    const s2=yield 'export i'\n    console.log(s2)\n    const value3='n'\n    console.log(value3)\n    const s3= yield 'export n'\n    console.log(s3)\n}\nconst generator=foo()\nconst word1=generator.next()\nconst word2=generator.next('incoming 1')\nconst word3=generator.next('incoming i')\nconst word4=generator.next('incoming n')\nconsole.log(word1)\nconsole.log(word2)\nconsole.log(word3)\nconsole.log(word4)\n```\n执行结果如下\n\n![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0b82171c6b44685a5a52d383cf17c75~tplv-k3u1fbpfcp-watermark.image?)\n\n### return方法以及throw方法\n通过调用return（）方法可以直接return出函数，不会再执行后边的函数，也无法用yield控制函数执行的过程，next（）方法也无法执行，throw方法则可以抛出异常。通过try catch方法去捕获错误。\n\n## yield*\n在生成器函数中 yield可以传出参数，但是当我们用yield* 传出参数时，传出的参数必须是可迭代对象，async和await语法糖也是用到了yield*实现。\n\n## 总结\n1. 迭代器是一个对象，这个对象中有一个next（）方法，每次调用会retrun出一个对象，这个对象中有两个参数，done（bool类型）、value（具体的属性值）\n2. 当一个对象实现了iterable protocol协议时，他就是一个可迭代对象，这个对象的要求是必须实现@@iterator方法，在代码中我们使用Symbol.iterator访问该属性。\n3. 生成器是ES6中新增的一种函数控制、使用的方案、它可以让我们更加灵活的控制函数什么时候继续执行、暂停执行等。\n4. 生成器事实上是一种特殊的迭代器。\n5. yield关键字传出参数、next（）方法调用传入参数。\n","slug":"迭代器（iterator）、可迭代对象、生成器（generator）到底是什么","published":1,"updated":"2023-05-28T11:54:59.522Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5ksr000u0svhhty7cpmv","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在JS中，我们常常需要使用async以及await语法来发送网络请求等操作，但是这个语法的背后实现原理到底是什么呢？，我们就得需要了解迭代器（iterator）、可迭代对象、生成器（generator）这些知识点也在各种开源库中，广泛应用。</p>\n<h2 id=\"什么是迭代器（iterator）\"><a href=\"#什么是迭代器（iterator）\" class=\"headerlink\" title=\"什么是迭代器（iterator）\"></a>什么是迭代器（iterator）</h2><p>在JS中，迭代器是一个对象，这个对象中有一个next（）方法，每次调用会retrun出一个对象，这个对象中有两个参数，done（bool类型）、value（具体的属性值），当迭代未完全完成时，done的值则会一直为false，当value的值为最后一个时，下一次的next（）调用返回的done则为true，表明迭代完全完成，此时的value值为undefined。</p>\n<p>下面则是一个简单的迭代器实现</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> obj=[<span class=\"string\">&#x27;1&#x27;</span>,<span class=\"string\">&#x27;i&#x27;</span>,<span class=\"string\">&#x27;n&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">iterator</span>=(<span class=\"params\">obj</span>)=&gt;&#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> index=<span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">next</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(index&lt;obj.<span class=\"property\">length</span>)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> &#123;<span class=\"attr\">done</span>:<span class=\"literal\">false</span>,<span class=\"attr\">value</span>:obj[index++]&#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> &#123;<span class=\"attr\">done</span>:<span class=\"literal\">true</span>,<span class=\"attr\">value</span>:<span class=\"literal\">undefined</span>&#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> iteratorObj=<span class=\"title function_\">iterator</span>(obj)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(iteratorObj.<span class=\"title function_\">next</span>())</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(iteratorObj.<span class=\"title function_\">next</span>())</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(iteratorObj.<span class=\"title function_\">next</span>())</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(iteratorObj.<span class=\"title function_\">next</span>())</span><br></pre></td></tr></table></figure>\n<p>调用四次next（）方法输出结果如下</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7683be7fded5469187808cbefae332b0~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br>每一次调用next（）方法就会返回迭代结果。</p>\n<h2 id=\"什么是可迭代对象\"><a href=\"#什么是可迭代对象\" class=\"headerlink\" title=\"什么是可迭代对象\"></a>什么是可迭代对象</h2><p>一种很简单的说法就是，具有迭代器的对象就是可迭代对象，但是这个迭代器的名称为[Symbol.iterator]，<br>它和迭代器是不同的概念，当一个对象实现了iterable protocol协议时，他就是一个可迭代对象，这个对象的要求是必须实现@@iterator方法，在代码中我们使用Symbol.iterator访问该属性。</p>\n<p>以下为简单的可迭代对象代码实现</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> iteratorObj=&#123;</span><br><span class=\"line\">    <span class=\"attr\">obj</span>:[<span class=\"string\">&#x27;1&#x27;</span>,<span class=\"string\">&#x27;i&#x27;</span>,<span class=\"string\">&#x27;n&#x27;</span>],</span><br><span class=\"line\">    [<span class=\"title class_\">Symbol</span>.<span class=\"property\">iterator</span>]:<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> index=<span class=\"number\">0</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>&#123;</span><br><span class=\"line\">            <span class=\"attr\">next</span>:<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(index&lt;<span class=\"variable language_\">this</span>.<span class=\"property\">obj</span>.<span class=\"property\">length</span>)&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> &#123;<span class=\"attr\">done</span>:<span class=\"literal\">false</span>,<span class=\"attr\">value</span>:<span class=\"variable language_\">this</span>.<span class=\"property\">obj</span>[index++]&#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> &#123;<span class=\"attr\">done</span>:<span class=\"literal\">true</span>,<span class=\"attr\">value</span>:<span class=\"literal\">undefined</span>&#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>那么可迭代对象有什么用呢？，我们都知道，for of 遍历的对象都需要是有迭代器的对象，比如Set、Map、Array，所以我们简单实现的这个可迭代对象是可以用 for of 遍历的。</p>\n<p>所以我们用for of 遍历输出一些结果，结果如下</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5523e567d5974c42b47172f1d986a49d~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>在这里，我们的next（）方法一定要用箭头函数，将this指针绑定为interatorObj</strong></p>\n<h2 id=\"可迭代对象的应用场景\"><a href=\"#可迭代对象的应用场景\" class=\"headerlink\" title=\"可迭代对象的应用场景\"></a>可迭代对象的应用场景</h2><ol>\n<li>Javascript语法中，for of、展开语法（spread syntax）、yield<em>（yield</em>返回的必须是一个可迭代对象）、数组的解构赋值。</li>\n<li>创建一些对象时：new Map([Iterable])、new WeakMap([Iterable])、new Set([Iterable])、new WeakSet([Iterable])。</li>\n<li>一些方法的调用：Promise.all（Iterable）、Promise.race（Iterable）、Array.from（Iterable）。</li>\n</ol>\n<h3 id=\"注意！！！\"><a href=\"#注意！！！\" class=\"headerlink\" title=\"注意！！！\"></a>注意！！！</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> newObj=&#123;...obj&#125;</span><br></pre></td></tr></table></figure>\n<p>像这个展开语法，没有用到可迭代对象，而是在ES9（ES2018）中新增的一个特性。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> &#123;done,value&#125;=obj</span><br></pre></td></tr></table></figure>\n<p>这种对象的解构赋值也是ES9新增的特性</p>\n<h2 id=\"什么是生成器\"><a href=\"#什么是生成器\" class=\"headerlink\" title=\"什么是生成器\"></a>什么是生成器</h2><p>生成器是ES6中新增的一种函数控制、使用的方案、它可以让我们更加灵活的控制函数什么时候继续执行、暂停执行等。</p>\n<p>平时我们会编写很多的函数，这些函数终止的条件通常是返回值或者发生了异常。</p>\n<p>在我们了解生成器之前，我们需要了解生成器函数。</p>\n<h2 id=\"生成器函数\"><a href=\"#生成器函数\" class=\"headerlink\" title=\"生成器函数\"></a>生成器函数</h2><p>生成器函数也是一个函数，但是和普通的函数有一些区别</p>\n<ol>\n<li>生成器函数需要在function的后面加一个符号：*。</li>\n<li>生成器函数可以通过yield关键字来控制函数的执行流程。</li>\n<li>生成器函数的返回值是一个Generator（生成器）。</li>\n</ol>\n<p>生成器事实上是一种特殊的迭代器。<br>MDN：Instead,they return a special type of iterator,called a <strong>Generator</strong></p>\n<p>下面是一个简单的生成器函数代码</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span>* <span class=\"title function_\">foo</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value1=<span class=\"string\">&#x27;1&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value1)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> value2=<span class=\"string\">&#x27;i&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value2)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> value3=<span class=\"string\">&#x27;n&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value3)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> generator=<span class=\"title function_\">foo</span>()</span><br><span class=\"line\">generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\">generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\">generator.<span class=\"title function_\">next</span>()</span><br></pre></td></tr></table></figure>\n<p>执行结果如下</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e17e01defcb94ea0b7fb4a7478bf9dea~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br>生成器函数通过yield关键字控制函数的执行，当我们每一次调用next（）方法时，就会调用yield对应顺序的以下代码。</p>\n<h3 id=\"yield关键字传出参数\"><a href=\"#yield关键字传出参数\" class=\"headerlink\" title=\"yield关键字传出参数\"></a>yield关键字传出参数</h3><p>当然，我们也可以通过在yield后边跟参数，将参数传出，并在next（）方法调用时接收</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span>* <span class=\"title function_\">foo</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value1=<span class=\"string\">&#x27;1&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value1)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export 1&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> value2=<span class=\"string\">&#x27;i&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value2)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export i&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> value3=<span class=\"string\">&#x27;n&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value3)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export n&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> generator=<span class=\"title function_\">foo</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word1=generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word2=generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word3=generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word1)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word2)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word3)</span><br></pre></td></tr></table></figure>\n<p>输出结果如下</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c510e993c4a42138fa923a81b0af9ce~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"next（）方法调用传入参数\"><a href=\"#next（）方法调用传入参数\" class=\"headerlink\" title=\"next（）方法调用传入参数\"></a>next（）方法调用传入参数</h3><p>当然，我们也可以在next（）方法调用时，传入参数，并用每一次yield执行时接收参数。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span>* <span class=\"title function_\">foo</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value1=<span class=\"string\">&#x27;1&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value1)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> s1=<span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export 1&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(s1)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value2=<span class=\"string\">&#x27;i&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value2)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> s2=<span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export i&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(s2)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value3=<span class=\"string\">&#x27;n&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value3)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> s3= <span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export n&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(s3)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> generator=<span class=\"title function_\">foo</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word1=generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word2=generator.<span class=\"title function_\">next</span>(<span class=\"string\">&#x27;incoming 1&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> word3=generator.<span class=\"title function_\">next</span>(<span class=\"string\">&#x27;incoming i&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> word4=generator.<span class=\"title function_\">next</span>(<span class=\"string\">&#x27;incoming n&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word1)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word2)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word3)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word4)</span><br></pre></td></tr></table></figure>\n<p>执行结果如下</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0b82171c6b44685a5a52d383cf17c75~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"return方法以及throw方法\"><a href=\"#return方法以及throw方法\" class=\"headerlink\" title=\"return方法以及throw方法\"></a>return方法以及throw方法</h3><p>通过调用return（）方法可以直接return出函数，不会再执行后边的函数，也无法用yield控制函数执行的过程，next（）方法也无法执行，throw方法则可以抛出异常。通过try catch方法去捕获错误。</p>\n<h2 id=\"yield\"><a href=\"#yield\" class=\"headerlink\" title=\"yield*\"></a>yield*</h2><p>在生成器函数中 yield可以传出参数，但是当我们用yield* 传出参数时，传出的参数必须是可迭代对象，async和await语法糖也是用到了yield*实现。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>迭代器是一个对象，这个对象中有一个next（）方法，每次调用会retrun出一个对象，这个对象中有两个参数，done（bool类型）、value（具体的属性值）</li>\n<li>当一个对象实现了iterable protocol协议时，他就是一个可迭代对象，这个对象的要求是必须实现@@iterator方法，在代码中我们使用Symbol.iterator访问该属性。</li>\n<li>生成器是ES6中新增的一种函数控制、使用的方案、它可以让我们更加灵活的控制函数什么时候继续执行、暂停执行等。</li>\n<li>生成器事实上是一种特殊的迭代器。</li>\n<li>yield关键字传出参数、next（）方法调用传入参数。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在JS中，我们常常需要使用async以及await语法来发送网络请求等操作，但是这个语法的背后实现原理到底是什么呢？，我们就得需要了解迭代器（iterator）、可迭代对象、生成器（generator）这些知识点也在各种开源库中，广泛应用。</p>\n<h2 id=\"什么是迭代器（iterator）\"><a href=\"#什么是迭代器（iterator）\" class=\"headerlink\" title=\"什么是迭代器（iterator）\"></a>什么是迭代器（iterator）</h2><p>在JS中，迭代器是一个对象，这个对象中有一个next（）方法，每次调用会retrun出一个对象，这个对象中有两个参数，done（bool类型）、value（具体的属性值），当迭代未完全完成时，done的值则会一直为false，当value的值为最后一个时，下一次的next（）调用返回的done则为true，表明迭代完全完成，此时的value值为undefined。</p>\n<p>下面则是一个简单的迭代器实现</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> obj=[<span class=\"string\">&#x27;1&#x27;</span>,<span class=\"string\">&#x27;i&#x27;</span>,<span class=\"string\">&#x27;n&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"title function_\">iterator</span>=(<span class=\"params\">obj</span>)=&gt;&#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> index=<span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_\">next</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(index&lt;obj.<span class=\"property\">length</span>)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> &#123;<span class=\"attr\">done</span>:<span class=\"literal\">false</span>,<span class=\"attr\">value</span>:obj[index++]&#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> &#123;<span class=\"attr\">done</span>:<span class=\"literal\">true</span>,<span class=\"attr\">value</span>:<span class=\"literal\">undefined</span>&#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> iteratorObj=<span class=\"title function_\">iterator</span>(obj)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(iteratorObj.<span class=\"title function_\">next</span>())</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(iteratorObj.<span class=\"title function_\">next</span>())</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(iteratorObj.<span class=\"title function_\">next</span>())</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(iteratorObj.<span class=\"title function_\">next</span>())</span><br></pre></td></tr></table></figure>\n<p>调用四次next（）方法输出结果如下</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7683be7fded5469187808cbefae332b0~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br>每一次调用next（）方法就会返回迭代结果。</p>\n<h2 id=\"什么是可迭代对象\"><a href=\"#什么是可迭代对象\" class=\"headerlink\" title=\"什么是可迭代对象\"></a>什么是可迭代对象</h2><p>一种很简单的说法就是，具有迭代器的对象就是可迭代对象，但是这个迭代器的名称为[Symbol.iterator]，<br>它和迭代器是不同的概念，当一个对象实现了iterable protocol协议时，他就是一个可迭代对象，这个对象的要求是必须实现@@iterator方法，在代码中我们使用Symbol.iterator访问该属性。</p>\n<p>以下为简单的可迭代对象代码实现</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> iteratorObj=&#123;</span><br><span class=\"line\">    <span class=\"attr\">obj</span>:[<span class=\"string\">&#x27;1&#x27;</span>,<span class=\"string\">&#x27;i&#x27;</span>,<span class=\"string\">&#x27;n&#x27;</span>],</span><br><span class=\"line\">    [<span class=\"title class_\">Symbol</span>.<span class=\"property\">iterator</span>]:<span class=\"keyword\">function</span> (<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> index=<span class=\"number\">0</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span>&#123;</span><br><span class=\"line\">            <span class=\"attr\">next</span>:<span class=\"function\">()=&gt;</span>&#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(index&lt;<span class=\"variable language_\">this</span>.<span class=\"property\">obj</span>.<span class=\"property\">length</span>)&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> &#123;<span class=\"attr\">done</span>:<span class=\"literal\">false</span>,<span class=\"attr\">value</span>:<span class=\"variable language_\">this</span>.<span class=\"property\">obj</span>[index++]&#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> &#123;<span class=\"attr\">done</span>:<span class=\"literal\">true</span>,<span class=\"attr\">value</span>:<span class=\"literal\">undefined</span>&#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>那么可迭代对象有什么用呢？，我们都知道，for of 遍历的对象都需要是有迭代器的对象，比如Set、Map、Array，所以我们简单实现的这个可迭代对象是可以用 for of 遍历的。</p>\n<p>所以我们用for of 遍历输出一些结果，结果如下</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5523e567d5974c42b47172f1d986a49d~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br><strong>在这里，我们的next（）方法一定要用箭头函数，将this指针绑定为interatorObj</strong></p>\n<h2 id=\"可迭代对象的应用场景\"><a href=\"#可迭代对象的应用场景\" class=\"headerlink\" title=\"可迭代对象的应用场景\"></a>可迭代对象的应用场景</h2><ol>\n<li>Javascript语法中，for of、展开语法（spread syntax）、yield<em>（yield</em>返回的必须是一个可迭代对象）、数组的解构赋值。</li>\n<li>创建一些对象时：new Map([Iterable])、new WeakMap([Iterable])、new Set([Iterable])、new WeakSet([Iterable])。</li>\n<li>一些方法的调用：Promise.all（Iterable）、Promise.race（Iterable）、Array.from（Iterable）。</li>\n</ol>\n<h3 id=\"注意！！！\"><a href=\"#注意！！！\" class=\"headerlink\" title=\"注意！！！\"></a>注意！！！</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> newObj=&#123;...obj&#125;</span><br></pre></td></tr></table></figure>\n<p>像这个展开语法，没有用到可迭代对象，而是在ES9（ES2018）中新增的一个特性。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> &#123;done,value&#125;=obj</span><br></pre></td></tr></table></figure>\n<p>这种对象的解构赋值也是ES9新增的特性</p>\n<h2 id=\"什么是生成器\"><a href=\"#什么是生成器\" class=\"headerlink\" title=\"什么是生成器\"></a>什么是生成器</h2><p>生成器是ES6中新增的一种函数控制、使用的方案、它可以让我们更加灵活的控制函数什么时候继续执行、暂停执行等。</p>\n<p>平时我们会编写很多的函数，这些函数终止的条件通常是返回值或者发生了异常。</p>\n<p>在我们了解生成器之前，我们需要了解生成器函数。</p>\n<h2 id=\"生成器函数\"><a href=\"#生成器函数\" class=\"headerlink\" title=\"生成器函数\"></a>生成器函数</h2><p>生成器函数也是一个函数，但是和普通的函数有一些区别</p>\n<ol>\n<li>生成器函数需要在function的后面加一个符号：*。</li>\n<li>生成器函数可以通过yield关键字来控制函数的执行流程。</li>\n<li>生成器函数的返回值是一个Generator（生成器）。</li>\n</ol>\n<p>生成器事实上是一种特殊的迭代器。<br>MDN：Instead,they return a special type of iterator,called a <strong>Generator</strong></p>\n<p>下面是一个简单的生成器函数代码</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span>* <span class=\"title function_\">foo</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value1=<span class=\"string\">&#x27;1&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value1)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> value2=<span class=\"string\">&#x27;i&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value2)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> value3=<span class=\"string\">&#x27;n&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value3)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> generator=<span class=\"title function_\">foo</span>()</span><br><span class=\"line\">generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\">generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\">generator.<span class=\"title function_\">next</span>()</span><br></pre></td></tr></table></figure>\n<p>执行结果如下</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e17e01defcb94ea0b7fb4a7478bf9dea~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"><br>生成器函数通过yield关键字控制函数的执行，当我们每一次调用next（）方法时，就会调用yield对应顺序的以下代码。</p>\n<h3 id=\"yield关键字传出参数\"><a href=\"#yield关键字传出参数\" class=\"headerlink\" title=\"yield关键字传出参数\"></a>yield关键字传出参数</h3><p>当然，我们也可以通过在yield后边跟参数，将参数传出，并在next（）方法调用时接收</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span>* <span class=\"title function_\">foo</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value1=<span class=\"string\">&#x27;1&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value1)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export 1&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> value2=<span class=\"string\">&#x27;i&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value2)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export i&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">const</span> value3=<span class=\"string\">&#x27;n&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value3)</span><br><span class=\"line\">    <span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export n&#x27;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> generator=<span class=\"title function_\">foo</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word1=generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word2=generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word3=generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word1)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word2)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word3)</span><br></pre></td></tr></table></figure>\n<p>输出结果如下</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c510e993c4a42138fa923a81b0af9ce~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"next（）方法调用传入参数\"><a href=\"#next（）方法调用传入参数\" class=\"headerlink\" title=\"next（）方法调用传入参数\"></a>next（）方法调用传入参数</h3><p>当然，我们也可以在next（）方法调用时，传入参数，并用每一次yield执行时接收参数。</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span>* <span class=\"title function_\">foo</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value1=<span class=\"string\">&#x27;1&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value1)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> s1=<span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export 1&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(s1)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value2=<span class=\"string\">&#x27;i&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value2)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> s2=<span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export i&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(s2)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> value3=<span class=\"string\">&#x27;n&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(value3)</span><br><span class=\"line\">    <span class=\"keyword\">const</span> s3= <span class=\"keyword\">yield</span> <span class=\"string\">&#x27;export n&#x27;</span></span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(s3)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">const</span> generator=<span class=\"title function_\">foo</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word1=generator.<span class=\"title function_\">next</span>()</span><br><span class=\"line\"><span class=\"keyword\">const</span> word2=generator.<span class=\"title function_\">next</span>(<span class=\"string\">&#x27;incoming 1&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> word3=generator.<span class=\"title function_\">next</span>(<span class=\"string\">&#x27;incoming i&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">const</span> word4=generator.<span class=\"title function_\">next</span>(<span class=\"string\">&#x27;incoming n&#x27;</span>)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word1)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word2)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word3)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(word4)</span><br></pre></td></tr></table></figure>\n<p>执行结果如下</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c0b82171c6b44685a5a52d383cf17c75~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"return方法以及throw方法\"><a href=\"#return方法以及throw方法\" class=\"headerlink\" title=\"return方法以及throw方法\"></a>return方法以及throw方法</h3><p>通过调用return（）方法可以直接return出函数，不会再执行后边的函数，也无法用yield控制函数执行的过程，next（）方法也无法执行，throw方法则可以抛出异常。通过try catch方法去捕获错误。</p>\n<h2 id=\"yield\"><a href=\"#yield\" class=\"headerlink\" title=\"yield*\"></a>yield*</h2><p>在生成器函数中 yield可以传出参数，但是当我们用yield* 传出参数时，传出的参数必须是可迭代对象，async和await语法糖也是用到了yield*实现。</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><ol>\n<li>迭代器是一个对象，这个对象中有一个next（）方法，每次调用会retrun出一个对象，这个对象中有两个参数，done（bool类型）、value（具体的属性值）</li>\n<li>当一个对象实现了iterable protocol协议时，他就是一个可迭代对象，这个对象的要求是必须实现@@iterator方法，在代码中我们使用Symbol.iterator访问该属性。</li>\n<li>生成器是ES6中新增的一种函数控制、使用的方案、它可以让我们更加灵活的控制函数什么时候继续执行、暂停执行等。</li>\n<li>生成器事实上是一种特殊的迭代器。</li>\n<li>yield关键字传出参数、next（）方法调用传入参数。</li>\n</ol>\n"},{"title":"Nest.js中如何使用HTTP五种数据传输方式","date":"2023-05-27T09:55:00.000Z","sticky":100,"_content":"\n\n## 前言\n\n<img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1514657ca1e468dbd1d7b76dc951ef3~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\">\nNest.js作为JS的后端框架，是JS开发者迈向全栈的不错选择，Nest.js也是企业中最流行的Node框架，它提供了IOC、AOP、微服务等架构特性。\n\n接下来就让我们认识一下Nest.js在`HTTP五种数据`传输方式中的使用。\n\n## Param\n\n`param` 传输方式是通过url的参数传递，也是最常见的一种前端向后端传递参数的方式。\n\n如果Nest后端接口这样设置\n\n```ts\n@Controller('api/parma')\nexport class ParmaController {\n  @Get(':id')\n  urlParm(@Param('id') id: string) {\n    return `id=${id}`;\n  }\n}\n```\n\n前端请求这样请求\n\n```js\naxios.get(\"http://localhost:3000/api/parma/cdut\")\n```\n\n那么，其中的`cdut`会被当做parma参数被Nest截取，Nest也为我们提供了便捷的`@Param`装饰器，使我们可以更便捷的提取param参数。\n\n## Query\n\n`query`传输方式也是通过url的参数传递，但是他与parma略有不同。query传输方式需要做url encode\n\n如果Nest后端接口这样设置\n\n```ts\n@Controller('api/query')\nexport class QueryController { \n    @Get('find') query(@Query('name') name: string, @Query('age') age: number) \n    { return `name=${name},age=${age}`; } }\n```\n\n前端请求这样请求\n\n```js\naxios.get(\"http://localhost:3000/api/query/\",{\n    name:\"1in\",\n    age:20\n})\n```\n\n因为axios会自动帮我们url encode，所以我们不需要自己手动url encode，在Nest中，我们通过`@Query`这个装饰器来取到query参数。\n\n## Form urlencoded\n\n与query不同的是，from urlencoded是通过post请求中的body来传递参数，实际上，就是把query的参数放在body中。\n\n需要注意的是我们需要在`请求头`中设置`'content-type': 'application/x-www-form-urlencoded'`。\n\n如果Nest后端接口这样设置\n\n```ts\n@Controller('api/form-urlencoded') \nexport class FormUrlencodedController { \n    @Post() body(@Body() body)\n    { return `${JSON.stringify(body)}` } \n}\n```\n\n前端请求前，我们需要使用`qs`这个库来做一下url encode\n\n前端请求这样请求\n\n```js\naxios.post('http://localhost:3000/api/form-urlencoded',\n    Qs.stringify({ name: '1in', age: 20 }), \n    { headers: { 'content-type': 'application/x-www-form-urlencoded' } });\n```\n\n在Nest中，我们可以通过@Body这个装饰器来直接取到body中的内容。\n\n## Json\n\n与form urlencoded不同的是，json需要指定的`content-type`为`application/json`，也不需要url encode，同样的也是通过post请求中的Body传输数据。\n\n如果Nest后端接口这样设置\n\n```ts\n@Controller('api/json')\nexport class JsonController {\n    @Post()\n    body(@Body() body) {\n    return `received: ${JSON.stringify(createPersonDto)}`\n    }\n}\n```\n\n前端这样请求\n\n```js\n    axios.post(\"http://localhost:3000/api/json\",{\n        name:\"1in\",\n        age:20\n    })\n```\n\n因为`axios`会帮我们设置`content-type`为`application/json`，所以不需要我们自动设置，Nest同样也是通过@Body装饰器取到body中传输的数据。\n\n## Form data\n\nform data是通过---------作为boundary传输的内容，主要用于传输文件。\n\n如果Nest后端接口这样设置\n\n```ts\nimport { AnyFilesInterceptor } from '@nestjs/platform-express';\n\n@Controller('api/form-data')\nexport class FormDataController {\n  @Post('file')\n  @UseInterceptors(AnyFilesInterceptor())\n  body2(@Body() body, @UploadedFiles() files: Array<Express.Multer.File>) {\n    console.log(files);\n    return `received: ${JSON.stringify(body)}`\n  }\n}\n\n```\n\n前端代码使用 axios 发送 post 请求，指定 content type 为 `multipart/form-data`\n\n前端请求是这样的\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <script src=\"https://unpkg.com/axios@0.24.0/dist/axios.min.js\"></script>\n</head>\n<body>\n    <input id=\"updateFile\" type=\"file\" multiple/>\n    <script>\n        const fileInput = document.querySelector('#updateFile');\n\n        async function formData() {\n            const data = new FormData();\n            data.set('name','1in');\n            data.set('age', 20);\n            data.set('file1', fileInput.files[0]);\n            data.set('file2', fileInput.files[1]);\n\n            const res = await axios.post('http://localhost:3000/api/form-data/file', data, {\n                headers: { 'content-type': 'multipart/form-data' }\n            });\n             \n        }\n        fileInput.onchange = formData;\n    </script>\n</body>\n</html>\n```\n\nform data通过 ----- 作为 boundary 分隔的数据。主要用于传输文件，在Nest中使用 FilesInterceptor 来处理其中的 binary 字段，用 @UseInterceptors 装饰器来启用，其余字段用 @Body 装饰器来取。axios 发送请求时，需要设置请求头，指定 `content type`为 `multipart/form-data`，并且用 FormData 对象来封装传输的内容。\n\n","source":"_posts/Nest.js中如何使用HTTP五种数据传输方式.md","raw":"---\ntitle: Nest.js中如何使用HTTP五种数据传输方式\ndate: 2023/05/27/ 17:55\nsticky: 100\ntag: \n - TepyScript\n - Nest.js\ncategory:\n - 后端\n---\n\n\n## 前言\n\n<img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1514657ca1e468dbd1d7b76dc951ef3~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\">\nNest.js作为JS的后端框架，是JS开发者迈向全栈的不错选择，Nest.js也是企业中最流行的Node框架，它提供了IOC、AOP、微服务等架构特性。\n\n接下来就让我们认识一下Nest.js在`HTTP五种数据`传输方式中的使用。\n\n## Param\n\n`param` 传输方式是通过url的参数传递，也是最常见的一种前端向后端传递参数的方式。\n\n如果Nest后端接口这样设置\n\n```ts\n@Controller('api/parma')\nexport class ParmaController {\n  @Get(':id')\n  urlParm(@Param('id') id: string) {\n    return `id=${id}`;\n  }\n}\n```\n\n前端请求这样请求\n\n```js\naxios.get(\"http://localhost:3000/api/parma/cdut\")\n```\n\n那么，其中的`cdut`会被当做parma参数被Nest截取，Nest也为我们提供了便捷的`@Param`装饰器，使我们可以更便捷的提取param参数。\n\n## Query\n\n`query`传输方式也是通过url的参数传递，但是他与parma略有不同。query传输方式需要做url encode\n\n如果Nest后端接口这样设置\n\n```ts\n@Controller('api/query')\nexport class QueryController { \n    @Get('find') query(@Query('name') name: string, @Query('age') age: number) \n    { return `name=${name},age=${age}`; } }\n```\n\n前端请求这样请求\n\n```js\naxios.get(\"http://localhost:3000/api/query/\",{\n    name:\"1in\",\n    age:20\n})\n```\n\n因为axios会自动帮我们url encode，所以我们不需要自己手动url encode，在Nest中，我们通过`@Query`这个装饰器来取到query参数。\n\n## Form urlencoded\n\n与query不同的是，from urlencoded是通过post请求中的body来传递参数，实际上，就是把query的参数放在body中。\n\n需要注意的是我们需要在`请求头`中设置`'content-type': 'application/x-www-form-urlencoded'`。\n\n如果Nest后端接口这样设置\n\n```ts\n@Controller('api/form-urlencoded') \nexport class FormUrlencodedController { \n    @Post() body(@Body() body)\n    { return `${JSON.stringify(body)}` } \n}\n```\n\n前端请求前，我们需要使用`qs`这个库来做一下url encode\n\n前端请求这样请求\n\n```js\naxios.post('http://localhost:3000/api/form-urlencoded',\n    Qs.stringify({ name: '1in', age: 20 }), \n    { headers: { 'content-type': 'application/x-www-form-urlencoded' } });\n```\n\n在Nest中，我们可以通过@Body这个装饰器来直接取到body中的内容。\n\n## Json\n\n与form urlencoded不同的是，json需要指定的`content-type`为`application/json`，也不需要url encode，同样的也是通过post请求中的Body传输数据。\n\n如果Nest后端接口这样设置\n\n```ts\n@Controller('api/json')\nexport class JsonController {\n    @Post()\n    body(@Body() body) {\n    return `received: ${JSON.stringify(createPersonDto)}`\n    }\n}\n```\n\n前端这样请求\n\n```js\n    axios.post(\"http://localhost:3000/api/json\",{\n        name:\"1in\",\n        age:20\n    })\n```\n\n因为`axios`会帮我们设置`content-type`为`application/json`，所以不需要我们自动设置，Nest同样也是通过@Body装饰器取到body中传输的数据。\n\n## Form data\n\nform data是通过---------作为boundary传输的内容，主要用于传输文件。\n\n如果Nest后端接口这样设置\n\n```ts\nimport { AnyFilesInterceptor } from '@nestjs/platform-express';\n\n@Controller('api/form-data')\nexport class FormDataController {\n  @Post('file')\n  @UseInterceptors(AnyFilesInterceptor())\n  body2(@Body() body, @UploadedFiles() files: Array<Express.Multer.File>) {\n    console.log(files);\n    return `received: ${JSON.stringify(body)}`\n  }\n}\n\n```\n\n前端代码使用 axios 发送 post 请求，指定 content type 为 `multipart/form-data`\n\n前端请求是这样的\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <script src=\"https://unpkg.com/axios@0.24.0/dist/axios.min.js\"></script>\n</head>\n<body>\n    <input id=\"updateFile\" type=\"file\" multiple/>\n    <script>\n        const fileInput = document.querySelector('#updateFile');\n\n        async function formData() {\n            const data = new FormData();\n            data.set('name','1in');\n            data.set('age', 20);\n            data.set('file1', fileInput.files[0]);\n            data.set('file2', fileInput.files[1]);\n\n            const res = await axios.post('http://localhost:3000/api/form-data/file', data, {\n                headers: { 'content-type': 'multipart/form-data' }\n            });\n             \n        }\n        fileInput.onchange = formData;\n    </script>\n</body>\n</html>\n```\n\nform data通过 ----- 作为 boundary 分隔的数据。主要用于传输文件，在Nest中使用 FilesInterceptor 来处理其中的 binary 字段，用 @UseInterceptors 装饰器来启用，其余字段用 @Body 装饰器来取。axios 发送请求时，需要设置请求头，指定 `content type`为 `multipart/form-data`，并且用 FormData 对象来封装传输的内容。\n\n","slug":"Nest.js中如何使用HTTP五种数据传输方式","published":1,"updated":"2023-05-28T11:52:54.851Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5kss000x0svha94j0b92","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1514657ca1e468dbd1d7b76dc951ef3~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\">\nNest.js作为JS的后端框架，是JS开发者迈向全栈的不错选择，Nest.js也是企业中最流行的Node框架，它提供了IOC、AOP、微服务等架构特性。\n\n<p>接下来就让我们认识一下Nest.js在<code>HTTP五种数据</code>传输方式中的使用。</p>\n<h2 id=\"Param\"><a href=\"#Param\" class=\"headerlink\" title=\"Param\"></a>Param</h2><p><code>param</code> 传输方式是通过url的参数传递，也是最常见的一种前端向后端传递参数的方式。</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/parma&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ParmaController</span> &#123;</span><br><span class=\"line\">  <span class=\"meta\">@Get</span>(<span class=\"string\">&#x27;:id&#x27;</span>)</span><br><span class=\"line\">  <span class=\"title function_\">urlParm</span>(<span class=\"params\"><span class=\"meta\">@Param</span>(<span class=\"string\">&#x27;id&#x27;</span>) id: <span class=\"built_in\">string</span></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">`id=<span class=\"subst\">$&#123;id&#125;</span>`</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>前端请求这样请求</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios.<span class=\"title function_\">get</span>(<span class=\"string\">&quot;http://localhost:3000/api/parma/cdut&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>那么，其中的<code>cdut</code>会被当做parma参数被Nest截取，Nest也为我们提供了便捷的<code>@Param</code>装饰器，使我们可以更便捷的提取param参数。</p>\n<h2 id=\"Query\"><a href=\"#Query\" class=\"headerlink\" title=\"Query\"></a>Query</h2><p><code>query</code>传输方式也是通过url的参数传递，但是他与parma略有不同。query传输方式需要做url encode</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/query&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">QueryController</span> &#123; </span><br><span class=\"line\">    <span class=\"meta\">@Get</span>(<span class=\"string\">&#x27;find&#x27;</span>) <span class=\"title function_\">query</span>(<span class=\"params\"><span class=\"meta\">@Query</span>(<span class=\"string\">&#x27;name&#x27;</span>) name: <span class=\"built_in\">string</span>, <span class=\"meta\">@Query</span>(<span class=\"string\">&#x27;age&#x27;</span>) age: <span class=\"built_in\">number</span></span>) </span><br><span class=\"line\">    &#123; <span class=\"keyword\">return</span> <span class=\"string\">`name=<span class=\"subst\">$&#123;name&#125;</span>,age=<span class=\"subst\">$&#123;age&#125;</span>`</span>; &#125; &#125;</span><br></pre></td></tr></table></figure>\n\n<p>前端请求这样请求</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios.<span class=\"title function_\">get</span>(<span class=\"string\">&quot;http://localhost:3000/api/query/&quot;</span>,&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>因为axios会自动帮我们url encode，所以我们不需要自己手动url encode，在Nest中，我们通过<code>@Query</code>这个装饰器来取到query参数。</p>\n<h2 id=\"Form-urlencoded\"><a href=\"#Form-urlencoded\" class=\"headerlink\" title=\"Form urlencoded\"></a>Form urlencoded</h2><p>与query不同的是，from urlencoded是通过post请求中的body来传递参数，实际上，就是把query的参数放在body中。</p>\n<p>需要注意的是我们需要在<code>请求头</code>中设置<code>&#39;content-type&#39;: &#39;application/x-www-form-urlencoded&#39;</code>。</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/form-urlencoded&#x27;</span>) </span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">FormUrlencodedController</span> &#123; </span><br><span class=\"line\">    <span class=\"meta\">@Post</span>() <span class=\"title function_\">body</span>(<span class=\"params\"><span class=\"meta\">@Body</span>() body</span>)</span><br><span class=\"line\">    &#123; <span class=\"keyword\">return</span> <span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"built_in\">JSON</span>.stringify(body)&#125;</span>`</span> &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>前端请求前，我们需要使用<code>qs</code>这个库来做一下url encode</p>\n<p>前端请求这样请求</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios.<span class=\"title function_\">post</span>(<span class=\"string\">&#x27;http://localhost:3000/api/form-urlencoded&#x27;</span>,</span><br><span class=\"line\">    <span class=\"title class_\">Qs</span>.<span class=\"title function_\">stringify</span>(&#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;1in&#x27;</span>, <span class=\"attr\">age</span>: <span class=\"number\">20</span> &#125;), </span><br><span class=\"line\">    &#123; <span class=\"attr\">headers</span>: &#123; <span class=\"string\">&#x27;content-type&#x27;</span>: <span class=\"string\">&#x27;application/x-www-form-urlencoded&#x27;</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>在Nest中，我们可以通过@Body这个装饰器来直接取到body中的内容。</p>\n<h2 id=\"Json\"><a href=\"#Json\" class=\"headerlink\" title=\"Json\"></a>Json</h2><p>与form urlencoded不同的是，json需要指定的<code>content-type</code>为<code>application/json</code>，也不需要url encode，同样的也是通过post请求中的Body传输数据。</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/json&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JsonController</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Post</span>()</span><br><span class=\"line\">    <span class=\"title function_\">body</span>(<span class=\"params\"><span class=\"meta\">@Body</span>() body</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">`received: <span class=\"subst\">$&#123;<span class=\"built_in\">JSON</span>.stringify(createPersonDto)&#125;</span>`</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>前端这样请求</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios.<span class=\"title function_\">post</span>(<span class=\"string\">&quot;http://localhost:3000/api/json&quot;</span>,&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>因为<code>axios</code>会帮我们设置<code>content-type</code>为<code>application/json</code>，所以不需要我们自动设置，Nest同样也是通过@Body装饰器取到body中传输的数据。</p>\n<h2 id=\"Form-data\"><a href=\"#Form-data\" class=\"headerlink\" title=\"Form data\"></a>Form data</h2><p>form data是通过———作为boundary传输的内容，主要用于传输文件。</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123; <span class=\"title class_\">AnyFilesInterceptor</span> &#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/form-data&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">FormDataController</span> &#123;</span><br><span class=\"line\">  <span class=\"meta\">@Post</span>(<span class=\"string\">&#x27;file&#x27;</span>)</span><br><span class=\"line\">  <span class=\"meta\">@UseInterceptors</span>(<span class=\"title class_\">AnyFilesInterceptor</span>())</span><br><span class=\"line\">  <span class=\"title function_\">body2</span>(<span class=\"params\"><span class=\"meta\">@Body</span>() body, <span class=\"meta\">@UploadedFiles</span>() files: <span class=\"built_in\">Array</span>&lt;Express.Multer.File&gt;</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(files);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">`received: <span class=\"subst\">$&#123;<span class=\"built_in\">JSON</span>.stringify(body)&#125;</span>`</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>前端代码使用 axios 发送 post 请求，指定 content type 为 <code>multipart/form-data</code></p>\n<p>前端请求是这样的</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;en&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;https://unpkg.com/axios@0.24.0/dist/axios.min.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;updateFile&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;file&quot;</span> <span class=\"attr\">multiple</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">const</span> fileInput = <span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&#x27;#updateFile&#x27;</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">formData</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"keyword\">const</span> data = <span class=\"keyword\">new</span> <span class=\"title class_\">FormData</span>();</span></span><br><span class=\"line\"><span class=\"language-javascript\">            data.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;name&#x27;</span>,<span class=\"string\">&#x27;1in&#x27;</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\">            data.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;age&#x27;</span>, <span class=\"number\">20</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\">            data.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;file1&#x27;</span>, fileInput.<span class=\"property\">files</span>[<span class=\"number\">0</span>]);</span></span><br><span class=\"line\"><span class=\"language-javascript\">            data.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;file2&#x27;</span>, fileInput.<span class=\"property\">files</span>[<span class=\"number\">1</span>]);</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"keyword\">const</span> res = <span class=\"keyword\">await</span> axios.<span class=\"title function_\">post</span>(<span class=\"string\">&#x27;http://localhost:3000/api/form-data/file&#x27;</span>, data, &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">                <span class=\"attr\">headers</span>: &#123; <span class=\"string\">&#x27;content-type&#x27;</span>: <span class=\"string\">&#x27;multipart/form-data&#x27;</span> &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">             </span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        fileInput.<span class=\"property\">onchange</span> = formData;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>form data通过 —– 作为 boundary 分隔的数据。主要用于传输文件，在Nest中使用 FilesInterceptor 来处理其中的 binary 字段，用 @UseInterceptors 装饰器来启用，其余字段用 @Body 装饰器来取。axios 发送请求时，需要设置请求头，指定 <code>content type</code>为 <code>multipart/form-data</code>，并且用 FormData 对象来封装传输的内容。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1514657ca1e468dbd1d7b76dc951ef3~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\" width=\"100%\">\nNest.js作为JS的后端框架，是JS开发者迈向全栈的不错选择，Nest.js也是企业中最流行的Node框架，它提供了IOC、AOP、微服务等架构特性。\n\n<p>接下来就让我们认识一下Nest.js在<code>HTTP五种数据</code>传输方式中的使用。</p>\n<h2 id=\"Param\"><a href=\"#Param\" class=\"headerlink\" title=\"Param\"></a>Param</h2><p><code>param</code> 传输方式是通过url的参数传递，也是最常见的一种前端向后端传递参数的方式。</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/parma&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ParmaController</span> &#123;</span><br><span class=\"line\">  <span class=\"meta\">@Get</span>(<span class=\"string\">&#x27;:id&#x27;</span>)</span><br><span class=\"line\">  <span class=\"title function_\">urlParm</span>(<span class=\"params\"><span class=\"meta\">@Param</span>(<span class=\"string\">&#x27;id&#x27;</span>) id: <span class=\"built_in\">string</span></span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">`id=<span class=\"subst\">$&#123;id&#125;</span>`</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>前端请求这样请求</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios.<span class=\"title function_\">get</span>(<span class=\"string\">&quot;http://localhost:3000/api/parma/cdut&quot;</span>)</span><br></pre></td></tr></table></figure>\n\n<p>那么，其中的<code>cdut</code>会被当做parma参数被Nest截取，Nest也为我们提供了便捷的<code>@Param</code>装饰器，使我们可以更便捷的提取param参数。</p>\n<h2 id=\"Query\"><a href=\"#Query\" class=\"headerlink\" title=\"Query\"></a>Query</h2><p><code>query</code>传输方式也是通过url的参数传递，但是他与parma略有不同。query传输方式需要做url encode</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/query&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">QueryController</span> &#123; </span><br><span class=\"line\">    <span class=\"meta\">@Get</span>(<span class=\"string\">&#x27;find&#x27;</span>) <span class=\"title function_\">query</span>(<span class=\"params\"><span class=\"meta\">@Query</span>(<span class=\"string\">&#x27;name&#x27;</span>) name: <span class=\"built_in\">string</span>, <span class=\"meta\">@Query</span>(<span class=\"string\">&#x27;age&#x27;</span>) age: <span class=\"built_in\">number</span></span>) </span><br><span class=\"line\">    &#123; <span class=\"keyword\">return</span> <span class=\"string\">`name=<span class=\"subst\">$&#123;name&#125;</span>,age=<span class=\"subst\">$&#123;age&#125;</span>`</span>; &#125; &#125;</span><br></pre></td></tr></table></figure>\n\n<p>前端请求这样请求</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios.<span class=\"title function_\">get</span>(<span class=\"string\">&quot;http://localhost:3000/api/query/&quot;</span>,&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>因为axios会自动帮我们url encode，所以我们不需要自己手动url encode，在Nest中，我们通过<code>@Query</code>这个装饰器来取到query参数。</p>\n<h2 id=\"Form-urlencoded\"><a href=\"#Form-urlencoded\" class=\"headerlink\" title=\"Form urlencoded\"></a>Form urlencoded</h2><p>与query不同的是，from urlencoded是通过post请求中的body来传递参数，实际上，就是把query的参数放在body中。</p>\n<p>需要注意的是我们需要在<code>请求头</code>中设置<code>&#39;content-type&#39;: &#39;application/x-www-form-urlencoded&#39;</code>。</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/form-urlencoded&#x27;</span>) </span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">FormUrlencodedController</span> &#123; </span><br><span class=\"line\">    <span class=\"meta\">@Post</span>() <span class=\"title function_\">body</span>(<span class=\"params\"><span class=\"meta\">@Body</span>() body</span>)</span><br><span class=\"line\">    &#123; <span class=\"keyword\">return</span> <span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"built_in\">JSON</span>.stringify(body)&#125;</span>`</span> &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>前端请求前，我们需要使用<code>qs</code>这个库来做一下url encode</p>\n<p>前端请求这样请求</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios.<span class=\"title function_\">post</span>(<span class=\"string\">&#x27;http://localhost:3000/api/form-urlencoded&#x27;</span>,</span><br><span class=\"line\">    <span class=\"title class_\">Qs</span>.<span class=\"title function_\">stringify</span>(&#123; <span class=\"attr\">name</span>: <span class=\"string\">&#x27;1in&#x27;</span>, <span class=\"attr\">age</span>: <span class=\"number\">20</span> &#125;), </span><br><span class=\"line\">    &#123; <span class=\"attr\">headers</span>: &#123; <span class=\"string\">&#x27;content-type&#x27;</span>: <span class=\"string\">&#x27;application/x-www-form-urlencoded&#x27;</span> &#125; &#125;);</span><br></pre></td></tr></table></figure>\n\n<p>在Nest中，我们可以通过@Body这个装饰器来直接取到body中的内容。</p>\n<h2 id=\"Json\"><a href=\"#Json\" class=\"headerlink\" title=\"Json\"></a>Json</h2><p>与form urlencoded不同的是，json需要指定的<code>content-type</code>为<code>application/json</code>，也不需要url encode，同样的也是通过post请求中的Body传输数据。</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/json&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JsonController</span> &#123;</span><br><span class=\"line\">    <span class=\"meta\">@Post</span>()</span><br><span class=\"line\">    <span class=\"title function_\">body</span>(<span class=\"params\"><span class=\"meta\">@Body</span>() body</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">`received: <span class=\"subst\">$&#123;<span class=\"built_in\">JSON</span>.stringify(createPersonDto)&#125;</span>`</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>前端这样请求</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios.<span class=\"title function_\">post</span>(<span class=\"string\">&quot;http://localhost:3000/api/json&quot;</span>,&#123;</span><br><span class=\"line\">    <span class=\"attr\">name</span>:<span class=\"string\">&quot;1in&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">age</span>:<span class=\"number\">20</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n\n<p>因为<code>axios</code>会帮我们设置<code>content-type</code>为<code>application/json</code>，所以不需要我们自动设置，Nest同样也是通过@Body装饰器取到body中传输的数据。</p>\n<h2 id=\"Form-data\"><a href=\"#Form-data\" class=\"headerlink\" title=\"Form data\"></a>Form data</h2><p>form data是通过———作为boundary传输的内容，主要用于传输文件。</p>\n<p>如果Nest后端接口这样设置</p>\n<figure class=\"highlight ts\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> &#123; <span class=\"title class_\">AnyFilesInterceptor</span> &#125; <span class=\"keyword\">from</span> <span class=\"string\">&#x27;@nestjs/platform-express&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Controller</span>(<span class=\"string\">&#x27;api/form-data&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">class</span> <span class=\"title class_\">FormDataController</span> &#123;</span><br><span class=\"line\">  <span class=\"meta\">@Post</span>(<span class=\"string\">&#x27;file&#x27;</span>)</span><br><span class=\"line\">  <span class=\"meta\">@UseInterceptors</span>(<span class=\"title class_\">AnyFilesInterceptor</span>())</span><br><span class=\"line\">  <span class=\"title function_\">body2</span>(<span class=\"params\"><span class=\"meta\">@Body</span>() body, <span class=\"meta\">@UploadedFiles</span>() files: <span class=\"built_in\">Array</span>&lt;Express.Multer.File&gt;</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(files);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"string\">`received: <span class=\"subst\">$&#123;<span class=\"built_in\">JSON</span>.stringify(body)&#125;</span>`</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>前端代码使用 axios 发送 post 请求，指定 content type 为 <code>multipart/form-data</code></p>\n<p>前端请求是这样的</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">&quot;en&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;https://unpkg.com/axios@0.24.0/dist/axios.min.js&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;updateFile&quot;</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;file&quot;</span> <span class=\"attr\">multiple</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">const</span> fileInput = <span class=\"variable language_\">document</span>.<span class=\"title function_\">querySelector</span>(<span class=\"string\">&#x27;#updateFile&#x27;</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"keyword\">async</span> <span class=\"keyword\">function</span> <span class=\"title function_\">formData</span>(<span class=\"params\"></span>) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"keyword\">const</span> data = <span class=\"keyword\">new</span> <span class=\"title class_\">FormData</span>();</span></span><br><span class=\"line\"><span class=\"language-javascript\">            data.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;name&#x27;</span>,<span class=\"string\">&#x27;1in&#x27;</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\">            data.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;age&#x27;</span>, <span class=\"number\">20</span>);</span></span><br><span class=\"line\"><span class=\"language-javascript\">            data.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;file1&#x27;</span>, fileInput.<span class=\"property\">files</span>[<span class=\"number\">0</span>]);</span></span><br><span class=\"line\"><span class=\"language-javascript\">            data.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;file2&#x27;</span>, fileInput.<span class=\"property\">files</span>[<span class=\"number\">1</span>]);</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"keyword\">const</span> res = <span class=\"keyword\">await</span> axios.<span class=\"title function_\">post</span>(<span class=\"string\">&#x27;http://localhost:3000/api/form-data/file&#x27;</span>, data, &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">                <span class=\"attr\">headers</span>: &#123; <span class=\"string\">&#x27;content-type&#x27;</span>: <span class=\"string\">&#x27;multipart/form-data&#x27;</span> &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">            &#125;);</span></span><br><span class=\"line\"><span class=\"language-javascript\">             </span></span><br><span class=\"line\"><span class=\"language-javascript\">        &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        fileInput.<span class=\"property\">onchange</span> = formData;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>form data通过 —– 作为 boundary 分隔的数据。主要用于传输文件，在Nest中使用 FilesInterceptor 来处理其中的 binary 字段，用 @UseInterceptors 装饰器来启用，其余字段用 @Body 装饰器来取。axios 发送请求时，需要设置请求头，指定 <code>content type</code>为 <code>multipart/form-data</code>，并且用 FormData 对象来封装传输的内容。</p>\n"},{"title":"迭代器（iterator）、可迭代对象、生成器（generator）到底是什么","date":"2023-05-28T11:43:28.928Z","_content":"\n\n## 前言\n在JS初期，JS没有模块化时，团队分工合作问题以及变量作用域问题很是问题，随后在JS社区衍生出AMD、CMD、CommonJS等模块化规范，[关于CommonJS的实现原理可以参考我这篇](https://juejin.cn/post/7205508171524096060)，现如今，AMD、CMD的使用逐渐变少，应用广泛的就是CommonJS和ES modules，ES modules是ECMA官方定义的模块化语法。\n\n## 使用陷阱\n在没有脚手架的帮助下，我们使用ES modules时，在HTML文件中引入script标签时，需要加上type=\"module\"属性，表示script使用方法为模块化。\n\n### HTML文件中引入方法\n```js\n<script src=\"./foo.js\" type=\"module\"></script>\n```\n### JS文件中使用方法\n```js\n//bar.js\nexport const name=\"1in\"\nexport const age=20\n```\n```js\n//foo.js\nimport {name,age} from \"./bar\"\n\nconsole.log(name)\nconsole.log(age)\n```\n### 结果\n打开浏览器，看一下console.log出我们想要的结果出来没\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82bcda331af44df4b0a5d31d4ef1d765~tplv-k3u1fbpfcp-watermark.image?)\n\n得到了我们想要的结果。但是！！！ 注意，因为我使用的编译器是Webstrom，所以我运行html文件时，Webstrom会帮我自动开启一个服务端口运行此文件，但是我们都知道，本地双击html文件也是可以用浏览器打开的，这个时候，就会报错，所以，我们在VScode中就会遇到这种情况。\n\n### 解决VScode报错问题\n我们只需要安装一个插件，安装之后，在html文件中右键用这个插件打开即可。\n\n在VScode中搜索 **Live Server**\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19e8b68deefa421d9d8363f331f08379~tplv-k3u1fbpfcp-watermark.image?)\n\n### 为什么报错\nMDN中是这样解释的。\n\nMDN： 如果你尝试用本地文件加载 HTML 文件 (i.e. with a `file://` URL)，由于 JavaScript 模块的安全性要求，你会遇到 CORS 错误。你需要通过服务器来做你的测试。\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/876cad088cb048e9bbab7042dd1163e0~tplv-k3u1fbpfcp-watermark.image?)\n\n## 实现原理\nES Module是如何被浏览器解析并且让模块之间可以互相引用的呢？\n\nES Module的解析过程可以划分为三个阶段。\n1. 构建（Construction），根据地址查找js文件，并且下载，将其解析成模块记录（Module Record）；\n2. 实例化（Instantiation），对模块记录进行实例化，并且分配内存空间，解析模块的导入和导出语句，把模块指向对应的内存地址；\n3. 运行（Evaluation），运行代码，计算值，并且将值填充到内存地址中；\n\n在构建时，浏览器会静态扫描每个js文件的import语句（不会执行代码），所以我们的import语句不能写在类似于if语句这种需要动态判断的代码之中，import函数除外，扫描到import语句后，开始下载每一个js文件，下载好的js文件会parse成一个Module Record，同时下载过程中，还会生成一个Module Map的表，会记录已经下载的js文件和正在下载的js文件，避免重复引入。\n\n当所有的js文件构建成Module Record后，就会开始实例化阶段和运行求值阶段，每一个Module Record会实例化一个Module Environment Record，将自己导出的值绑定（Bindings）到Module Environment Record（内存地址）中，同时，需要导入js文件的Module Record也会将自己需要导入的值绑定（Bindings）到Module Environment Record（内存地址）中，在这个地址内存中，导入、导出自己对应的值，当然这个值，是需要求值运算过得，也就是阶段三完成后，对应的js文件就可以导入对应的值。如果导出的是数值，导入的js文件就会拿到对应的数值，如果导出的是函数或者对象，导入的js文件就会拿到对应的地址\n\n### 注意！！！\n导出的模块是可以修改导出的值（value），导入模块是不可以修改导入的值（value）否则会报错！！！\n\n## 总结\nES Module的解析过程可以划分为三个阶段。\n\n1.1 构建（Construction），根据地址查找js文件，并且下载，将其解析成模块记录（Module Record）；\n\n1.2  实例化（Instantiation），对模块记录进行实例化，并且分配内存空间，解析模块的导入和导出语句，把模块指向对应的内存地址；\n  \n1.3  运行（Evaluation），运行代码，计算值，并且将值填充到内存地址中；\n\n2. 导出的模块是可以修改导出的值（value），导入模块是不可以修改导入的值（value）否则会报错！！！ \n3. 在没有脚手架的帮助下，我们使用ES modules时，在HTML文件中引入script标签时，需要加上type=\"module\"属性，表示script使用方法为模块化。\n4. 在本地使用（没有脚手架的情况下）ES modules，需要使用VScode的一个插件**Live Server**，而Webstrom编辑器打开时会自动创建一个服务端口。\n\n\n\n","source":"_posts/ES Modules的实现原理.md","raw":"---\ntitle: 迭代器（iterator）、可迭代对象、生成器（generator）到底是什么\ndate: 2023/04/06 22-39\ntag: JavaScript\ncategory:\n - 前端\n---\n\n\n## 前言\n在JS初期，JS没有模块化时，团队分工合作问题以及变量作用域问题很是问题，随后在JS社区衍生出AMD、CMD、CommonJS等模块化规范，[关于CommonJS的实现原理可以参考我这篇](https://juejin.cn/post/7205508171524096060)，现如今，AMD、CMD的使用逐渐变少，应用广泛的就是CommonJS和ES modules，ES modules是ECMA官方定义的模块化语法。\n\n## 使用陷阱\n在没有脚手架的帮助下，我们使用ES modules时，在HTML文件中引入script标签时，需要加上type=\"module\"属性，表示script使用方法为模块化。\n\n### HTML文件中引入方法\n```js\n<script src=\"./foo.js\" type=\"module\"></script>\n```\n### JS文件中使用方法\n```js\n//bar.js\nexport const name=\"1in\"\nexport const age=20\n```\n```js\n//foo.js\nimport {name,age} from \"./bar\"\n\nconsole.log(name)\nconsole.log(age)\n```\n### 结果\n打开浏览器，看一下console.log出我们想要的结果出来没\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82bcda331af44df4b0a5d31d4ef1d765~tplv-k3u1fbpfcp-watermark.image?)\n\n得到了我们想要的结果。但是！！！ 注意，因为我使用的编译器是Webstrom，所以我运行html文件时，Webstrom会帮我自动开启一个服务端口运行此文件，但是我们都知道，本地双击html文件也是可以用浏览器打开的，这个时候，就会报错，所以，我们在VScode中就会遇到这种情况。\n\n### 解决VScode报错问题\n我们只需要安装一个插件，安装之后，在html文件中右键用这个插件打开即可。\n\n在VScode中搜索 **Live Server**\n\n![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19e8b68deefa421d9d8363f331f08379~tplv-k3u1fbpfcp-watermark.image?)\n\n### 为什么报错\nMDN中是这样解释的。\n\nMDN： 如果你尝试用本地文件加载 HTML 文件 (i.e. with a `file://` URL)，由于 JavaScript 模块的安全性要求，你会遇到 CORS 错误。你需要通过服务器来做你的测试。\n\n\n![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/876cad088cb048e9bbab7042dd1163e0~tplv-k3u1fbpfcp-watermark.image?)\n\n## 实现原理\nES Module是如何被浏览器解析并且让模块之间可以互相引用的呢？\n\nES Module的解析过程可以划分为三个阶段。\n1. 构建（Construction），根据地址查找js文件，并且下载，将其解析成模块记录（Module Record）；\n2. 实例化（Instantiation），对模块记录进行实例化，并且分配内存空间，解析模块的导入和导出语句，把模块指向对应的内存地址；\n3. 运行（Evaluation），运行代码，计算值，并且将值填充到内存地址中；\n\n在构建时，浏览器会静态扫描每个js文件的import语句（不会执行代码），所以我们的import语句不能写在类似于if语句这种需要动态判断的代码之中，import函数除外，扫描到import语句后，开始下载每一个js文件，下载好的js文件会parse成一个Module Record，同时下载过程中，还会生成一个Module Map的表，会记录已经下载的js文件和正在下载的js文件，避免重复引入。\n\n当所有的js文件构建成Module Record后，就会开始实例化阶段和运行求值阶段，每一个Module Record会实例化一个Module Environment Record，将自己导出的值绑定（Bindings）到Module Environment Record（内存地址）中，同时，需要导入js文件的Module Record也会将自己需要导入的值绑定（Bindings）到Module Environment Record（内存地址）中，在这个地址内存中，导入、导出自己对应的值，当然这个值，是需要求值运算过得，也就是阶段三完成后，对应的js文件就可以导入对应的值。如果导出的是数值，导入的js文件就会拿到对应的数值，如果导出的是函数或者对象，导入的js文件就会拿到对应的地址\n\n### 注意！！！\n导出的模块是可以修改导出的值（value），导入模块是不可以修改导入的值（value）否则会报错！！！\n\n## 总结\nES Module的解析过程可以划分为三个阶段。\n\n1.1 构建（Construction），根据地址查找js文件，并且下载，将其解析成模块记录（Module Record）；\n\n1.2  实例化（Instantiation），对模块记录进行实例化，并且分配内存空间，解析模块的导入和导出语句，把模块指向对应的内存地址；\n  \n1.3  运行（Evaluation），运行代码，计算值，并且将值填充到内存地址中；\n\n2. 导出的模块是可以修改导出的值（value），导入模块是不可以修改导入的值（value）否则会报错！！！ \n3. 在没有脚手架的帮助下，我们使用ES modules时，在HTML文件中引入script标签时，需要加上type=\"module\"属性，表示script使用方法为模块化。\n4. 在本地使用（没有脚手架的情况下）ES modules，需要使用VScode的一个插件**Live Server**，而Webstrom编辑器打开时会自动创建一个服务端口。\n\n\n\n","slug":"ES Modules的实现原理","published":1,"updated":"2023-05-28T11:44:18.075Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cli7g5kst00110svhdkboawqy","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在JS初期，JS没有模块化时，团队分工合作问题以及变量作用域问题很是问题，随后在JS社区衍生出AMD、CMD、CommonJS等模块化规范，<a href=\"https://juejin.cn/post/7205508171524096060\">关于CommonJS的实现原理可以参考我这篇</a>，现如今，AMD、CMD的使用逐渐变少，应用广泛的就是CommonJS和ES modules，ES modules是ECMA官方定义的模块化语法。</p>\n<h2 id=\"使用陷阱\"><a href=\"#使用陷阱\" class=\"headerlink\" title=\"使用陷阱\"></a>使用陷阱</h2><p>在没有脚手架的帮助下，我们使用ES modules时，在HTML文件中引入script标签时，需要加上type&#x3D;”module”属性，表示script使用方法为模块化。</p>\n<h3 id=\"HTML文件中引入方法\"><a href=\"#HTML文件中引入方法\" class=\"headerlink\" title=\"HTML文件中引入方法\"></a>HTML文件中引入方法</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=<span class=\"string\">&quot;./foo.js&quot;</span> type=<span class=\"string\">&quot;module&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"JS文件中使用方法\"><a href=\"#JS文件中使用方法\" class=\"headerlink\" title=\"JS文件中使用方法\"></a>JS文件中使用方法</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//bar.js</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> name=<span class=\"string\">&quot;1in&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> age=<span class=\"number\">20</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//foo.js</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123;name,age&#125; <span class=\"keyword\">from</span> <span class=\"string\">&quot;./bar&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(age)</span><br></pre></td></tr></table></figure>\n<h3 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h3><p>打开浏览器，看一下console.log出我们想要的结果出来没</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82bcda331af44df4b0a5d31d4ef1d765~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p>得到了我们想要的结果。但是！！！ 注意，因为我使用的编译器是Webstrom，所以我运行html文件时，Webstrom会帮我自动开启一个服务端口运行此文件，但是我们都知道，本地双击html文件也是可以用浏览器打开的，这个时候，就会报错，所以，我们在VScode中就会遇到这种情况。</p>\n<h3 id=\"解决VScode报错问题\"><a href=\"#解决VScode报错问题\" class=\"headerlink\" title=\"解决VScode报错问题\"></a>解决VScode报错问题</h3><p>我们只需要安装一个插件，安装之后，在html文件中右键用这个插件打开即可。</p>\n<p>在VScode中搜索 <strong>Live Server</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19e8b68deefa421d9d8363f331f08379~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"为什么报错\"><a href=\"#为什么报错\" class=\"headerlink\" title=\"为什么报错\"></a>为什么报错</h3><p>MDN中是这样解释的。</p>\n<p>MDN： 如果你尝试用本地文件加载 HTML 文件 (i.e. with a <code>file://</code> URL)，由于 JavaScript 模块的安全性要求，你会遇到 CORS 错误。你需要通过服务器来做你的测试。</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/876cad088cb048e9bbab7042dd1163e0~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h2 id=\"实现原理\"><a href=\"#实现原理\" class=\"headerlink\" title=\"实现原理\"></a>实现原理</h2><p>ES Module是如何被浏览器解析并且让模块之间可以互相引用的呢？</p>\n<p>ES Module的解析过程可以划分为三个阶段。</p>\n<ol>\n<li>构建（Construction），根据地址查找js文件，并且下载，将其解析成模块记录（Module Record）；</li>\n<li>实例化（Instantiation），对模块记录进行实例化，并且分配内存空间，解析模块的导入和导出语句，把模块指向对应的内存地址；</li>\n<li>运行（Evaluation），运行代码，计算值，并且将值填充到内存地址中；</li>\n</ol>\n<p>在构建时，浏览器会静态扫描每个js文件的import语句（不会执行代码），所以我们的import语句不能写在类似于if语句这种需要动态判断的代码之中，import函数除外，扫描到import语句后，开始下载每一个js文件，下载好的js文件会parse成一个Module Record，同时下载过程中，还会生成一个Module Map的表，会记录已经下载的js文件和正在下载的js文件，避免重复引入。</p>\n<p>当所有的js文件构建成Module Record后，就会开始实例化阶段和运行求值阶段，每一个Module Record会实例化一个Module Environment Record，将自己导出的值绑定（Bindings）到Module Environment Record（内存地址）中，同时，需要导入js文件的Module Record也会将自己需要导入的值绑定（Bindings）到Module Environment Record（内存地址）中，在这个地址内存中，导入、导出自己对应的值，当然这个值，是需要求值运算过得，也就是阶段三完成后，对应的js文件就可以导入对应的值。如果导出的是数值，导入的js文件就会拿到对应的数值，如果导出的是函数或者对象，导入的js文件就会拿到对应的地址</p>\n<h3 id=\"注意！！！\"><a href=\"#注意！！！\" class=\"headerlink\" title=\"注意！！！\"></a>注意！！！</h3><p>导出的模块是可以修改导出的值（value），导入模块是不可以修改导入的值（value）否则会报错！！！</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>ES Module的解析过程可以划分为三个阶段。</p>\n<p>1.1 构建（Construction），根据地址查找js文件，并且下载，将其解析成模块记录（Module Record）；</p>\n<p>1.2  实例化（Instantiation），对模块记录进行实例化，并且分配内存空间，解析模块的导入和导出语句，把模块指向对应的内存地址；</p>\n<p>1.3  运行（Evaluation），运行代码，计算值，并且将值填充到内存地址中；</p>\n<ol start=\"2\">\n<li>导出的模块是可以修改导出的值（value），导入模块是不可以修改导入的值（value）否则会报错！！！ </li>\n<li>在没有脚手架的帮助下，我们使用ES modules时，在HTML文件中引入script标签时，需要加上type&#x3D;”module”属性，表示script使用方法为模块化。</li>\n<li>在本地使用（没有脚手架的情况下）ES modules，需要使用VScode的一个插件<strong>Live Server</strong>，而Webstrom编辑器打开时会自动创建一个服务端口。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>在JS初期，JS没有模块化时，团队分工合作问题以及变量作用域问题很是问题，随后在JS社区衍生出AMD、CMD、CommonJS等模块化规范，<a href=\"https://juejin.cn/post/7205508171524096060\">关于CommonJS的实现原理可以参考我这篇</a>，现如今，AMD、CMD的使用逐渐变少，应用广泛的就是CommonJS和ES modules，ES modules是ECMA官方定义的模块化语法。</p>\n<h2 id=\"使用陷阱\"><a href=\"#使用陷阱\" class=\"headerlink\" title=\"使用陷阱\"></a>使用陷阱</h2><p>在没有脚手架的帮助下，我们使用ES modules时，在HTML文件中引入script标签时，需要加上type&#x3D;”module”属性，表示script使用方法为模块化。</p>\n<h3 id=\"HTML文件中引入方法\"><a href=\"#HTML文件中引入方法\" class=\"headerlink\" title=\"HTML文件中引入方法\"></a>HTML文件中引入方法</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=<span class=\"string\">&quot;./foo.js&quot;</span> type=<span class=\"string\">&quot;module&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"JS文件中使用方法\"><a href=\"#JS文件中使用方法\" class=\"headerlink\" title=\"JS文件中使用方法\"></a>JS文件中使用方法</h3><figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//bar.js</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> name=<span class=\"string\">&quot;1in&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">const</span> age=<span class=\"number\">20</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//foo.js</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123;name,age&#125; <span class=\"keyword\">from</span> <span class=\"string\">&quot;./bar&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(name)</span><br><span class=\"line\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(age)</span><br></pre></td></tr></table></figure>\n<h3 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h3><p>打开浏览器，看一下console.log出我们想要的结果出来没</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/82bcda331af44df4b0a5d31d4ef1d765~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<p>得到了我们想要的结果。但是！！！ 注意，因为我使用的编译器是Webstrom，所以我运行html文件时，Webstrom会帮我自动开启一个服务端口运行此文件，但是我们都知道，本地双击html文件也是可以用浏览器打开的，这个时候，就会报错，所以，我们在VScode中就会遇到这种情况。</p>\n<h3 id=\"解决VScode报错问题\"><a href=\"#解决VScode报错问题\" class=\"headerlink\" title=\"解决VScode报错问题\"></a>解决VScode报错问题</h3><p>我们只需要安装一个插件，安装之后，在html文件中右键用这个插件打开即可。</p>\n<p>在VScode中搜索 <strong>Live Server</strong></p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19e8b68deefa421d9d8363f331f08379~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h3 id=\"为什么报错\"><a href=\"#为什么报错\" class=\"headerlink\" title=\"为什么报错\"></a>为什么报错</h3><p>MDN中是这样解释的。</p>\n<p>MDN： 如果你尝试用本地文件加载 HTML 文件 (i.e. with a <code>file://</code> URL)，由于 JavaScript 模块的安全性要求，你会遇到 CORS 错误。你需要通过服务器来做你的测试。</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/876cad088cb048e9bbab7042dd1163e0~tplv-k3u1fbpfcp-watermark.image\" alt=\"image.png\"></p>\n<h2 id=\"实现原理\"><a href=\"#实现原理\" class=\"headerlink\" title=\"实现原理\"></a>实现原理</h2><p>ES Module是如何被浏览器解析并且让模块之间可以互相引用的呢？</p>\n<p>ES Module的解析过程可以划分为三个阶段。</p>\n<ol>\n<li>构建（Construction），根据地址查找js文件，并且下载，将其解析成模块记录（Module Record）；</li>\n<li>实例化（Instantiation），对模块记录进行实例化，并且分配内存空间，解析模块的导入和导出语句，把模块指向对应的内存地址；</li>\n<li>运行（Evaluation），运行代码，计算值，并且将值填充到内存地址中；</li>\n</ol>\n<p>在构建时，浏览器会静态扫描每个js文件的import语句（不会执行代码），所以我们的import语句不能写在类似于if语句这种需要动态判断的代码之中，import函数除外，扫描到import语句后，开始下载每一个js文件，下载好的js文件会parse成一个Module Record，同时下载过程中，还会生成一个Module Map的表，会记录已经下载的js文件和正在下载的js文件，避免重复引入。</p>\n<p>当所有的js文件构建成Module Record后，就会开始实例化阶段和运行求值阶段，每一个Module Record会实例化一个Module Environment Record，将自己导出的值绑定（Bindings）到Module Environment Record（内存地址）中，同时，需要导入js文件的Module Record也会将自己需要导入的值绑定（Bindings）到Module Environment Record（内存地址）中，在这个地址内存中，导入、导出自己对应的值，当然这个值，是需要求值运算过得，也就是阶段三完成后，对应的js文件就可以导入对应的值。如果导出的是数值，导入的js文件就会拿到对应的数值，如果导出的是函数或者对象，导入的js文件就会拿到对应的地址</p>\n<h3 id=\"注意！！！\"><a href=\"#注意！！！\" class=\"headerlink\" title=\"注意！！！\"></a>注意！！！</h3><p>导出的模块是可以修改导出的值（value），导入模块是不可以修改导入的值（value）否则会报错！！！</p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>ES Module的解析过程可以划分为三个阶段。</p>\n<p>1.1 构建（Construction），根据地址查找js文件，并且下载，将其解析成模块记录（Module Record）；</p>\n<p>1.2  实例化（Instantiation），对模块记录进行实例化，并且分配内存空间，解析模块的导入和导出语句，把模块指向对应的内存地址；</p>\n<p>1.3  运行（Evaluation），运行代码，计算值，并且将值填充到内存地址中；</p>\n<ol start=\"2\">\n<li>导出的模块是可以修改导出的值（value），导入模块是不可以修改导入的值（value）否则会报错！！！ </li>\n<li>在没有脚手架的帮助下，我们使用ES modules时，在HTML文件中引入script标签时，需要加上type&#x3D;”module”属性，表示script使用方法为模块化。</li>\n<li>在本地使用（没有脚手架的情况下）ES modules，需要使用VScode的一个插件<strong>Live Server</strong>，而Webstrom编辑器打开时会自动创建一个服务端口。</li>\n</ol>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cli7g5ksh00070svhgytm0hzt","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5ksk000f0svh7uu64vn0"},{"post_id":"cli7g5ks800010svh3zhc36rg","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5ksn000j0svh88x0g5g9"},{"post_id":"cli7g5ksj000c0svh88fk2si9","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5kso000m0svh6s7qclls"},{"post_id":"cli7g5ksc00030svhcpkq04tm","category_id":"cli7g5ksi00090svhaw5ral7s","_id":"cli7g5ksp000q0svhf7oubvye"},{"post_id":"cli7g5ksk000e0svhdc884duf","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5ksr000s0svh99w1d4xd"},{"post_id":"cli7g5ksm000i0svh612t6iqy","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5kss000v0svh7t0e9fza"},{"post_id":"cli7g5ksg00060svhevfi0ivn","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5kss000y0svhf4x448kd"},{"post_id":"cli7g5ksn000l0svh74yd1zd3","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5ksu00120svhen7ag70i"},{"post_id":"cli7g5kso000p0svh4fwgayp7","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5ksu00140svh9m934dk7"},{"post_id":"cli7g5ksi00080svheambc667","category_id":"cli7g5ksi00090svhaw5ral7s","_id":"cli7g5ksu00170svh8ohfd09z"},{"post_id":"cli7g5ksp000r0svh678iay4u","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5ksv00190svh7hhvbxpk"},{"post_id":"cli7g5ksr000u0svhhty7cpmv","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5ksv001c0svh7mgr56w8"},{"post_id":"cli7g5kss000x0svha94j0b92","category_id":"cli7g5ksi00090svhaw5ral7s","_id":"cli7g5ksw001e0svhg7py4k53"},{"post_id":"cli7g5kst00110svhdkboawqy","category_id":"cli7g5ksd00040svh4jr236d4","_id":"cli7g5ksw001h0svh57mrgwp3"}],"PostTag":[{"post_id":"cli7g5ksh00070svhgytm0hzt","tag_id":"cli7g5ksf00050svhan0m6qc2","_id":"cli7g5ksj000b0svh1i06areq"},{"post_id":"cli7g5ks800010svh3zhc36rg","tag_id":"cli7g5ksf00050svhan0m6qc2","_id":"cli7g5ksk000d0svh332921m8"},{"post_id":"cli7g5ksc00030svhcpkq04tm","tag_id":"cli7g5ksj000a0svhf9woaxan","_id":"cli7g5ksn000k0svh976xc2gp"},{"post_id":"cli7g5ksg00060svhevfi0ivn","tag_id":"cli7g5ksf00050svhan0m6qc2","_id":"cli7g5kss000w0svh4n6y286g"},{"post_id":"cli7g5ksg00060svhevfi0ivn","tag_id":"cli7g5kso000o0svhdmmpavg0","_id":"cli7g5kst000z0svhfmc86ikd"},{"post_id":"cli7g5ksp000r0svh678iay4u","tag_id":"cli7g5ksf00050svhan0m6qc2","_id":"cli7g5ksu00130svhbnp293kk"},{"post_id":"cli7g5ksr000u0svhhty7cpmv","tag_id":"cli7g5ksf00050svhan0m6qc2","_id":"cli7g5ksu00150svh16dmbjcl"},{"post_id":"cli7g5ksi00080svheambc667","tag_id":"cli7g5ksj000a0svhf9woaxan","_id":"cli7g5ksv00180svhf3bsh6vj"},{"post_id":"cli7g5kst00110svhdkboawqy","tag_id":"cli7g5ksf00050svhan0m6qc2","_id":"cli7g5ksv001a0svhdam07eow"},{"post_id":"cli7g5ksj000c0svh88fk2si9","tag_id":"cli7g5kst00100svh41docwfx","_id":"cli7g5ksw001d0svhc0ape4ri"},{"post_id":"cli7g5ksk000e0svhdc884duf","tag_id":"cli7g5kst00100svh41docwfx","_id":"cli7g5ksw001f0svh13ln4jd1"},{"post_id":"cli7g5ksm000i0svh612t6iqy","tag_id":"cli7g5kst00100svh41docwfx","_id":"cli7g5ksw001i0svh16utb2u5"},{"post_id":"cli7g5ksn000l0svh74yd1zd3","tag_id":"cli7g5kst00100svh41docwfx","_id":"cli7g5ksx001k0svhct8x20cv"},{"post_id":"cli7g5kso000p0svh4fwgayp7","tag_id":"cli7g5ksw001j0svh51c4adjs","_id":"cli7g5ksx001n0svh4vl76c5h"},{"post_id":"cli7g5kso000p0svh4fwgayp7","tag_id":"cli7g5ksx001l0svhazhj2hps","_id":"cli7g5ksx001o0svh3meh7rdm"},{"post_id":"cli7g5kss000x0svha94j0b92","tag_id":"cli7g5ksx001m0svh1kom13kn","_id":"cli7g5ksy001q0svh7g3r28lu"},{"post_id":"cli7g5kss000x0svha94j0b92","tag_id":"cli7g5ksx001p0svh16002f0a","_id":"cli7g5ksy001r0svhf1t6e7f7"}],"Tag":[{"name":"JavaScript","_id":"cli7g5ksf00050svhan0m6qc2"},{"name":"Node.js","_id":"cli7g5ksj000a0svhf9woaxan"},{"name":"并发请求","_id":"cli7g5kso000o0svhdmmpavg0"},{"name":"React","_id":"cli7g5kst00100svh41docwfx"},{"name":"Vue","_id":"cli7g5ksw001j0svh51c4adjs"},{"name":"Mobile","_id":"cli7g5ksx001l0svhazhj2hps"},{"name":"TepyScript","_id":"cli7g5ksx001m0svh1kom13kn"},{"name":"Nest.js","_id":"cli7g5ksx001p0svh16002f0a"}]}}